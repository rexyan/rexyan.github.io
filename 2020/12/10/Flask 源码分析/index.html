<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"rexyan.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"top","display":"hide","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"buttons","active":null,"storage":true,"lazyload":true,"nav":{"disqus":{"text":"Load Disqus","order":-1}}},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":3,"unescape":false,"preload":false},"motion":{"enable":false,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="参考文章: Flask源码分析（一）, Flask源码分析（二）, Flask源码分析（三） WSGI在说到wsgi时我们先看一下面向http的python程序需要关心的内容:  请求: 请求方法(method) 请求地址(url) 请求内容(body) 请求头(header) 请求环境(environ)   响应: 响应码(status_code) 响应数据(data) 响应头(header)">
<meta name="keywords" content="源码分析,Flask">
<meta property="og:type" content="article">
<meta property="og:title" content="Flask 源码分析">
<meta property="og:url" content="https://rexyan.github.io/2020/12/10/Flask 源码分析/index.html">
<meta property="og:site_name" content="星尘">
<meta property="og:description" content="参考文章: Flask源码分析（一）, Flask源码分析（二）, Flask源码分析（三） WSGI在说到wsgi时我们先看一下面向http的python程序需要关心的内容:  请求: 请求方法(method) 请求地址(url) 请求内容(body) 请求头(header) 请求环境(environ)   响应: 响应码(status_code) 响应数据(data) 响应头(header)">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2025-10-31T03:20:39.392Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Flask 源码分析">
<meta name="twitter:description" content="参考文章: Flask源码分析（一）, Flask源码分析（二）, Flask源码分析（三） WSGI在说到wsgi时我们先看一下面向http的python程序需要关心的内容:  请求: 请求方法(method) 请求地址(url) 请求内容(body) 请求头(header) 请求环境(environ)   响应: 响应码(status_code) 响应数据(data) 响应头(header)">

<link rel="canonical" href="https://rexyan.github.io/2020/12/10/Flask 源码分析/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Flask 源码分析 | 星尘</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

  
  <link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/lxgwwenkaiscreen.css" />
  <!-- 自定义为霞鹜文楷字体 -->
  <style>
	  body,div.post-body,h1,h2,h3,h4 {
		font-family: "LXGW WenKai Screen", sans-serif;
		font-size: 104%;
	  }
  </style>
  
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">星尘</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-读书">

    <a href="/books/" rel="section"><i class="address-book fa-fw"></i>读书</a>

  </li>
        <li class="menu-item menu-item-瞎扯">

    <a href="/crap/" rel="section"><i class="crap fa-fw"></i>瞎扯</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



<script src="https://cdn.jsdelivr.net/npm/echarts@4.8.0/dist/echarts.min.js"></script>

<meta name="referrer" content="never">




  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://rexyan.github.io/2020/12/10/Flask 源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/rexyan/warehouse/master/20230809141242.jpg">
      <meta itemprop="name" content="Rex">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="星尘">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Flask 源码分析
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-10 20:39:57" itemprop="dateCreated datePublished" datetime="2020-12-10T20:39:57+00:00">2020-12-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-10-31 03:20:39" itemprop="dateModified" datetime="2025-10-31T03:20:39+00:00">2025-10-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python-进阶/" itemprop="url" rel="index"><span itemprop="name">Python 进阶</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>参考文章: <a href="https://segmentfault.com/a/1190000022139239" target="_blank" rel="noopener">Flask源码分析（一）</a>, <a href="https://segmentfault.com/a/1190000022162758" target="_blank" rel="noopener">Flask源码分析（二）</a>, <a href="https://segmentfault.com/a/1190000022175553" target="_blank" rel="noopener">Flask源码分析（三）</a></p>
<h3 id="WSGI"><a href="#WSGI" class="headerlink" title="WSGI"></a>WSGI</h3><p>在说到wsgi时我们先看一下面向http的python程序需要关心的内容:</p>
<ol>
<li>请求:<ul>
<li>请求方法(method)</li>
<li>请求地址(url)</li>
<li>请求内容(body)</li>
<li>请求头(header)</li>
<li>请求环境(environ)</li>
</ul>
</li>
<li>响应:<ul>
<li>响应码(status_code)</li>
<li>响应数据(data)</li>
<li>响应头(header)</li>
</ul>
</li>
</ol>
<p>wsgi要做的就是关于程序端和服务端的标准规范, 将服务程序接收到的请i去传递给python程序, 并将网络的数据流和python的结构体进行转换.<br>它规定了python程序必须是一个可调用对象(实现了<strong>call</strong>函数的方法或类), 接受两个参数environ(WSGI的环境信息)和start_response(开始响应请求的函数), 并返回可迭代的结果. 直接上代码来实现一个最简单的web程序返回hello world:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> werkzeug.serving <span class="keyword">import</span> run_simple</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WebClass</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, environ, start_response)</span>:</span></span><br><span class="line">        status = <span class="string">'200 OK'</span></span><br><span class="line">        response_headers = [(<span class="string">'Content-type'</span>, <span class="string">'text/plain'</span>)]</span><br><span class="line">        start_response(status, response_headers)</span><br><span class="line">        <span class="keyword">yield</span> str.encode(<span class="string">"Hello World!\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app = WebClass()</span><br><span class="line">    run_simple(<span class="string">"127.0.0.1"</span>, <span class="number">5000</span>, app)</span><br></pre></td></tr></table></figure>
<p>WebClass正是实现了<code>__call__</code>方法的可调用对象, 接受environ和start_respone, 并在返回之前调用start_response, start_response接受两个必须的参数, status_code(http状态码)和response_header(响应头), yield hello world正是要求的可迭代结果, 现在这个类只是实现了最简单的功能, 路由注册, 模板渲染等都没有实现.这里用了werkzeug提供的run_simple, 其实我们创建flask应用, 跑起来的时候调用的也是这个函数,后面将会讲到。</p>
<h3 id="项目运行"><a href="#项目运行" class="headerlink" title="项目运行"></a>项目运行</h3><p><code>app.run()</code>, 源码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self, host=None, port=None, debug=None, load_dotenv=True, **options)</span>:</span></span><br><span class="line">    <span class="comment"># 是否是 cli 启动</span></span><br><span class="line">    <span class="keyword">if</span> os.environ.get(<span class="string">"FLASK_RUN_FROM_CLI"</span>) == <span class="string">"true"</span>:</span><br><span class="line">        <span class="keyword">from</span> .debughelpers <span class="keyword">import</span> explain_ignored_app_run</span><br><span class="line"></span><br><span class="line">        explain_ignored_app_run()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> get_load_dotenv(load_dotenv):</span><br><span class="line">        cli.load_dotenv()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># if set, let env vars override previous values</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">"FLASK_ENV"</span> <span class="keyword">in</span> os.environ:</span><br><span class="line">            self.env = get_env()</span><br><span class="line">            self.debug = get_debug_flag()</span><br><span class="line">        <span class="keyword">elif</span> <span class="string">"FLASK_DEBUG"</span> <span class="keyword">in</span> os.environ:</span><br><span class="line">            self.debug = get_debug_flag()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># debug passed to method overrides all other sources</span></span><br><span class="line">    <span class="keyword">if</span> debug <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        self.debug = bool(debug)</span><br><span class="line"></span><br><span class="line">    _host = <span class="string">"127.0.0.1"</span></span><br><span class="line">    _port = <span class="number">5000</span></span><br><span class="line">    server_name = self.config.get(<span class="string">"SERVER_NAME"</span>)</span><br><span class="line">    sn_host, sn_port = <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> server_name:</span><br><span class="line">        sn_host, _, sn_port = server_name.partition(<span class="string">":"</span>)</span><br><span class="line"></span><br><span class="line">    host = host <span class="keyword">or</span> sn_host <span class="keyword">or</span> _host</span><br><span class="line">    <span class="comment"># pick the first value that's not None (0 is allowed)</span></span><br><span class="line">    port = int(next((p <span class="keyword">for</span> p <span class="keyword">in</span> (port, sn_port) <span class="keyword">if</span> p <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>), _port))</span><br><span class="line"></span><br><span class="line">    options.setdefault(<span class="string">"use_reloader"</span>, self.debug)</span><br><span class="line">    options.setdefault(<span class="string">"use_debugger"</span>, self.debug)</span><br><span class="line">    <span class="comment"># 默认是多线程启动的</span></span><br><span class="line">    options.setdefault(<span class="string">"threaded"</span>, <span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># 显示 banner 信息</span></span><br><span class="line">    cli.show_server_banner(self.env, self.debug, self.name, <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> werkzeug.serving <span class="keyword">import</span> run_simple</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 运行 run_simple</span></span><br><span class="line">        run_simple(host, port, self, **options)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        self._got_first_request = <span class="literal">False</span></span><br></pre></td></tr></table></figure>
<p>上面函数的功能很简单，处理了以下参数，其中最主要的还是调用 werkzeug 的 run_simple 函数, run_simple 源码如下： </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_simple</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    hostname,</span></span></span><br><span class="line"><span class="function"><span class="params">    port,</span></span></span><br><span class="line"><span class="function"><span class="params">    application,</span></span></span><br><span class="line"><span class="function"><span class="params">    use_reloader=False,</span></span></span><br><span class="line"><span class="function"><span class="params">    use_debugger=False,</span></span></span><br><span class="line"><span class="function"><span class="params">    use_evalex=True,</span></span></span><br><span class="line"><span class="function"><span class="params">    extra_files=None,</span></span></span><br><span class="line"><span class="function"><span class="params">    reloader_interval=<span class="number">1</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    reloader_type=<span class="string">"auto"</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    threaded=False,</span></span></span><br><span class="line"><span class="function"><span class="params">    processes=<span class="number">1</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    request_handler=None,</span></span></span><br><span class="line"><span class="function"><span class="params">    static_files=None,</span></span></span><br><span class="line"><span class="function"><span class="params">    passthrough_errors=False,</span></span></span><br><span class="line"><span class="function"><span class="params">    ssl_context=None,</span></span></span><br><span class="line"><span class="function"><span class="params">)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> isinstance(port, int):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">"port must be an integer"</span>)</span><br><span class="line">    <span class="keyword">if</span> use_debugger:</span><br><span class="line">        <span class="keyword">from</span> .debug <span class="keyword">import</span> DebuggedApplication</span><br><span class="line"></span><br><span class="line">        application = DebuggedApplication(application, use_evalex)</span><br><span class="line">    <span class="keyword">if</span> static_files:</span><br><span class="line">        <span class="keyword">from</span> .middleware.shared_data <span class="keyword">import</span> SharedDataMiddleware</span><br><span class="line"></span><br><span class="line">        application = SharedDataMiddleware(application, static_files)</span><br><span class="line">    <span class="comment"># 启动后的显示信息，包含运行地址，端口等</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">log_startup</span><span class="params">(sock)</span>:</span></span><br><span class="line">        display_hostname = hostname <span class="keyword">if</span> hostname <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">""</span>, <span class="string">"*"</span>) <span class="keyword">else</span> <span class="string">"localhost"</span></span><br><span class="line">        quit_msg = <span class="string">"(Press CTRL+C to quit)"</span></span><br><span class="line">        <span class="keyword">if</span> sock.family == af_unix:</span><br><span class="line">            _log(<span class="string">"info"</span>, <span class="string">" * Running on %s %s"</span>, display_hostname, quit_msg)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">":"</span> <span class="keyword">in</span> display_hostname:</span><br><span class="line">                display_hostname = <span class="string">"[%s]"</span> % display_hostname</span><br><span class="line">            port = sock.getsockname()[<span class="number">1</span>]</span><br><span class="line">            _log(</span><br><span class="line">                <span class="string">"info"</span>,</span><br><span class="line">                <span class="string">" * Running on %s://%s:%d/ %s"</span>,</span><br><span class="line">                <span class="string">"http"</span> <span class="keyword">if</span> ssl_context <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> <span class="string">"https"</span>,</span><br><span class="line">                display_hostname,</span><br><span class="line">                port,</span><br><span class="line">                quit_msg,</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            fd = int(os.environ[<span class="string">"WERKZEUG_SERVER_FD"</span>])</span><br><span class="line">        <span class="keyword">except</span> (LookupError, ValueError):</span><br><span class="line">            fd = <span class="literal">None</span></span><br><span class="line">        <span class="comment"># 获取一个 wsgi 对象</span></span><br><span class="line">        srv = make_server(</span><br><span class="line">            hostname,</span><br><span class="line">            port,</span><br><span class="line">            application,</span><br><span class="line">            threaded,</span><br><span class="line">            processes,</span><br><span class="line">            request_handler,</span><br><span class="line">            passthrough_errors,</span><br><span class="line">            ssl_context,</span><br><span class="line">            fd=fd,</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> fd <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            log_startup(srv.socket)</span><br><span class="line">        <span class="comment"># 调用这个 wsgi 对象的 serve_forever 方法，让其项目处于运行状态</span></span><br><span class="line">        srv.serve_forever()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> use_reloader:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> is_running_from_reloader():</span><br><span class="line">            <span class="keyword">if</span> port == <span class="number">0</span> <span class="keyword">and</span> <span class="keyword">not</span> can_open_by_fd:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(</span><br><span class="line">                    <span class="string">"Cannot bind to a random port with enabled "</span></span><br><span class="line">                    <span class="string">"reloader if the Python interpreter does "</span></span><br><span class="line">                    <span class="string">"not support socket opening by fd."</span></span><br><span class="line">                )</span><br><span class="line">            address_family = select_address_family(hostname, port)</span><br><span class="line">            server_address = get_sockaddr(hostname, port, address_family)</span><br><span class="line">            s = socket.socket(address_family, socket.SOCK_STREAM)</span><br><span class="line">            s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">            s.bind(server_address)</span><br><span class="line">            <span class="keyword">if</span> hasattr(s, <span class="string">"set_inheritable"</span>):</span><br><span class="line">                s.set_inheritable(<span class="literal">True</span>)</span><br><span class="line">            <span class="keyword">if</span> can_open_by_fd:</span><br><span class="line">                os.environ[<span class="string">"WERKZEUG_SERVER_FD"</span>] = str(s.fileno())</span><br><span class="line">                s.listen(LISTEN_QUEUE)</span><br><span class="line">                log_startup(s)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                s.close()</span><br><span class="line">                <span class="keyword">if</span> address_family == af_unix:</span><br><span class="line">                    _log(<span class="string">"info"</span>, <span class="string">"Unlinking %s"</span> % server_address)</span><br><span class="line">                    os.unlink(server_address)</span><br><span class="line">        <span class="keyword">from</span> ._reloader <span class="keyword">import</span> run_with_reloader</span><br><span class="line"></span><br><span class="line">        run_with_reloader(inner, extra_files, reloader_interval, reloader_type)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 调用 inner 函数</span></span><br><span class="line">        inner()</span><br></pre></td></tr></table></figure>
<p>run_simple 中最后调用了其中的 inner 函数，inner 中的 make_server 函数返回一个 WSGIServer 对象，然后再调用  WSGIServer 对象的 serve_forever 方法，创建 wsgi 的服务, 然后运行，这样项目就运行起来了。</p>
<h3 id="请求处理"><a href="#请求处理" class="headerlink" title="请求处理"></a>请求处理</h3><p>前面说了wsgi规定应用程序必须实现<code>__call__</code>方法, 找到Flask对应的内容:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, environ, start_response)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> self.wsgi_app(environ, start_response)</span><br></pre></td></tr></table></figure>
<p>wsgi_app 源码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wsgi_app</span><span class="params">(self, environ, start_response)</span>:</span></span><br><span class="line">    <span class="comment"># 获取 RequestContext 对象</span></span><br><span class="line">    ctx = self.request_context(environ)</span><br><span class="line">    error = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            ctx.push()</span><br><span class="line">            <span class="comment"># full_dispatch_request 中做了很多事情，包含请求钩子处理，请求处理等</span></span><br><span class="line">            response = self.full_dispatch_request()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            error = e</span><br><span class="line">            response = self.handle_exception(e)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            error = sys.exc_info()[<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">return</span> response(environ, start_response)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">if</span> self.should_ignore_error(error):</span><br><span class="line">            error = <span class="literal">None</span></span><br><span class="line">        ctx.auto_pop(error)</span><br></pre></td></tr></table></figure>
<p><code>full_dispatch_request</code> 源码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">full_dispatch_request</span><span class="params">(self)</span>:</span></span><br><span class="line">    self.try_trigger_before_first_request_functions()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        request_started.send(self)</span><br><span class="line">        <span class="comment"># 判断是否有 @before_first_request，@before_request 装饰的钩子函数，如果有调用</span></span><br><span class="line">        rv = self.preprocess_request()</span><br><span class="line">        <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            rv = self.dispatch_request()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        rv = self.handle_user_exception(e)</span><br><span class="line">     <span class="comment"># 将请求结果通过钩子函数处理（如果有 @after_request 装饰的函数，那么就处理，不管请求是否异常都要执行的 teardown_request 函数）</span></span><br><span class="line">    <span class="keyword">return</span> self.finalize_request(rv)</span><br></pre></td></tr></table></figure>
<p>这段最核心的就是 <code>dispatch_request</code> , <code>dispatch_request</code> 就是我们注册的路由函数的执行结果, 在 <code>dispatch_request</code> 之前我们看到 <code>preprocess_request</code> , 它的作用是将钩子函数处理一下</p>
<ol>
<li>第一次请求处理之前的钩子函数, 通过 <code>before_first_request</code> 定义的</li>
<li>每个请求处理之前的钩子函数, 通过 <code>before_request</code> 定义的</li>
</ol>
<p>dispatch_request 源码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatch_request</span><span class="params">(self)</span>:</span></span><br><span class="line">    req = _request_ctx_stack.top.request</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 如果有 routing_exception（即 URL 路由异常），则抛出该异常</span></span><br><span class="line">    <span class="keyword">if</span> req.routing_exception <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">    	self.raise_routing_exception(req)</span><br><span class="line">    rule = req.url_rule</span><br><span class="line">	</span><br><span class="line">    <span class="comment"># 如果 URL 规则要求自动提供 OPTIONS 方法，并且当前请求是 OPTIONS 请求</span></span><br><span class="line">    <span class="keyword">if</span> (getattr(rule, <span class="string">"provide_automatic_options"</span>, <span class="literal">False</span>) <span class="keyword">and</span> req.method == <span class="string">"OPTIONS"</span>):</span><br><span class="line">    	<span class="keyword">return</span> self.make_default_options_response()</span><br><span class="line">	</span><br><span class="line">    <span class="comment"># 根据 URL 规则的 endpoint 获取相应的视图函数，并传递 req.view_args 参数</span></span><br><span class="line">    <span class="keyword">return</span> self.view_functions[rule.endpoint](**req.view_args)</span><br></pre></td></tr></table></figure>
<p>而在 <code>dispat_request</code> 之后还有 <code>finalize_request</code> 函数, 它的作用同样是将请求结果通过钩子函数处理一下:</p>
<ol>
<li>每个请求正常处理之后的 hook 函数，通过 <code>after_request</code> 定义</li>
<li>不管请求是否异常都要执行的 <code>teardown_request</code> hook 函数 所以上面最重要的就是 <code>dispatch_request</code> 函数, 找到我们注册的路由函数, 并返回</li>
</ol>
<p><code>preprocess_request</code> 源码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">preprocess_request</span><span class="params">(self)</span>:</span></span><br><span class="line">      <span class="comment"># 获取当前请求对象的 blueprint</span></span><br><span class="line">      bp = _request_ctx_stack.top.request.blueprint</span><br><span class="line"><span class="comment"># None 是获取作用于全局的函数</span></span><br><span class="line">      funcs = self.url_value_preprocessors.get(<span class="literal">None</span>, ())</span><br><span class="line">      <span class="comment"># 如果有蓝图，并且蓝图在 url_value_preprocessors 中</span></span><br><span class="line">      <span class="keyword">if</span> bp <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> bp <span class="keyword">in</span> self.url_value_preprocessors:</span><br><span class="line">          funcs = chain(funcs, self.url_value_preprocessors[bp]) <span class="comment"># 将蓝图上的函数与全局的函数进行合并</span></span><br><span class="line">      <span class="keyword">for</span> func <span class="keyword">in</span> funcs:</span><br><span class="line">          func(request.endpoint, request.view_args) <span class="comment"># 执行</span></span><br><span class="line">      <span class="comment"># 获取在 app 上注册的 before_request_funcs，可能会包含全局的和蓝图上的处理函数</span></span><br><span class="line">      funcs = self.before_request_funcs.get(<span class="literal">None</span>, ())</span><br><span class="line">      <span class="keyword">if</span> bp <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> bp <span class="keyword">in</span> self.before_request_funcs:</span><br><span class="line">          funcs = chain(funcs, self.before_request_funcs[bp])  <span class="comment"># 将蓝图上的函数与全局的函数进行合并</span></span><br><span class="line">      <span class="keyword">for</span> func <span class="keyword">in</span> funcs: <span class="comment"># 执行 before_request_funcs</span></span><br><span class="line">          rv = func()</span><br><span class="line">          <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">              <span class="keyword">return</span> rv</span><br></pre></td></tr></table></figure>
<blockquote>
<p>url_value_preprocessors 是一个字典，用于存储预处理请求 URL 中的值的函数。这些函数可以是全局的，也可以是与特定蓝图（Blueprint）关联的。当一个请求进入应用时，Flask 需要根据请求的蓝图确定需要执行哪些预处理函数。</p>
<p>考虑以下情况：您可能在应用级别注册了一些全局的 url_value_preprocessors，同时在特定的蓝图上也注册了一些预处理函数。在处理请求时，您可能希望先执行全局的预处理函数，然后再执行与当前蓝图关联的预处理函数。</p>
<p>这就是 funcs = chain(funcs, self.url_value_preprocessors[bp]) 这句代码的作用。它使用 itertools.chain 函数，将全局的预处理函数和与当前蓝图关联的预处理函数合并成一个生成器。生成器会依次返回这些函数，让 Flask 在适当的时候调用它们来预处理请求 URL 中的值。</p>
<p>要注意的是，itertools.chain 并不会立即执行这些函数，而是在迭代过程中依次执行它们。这样可以确保在请求处理之前按照合适的顺序执行所有的预处理函数。</p>
</blockquote>
<p><code>finalize_request</code> 源码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finalize_request</span><span class="params">(self, rv, from_error_handler=False)</span>:</span></span><br><span class="line">    <span class="comment"># 创建一个 response 对象</span></span><br><span class="line">    response = self.make_response(rv)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 处理返回前的钩子函数</span></span><br><span class="line">        response = self.process_response(response)</span><br><span class="line">        request_finished.send(self, response=response)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> from_error_handler:</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        self.logger.exception(</span><br><span class="line">            <span class="string">"Request finalizing failed with an error while handling an error"</span></span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>
<p><code>process_response</code> 源码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self, response)</span>:</span></span><br><span class="line">     ctx = _request_ctx_stack.top</span><br><span class="line">     bp = ctx.request.blueprint</span><br><span class="line">     funcs = ctx._after_request_functions</span><br><span class="line">     <span class="keyword">if</span> bp <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> bp <span class="keyword">in</span> self.after_request_funcs:</span><br><span class="line">         funcs = chain(funcs, reversed(self.after_request_funcs[bp]))</span><br><span class="line">     <span class="keyword">if</span> <span class="literal">None</span> <span class="keyword">in</span> self.after_request_funcs:</span><br><span class="line">         funcs = chain(funcs, reversed(self.after_request_funcs[<span class="literal">None</span>]))</span><br><span class="line">     <span class="keyword">for</span> handler <span class="keyword">in</span> funcs:</span><br><span class="line">         response = handler(response)</span><br><span class="line">     <span class="keyword">if</span> <span class="keyword">not</span> self.session_interface.is_null_session(ctx.session):</span><br><span class="line">         self.session_interface.save_session(self, ctx.session, response)</span><br><span class="line">     <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>
<h3 id="响应"><a href="#响应" class="headerlink" title="响应"></a>响应</h3><p><code>make_response</code> 源码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_response</span><span class="params">(self, rv)</span>:</span></span><br><span class="line">    status = headers = <span class="literal">None</span></span><br><span class="line">    <span class="comment"># 如果返回是一个 tuple</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(rv, tuple):</span><br><span class="line">        len_rv = len(rv)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 返回的长度为 3，那么分别就是 response 内容，http status，http headers</span></span><br><span class="line">        <span class="keyword">if</span> len_rv == <span class="number">3</span>:</span><br><span class="line">            rv, status, headers = rv</span><br><span class="line">        <span class="comment"># 如果返回长度只有两个</span></span><br><span class="line">        <span class="keyword">elif</span> len_rv == <span class="number">2</span>:</span><br><span class="line">            <span class="comment"># 且最后一个是 dict, tuple, list 格式的，那么返回是 response 内容和 headers</span></span><br><span class="line">            <span class="keyword">if</span> isinstance(rv[<span class="number">1</span>], (Headers, dict, tuple, list)):</span><br><span class="line">                rv, headers = rv</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 否则返回内容就是 response 内容和 status</span></span><br><span class="line">                rv, status = rv</span><br><span class="line">        <span class="comment"># 其他格式则不支持</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(</span><br><span class="line">                <span class="string">"The view function did not return a valid response tuple."</span></span><br><span class="line">                <span class="string">" The tuple must have the form (body, status, headers),"</span></span><br><span class="line">                <span class="string">" (body, status), or (body, headers)."</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 返回响应内容则不支持</span></span><br><span class="line">    <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> TypeError(</span><br><span class="line">            <span class="string">"The view function did not return a valid response. The"</span></span><br><span class="line">            <span class="string">" function either returned None or ended without a return"</span></span><br><span class="line">            <span class="string">" statement."</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 确保 response 是响应类的实例</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> isinstance(rv, self.response_class):</span><br><span class="line">        <span class="keyword">if</span> isinstance(rv, (text_type, bytes, bytearray)):</span><br><span class="line">            rv = self.response_class(rv, status=status, headers=headers)</span><br><span class="line">            status = headers = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">elif</span> isinstance(rv, dict):</span><br><span class="line">            rv = jsonify(rv)</span><br><span class="line">        <span class="keyword">elif</span> isinstance(rv, BaseResponse) <span class="keyword">or</span> callable(rv):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                rv = self.response_class.force_type(rv, request.environ)</span><br><span class="line">            <span class="keyword">except</span> TypeError <span class="keyword">as</span> e:</span><br><span class="line">                new_error = TypeError(</span><br><span class="line">                    <span class="string">"&#123;e&#125;\nThe view function did not return a valid"</span></span><br><span class="line">                    <span class="string">" response. The return type must be a string, dict, tuple,"</span></span><br><span class="line">                    <span class="string">" Response instance, or WSGI callable, but it was a"</span></span><br><span class="line">                    <span class="string">" &#123;rv.__class__.__name__&#125;."</span>.format(e=e, rv=rv)</span><br><span class="line">                )</span><br><span class="line">                reraise(TypeError, new_error, sys.exc_info()[<span class="number">2</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(</span><br><span class="line">                <span class="string">"The view function did not return a valid"</span></span><br><span class="line">                <span class="string">" response. The return type must be a string, dict, tuple,"</span></span><br><span class="line">                <span class="string">" Response instance, or WSGI callable, but it was a"</span></span><br><span class="line">                <span class="string">" &#123;rv.__class__.__name__&#125;."</span>.format(rv=rv)</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> status <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">if</span> isinstance(status, (text_type, bytes, bytearray)):</span><br><span class="line">            rv.status = status</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            rv.status_code = status</span><br><span class="line">    <span class="keyword">if</span> headers:</span><br><span class="line">        rv.headers.extend(headers)</span><br><span class="line">    <span class="keyword">return</span> rv</span><br></pre></td></tr></table></figure>
<h3 id="路由匹配"><a href="#路由匹配" class="headerlink" title="路由匹配"></a>路由匹配</h3><p>在 flask 中, 构建路由规则有两种方法, 这两种方法其实是一样的，都是调用 <code>add_url_rule</code> 来实现</p>
<ol>
<li>通过<a href="mailto:`@app.route" target="_blank" rel="noopener">`@app.route</a>()`的装饰器, 上面例子用的就是这种方法</li>
<li>通过<code>app.add_url_rule</code>, 这个方法的签名为 <code>add_url_rule(self, rule, endpoint=None, view_func=None, **options)</code></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">route</span><span class="params">(self, rule, **options)</span>:</span></span><br><span class="line"> <span class="function"><span class="keyword">def</span> <span class="title">decorator</span><span class="params">(f)</span>:</span></span><br><span class="line">  endpoint = options.pop(<span class="string">"endpoint"</span>, <span class="literal">None</span>)</span><br><span class="line">  self.add_url_rule(rule, endpoint, f, **options)</span><br><span class="line">  <span class="keyword">return</span> f</span><br><span class="line"> <span class="keyword">return</span> decorator</span><br></pre></td></tr></table></figure>
<p><code>add_url_rule</code> 源码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@setupmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_url_rule</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        self,</span></span></span><br><span class="line"><span class="function"><span class="params">        rule,</span></span></span><br><span class="line"><span class="function"><span class="params">        endpoint=None,</span></span></span><br><span class="line"><span class="function"><span class="params">        view_func=None,</span></span></span><br><span class="line"><span class="function"><span class="params">        provide_automatic_options=None,</span></span></span><br><span class="line"><span class="function"><span class="params">        **options</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span>:</span></span><br><span class="line">        <span class="comment"># 如果没有设置 endpoint，那么 endpoint 就是函数名称</span></span><br><span class="line">        <span class="keyword">if</span> endpoint <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            endpoint = _endpoint_from_view_func(view_func)</span><br><span class="line">        options[<span class="string">"endpoint"</span>] = endpoint</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获取函数对应的方法</span></span><br><span class="line">        methods = options.pop(<span class="string">"methods"</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> methods <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            methods = getattr(view_func, <span class="string">"methods"</span>, <span class="literal">None</span>) <span class="keyword">or</span> (<span class="string">"GET"</span>,)</span><br><span class="line">        <span class="keyword">if</span> isinstance(methods, string_types):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(</span><br><span class="line">                <span class="string">"Allowed methods have to be iterables of strings, "</span></span><br><span class="line">                <span class="string">'for example: @app.route(..., methods=["POST"])'</span></span><br><span class="line">            )</span><br><span class="line">        methods = set(item.upper() <span class="keyword">for</span> item <span class="keyword">in</span> methods)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获取 required_methods</span></span><br><span class="line">        required_methods = set(getattr(view_func, <span class="string">"required_methods"</span>, ()))</span><br><span class="line">        <span class="keyword">if</span> provide_automatic_options <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            provide_automatic_options = getattr(</span><br><span class="line">                view_func, <span class="string">"provide_automatic_options"</span>, <span class="literal">None</span></span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">if</span> provide_automatic_options <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">"OPTIONS"</span> <span class="keyword">not</span> <span class="keyword">in</span> methods:</span><br><span class="line">                provide_automatic_options = <span class="literal">True</span></span><br><span class="line">                required_methods.add(<span class="string">"OPTIONS"</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                provide_automatic_options = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 全部 methods</span></span><br><span class="line">        methods |= required_methods</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获取一个 rule，底层使用的是 werkzeug.routing 的 Rule 类对象</span></span><br><span class="line">        rule = self.url_rule_class(rule, methods=methods, **options)</span><br><span class="line">        rule.provide_automatic_options = provide_automatic_options</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 将路由添加进入 view_functions 中，底层使用的是 werkzeug.routing 的 Map 类对象</span></span><br><span class="line">        self.url_map.add(rule)</span><br><span class="line">        <span class="keyword">if</span> view_func <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            old_func = self.view_functions.get(endpoint)</span><br><span class="line">            <span class="keyword">if</span> old_func <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> old_func != view_func:</span><br><span class="line">                <span class="keyword">raise</span> AssertionError(</span><br><span class="line">                    <span class="string">"View function mapping is overwriting an "</span></span><br><span class="line">                    <span class="string">"existing endpoint function: %s"</span> % endpoint</span><br><span class="line">                )</span><br><span class="line">            self.view_functions[endpoint] = view_func</span><br></pre></td></tr></table></figure>
<p>可以发现这个函数主要做的就是更新 app 的 url_map 和 view_functions 这两个变量.查找定义, 发现 url_map 是 werkzeug.routing 的Map 类对象, rule 是 werkzeug.routing 的 Rule 类对象, view_functions 就是一个字典, 从上我们也可以知道每个视图函数的 endpoint 必须是不同的.也可以发现, flask 的核心路由逻辑其实实在 werkzeug 中实现的。</p>
<p><code>dispatch_request</code> 源码如下，在这里面将路由和要处理的函数结合起来，实现执行视图函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatch_request</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="comment"># 获取当前请求</span></span><br><span class="line">    req = _request_ctx_stack.top.request</span><br><span class="line">    <span class="keyword">if</span> req.routing_exception <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        self.raise_routing_exception(req)</span><br><span class="line">    <span class="comment"># 获取当前请求的 rule</span></span><br><span class="line">    rule = req.url_rule</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        getattr(rule, <span class="string">"provide_automatic_options"</span>, <span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">and</span> req.method == <span class="string">"OPTIONS"</span></span><br><span class="line">    ):</span><br><span class="line">        <span class="keyword">return</span> self.make_default_options_response()</span><br><span class="line">    <span class="comment"># 通过 endpoint 匹配视图函数并且执行</span></span><br><span class="line">    <span class="keyword">return</span> self.view_functions[rule.endpoint](**req.view_args)</span><br></pre></td></tr></table></figure>
<h3 id="上下文"><a href="#上下文" class="headerlink" title="上下文"></a>上下文</h3><p>之前在上面我们已经讲到dispatch_request函数在找到view_function后, 只是将最基本的参数传给了view_function, 可是有时这对视图函数来说是远远不够的, 它有时还需要头部(header), body里的数据, 才能正确运行, 可能 最简单的方法就是将所有的这些信息封装成一个对象, 作为参数传给视图函数, 可是这样一来所有的视图函数都需要添加对应的参数, 即使并没有用到它.</p>
<p><strong>flask</strong> 的做法是把这些信息作为上下文, 类似全局变量的东西, 在需要的时候, 用 <strong>from flask import request</strong> 获取, 比如经常用的request.json, request.args, 这里有一个很重要的点就是它们必须是动态的, 在多线程或多协程的情况下, 每个线程或协程获取的必须是自己独特的对象, 不能导入后结果获取的是其他请求的内容, 那就乱套了.</p>
<p>那么flask是如何实现不同的线程协程准确获得自己的上下文的呢, 我们先来看一下这两个上下文的定义:</p>
<p><code>application context</code> 演化成出两个变量 <code>current_app</code> 和 <code>g</code></p>
<p><code>request context</code> 演化出 <code>request</code> 和 <code>session</code></p>
<p>他们的实现正式依靠 <code>Local Stack</code> 和 <code>Local Proxy</code> 类, 正是这两个东西才让我们在并发程序中每个视图函数都会看到属于自己的上下文而不会混乱, 而这两个类能在多线程或多协程情况下实现隔离效果是考了另一个基础类 <code>Local</code>, 实现了类似threading.local的效果</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_lookup_req_object</span><span class="params">(name)</span>:</span></span><br><span class="line">    top = _request_ctx_stack.top</span><br><span class="line">    <span class="keyword">if</span> top <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(_request_ctx_err_msg)</span><br><span class="line">    <span class="keyword">return</span> getattr(top, name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_lookup_app_object</span><span class="params">(name)</span>:</span></span><br><span class="line">    top = _app_ctx_stack.top</span><br><span class="line">    <span class="keyword">if</span> top <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(_app_ctx_err_msg)</span><br><span class="line">    <span class="keyword">return</span> getattr(top, name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_find_app</span><span class="params">()</span>:</span></span><br><span class="line">    top = _app_ctx_stack.top</span><br><span class="line">    <span class="keyword">if</span> top <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(_app_ctx_err_msg)</span><br><span class="line">    <span class="keyword">return</span> top.app</span><br><span class="line"></span><br><span class="line">_request_ctx_stack = LocalStack()</span><br><span class="line">_app_ctx_stack = LocalStack()</span><br><span class="line">current_app = LocalProxy(_find_app)</span><br><span class="line">request = LocalProxy(partial(_lookup_req_object, <span class="string">"request"</span>))</span><br><span class="line">session = LocalProxy(partial(_lookup_req_object, <span class="string">"session"</span>))</span><br><span class="line">g = LocalProxy(partial(_lookup_app_object, <span class="string">"g"</span>))</span><br></pre></td></tr></table></figure>
<p><strong>为什么不直接使用 LocalStack，而是使用 LocalProxy 呢？</strong></p>
<p>主要原因在于 <code>LocalProxy</code> 的设计目标是为了提供更加简洁和方便的访问方式，使开发人员能够以属性访问的方式轻松地获取当前线程的上下文数据。<code>LocalProxy</code> 可以用来简化代码，并让您的代码更具可读性和可维护性。通过使用 <code>LocalProxy</code>，您可以避免在多个地方重复引用 <code>LocalStack</code> 实例。</p>
<p>Local 代码如下：</p>
<p><code>__storage__</code> 是用于存储内容的地方，格式为 {“线程ID”: {“key”:”value”}}，因为每个请求线程 ID 不一样，所以 Local  实现了隔离的效果。<code>__ident_func__</code> 绑定的是 <code>get_ident</code> 函数，作用是获取当前的线程 ID。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Local</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="comment"># 设置只有这两个属性可以被外部访问</span></span><br><span class="line">    __slots__ = (<span class="string">"__storage__"</span>, <span class="string">"__ident_func__"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># 设置 __storage__ 的初始化值</span></span><br><span class="line">        object.__setattr__(self, <span class="string">"__storage__"</span>, &#123;&#125;)</span><br><span class="line">        <span class="comment"># 设置 __ident_func__ 的值，get_ident 获得当前线程的 id</span></span><br><span class="line">        object.__setattr__(self, <span class="string">"__ident_func__"</span>, get_ident)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 遍历 Local</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> iter(self.__storage__.items())</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, proxy)</span>:</span></span><br><span class="line">        <span class="string">"""Create a proxy for a name."""</span></span><br><span class="line">        <span class="keyword">return</span> LocalProxy(self, proxy)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 释放</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__release_local__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.__storage__.pop(self.__ident_func__(), <span class="literal">None</span>)</span><br><span class="line">    <span class="comment"># 获取</span></span><br><span class="line">    <span class="comment"># 下面三个方法实现了属性的访问,设置和删除</span></span><br><span class="line">    <span class="comment"># 内部都调用了get_ident方法, 获取当前的线程或协程id, 然后一次为键访问值</span></span><br><span class="line">    <span class="comment"># 这样外部只是看到访问实例的属性, 其实内部已经实现了线程或协程的切换</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self.__storage__[self.__ident_func__()][name]</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            <span class="keyword">raise</span> AttributeError(name)</span><br><span class="line">    <span class="comment"># 设置</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, name, value)</span>:</span></span><br><span class="line">        ident = self.__ident_func__()</span><br><span class="line">        storage = self.__storage__</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            storage[ident][name] = value</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            storage[ident] = &#123;name: value&#125;</span><br><span class="line">    <span class="comment"># 删除</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delattr__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">del</span> self.__storage__[self.__ident_func__()][name]</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            <span class="keyword">raise</span> AttributeError(name)</span><br></pre></td></tr></table></figure>
<p>Local 是用来提供多线程或多协程的隔离属性访问的, 那么 Local Stack 就提供了隔离的栈访问, 它只要提供了 push, pop, top方法, 主要是栈的一些方法，在 LocalStack 的 push 方法中, 其实是对属性<code>_local</code>也就是 Local 的操作, 也就是先创建一个列表, <code>self._local.storage[ident(当前线程或协程id)][&#39;stack&#39;] = []</code>, 然后其实还是用 append 将 request 请求信息添加进去</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LocalStack</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._local = Local()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__release_local__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._local.__release_local__()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get__ident_func__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._local.__ident_func__</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_set__ident_func__</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        object.__setattr__(self._local, <span class="string">'__ident_func__'</span>, value)</span><br><span class="line">    __ident_func__ = property(_get__ident_func__, _set__ident_func__)</span><br><span class="line">    <span class="keyword">del</span> _get__ident_func__, _set__ident_func__</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_lookup</span><span class="params">()</span>:</span></span><br><span class="line">            rv = self.top</span><br><span class="line">            <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">raise</span> RuntimeError(<span class="string">'object unbound'</span>)</span><br><span class="line">            <span class="keyword">return</span> rv</span><br><span class="line">        <span class="keyword">return</span> LocalProxy(_lookup)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># push, pop, top 实现了栈的操作</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">push</span><span class="params">(self, obj)</span>:</span></span><br><span class="line">        rv = getattr(self._local, <span class="string">'stack'</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self._local.stack = rv = []</span><br><span class="line">        rv.append(obj)</span><br><span class="line">        <span class="keyword">return</span> rv</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pop</span><span class="params">(self)</span>:</span></span><br><span class="line">        stack = getattr(self._local, <span class="string">'stack'</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> stack <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">elif</span> len(stack) == <span class="number">1</span>:</span><br><span class="line">            release_local(self._local)</span><br><span class="line">            <span class="keyword">return</span> stack[<span class="number">-1</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> stack.pop()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">top</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self._local.stack[<span class="number">-1</span>]</span><br><span class="line">        <span class="keyword">except</span> (AttributeError, IndexError):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>
<p>上述已经将 Local 和 LocalStack 讲的差不多了。request ,g 的实现，用的是 LocalProxy，LocalProxy 还重写了所有的魔术方法,具体实现都是代理对象，LocalProxy 简要代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@implements_bool</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LocalProxy</span><span class="params">(object)</span>:</span></span><br><span class="line">    __slots__ = (<span class="string">'__local'</span>, <span class="string">'__dict__'</span>, <span class="string">'__name__'</span>, <span class="string">'__wrapped__'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, local, name=None)</span>:</span></span><br><span class="line">        object.__setattr__(self, <span class="string">'_LocalProxy__local'</span>, local)</span><br><span class="line">        object.__setattr__(self, <span class="string">'__name__'</span>, name)</span><br><span class="line">        <span class="keyword">if</span> callable(local) <span class="keyword">and</span> <span class="keyword">not</span> hasattr(local, <span class="string">'__release_local__'</span>):</span><br><span class="line">            <span class="comment"># "local" 是一个回调函数</span></span><br><span class="line">            object.__setattr__(self, <span class="string">'__wrapped__'</span>, local)</span><br><span class="line">	<span class="comment"># 获取当前线程或协程对应的对象</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get_current_object</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasattr(self.__local, <span class="string">'__release_local__'</span>):</span><br><span class="line">            <span class="keyword">return</span> self.__local()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> getattr(self.__local, self.__name__)</span><br><span class="line">        <span class="keyword">except</span> AttributeError:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">'no object bound to %s'</span> % self.__name__)</span><br></pre></td></tr></table></figure>
<p><code>_request_ctx_stack</code> 代表的就是请求上下文，ctx 其实是 RequestContext，请求来的时候会调用 RequestContext 的 push 方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">push</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># app_ctx 存放的是 Flask 应用实例，如果不存在，且不是当前的应用实例，那么就创建一个，在进行 push 操作</span></span><br><span class="line">        app_ctx = _app_ctx_stack.top</span><br><span class="line">        <span class="keyword">if</span> app_ctx <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> app_ctx.app != self.app:</span><br><span class="line">            app_ctx = self.app.app_context()</span><br><span class="line">            app_ctx.push()</span><br><span class="line">            self._implicit_app_ctx_stack.append(app_ctx)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self._implicit_app_ctx_stack.append(<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> hasattr(sys, <span class="string">"exc_clear"</span>):</span><br><span class="line">            sys.exc_clear()</span><br><span class="line">        <span class="comment"># push 当前 RequestContext 对象到 _request_ctx_stack 中</span></span><br><span class="line">        _request_ctx_stack.push(self)</span><br><span class="line">        <span class="keyword">if</span> self.session <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            session_interface = self.app.session_interface</span><br><span class="line">            self.session = session_interface.open_session(self.app, self.request)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> self.session <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                self.session = session_interface.make_null_session(self.app)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.url_adapter <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.match_request()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pop</span><span class="params">(self, exc=_sentinel)</span>:</span></span><br><span class="line">        app_ctx = self._implicit_app_ctx_stack.pop()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            clear_request = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> self._implicit_app_ctx_stack:</span><br><span class="line">                self.app.do_teardown_request(exc)</span><br><span class="line"></span><br><span class="line">                request_close = getattr(self.request, <span class="string">'close'</span>, <span class="literal">None</span>)</span><br><span class="line">                <span class="keyword">if</span> request_close <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    request_close()</span><br><span class="line">                clear_request = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            rv = _request_ctx_stack.pop()</span><br><span class="line">            <span class="keyword">if</span> clear_request:</span><br><span class="line">                rv.request.environ[<span class="string">'werkzeug.request'</span>] = <span class="literal">None</span></span><br><span class="line">            <span class="keyword">if</span> app_ctx <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                app_ctx.pop(exc)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">auto_pop</span><span class="params">(self, exc)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.request.environ.get(<span class="string">'flask._preserve_context'</span>) <span class="keyword">or</span> \</span><br><span class="line">           (exc <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> self.app.preserve_context_on_exception):</span><br><span class="line">            self.preserved = <span class="literal">True</span></span><br><span class="line">            self._preserved_exc = exc</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.pop(exc)</span><br></pre></td></tr></table></figure>
<p>push 就是将该请求的 application context (如果 _app_ctx_stack 栈顶不是当前请求所在 app,需要重新创建 app context )和 request context 都保存到相关的栈上, pop 则相反, 做一些出栈清理操作。</p>
<p>现在上下文就比较清楚了,就是每次有请求过来,flask 会创建当前线程或协程需要处理的两个上下文,并压入隔离的栈。application context针对的是 flask实 例的, 因为 app 实例只有一个, 所以多个请求其实是公用一个 application context, 而 request context 是每次请求过来都要创建的,在请求结束时又出栈, 所以两个的生命周期时不同的, 也就是 application context 的周期就是实例的生命周期, 而request context 的生命周期取决于请求存在的时间。</p>
<p>flask: <strong>app.run()</strong> 时, 并没有看到哪里启动了多线程, 理论上在单线程的情况下, 只有一个请求处理完成之后才能处理下一个请求, 那么上面为什么能同时处理多个请求, 哪里创建了多线程呢?<br>在flask的启动函数(run)中, 有这么一个源码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">options.setdefault(<span class="string">"threaded"</span>, <span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p><strong>有了 LocalStack  为什么还需要 LocalProxy？LocalProxy 起到了什么作用？</strong></p>
<p><code>LocalStack</code> 是 Flask 中用于在每个线程中管理上下文数据的工具。它在多线程环境下为每个线程维护一个独立的数据栈，确保数据隔离和线程安全。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 LocalStack 实例</span></span><br><span class="line">my_stack = LocalStack()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在线程中推入和弹出数据</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">(data)</span>:</span></span><br><span class="line">    my_stack.push(data)</span><br><span class="line">    print(<span class="string">"Data pushed:"</span>, my_stack.top)</span><br><span class="line">    my_stack.pop()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动多个线程来演示 LocalStack 的工作</span></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">    t = threading.Thread(target=worker, args=(<span class="string">f"Thread-<span class="subst">&#123;i&#125;</span>"</span>,))</span><br><span class="line">    threads.append(t)</span><br><span class="line">    t.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">    t.join()</span><br></pre></td></tr></table></figure>
<p><code>LocalProxy</code> 是 Flask 中的一个代理对象，用于访问 <code>LocalStack</code> 中的数据。它提供了一种简洁的方式来访问当前线程的上下文数据，而不需要显式地引用 <code>LocalStack</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 LocalStack 实例</span></span><br><span class="line">my_stack = LocalStack()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 LocalStack 包装为 LocalProxy</span></span><br><span class="line">current_data = LocalProxy(my_stack)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在线程中推入数据并通过 LocalProxy 访问</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">(data)</span>:</span></span><br><span class="line">    my_stack.push(data)</span><br><span class="line">    print(<span class="string">"Data pushed:"</span>, current_data)</span><br><span class="line">    my_stack.pop()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动多个线程来演示 LocalProxy 的工作</span></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">    t = threading.Thread(target=worker, args=(<span class="string">f"Thread-<span class="subst">&#123;i&#125;</span>"</span>,))</span><br><span class="line">    threads.append(t)</span><br><span class="line">    t.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">    t.join()</span><br></pre></td></tr></table></figure>
<p>在上述示例中，<code>LocalStack</code> 用于在每个线程中管理数据栈，而 <code>LocalProxy</code> 则是在访问数据时提供了简洁的方式。通过将 <code>LocalStack</code> 包装为 <code>LocalProxy</code>，您可以通过属性访问的方式来获取当前线程的上下文数据，而无需明确引用 <code>LocalStack</code>。</p>
<p>总结：<code>LocalStack</code> 用于管理数据栈的隔离和线程安全，而 <code>LocalProxy</code> 则是提供了方便的访问方式，使您能够轻松地从当前线程的上下文中获取数据。</p>
<h3 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h3><p>在 Flask 中，异常处理主要涉及以下几个核心模块和类：</p>
<ol>
<li><strong><code>werkzeug.exceptions</code> 模块</strong>：Werkzeug 是 Flask 的底层库，<code>werkzeug.exceptions</code> 模块定义了许多常见的 HTTP 异常类，如 <code>HTTPException</code>、<code>BadRequest</code>、<code>NotFound</code> 等。这些异常类用于表示 HTTP 请求和响应中的不同状态码和错误情况。</li>
<li><strong><code>flask</code> 模块中的异常类</strong>：在 Flask 的 <code>flask</code> 模块中，有一些自定义的异常类，如 <code>FlaskException</code> 和 <code>RequestRedirect</code> 等。这些异常类用于处理与 Flask 特定功能和行为相关的错误。</li>
<li><strong>应用和蓝图中的错误处理装饰器</strong>：在 Flask 应用中，您可以使用装饰器 <a href="mailto:`@app.errorhandler" target="_blank" rel="noopener">`@app.errorhandler</a>(Exception)` 来为特定异常注册处理函数，从而实现自定义的异常处理逻辑。同样，在蓝图中也有类似的机制。</li>
</ol>
<p><a href="mailto:**@app.errorhandler" target="_blank" rel="noopener">**@app.errorhandler</a> 源码分析**</p>
<p><a href="mailto:`@app.errorhandler" target="_blank" rel="noopener">`@app.errorhandler</a>` 装饰器是 Flask 提供的一种机制，用于为特定的异常类型注册自定义的错误处理函数。当异常被抛出并且与装饰器中指定的异常类型匹配时，注册的错误处理函数会被调用。让我们来分析一下这个装饰器的源码以及它是如何工作的。</p>
<p>在 Flask 中，<a href="mailto:`@app.errorhandler" target="_blank" rel="noopener">`@app.errorhandler</a><code>装饰器的定义位于</code>flask.app` 模块中。以下是大致的源码结构和解释：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flask</span>:</span></span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">errorhandler</span><span class="params">(self, code_or_exception)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">decorator</span><span class="params">(f)</span>:</span></span><br><span class="line">            self._register_error_handler(code_or_exception, f)</span><br><span class="line">            <span class="keyword">return</span> f</span><br><span class="line">        <span class="keyword">return</span> decorator</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_register_error_handler</span><span class="params">(self, code_or_exception, f)</span>:</span></span><br><span class="line">        <span class="comment"># 将错误处理函数注册到 _error_handlers 字典中</span></span><br><span class="line">        self._error_handlers[code_or_exception] = f</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_exception</span><span class="params">(self, e)</span>:</span></span><br><span class="line">        <span class="comment"># 查找匹配异常类型的错误处理函数并调用</span></span><br><span class="line">        <span class="keyword">for</span> code_or_exception, handler <span class="keyword">in</span> self._error_handlers.items():</span><br><span class="line">            <span class="keyword">if</span> isinstance(e, code_or_exception):</span><br><span class="line">                <span class="keyword">return</span> handler(e)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>
<ol>
<li><a href="mailto:`@app.errorhandler" target="_blank" rel="noopener">`@app.errorhandler</a><code>是</code>Flask<code>类的一个方法，它接受一个异常类型或者状态码作为参数。它返回一个装饰器函数</code>decorator`。</li>
<li><code>decorator</code> 函数接受一个处理函数 <code>f</code>，并在内部调用 <code>_register_error_handler</code> 方法将处理函数与异常类型或状态码注册到 <code>_error_handlers</code> 字典中。</li>
<li><code>_register_error_handler</code> 方法将异常类型或状态码作为键，处理函数作为值，注册到 <code>_error_handlers</code> 字典中。</li>
<li>当应用中抛出异常时，<code>handle_exception</code> 方法会被调用。它会遍历 <code>_error_handlers</code> 字典，查找与异常类型匹配的处理函数，并调用该处理函数来处理异常。</li>
</ol>
<p><strong>是怎么触发错误处理的？</strong></p>
<p>在 wsgi_app 中，如果 <code>full_dispatch_request</code> 调用失败，则会调用 handle_exception 进行错误处理，在 handle_exception  中，会根据当前的 error 去寻找对应的注册的回调方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_exception</span><span class="params">(self, e)</span>:</span></span><br><span class="line">    exc_type, exc_value, tb = sys.exc_info()</span><br><span class="line">    got_request_exception.send(self, exception=e)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> self.propagate_exceptions:</span><br><span class="line">        <span class="keyword">if</span> exc_value <span class="keyword">is</span> e:</span><br><span class="line">            reraise(exc_type, exc_value, tb)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> e</span><br><span class="line"></span><br><span class="line">    self.log_exception((exc_type, exc_value, tb))</span><br><span class="line">    server_error = InternalServerError()</span><br><span class="line">    server_error.original_exception = e</span><br><span class="line">    handler = self._find_error_handler(server_error)  <span class="comment"># 寻找处理错误的 handler，没有则就是 server_error</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> handler <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        server_error = handler(server_error)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> self.finalize_request(server_error, from_error_handler=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<h3 id="信号"><a href="#信号" class="headerlink" title="信号"></a>信号</h3><p>Flask 信号机制的核心是 <code>blinker</code> 库，它提供了一种用于实现事件触发和响应的简单方法。<code>blinker</code> 是一个独立的 Python 库，被 Flask 内部用作信号机制的基础。</p>
<p>以下是 Flask 中信号的基本用法：</p>
<ol>
<li><p><strong>导入 <code>blinker</code> 模块</strong>：在 Flask 中，您可以通过导入 <code>flask.signals</code> 模块来获得 <code>blinker</code> 的实例。</p>
</li>
<li><p><strong>创建信号对象</strong>：使用 <code>flask.signals.Namespace</code> 类创建信号对象。例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask.signals <span class="keyword">import</span> Namespace</span><br><span class="line"></span><br><span class="line">signals = Namespace()</span><br><span class="line">my_signal = signals.signal(<span class="string">"my-signal"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>连接信号和回调函数</strong>：使用 <code>.connect</code> 方法将信号与回调函数关联起来。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@my_signal.connect</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_signal_handler</span><span class="params">(sender, **kwargs)</span>:</span></span><br><span class="line">    print(<span class="string">"Signal received!"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>触发信号</strong>：在适当的时候，通过调用信号对象的 <code>.send</code> 方法来触发信号。您可以在应用中的某个地方触发信号，然后相关的回调函数会被执行。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">my_signal.send(<span class="literal">None</span>)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>在 Flask 中，有一些内置的信号可以用于不同的事件，例如 <code>request_started</code>、<code>request_finished</code>、<code>template_rendered</code> 等。您还可以自定义信号来实现特定的事件响应。</p>
<p>信号机制在 Flask 中的应用范围广泛，它可以用于以下场景：</p>
<ul>
<li>在请求处理开始和结束时执行一些操作。</li>
<li>在模板渲染完成后执行特定的操作。</li>
<li>在应用启动、关闭或重载时触发自定义操作。</li>
<li>在扩展或插件中进行事件监听和处理。</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/源码分析/" rel="tag"><i class="fa fa-tag"></i> 源码分析</a>
              <a href="/tags/Flask/" rel="tag"><i class="fa fa-tag"></i> Flask</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/11/29/Python 开发及周边技术介绍/" rel="prev" title="Python 开发及周边技术介绍">
      <i class="fa fa-chevron-left"></i> Python 开发及周边技术介绍
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/12/10/Flask restful源码分析/" rel="next" title="Flask restful源码分析">
      Flask restful源码分析 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#WSGI"><span class="nav-number">1.</span> <span class="nav-text">WSGI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#项目运行"><span class="nav-number">2.</span> <span class="nav-text">项目运行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#请求处理"><span class="nav-number">3.</span> <span class="nav-text">请求处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#响应"><span class="nav-number">4.</span> <span class="nav-text">响应</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#路由匹配"><span class="nav-number">5.</span> <span class="nav-text">路由匹配</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#上下文"><span class="nav-number">6.</span> <span class="nav-text">上下文</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#异常处理"><span class="nav-number">7.</span> <span class="nav-text">异常处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#信号"><span class="nav-number">8.</span> <span class="nav-text">信号</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Rex"
      src="https://raw.githubusercontent.com/rexyan/warehouse/master/20230809141242.jpg">
  <p class="site-author-name" itemprop="name">Rex</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">446</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">183</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa-hand-o-right"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Rex</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
<script src="/js/utils.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  

</body>
</html>
