<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"rexyan.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"top","display":"hide","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"buttons","active":null,"storage":true,"lazyload":true,"nav":{"disqus":{"text":"Load Disqus","order":-1}}},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":3,"unescape":false,"preload":false},"motion":{"enable":false,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="æ‘˜è¦ã€Š100 Go Mistakes and How to Avoid Themã€‹ä¸€æœ¬å…³äº Go è¯­è¨€ä¸­å¸¸è§é”™è¯¯çš„ä¹¦ç±ï¼Œåœ¨äºä»‹ç»å’Œè®©æˆ‘ä»¬ä¸å†é™·å…¥è¿™äº›é™·é˜±å½“ä¸­ã€‚ä¹¦ 2022 å¹´ 8æœˆå‡ºç‰ˆï¼Œå›½å†…ç›®å‰è¿˜æ²¡æœ‰ä¸­æ–‡ç‰ˆæœ¬ï¼ŒèŠ±äº†å‡ å‘¨çš„åœ°é“æ—¶é—´ï¼Œç»ˆäºé™†é™†ç»­ç»­çœ‹å®Œäº†ã€‚ æ¶‰åŠçš„ä»£ç ä»“åº“ï¼šhttps://github.com/rexyan/100-Go-Mistakes">
<meta property="og:type" content="article">
<meta property="og:title" content="100 Go Mistakes">
<meta property="og:url" content="https://rexyan.github.io/2023/08/02/100 Go Mistakes/index.html">
<meta property="og:site_name" content="æ˜Ÿå°˜">
<meta property="og:description" content="æ‘˜è¦ã€Š100 Go Mistakes and How to Avoid Themã€‹ä¸€æœ¬å…³äº Go è¯­è¨€ä¸­å¸¸è§é”™è¯¯çš„ä¹¦ç±ï¼Œåœ¨äºä»‹ç»å’Œè®©æˆ‘ä»¬ä¸å†é™·å…¥è¿™äº›é™·é˜±å½“ä¸­ã€‚ä¹¦ 2022 å¹´ 8æœˆå‡ºç‰ˆï¼Œå›½å†…ç›®å‰è¿˜æ²¡æœ‰ä¸­æ–‡ç‰ˆæœ¬ï¼ŒèŠ±äº†å‡ å‘¨çš„åœ°é“æ—¶é—´ï¼Œç»ˆäºé™†é™†ç»­ç»­çœ‹å®Œäº†ã€‚ æ¶‰åŠçš„ä»£ç ä»“åº“ï¼šhttps://github.com/rexyan/100-Go-Mistakes">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://raw.githubusercontent.com/rexyan/warehouse/master/202308032150361.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rexyan/warehouse/master/202308032151555.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rexyan/warehouse/master/202308032202705.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rexyan/warehouse/master/202308032218861.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rexyan/warehouse/master/202308061018957.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rexyan/warehouse/master/202308061027915.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rexyan/warehouse/master/202308082155084.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rexyan/warehouse/master/202308142134038.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rexyan/warehouse/master/202308152148145.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rexyan/warehouse/master/202308152147814.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rexyan/warehouse/master/202308152153139.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rexyan/warehouse/master/202308191015329.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rexyan/warehouse/master/202308191252346.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rexyan/warehouse/master/202308192143378.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rexyan/warehouse/master/202308212055921.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rexyan/warehouse/master/202308232117401.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rexyan/warehouse/master/202308232138776.png">
<meta property="og:updated_time" content="2025-10-31T03:20:39.382Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="100 Go Mistakes">
<meta name="twitter:description" content="æ‘˜è¦ã€Š100 Go Mistakes and How to Avoid Themã€‹ä¸€æœ¬å…³äº Go è¯­è¨€ä¸­å¸¸è§é”™è¯¯çš„ä¹¦ç±ï¼Œåœ¨äºä»‹ç»å’Œè®©æˆ‘ä»¬ä¸å†é™·å…¥è¿™äº›é™·é˜±å½“ä¸­ã€‚ä¹¦ 2022 å¹´ 8æœˆå‡ºç‰ˆï¼Œå›½å†…ç›®å‰è¿˜æ²¡æœ‰ä¸­æ–‡ç‰ˆæœ¬ï¼ŒèŠ±äº†å‡ å‘¨çš„åœ°é“æ—¶é—´ï¼Œç»ˆäºé™†é™†ç»­ç»­çœ‹å®Œäº†ã€‚ æ¶‰åŠçš„ä»£ç ä»“åº“ï¼šhttps://github.com/rexyan/100-Go-Mistakes">
<meta name="twitter:image" content="https://raw.githubusercontent.com/rexyan/warehouse/master/202308032150361.png">

<link rel="canonical" href="https://rexyan.github.io/2023/08/02/100 Go Mistakes/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>100 Go Mistakes | æ˜Ÿå°˜</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

  
  <link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/lxgwwenkaiscreen.css" />
  <!-- è‡ªå®šä¹‰ä¸ºéœé¹œæ–‡æ¥·å­—ä½“ -->
  <style>
	  body,div.post-body,h1,h2,h3,h4 {
		font-family: "LXGW WenKai Screen", sans-serif;
		font-size: 104%;
	  }
  </style>
  
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">æ˜Ÿå°˜</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>å½’æ¡£</a>

  </li>
        <li class="menu-item menu-item-è¯»ä¹¦">

    <a href="/books/" rel="section"><i class="address-book fa-fw"></i>è¯»ä¹¦</a>

  </li>
        <li class="menu-item menu-item-çæ‰¯">

    <a href="/crap/" rel="section"><i class="crap fa-fw"></i>çæ‰¯</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user fa-fw"></i>å…³äº</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



<script src="https://cdn.jsdelivr.net/npm/echarts@4.8.0/dist/echarts.min.js"></script>

<meta name="referrer" content="never">




  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://rexyan.github.io/2023/08/02/100 Go Mistakes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/rexyan/warehouse/master/20230809141242.jpg">
      <meta itemprop="name" content="Rex">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ˜Ÿå°˜">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          100 Go Mistakes
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2023-08-02 23:04:57" itemprop="dateCreated datePublished" datetime="2023-08-02T23:04:57+00:00">2023-08-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-10-31 03:20:39" itemprop="dateModified" datetime="2025-10-31T03:20:39+00:00">2025-10-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Go/" itemprop="url" rel="index"><span itemprop="name">Go</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/é˜…è¯»/" itemprop="url" rel="index"><span itemprop="name">é˜…è¯»</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="é˜…è¯»æ¬¡æ•°" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="eye"></i>
              </span>
              <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h3 id="æ‘˜è¦"><a href="#æ‘˜è¦" class="headerlink" title="æ‘˜è¦"></a>æ‘˜è¦</h3><p><a href="https://www.manning.com/books/100-go-mistakes-and-how-to-avoid-them" target="_blank" rel="noopener">ã€Š100 Go Mistakes and How to Avoid Themã€‹</a>ä¸€æœ¬å…³äº Go è¯­è¨€ä¸­å¸¸è§é”™è¯¯çš„ä¹¦ç±ï¼Œåœ¨äºä»‹ç»å’Œè®©æˆ‘ä»¬ä¸å†é™·å…¥è¿™äº›é™·é˜±å½“ä¸­ã€‚ä¹¦ 2022 å¹´ 8æœˆå‡ºç‰ˆï¼Œå›½å†…ç›®å‰è¿˜æ²¡æœ‰ä¸­æ–‡ç‰ˆæœ¬ï¼ŒèŠ±äº†å‡ å‘¨çš„åœ°é“æ—¶é—´ï¼Œç»ˆäºé™†é™†ç»­ç»­çœ‹å®Œäº†ã€‚</p>
<p>æ¶‰åŠçš„ä»£ç ä»“åº“ï¼š<a href="https://github.com/rexyan/100-Go-Mistakes" target="_blank" rel="noopener">https://github.com/rexyan/100-Go-Mistakes</a></p>
<a id="more"></a>
<h3 id="å˜é‡å±è”½"><a href="#å˜é‡å±è”½" class="headerlink" title="å˜é‡å±è”½"></a>å˜é‡å±è”½</h3><p>åœ¨ Go è¯­è¨€ä¸­ï¼Œå—ä½œç”¨åŸŸå†…å£°æ˜çš„å˜é‡åå¯ä»¥åœ¨å†…éƒ¨å—ä¸­é‡æ–°å£°æ˜ã€‚è¿™ä¸ªåŸåˆ™è¢«ç§°ä¸ºå˜é‡å±è”½ï¼Œå®¹æ˜“å‡ºç°å¸¸è§çš„é”™è¯¯ã€‚</p>
<p><strong>âŒé”™è¯¯ä»£ç </strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> client *http.Client                          â¶ å£°æ˜ä¸€ä¸ª client å˜é‡</span><br><span class="line"><span class="keyword">if</span> tracing &#123;</span><br><span class="line">    client, err := createClientWithTracing()     â· å˜é‡è¢«å±è”½</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    log.Println(client)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    client, err := createDefaultClient()         â¸ å˜é‡è¢«å±è”½</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    log.Println(client)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Use client</span></span><br><span class="line">fmt.Println(client)  <span class="comment">// nil</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬é¦–å…ˆå£°æ˜ä¸€ä¸ªclientå˜é‡ã€‚ç„¶åï¼Œæˆ‘ä»¬åœ¨ä¸¤ä¸ªå†…éƒ¨å—ä¸­ä½¿ç”¨çŸ­å˜é‡å£°æ˜è¿ç®—ç¬¦ï¼ˆ:=ï¼‰å°†å‡½æ•°è°ƒç”¨çš„ç»“æœåˆ†é…ç»™å†…éƒ¨clientå˜é‡ï¼Œè€Œä¸æ˜¯å¤–éƒ¨å˜é‡ã€‚å› æ­¤ï¼Œå¤–éƒ¨å˜é‡å§‹ç»ˆä¸ºnilã€‚</p>
<p><strong>âœ…æ­£ç¡®ä»£ç </strong></p>
<p>æ­£ç¡®å†™æ³•1</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> client *http.Client</span><br><span class="line"><span class="keyword">if</span> tracing &#123;</span><br><span class="line">    c, err := createClientWithTracing()    â¶ åˆ›å»ºä¸€ä¸ªä¸´æ—¶å˜é‡ c</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    client = c                             â· å°† c åˆ†é…ç»™ client</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Same logic</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­£ç¡®å†™æ³•2ï¼šæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†ç»“æœèµ‹å€¼ç»™ client, è€Œä¸æ˜¯å…ˆåˆ†é…ç»™ä¸€ä¸ªä¸´æ—¶å˜é‡</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> client *http.Client</span><br><span class="line"><span class="keyword">var</span> err error                                  â¶ å£°æ˜ client å’Œ err</span><br><span class="line"><span class="keyword">if</span> tracing &#123;</span><br><span class="line">    client, err = createClientWithTracing()    â· å°†è¿”å›å€¼èµ‹ç»™ client å’Œ err</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Same logic</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ğŸ¡æ€»ç»“</strong></p>
<p>å˜é‡å±è”½æ˜¯æŒ‡åœ¨å†…éƒ¨å—ä¸­é‡æ–°å£°æ˜å˜é‡åï¼Œä½†æˆ‘ä»¬å·²ç»å‘ç°è¿™ç§åšæ³•å®¹æ˜“å‡ºé”™ã€‚ç¦æ­¢å±è”½å˜é‡çš„åšæ³•å–å†³äºä¸ªäººå£å‘³ã€‚ä¾‹å¦‚ï¼Œæœ‰æ—¶é‡ç”¨ç°æœ‰çš„å˜é‡åï¼ˆå¦‚é”™è¯¯ï¼‰å¯ä»¥æ›´æ–¹ä¾¿ã€‚</p>
<h3 id="ä¸å¿…è¦çš„åµŒå¥—"><a href="#ä¸å¿…è¦çš„åµŒå¥—" class="headerlink" title="ä¸å¿…è¦çš„åµŒå¥—"></a>ä¸å¿…è¦çš„åµŒå¥—</h3><p><strong>âŒé”™è¯¯ä»£ç </strong></p>
<p>join å‡½æ•°æ‹¼æ¥ä¸¤ä¸ªå­—ç¬¦ä¸²å¹¶åœ¨é•¿åº¦å¤§äº max æ—¶è¿”å›å­ä¸²ã€‚åŒæ—¶ï¼Œå®ƒè¿˜æ ¡éªŒ s1 å’Œ s2 å‚æ•°ï¼Œä»¥åŠæ‹¼æ¥è°ƒç”¨æ˜¯å¦è¿”å›é”™è¯¯ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">join</span><span class="params">(s1, s2 <span class="keyword">string</span>, max <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> s1 == <span class="string">""</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>, errors.New(<span class="string">"s1 is empty"</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> s2 == <span class="string">""</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">""</span>, errors.New(<span class="string">"s2 is empty"</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            concat, err := concatenate(s1, s2)     â¶ è°ƒç”¨ä¸€ä¸ªå‡½æ•°æ¥è¿›è¡Œè¿æ¥æ“ä½œï¼Œä½†å¯èƒ½è¿”å›é”™è¯¯ã€‚</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">""</span>, err</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(concat) &gt; max &#123;</span><br><span class="line">                    <span class="keyword">return</span> concat[:max], <span class="literal">nil</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> concat, <span class="literal">nil</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">concatenate</span><span class="params">(s1 <span class="keyword">string</span>, s2 <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»å®ç°çš„è§’åº¦æ¥çœ‹ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯æ­£ç¡®çš„ã€‚ä½†æ˜¯åµŒå¥—çš„å±‚çº§å´å¾ˆå¤šã€‚</p>
<p><strong>âœ…æ­£ç¡®ä»£ç </strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">join</span><span class="params">(s1, s2 <span class="keyword">string</span>, max <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> s1 == <span class="string">""</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>, errors.New(<span class="string">"s1 is empty"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> s2 == <span class="string">""</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>, errors.New(<span class="string">"s2 is empty"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    concat, err := concatenate(s1, s2)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(concat) &gt; max &#123;</span><br><span class="line">        <span class="keyword">return</span> concat[:max], <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> concat, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">concatenate</span><span class="params">(s1 <span class="keyword">string</span>, s2 <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ğŸ¡æ€»ç»“</strong></p>
<p>ä¸åº”è¯¥è¿™æ ·å†™</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> foo() &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è€Œåº”è¯¥è¿™æ ·å†™</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> foo() &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ... çœç•¥ else</span></span><br></pre></td></tr></table></figure>
<p>åŒç†ä¸åº”è¯¥è¿™æ ·å†™</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> s != <span class="string">""</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> errors.New(<span class="string">"empty string"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è€Œåº”è¯¥è¿™ä¹ˆå†™</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> s == <span class="string">""</span> &#123;                        </span><br><span class="line">    <span class="keyword">return</span> errors.New(<span class="string">"empty string"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<h3 id="æ»¥ç”¨-init"><a href="#æ»¥ç”¨-init" class="headerlink" title="æ»¥ç”¨ init"></a>æ»¥ç”¨ init</h3><p>ä¸€ä¸ªinitå‡½æ•°æ˜¯ç”¨æ¥åˆå§‹åŒ–åº”ç”¨ç¨‹åºçŠ¶æ€çš„å‡½æ•°ã€‚å®ƒä¸å¸¦ä»»ä½•å‚æ•°ï¼Œä¹Ÿä¸è¿”å›ç»“æœï¼ˆä¸€ä¸ª func() å‡½æ•°ï¼‰ã€‚å½“ä¸€ä¸ªåŒ…è¢«åˆå§‹åŒ–æ—¶ï¼ŒåŒ…ä¸­çš„æ‰€æœ‰å¸¸é‡å’Œå˜é‡å£°æ˜éƒ½ä¼šè¢«è®¡ç®—ã€‚ç„¶åï¼Œinitå‡½æ•°ä¼šè¢«æ‰§è¡Œã€‚ä¾‹å¦‚ä¸€ä¸‹ä»£ç ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">var</span> a = <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"var"</span>)        â¶ ç¬¬ä¸€ä¸ªæ‰“å°</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;()</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"init"</span>)       â· ç¬¬äºŒä¸ªæ‰“å°</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"main"</span>)       â¸ ç¬¬ä¸‰ä¸ªæ‰“å°</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¾‹å¦‚ä»¥ä¸‹ä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº† main åŒ…ï¼Œåˆåœ¨ main åŒ…ä¸­å¼•ç”¨äº† redis åŒ…ï¼Œå¦‚æœ redis åŒ…ä¸­å­˜åœ¨ init å‡½æ•°ï¼Œé‚£ä¹ˆå°±ä¼šå…ˆæ‰§è¡Œ redis åŒ…ä¸­çš„ initï¼Œç„¶åå†æ‰§è¡Œ main åŒ…ä¸­çš„ initã€‚æœ€ååœ¨æ‰§è¡Œ main å‡½æ•°æœ¬èº«ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line"> </span><br><span class="line">    <span class="string">"redis"</span></span><br><span class="line">)</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    err := redis.Store(<span class="string">"foo"</span>, <span class="string">"bar"</span>)</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥ä¸ºæ¯ä¸ªåŒ…å®šä¹‰å¤šä¸ª init å‡½æ•°ã€‚å½“å­˜åœ¨å¤šä¸ª init å‡½æ•°æ—¶ï¼ŒåŒ…ä¸­æ¯ä¸ª init å‡½æ•°çš„æ‰§è¡Œé¡ºåºå–å†³äºæºæ–‡ä»¶çš„å­—æ¯é¡ºåºã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªåŒ…åŒ…å« a.go å’Œ b.go æ–‡ä»¶ï¼Œå¹¶ä¸”ä¸¤ä¸ªæ–‡ä»¶éƒ½æœ‰ init å‡½æ•°ï¼Œåˆ™ a.go æ–‡ä»¶çš„ init å‡½æ•°é¦–å…ˆè¢«æ‰§è¡Œã€‚</p>
<p>ä½†é—®é¢˜å°±å‡ºåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æœ‰æ—¶ä¼šä¾èµ–åŒä¸€ä¸ªåŒ…å†…çš„å¤šä¸ª init çš„æ‰§è¡Œé¡ºåºã€‚è¿™æ ·åšå¯èƒ½æ˜¯å±é™©çš„ï¼Œå› ä¸ºæºæ–‡ä»¶å¯èƒ½ä¼šè¢«é‡å‘½åï¼Œä»è€Œæ½œåœ¨åœ°å½±å“æ‰§è¡Œé¡ºåºã€‚</p>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨åŒä¸€æºæ–‡ä»¶ä¸­å®šä¹‰å¤šä¸ªinitå‡½æ•°</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;               â¶ ç¬¬ä¸€ä¸ªåˆå§‹åŒ–å‡½æ•°</span><br><span class="line">    fmt.Println(<span class="string">"init 1"</span>)</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;               â· ç¬¬äºŒä¸ªåˆå§‹åŒ–å‡½æ•°</span><br><span class="line">    fmt.Println(<span class="string">"init 2"</span>)</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">init 1</span></span><br><span class="line"><span class="comment">init 2</span></span><br><span class="line"><span class="comment">**/</span></span><br></pre></td></tr></table></figure>
<p>æœ‰æ—¶ï¼Œæˆ‘ä»¬å¹¶ä¸ä¾èµ–åŒ…çš„ä¸­çš„æŸä¸ªå‡½æ•°ï¼Œä½†æ˜¯éœ€è¦è¿›è¡Œåˆå§‹åŒ–è¿™ä¸ªåŒ…ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ _ æ“ä½œç¬¦æ¥åšåˆ°ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line"> </span><br><span class="line">    _ <span class="string">"foo"</span>    â¶ fooåŒ…åœ¨mainå‡½æ•°ä¹‹å‰åˆå§‹åŒ–ã€‚å› æ­¤ï¼Œä¼šæ‰§è¡Œfooçš„initå‡½æ•°</span><br><span class="line">)</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦ä¸€æ–¹é¢ï¼Œinit å‡½æ•°å®ƒä¸èƒ½å¤Ÿç›´æ¥è¢«è°ƒç”¨ï¼Œå°±å¦‚ä»¥ä¸‹çš„ä¾‹å­ä¸€æ ·ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    init()       â¶ æ— æ•ˆè°ƒç”¨</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿˜æœ‰ä¸€äº›åœºæ™¯ä¸‹ä¸é€‚åˆä½¿ç”¨ init å‡½æ•°ï¼Œä¾‹å¦‚ï¼šåœ¨ç¤ºä¾‹çš„ init å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ sql.Open æ‰“å¼€ä¸€ä¸ªæ•°æ®åº“ã€‚å°†æ­¤æ•°æ®åº“ä½œä¸ºå…¨å±€å˜é‡ä½¿å…¶ä»–å‡½æ•°å¯ä»¥ç¨åä½¿ç”¨ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> db *sql.DB</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    dataSourceName := os.Getenv(<span class="string">"MYSQL_DATA_SOURCE_NAME"</span>)  </span><br><span class="line">    d, err := sql.Open(<span class="string">"mysql"</span>, dataSourceName)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Panic(err)</span><br><span class="line">    &#125;</span><br><span class="line">    err = d.Ping()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Panic(err)</span><br><span class="line">    &#125;</span><br><span class="line">    db = d      â¶ å°† DB è¿æ¥åˆ†é…ç»™å…¨å±€çš„ db å˜é‡</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆï¼Œåœ¨ init å‡½æ•°ä¸­çš„é”™è¯¯ç®¡ç†æ˜¯å—é™çš„ã€‚ç”±äº init å‡½æ•°ä¸è¿”å›é”™è¯¯ï¼Œè¦å‘å‡ºé”™è¯¯ä¿¡å·çš„å”¯ä¸€æ–¹æ³•ä¹‹ä¸€æ˜¯ä½¿ç”¨ panicï¼Œä½¿åº”ç”¨ç¨‹åºåœæ­¢ã€‚å…¶æ¬¡ï¼Œå¦ä¸€ä¸ªé‡è¦çš„ç¼ºç‚¹ä¸æµ‹è¯•æœ‰å…³ã€‚å¦‚æœæˆ‘ä»¬å‘è¯¥æ–‡ä»¶æ·»åŠ æµ‹è¯•ï¼Œé‚£ä¹ˆinitå‡½æ•°å°†åœ¨è¿è¡Œæµ‹è¯•ç”¨ä¾‹ä¹‹å‰æ‰§è¡Œï¼Œè¿™å¯èƒ½ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œå› ä¸ºæˆ‘ä»¬å¯èƒ½å°±æ˜¯è¦æµ‹è¯• init ä¸­è¿æ¥ã€‚æœ€åä¸€ä¸ªç¼ºç‚¹æ˜¯ç¤ºä¾‹å°†æ•°æ®åº“è¿æ¥æ± åˆ†é…ç»™å…¨å±€å˜é‡ï¼Œå…¨å±€å˜é‡çš„åå¤„å°±æ˜¯ä»»ä½•åŒ…å†…çš„å‡½æ•°éƒ½å¯ä»¥ä¿®æ”¹è¿™ä¸ªå…¨å±€å˜é‡ï¼Œå¹¶ä¸”å¯èƒ½ä¼šå¯¼è‡´å…¨å±€å˜é‡çš„æµ‹è¯•å˜å¾—å¤æ‚ï¼Œå› ä¸ºå…¨å±€å˜é‡æ²¡æœ‰äº†éš”ç¦»æ€§ã€‚</p>
<p>æ‰€ä»¥ï¼Œæ•°æ®åº“åˆå§‹åŒ–ï¼Œå¹¶ä¸åˆé€‚åœ¨ init ä¸­è¿›è¡Œã€‚æ•°æ®åº“çš„åˆå§‹åŒ–åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ä¸€ä¸ªå˜é‡å°†å…¶å°è£…èµ·æ¥ï¼Œè€Œä¸æ˜¯è®©å®ƒæˆä¸ºå…¨å±€å˜é‡ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createClient</span><span class="params">(dsn <span class="keyword">string</span>)</span> <span class="params">(*sql.DB, error)</span></span> &#123;    â¶ æ¥å—ä¸€ä¸ªæ•°æ®æºåç§°å¹¶è¿”å› *sql.DB å’Œé”™è¯¯</span><br><span class="line">    db, err := sql.Open(<span class="string">"mysql"</span>, dsn)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err                             â· è¿”å›é”™è¯¯</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err = db.Ping(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> db, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æ­¤å°è£…ï¼Œå°±è§£å†³äº†ä½¿ç”¨ init å¸¦æ¥çš„ç¼ºç‚¹äº†ï¼Œé”™è¯¯å¤„ç†çš„è´£ä»»ç”±è°ƒç”¨è€…æ‰¿æ‹…ï¼Œè¿˜å¯ä»¥åˆ›å»ºé›†æˆæµ‹è¯•æ¥æ£€æŸ¥è¿™ä¸ªå‡½æ•°æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Œå¹¶ä¸”è¿æ¥æ± è¢«å°è£…åœ¨å‡½æ•°å†…éƒ¨ã€‚</p>
<p><strong>âŒé”™è¯¯ä»£ç </strong></p>
<ol>
<li>åŒä¸€ä¸ªåŒ…ä¸­å­˜åœ¨å¤šä¸ª initï¼Œæˆ‘ä»¬å¾ˆä¾èµ– init çš„æ‰§è¡Œé¡ºåºï¼ˆè¿™ç§æƒ…å†µä¸‹ init çš„æ‰§è¡Œé¡ºåºå’Œæºæ–‡ä»¶çš„å­—æ¯é¡ºåºæœ‰å…³ï¼‰ä½†æ˜¯è¿™ç§é¡ºåºä¸èƒ½è¢«ä¿è¯ï¼Œå¾ˆå®¹æ˜“å°±ä¼šè¢«ä¿®æ”¹äº†ã€‚</li>
<li>ç›´æ¥è°ƒç”¨ init å‡½æ•°</li>
</ol>
<p><strong>âœ…æ­£ç¡®ä»£ç </strong></p>
<ol>
<li>ä¸åº”è¯¥ä¾èµ–åŒä¸€ä¸ªåŒ…å†…çš„å¤šä¸ª init çš„æ‰§è¡Œé¡ºåº</li>
<li>å¦‚æœåªæƒ³åˆå§‹åŒ–å¦ä¸€ä¸ªåŒ…ï¼Œå¯ä»¥ä½¿ç”¨ _ æ“ä½œç¬¦</li>
<li>ä¸åº”è¯¥ç›´æ¥è°ƒç”¨ init å‡½æ•°</li>
<li>å› ä¸º init ä¸èƒ½å¾ˆå¥½çš„å¤„ç†é”™è¯¯ï¼Œé‡Œé¢å¯ä»¥ä½¿ç”¨ panicï¼Œä½†æ˜¯é™¤éæ˜¯è‡´å‘½çš„é”™è¯¯ï¼Œå¦åˆ™ä½¿ç”¨ä¼šé€ æˆç¨‹åºè¿è¡Œä¸­æ–­</li>
<li>ä¸å»ºè®®åœ¨ init ä¸­è·å–æ•°æ®åº“çš„è¿æ¥ï¼Œå¹¶å°†è¿æ¥å¯¹è±¡è®¾ç½®ä¸€ä¸ªå…¨å±€å˜é‡</li>
</ol>
<h3 id="è¿‡åº¦ä½¿ç”¨-getter-å’Œ-setter"><a href="#è¿‡åº¦ä½¿ç”¨-getter-å’Œ-setter" class="headerlink" title="è¿‡åº¦ä½¿ç”¨ getter å’Œ setter"></a>è¿‡åº¦ä½¿ç”¨ getter å’Œ setter</h3><p>åœ¨ç¼–ç¨‹ä¸­ï¼Œæ•°æ®å°è£…å¾€å¾€æ˜¯ä¸ºäº†éšè—å¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ã€‚getters å’Œ setters å°±æ˜¯æä¾›ä¿®æ”¹/è·å–å†…éƒ¨å¯¹è±¡å­—æ®µçš„å¯¼å‡ºå‡½æ•°ã€‚åœ¨Goè¯­è¨€ä¸­ï¼Œå¹¶æ²¡æœ‰æ˜ç¡®çš„é™åˆ¶å¿…é¡»è¦é€šè¿‡ getters and setters å»è·å–æ•°æ®ã€‚æ¯”å¦‚ time æ ‡å‡†åº“ä¸­æœ‰ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">timer := time.NewTimer(time.Second)</span><br><span class="line">&lt;-timer.C</span><br></pre></td></tr></table></figure>
<p>ä½ å¯ä»¥ç›´æ¥ä¿®æ”¹Cå˜é‡ã€‚</p>
<p><strong>âŒé”™è¯¯ä»£ç </strong></p>
<p>åœ¨ go ä¸­å¼ºæ±‚ä½¿ç”¨ Getter å’Œ Setterã€‚</p>
<p><strong>âœ…æ­£ç¡®ä»£ç </strong></p>
<p>åœ¨ go ä¸­ä¸å¼ºæ±‚ä½¿ç”¨ getter å’Œ setterã€‚ä½†æ˜¯å½“æˆ‘ä»¬ï¼Œè¦ä½¿ç”¨ getter å’Œ setter çš„æ—¶å€™ï¼Œå‡è®¾æ˜¯ä¸€ä¸ªåä¸º balance çš„å­—æ®µï¼Œæˆ‘ä»¬åº”è¯¥éµå¾ªè¿™äº›å‘½åæƒ¯ä¾‹ï¼š</p>
<ol>
<li>Getter æ–¹æ³•çš„åç§°åº”è¯¥ä¸º Balanceï¼ˆè€Œä¸æ˜¯ GetBalanceï¼‰</li>
<li>Setter æ–¹æ³•åº”è¯¥è¢«å‘½åä¸º SetBalance</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">currentBalance := customer.Balance()     â¶ getter</span><br><span class="line"><span class="keyword">if</span> currentBalance &lt; <span class="number">0</span> &#123;</span><br><span class="line">    customer.SetBalance(<span class="number">0</span>)               â· setter</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ¥å£æ±¡æŸ“"><a href="#æ¥å£æ±¡æŸ“" class="headerlink" title="æ¥å£æ±¡æŸ“"></a>æ¥å£æ±¡æŸ“</h3><h4 id="æ¥å£æ¦‚å¿µ"><a href="#æ¥å£æ¦‚å¿µ" class="headerlink" title="æ¥å£æ¦‚å¿µ"></a>æ¥å£æ¦‚å¿µ</h4><p>Go æ¥å£çš„ä¸åŒä¹‹å¤„åœ¨äºå®ƒä»¬æ˜¯éšå¼æ»¡è¶³çš„ã€‚æ²¡æœ‰åƒ implements è¿™æ ·çš„å…³é”®å­—æ¥æ ‡è®°ä¸€ä¸ªå¯¹è±¡Xå®ç°äº†æ¥å£Yã€‚æˆ‘ä»¬å¯ä»¥æ‹¿æ ‡å‡†åº“ä¸­çš„ä¾‹å­ï¼š<code>io.Reader</code>å’Œ<code>io.Writer</code>ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span> &#123;</span><br><span class="line">    Read(p []<span class="keyword">byte</span>) (n <span class="keyword">int</span>, err error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Writer <span class="keyword">interface</span> &#123;</span><br><span class="line">    Write(p []<span class="keyword">byte</span>) (n <span class="keyword">int</span>, err error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‡è®¾æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªå‡½æ•°ï¼Œå…¶ç›®çš„æ˜¯å°†ä¸€ä¸ªæ–‡ä»¶å†…å®¹å¤åˆ¶åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ã€‚æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªç‰¹å®šçš„å‡½æ•°ï¼Œè¯¥å‡½æ•°å°†ä»¥ä¸¤ä¸ª <code>*os.Files</code> ä½œä¸ºè¾“å…¥ã€‚æˆ–è€…ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä½¿ç”¨ io.Reader å’Œ io.Writer æŠ½è±¡æ¥åˆ›å»ºæ›´é€šç”¨çš„å‡½æ•°ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">copySourceToDest</span><span class="params">(source io.Reader, dest io.Writer)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‡½æ•°å¯ä»¥ä½¿ç”¨<code>*os.File</code>å‚æ•°ï¼ˆå› ä¸º<code>*os.File</code>å®ç°äº†io.Readerå’Œio.Writerï¼‰ï¼Œä»¥åŠä»»ä½•å®ç°è¿™äº›æ¥å£çš„å…¶ä»–ç±»å‹ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºè‡ªå·±çš„io.Writerï¼Œå°†æ•°æ®å†™å…¥æ•°æ®åº“ï¼Œè€Œä»£ç ä¹Ÿå°†ä¿æŒä¸å˜ã€‚è¿™å¢åŠ äº†å‡½æ•°çš„é€šç”¨æ€§ï¼Œå› æ­¤æé«˜äº†å®ƒçš„å¯é‡ç”¨æ€§ã€‚</p>
<p>å¦å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å°†ç»†ç²’åº¦çš„æ¥å£ç»„åˆåœ¨ä¸€èµ·ï¼Œä»¥åˆ›å»ºæ›´é«˜çº§åˆ«çš„æŠ½è±¡ã€‚è¿™å°±æ˜¯io.ReadWriterçš„æƒ…å†µï¼Œå®ƒç»“åˆäº†è¯»å–å™¨å’Œå†™å…¥å™¨çš„è¡Œä¸ºï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ReadWriter <span class="keyword">interface</span> &#123;</span><br><span class="line">    Reader</span><br><span class="line">    Writer</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ä»€ä¹ˆæ—¶å€™ä½¿ç”¨æ¥å£"><a href="#ä»€ä¹ˆæ—¶å€™ä½¿ç”¨æ¥å£" class="headerlink" title="ä»€ä¹ˆæ—¶å€™ä½¿ç”¨æ¥å£"></a>ä»€ä¹ˆæ—¶å€™ä½¿ç”¨æ¥å£</h4><p><strong>é€šç”¨çš„è¡Œä¸º</strong></p>
<p>åœ¨sortåŒ…ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°æ•°åç§å®ç°ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨æŸä¸ªæ—¶åˆ»è®¡ç®—ä¸€ç»„æ•´æ•°ï¼Œæƒ³è¦å°†å®ƒä»¬æ’åºï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸€å®šå¯¹å®ç°ç±»å‹æ„Ÿå…´è¶£å—ï¼Ÿæ’åºç®—æ³•æ˜¯å½’å¹¶æ’åºè¿˜æ˜¯å¿«é€Ÿæ’åºå¾ˆé‡è¦å—ï¼Ÿåœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¹¶ä¸å…³å¿ƒã€‚å› æ­¤ï¼Œæ’åºè¡Œä¸ºå¯ä»¥è¢«æŠ½è±¡å‡ºæ¥ï¼Œæˆ‘ä»¬å¯ä»¥ä¾èµ–sort.Interfaceã€‚ä¾‹å¦‚ sort åŒ… ä¸­çš„ Interface æ¥å£ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Interface <span class="keyword">interface</span> &#123;</span><br><span class="line">    Len() <span class="keyword">int</span>               â¶ è·å–å…ƒç´ æ•°é‡</span><br><span class="line">    Less(i, j <span class="keyword">int</span>) <span class="keyword">bool</span>     â· æ£€æŸ¥ä¸¤ä¸ªå…ƒç´ </span><br><span class="line">    Swap(i, j <span class="keyword">int</span>)          â¸ äº¤æ¢ä¸¤ä¸ªå…ƒç´ </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ£€æŸ¥ä¸€ä¸ªé›†åˆæ˜¯å¦å·²ç»æ’åºï¼Œå°±å¯ä»¥ç”¨ä¸Šä¸Šé¢çš„æ¥å£ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">IsSorted</span><span class="params">(data Interface)</span> <span class="title">bool</span></span> &#123;  <span class="comment">// ä¼ å…¥ å®ç°äº†æ¥å£çš„ data</span></span><br><span class="line">    n := data.Len()                   <span class="comment">// è·å–å…ƒç´ æ•°é‡</span></span><br><span class="line">    <span class="keyword">for</span> i := n - <span class="number">1</span>; i &gt; <span class="number">0</span>; i-- &#123;</span><br><span class="line">        <span class="keyword">if</span> data.Less(i, i<span class="number">-1</span>) &#123;        <span class="comment">// æ£€æŸ¥ä¸¤ä¸ªå…ƒç´ </span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>è§£è€¦</strong></p>
<p>è§£è€¦çš„ä¸€ä¸ªå¥½å¤„å¯ä»¥ä¸å•å…ƒæµ‹è¯•ç›¸å…³ã€‚å‡è®¾æˆ‘ä»¬æƒ³å®ç°ä¸€ä¸ªåä¸º CreateNewCustomer çš„æ–¹æ³•ï¼Œç”¨äºåˆ›å»ºå¹¶å­˜å‚¨ä¸€ä¸ªæ–°å®¢æˆ·ï¼Œä¸è§£è€¦çš„æƒ…å†µä¸‹, æˆ‘ä»¬å¯èƒ½ä¼šè¿™ä¹ˆå®ç°ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> CustomerService <span class="keyword">struct</span> &#123;</span><br><span class="line">    store mysql.Store          â¶ å…·ä½“çš„å®ç°</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cs CustomerService)</span> <span class="title">CreateNewCustomer</span><span class="params">(id <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    customer := Customer&#123;id: id&#125;</span><br><span class="line">    <span class="keyword">return</span> cs.store.StoreCustomer(customer)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæˆ‘ä»¬æƒ³è¦æµ‹è¯•è¿™ä¸ªæ–¹æ³•æ€ä¹ˆåŠï¼Ÿå› ä¸º CustomerService ä¾èµ–äºå®é™…çš„å®ç° mysql æ¥å­˜å‚¨å®¢æˆ·ï¼Œæˆ‘ä»¬è¢«è¿«é€šè¿‡é›†æˆæµ‹è¯•æ¥è¿›è¡Œæµ‹è¯•ï¼Œè¿™éœ€è¦å¯åŠ¨ä¸€ä¸ª MySQL å®ä¾‹ã€‚é‚£å¦‚æœæˆ‘ä»¬è§£è€¦å‘¢ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> customerStorer <span class="keyword">interface</span> &#123;      â¶ åˆ›å»ºä¸€ä¸ªå­˜å‚¨çš„æŠ½è±¡æ¥å£ï¼Œé‡Œé¢æœ‰ä¸ª StoreCustomer æ–¹æ³•</span><br><span class="line">    StoreCustomer(Customer) error</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">type</span> CustomerService <span class="keyword">struct</span> &#123;</span><br><span class="line">    storer customerStorer            â· å°†CustomerServiceä¸å®é™…å®ç°åˆ†ç¦»</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cs CustomerService)</span> <span class="title">CreateNewCustomer</span><span class="params">(id <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    customer := Customer&#123;id: id&#125;</span><br><span class="line">    <span class="keyword">return</span> cs.storer.StoreCustomer(customer)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨å­˜å‚¨å®¢æˆ·æ˜¯é€šè¿‡æ¥å£å®Œæˆçš„ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬åœ¨æµ‹è¯•è¯¥æ–¹æ³•æ—¶å…·æœ‰æ›´å¤šçš„çµæ´»æ€§ã€‚å¯ä»¥é€šé›†æˆæµ‹è¯•ï¼Œæˆ–è€…é€šè¿‡å•å…ƒæµ‹è¯•ä½¿ç”¨æ¨¡æ‹Ÿå¯¹è±¡ã€‚</p>
<p><strong>é™åˆ¶è¡Œä¸º</strong></p>
<p>å‡è®¾æˆ‘ä»¬ç°åœ¨å·²ç»æœ‰äº†ä¸€ä¸ª IntConfig ç»“æ„ä½“ï¼Œå¹¶ä¸”è¿™ä¸ªç»“æ„ä½“æœ‰ä¸¤ä¸ªæ–¹æ³• Get å’Œ Setã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> IntConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *IntConfig)</span> <span class="title">Get</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="comment">// Retrieve configuration</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *IntConfig)</span> <span class="title">Set</span><span class="params">(value <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// Update configuration</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨æœ‰ä¸€ä¸ªéœ€æ±‚æ˜¯ä¸æ”¹åŠ¨ä¸Šé¢çš„ä»£ç ï¼Œè¦é˜»æ­¢è°ƒç”¨ Set æ–¹æ³•ï¼ˆå±è”½ï¼‰å¯¹ IntConfig è¿›è¡Œæ›´æ–°ã€‚è¿™æ—¶æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„æ¥å£ï¼Œé‡Œé¢åªæœ‰ä¸€ä¸ª Get æ–¹æ³•ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> intConfigGetter <span class="keyword">interface</span> &#123;</span><br><span class="line">    Get() <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·ï¼Œå°±æ˜¯ IntConfig å®ç°äº† intConfigGetter æ¥å£äº†ã€‚å¹¶ä¸”æˆ‘ä»¬åªæä¾›äº† Get æ–¹æ³•ã€‚åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·ä½¿ç”¨ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Foo <span class="keyword">struct</span> &#123;</span><br><span class="line">    threshold intConfigGetter   <span class="comment">// åªæœ‰ Get æ–¹æ³•çš„æ¥å£</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewFoo</span><span class="params">(threshold intConfigGetter)</span> <span class="title">Foo</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Foo&#123;threshold: threshold&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f Foo)</span> <span class="title">Bar</span><span class="params">()</span></span>  &#123;</span><br><span class="line">    threshold := f.threshold.Get()   <span class="comment">// åªèƒ½è°ƒç”¨ Get æ–¹æ³•</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="æ¥å£æ±¡æŸ“-1"><a href="#æ¥å£æ±¡æŸ“-1" class="headerlink" title="æ¥å£æ±¡æŸ“"></a>æ¥å£æ±¡æŸ“</h4><p>Interface æ±¡æŸ“åˆ™ä»£è¡¨äº†ä»£ç ä¸­å……æ–¥ç€æ— ç”¨çš„æŠ½è±¡ï¼Œéš¾ä»¥ç†è§£ã€‚</p>
<p>æ¥å£çš„ç›®çš„æ˜¯åˆ›å»ºæŠ½è±¡ã€‚å½“ç¼–ç¨‹é‡åˆ°æŠ½è±¡æ—¶ï¼Œä¸»è¦æ³¨æ„ç‚¹æ˜¯è¦è®°ä½æŠ½è±¡åº”è¯¥è¢«å‘ç°ï¼Œè€Œä¸æ˜¯è¢«åˆ›é€ ã€‚è¿™æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿè¿™æ„å‘³ç€å¦‚æœæ²¡æœ‰ç«‹å³éœ€è¦ï¼Œæˆ‘ä»¬ä¸åº”è¯¥åœ¨æˆ‘ä»¬çš„ä»£ç ä¸­å¼€å§‹åˆ›å»ºæŠ½è±¡ã€‚æˆ‘ä»¬ä¸åº”è¯¥ç”¨æ¥å£è¿›è¡Œè®¾è®¡ï¼Œè€Œåº”ç­‰å¾…å…·ä½“çš„éœ€æ±‚ã€‚æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬åº”è¯¥åœ¨éœ€è¦æ—¶åˆ›å»ºæ¥å£ï¼Œè€Œä¸æ˜¯åœ¨é¢„è§åˆ°å¯èƒ½éœ€è¦æ—¶åˆ›å»ºæ¥å£ã€‚</p>
<h3 id="æ¥å£åº”è¯¥åœ¨å“ªé‡Œ"><a href="#æ¥å£åº”è¯¥åœ¨å“ªé‡Œ" class="headerlink" title="æ¥å£åº”è¯¥åœ¨å“ªé‡Œ"></a>æ¥å£åº”è¯¥åœ¨å“ªé‡Œ</h3><p>æƒ…æ™¯1: æ¥å£åœ¨ç”Ÿäº§è€…ç«¯ â€” æ¥å£ä¸å…·ä½“å®ç°ä¸€åŒè¢«å®šä¹‰</p>
<p><img src="https://raw.githubusercontent.com/rexyan/warehouse/master/202308032150361.png" alt></p>
<p>æƒ…æ™¯2: æ¥å£åœ¨æ¶ˆè´¹è€…ç«¯ â€” æ¥å£æ˜¯åœ¨ä½¿ç”¨çš„åœ°æ–¹è¿›è¡Œå®šä¹‰çš„</p>
<p><img src="https://raw.githubusercontent.com/rexyan/warehouse/master/202308032151555.png" alt></p>
<p>åœ¨ C# æˆ–è€… Java ä¸­ï¼Œå¾ˆå¸¸è§çš„æ¨¡å¼æ˜¯æƒ…å¢ƒ1ã€‚ä½†æ˜¯åœ¨ Go ä¸­ï¼Œæˆ‘ä»¬è¿˜å¯èƒ½æˆ–è€…æ›´åº”è¯¥å­˜åœ¨æƒ…å¢ƒ2ï¼Œå› ä¸º Go è¯­è¨€çš„æ¥å£æ˜¯éšå¼æ»¡è¶³çš„ã€‚</p>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬æƒ³å®ç°ä¸€ä¸ªåŒ…æ¥è¿›è¡Œå®¢æˆ·çš„å­˜å‚¨å’ŒæŸ¥è¯¢ã€‚ä½†æ˜¯å‘¢ï¼Œè§„å®šæ‰€æœ‰çš„æ“ä½œéƒ½å¿…é¡»é€šè¿‡æ¥å£æ¥è¿›è¡Œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> store</span><br><span class="line"> </span><br><span class="line"><span class="keyword">type</span> CustomerStorage <span class="keyword">interface</span> &#123;</span><br><span class="line">    StoreCustomer(customer Customer) error</span><br><span class="line">    GetCustomer(id <span class="keyword">string</span>) (Customer, error)</span><br><span class="line">    UpdateCustomer(customer Customer) error</span><br><span class="line">    GetAllCustomers() ([]Customer, error)</span><br><span class="line">    GetCustomersWithoutContract() ([]Customer, error)</span><br><span class="line">    GetCustomersWithNegativeBalance() ([]Customer, error)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ‰€æœ‰å®¢æˆ·çš„æ“ä½œéƒ½ç»è¿‡æ¥å£æ¥è¿›è¡Œ</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœé‡‡ç”¨æƒ…æ™¯1ï¼Œé‚£ä¹ˆè¿™ä¹ˆæŠ½è±¡å’Œå®ç°éƒ½è¢«å®šä¹‰åœ¨äº†åˆ¶é€ è€…ç«¯ã€‚ä½†æ˜¯å¦‚å‰æ‰€è¿°ï¼ŒGo è¯­è¨€ä¸­çš„æ¥å£æ˜¯éšå¼æ»¡è¶³çš„ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åº”è¯¥å‘ç°æŠ½è±¡ï¼Œè€Œä¸æ˜¯åˆ›å»ºæŠ½è±¡ã€‚è¿™æ„å‘³ç€åˆ¶é€ è€…å¹¶ä¸éœ€è¦å¼ºåˆ¶ä¸ºæ‰€æœ‰å®¢æˆ·ç«¯æä¾›ç‰¹å®šçš„æŠ½è±¡ã€‚ç›¸åï¼Œå®¢æˆ·ç«¯éœ€è¦å†³å®šæ˜¯å¦éœ€è¦æŸç§å½¢å¼çš„æŠ½è±¡ï¼Œå¹¶ç¡®å®šå…¶éœ€è¦çš„æœ€ä½³æŠ½è±¡çº§åˆ«ã€‚</p>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬åªå¯¹ GetAllCustomers æ–¹æ³•æ„Ÿå…´è¶£ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå®¢æˆ·å¯ä»¥åˆ›å»ºä¸€ä¸ªä»…åŒ…å«å•ä¸ªæ–¹æ³•çš„æ¥å£ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> client</span><br><span class="line"> </span><br><span class="line"><span class="keyword">type</span> customersGetter <span class="keyword">interface</span> &#123;</span><br><span class="line">    GetAllCustomers() ([]store.Customer, error)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å®¢æˆ·ç«¯åŒ…é€šè¿‡åˆ›å»ºè‡ªå·±çš„æ¥å£æ¥å®šä¹‰æ‰€éœ€çš„æŠ½è±¡</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>customersGetter</code>åªåœ¨å†…éƒ¨ä½¿ç”¨ï¼Œæ‰€ä»¥å¯ä»¥ä¸å¯¼å‡º</li>
<li>å¾ˆå¤šäººä¼šè®¤ä¸ºä»–æœ‰å¾ªç¯ä¾èµ–ï¼Œå…¶å®å¹¶æ²¡æœ‰ï¼Œå› ä¸ºGoçš„interfaceæ˜¯éšå¼çš„ã€‚<br><img src="https://raw.githubusercontent.com/rexyan/warehouse/master/202308032202705.png" alt></li>
</ul>
<p>å› æ­¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæœ€å¥½çš„æ–¹æ³•æ˜¯åœ¨ç”Ÿäº§è€…ä¾§å…¬å¼€å…·ä½“å®ç°ï¼Œè®©å®¢æˆ·ç«¯å†³å®šå¦‚ä½•ä½¿ç”¨å®ƒä»¥åŠæ˜¯å¦éœ€è¦æŠ½è±¡ã€‚</p>
<p>ä½†æ˜¯åœ¨ Go ä¸­ï¼Œè™½ç„¶æˆ‘ä»¬æ¨èæƒ…æ™¯2 çš„å†™æ³•ï¼Œä½†ä¹Ÿå­˜åœ¨æƒ…å¢ƒ1 çš„æƒ…å†µï¼Œä¾‹å¦‚åœ¨æ ‡å‡†åº“ä¸­ã€‚<code>encoding</code>åŒ…å®šä¹‰äº†ä¸€äº›intefaceï¼Œè¢«å­åŒ…<code>encoding/json</code>ï¼Œ<code>encoding/binary</code>å®ç°ã€‚</p>
<h3 id="è¿”å›æ¥å£"><a href="#è¿”å›æ¥å£" class="headerlink" title="è¿”å›æ¥å£"></a>è¿”å›æ¥å£</h3><p>åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œåœ¨Goè¯­è¨€ä¸­è¿”å›æ¥å£è¢«è®¤ä¸ºæ˜¯ä¸€ç§ä¸è‰¯å®è·µã€‚ä¾‹å¦‚ä¸‹é¢ä»£ç ä¸­ï¼Œstore åŒ…è¿”å› client åŒ…ä¸­çš„ Store çš„æ¥å£ã€‚è¿™æ—¶ï¼Œstore åŒ…å°±ä¾èµ–äº client åŒ…ã€‚</p>
<p><img src="https://raw.githubusercontent.com/rexyan/warehouse/master/202308032218861.png" alt></p>
<p>åœ¨ store åŒ…ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå®ç°å­˜å‚¨æ¥å£çš„ InMemoryStore ç»“æ„ä½“ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªNewInMemoryStore å‡½æ•°æ¥è¿”å›ä¸€ä¸ª Store æ¥å£ã€‚è¿™æ—¶å°±å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œclient åŒ…ä¸èƒ½å†è°ƒç”¨NewInMemoryStore å‡½æ•°ï¼Œå¦åˆ™ä¼šé€ æˆå¾ªç¯ä¾èµ–ã€‚ä¸€ä¸ªå¯èƒ½çš„è§£å†³æ–¹æ¡ˆæ˜¯ä»å¦ä¸€ä¸ªåŒ…ä¸­è°ƒç”¨è¯¥å‡½æ•°ï¼Œå¹¶å‘ client åŒ… æ³¨å…¥ä¸€ä¸ªStoreå®ç°ã€‚ä½†è¿™æ ·çš„ä»£ç å°±ä¼šå¾ˆéš¾ç†è§£ã€‚æ‰€ä»¥ï¼Œç»“è®ºæ˜¯ï¼š</p>
<ul>
<li>ç”¨è¿”å›å…·ä½“å®ç°æ¥ä»£æ›¿ interface</li>
<li>å°½å¯èƒ½çš„æ¥æ”¶ interface å‚æ•°</li>
</ul>
<blockquote>
<p>åšäº‹è¦ä¿å®ˆï¼Œä½†æ¥å—åˆ«äººçš„è§‚ç‚¹è¦å¼€æ”¾ã€‚</p>
</blockquote>
<p>ä½†æ˜¯è¿™å¹¶ä¸æ˜¯ä¸€ç›´è¿™æ ·çš„ï¼Œä¹Ÿä¼šæœ‰è¿”å›æ¥å£çš„æƒ…å†µï¼Œä¾‹å¦‚ï¼šä»¥ä¸‹å‡½æ•°è¿”å›ä¸€ä¸ªå¯¼å‡ºçš„ç»“æ„ä½“ io.LimitedReaderã€‚ç„¶è€Œï¼Œå‡½æ•°ç­¾åæ˜¯ä¸€ä¸ªæ¥å£ io.Readerã€‚è¿™å’Œä¸Šé¢æˆ‘ä»¬çš„å»ºè®®å’Œç»“è®ºç›¸è¿èƒŒã€‚io.Reader æ˜¯ä¸€ä¸ªå‰ç½®æŠ½è±¡ã€‚å®ƒä¸æ˜¯ç”±å®¢æˆ·ç«¯å®šä¹‰çš„ï¼Œè€Œæ˜¯ç”±è¯­è¨€è®¾è®¡è€…é¢„å…ˆäº†è§£åˆ°è¿™ä¸ªæŠ½è±¡çº§åˆ«å°†æ˜¯æœ‰å¸®åŠ©çš„ï¼ˆä¾‹å¦‚ï¼Œå…³äºå¯é‡ç”¨æ€§å’Œç»„åˆæ€§ï¼‰ã€‚æ‰€ä»¥è¿™ç§æƒ…å†µä¸‹ä¹Ÿæ˜¯å¯¹çš„ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LimitReader</span><span class="params">(r Reader, n <span class="keyword">int64</span>)</span> <span class="title">Reader</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;LimitedReader&#123;r, n&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ€»çš„æ¥è¯´ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸åº”è¯¥è¿”å›æ¥å£è€Œæ˜¯å…·ä½“çš„å®ç°ã€‚å¦åˆ™ï¼Œç”±äºåŒ…ä¾èµ–å…³ç³»ä¼šä½¿æˆ‘ä»¬çš„è®¾è®¡æ›´åŠ å¤æ‚ï¼Œå¹¶ä¸”ä¼šé™åˆ¶çµæ´»æ€§ã€‚</p>
<p>å†æ¬¡å¼ºè°ƒï¼Œç»“è®ºä¸å‰é¢çš„éƒ¨åˆ†ç±»ä¼¼ï¼šå¦‚æœæˆ‘ä»¬çŸ¥é“ï¼ˆè€Œä¸æ˜¯é¢„è§ï¼‰æŠ½è±¡å¯¹å®¢æˆ·æœ‰å¸®åŠ©ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘è¿”å›æ¥å£ã€‚å¦åˆ™ï¼Œæˆ‘ä»¬ä¸åº”è¯¥å¼ºè¿«æŠ½è±¡ï¼›å®ƒä»¬åº”è¯¥ç”±å®¢æˆ·ç«¯å‘ç°ã€‚</p>
<h3 id="any"><a href="#any" class="headerlink" title="any"></a>any</h3><p>Go 1.18 çš„æ¨å‡ºåï¼Œé¢„å®šä¹‰çš„ any ç±»å‹æˆä¸ºäº†ç©ºæ¥å£çš„åˆ«åï¼›å› æ­¤ï¼Œæ‰€æœ‰ interface{} çš„å‡ºç°éƒ½å¯ä»¥ç”¨ any æ¥æ›¿ä»£ã€‚</p>
<p><strong>âŒé”™è¯¯ä»£ç </strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> store</span><br><span class="line"> </span><br><span class="line"><span class="keyword">type</span> Customer <span class="keyword">struct</span>&#123;</span><br><span class="line">    <span class="comment">// Some fields</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> Contract <span class="keyword">struct</span>&#123;</span><br><span class="line">    <span class="comment">// Some fields</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">type</span> Store <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Store)</span> <span class="title">Get</span><span class="params">(id <span class="keyword">string</span>)</span> <span class="params">(any, error)</span></span> &#123;     â¶ è¿”å› any</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Store)</span> <span class="title">Set</span><span class="params">(id <span class="keyword">string</span>, v any)</span> <span class="title">error</span></span> &#123;     â· æ¥å— any</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ä½¿ç”¨anyï¼Œæˆ‘ä»¬å¤±å»äº†Golangä½œä¸ºé™æ€ç±»å‹è¯­è¨€çš„ä¸€äº›å¥½å¤„ã€‚ç›¸åï¼Œæˆ‘ä»¬åº”è¯¥é¿å…ä½¿ç”¨ä»»ä½•ç±»å‹ï¼Œå¹¶å°½å¯èƒ½ä½¿æˆ‘ä»¬çš„å‡½æ•°ç­¾åæ˜ç¡®ã€‚</p>
<p><strong>âœ…æ­£ç¡®ä»£ç </strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Store)</span> <span class="title">GetContract</span><span class="params">(id <span class="keyword">string</span>)</span> <span class="params">(Contract, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Store)</span> <span class="title">SetContract</span><span class="params">(id <span class="keyword">string</span>, contract Contract)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Store)</span> <span class="title">GetCustomer</span><span class="params">(id <span class="keyword">string</span>)</span> <span class="params">(Customer, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Store)</span> <span class="title">SetCustomer</span><span class="params">(id <span class="keyword">string</span>, customer Customer)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ğŸ¡æ€»ç»“</strong></p>
<p>ä»»ä½•æƒ…å†µä¸‹éƒ½ä¸å¯ä»¥ä½¿ç”¨ any å—ï¼Ÿå…¶å®ä¸æ˜¯çš„ï¼Œä¾‹å¦‚åœ¨ encoding/json åŒ…ä¸­ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥å°†ä»»ä½•ç±»å‹ç¼–ç»„ï¼Œæ‰€ä»¥ Marshal å‡½æ•°æ¥å—ä¸€ä¸ªä»»æ„å‚æ•°</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Marshal</span><span class="params">(v any)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦ä¸€ä¸ªä¾‹å­åœ¨ database/sql åŒ…ä¸­ã€‚ å¦‚æœæŸ¥è¯¢æ˜¯å‚æ•°åŒ–çš„ï¼ˆä¾‹å¦‚ï¼ŒSELECT * FROM FOO WHERE id = ?ï¼‰ï¼Œåˆ™å‚æ•°å¯ä»¥æ˜¯ä»»ä½•ç±»å‹ã€‚ å› æ­¤ï¼Œå®ƒä¹Ÿä½¿ç”¨ä»»ä½•å‚æ•°ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Conn)</span> <span class="title">QueryContext</span><span class="params">(ctx context.Context, query <span class="keyword">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    args ...any)</span> <span class="params">(*Rows, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ€»çš„æ¥è¯´ï¼Œè¯¥ç”¨çš„æ—¶å€™ä½¿ç”¨ï¼Œä¸ç”¨èƒ½è®©ä»£ç çš„è¡¨è¾¾èƒ½åŠ›æ›´æ¸…æ¥šï¼Œæ›´èƒ½è¡¨è¾¾ä»£ç çš„ä½œç”¨ã€‚</p>
<h3 id="ä»€ä¹ˆæ—¶å€™ç”¨æ³›å‹"><a href="#ä»€ä¹ˆæ—¶å€™ç”¨æ³›å‹" class="headerlink" title="ä»€ä¹ˆæ—¶å€™ç”¨æ³›å‹"></a>ä»€ä¹ˆæ—¶å€™ç”¨æ³›å‹</h3><h4 id="ä»€ä¹ˆæ˜¯æ³›å‹"><a href="#ä»€ä¹ˆæ˜¯æ³›å‹" class="headerlink" title="ä»€ä¹ˆæ˜¯æ³›å‹"></a>ä»€ä¹ˆæ˜¯æ³›å‹</h4><p>ä¾‹å¦‚æœ‰ä»¥ä¸‹ä»£ç ï¼Œè·å– map ä¸­çš„æ‰€æœ‰keyã€‚ä½†æ˜¯å‘¢ map æœ‰ä¸ç”¨ç±»å‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getKeys</span><span class="params">(m any)</span> <span class="params">([]any, error)</span></span> &#123;                      â¶ æ¥å—å¹¶è¿”å›ä»»ä½•å‚æ•°</span><br><span class="line">    <span class="keyword">switch</span> t := m.(<span class="keyword">type</span>) &#123;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"unknown type: %T"</span>, t)     â· æœªçŸ¥ <span class="keyword">map</span> ç±»å‹</span><br><span class="line">    <span class="keyword">case</span> <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>:</span><br><span class="line">        <span class="keyword">var</span> keys []any</span><br><span class="line">        <span class="keyword">for</span> k := <span class="keyword">range</span> t &#123;</span><br><span class="line">        	keys = <span class="built_in">append</span>(keys, k)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> keys, <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">case</span> <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">string</span>:</span><br><span class="line">        <span class="comment">// Copy the extraction logic</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“æˆ‘ä»¬æƒ³æ·»åŠ ä¸€ä¸ª case æ—¶ï¼Œéœ€è¦é‡å¤ range å¾ªç¯ã€‚ä¸æ­¤åŒæ—¶ï¼Œè¿™ä¸ªå‡½æ•°ç°åœ¨æ¥å—äº† any ç±»å‹ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¤±å»äº†ä½œä¸ºå¼ºç±»å‹è¯­è¨€Goçš„ä¸€äº›ä¼˜åŠ¿ã€‚</p>
<p>ä»¥ä¸‹æ˜¯æ³›å‹ç¤ºä¾‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">foo</span>[<span class="title">T</span> <span class="title">any</span>]<span class="params">(t T)</span></span> &#123;     â¶ T æ˜¯ä¸€ä¸ªç±»å‹å‚æ•°</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ä½¿ç”¨åœºæ™¯"><a href="#ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h4><p>ä»¥ä¸‹æ˜¯ä½¿ç”¨æ³›å‹é‡å†™ getKeys çš„ç¤ºä¾‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getKeys</span>[<span class="title">K</span> <span class="title">comparable</span>, <span class="title">V</span> <span class="title">any</span>]<span class="params">(m <span class="keyword">map</span>[K]V)</span> []<span class="title">K</span></span> &#123;   â¶ é”®æ˜¯å¯æ¯”è¾ƒçš„ï¼Œè€Œå€¼å¯ä»¥æ˜¯ä»»ä½•ç±»å‹</span><br><span class="line">    <span class="keyword">var</span> keys []K                                     â· åˆ›å»ºä¸€ä¸ª keys åˆ‡ç‰‡</span><br><span class="line">    <span class="keyword">for</span> k := <span class="keyword">range</span> m &#123;</span><br><span class="line">        keys = <span class="built_in">append</span>(keys, k)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> keys</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨Goä¸­ï¼ŒMap çš„é”®ä¸èƒ½æ˜¯ä»»ä½•ç±»å‹ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬ä¸èƒ½ä½¿ç”¨åˆ‡ç‰‡ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> m <span class="keyword">map</span>[[]<span class="keyword">byte</span>]<span class="keyword">int</span></span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç ä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯ï¼šæ— æ•ˆçš„ map é”®ç±»å‹ []byteã€‚åœ¨è¿™é‡Œï¼Œè¦æ±‚æ˜¯é”®ç±»å‹å¿…é¡»æ˜¯å¯æ¯”è¾ƒçš„ï¼ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨==æˆ–!=ï¼‰ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°† K å®šä¹‰ä¸ºå¯æ¯”è¾ƒçš„ç±»å‹ï¼Œè€Œä¸æ˜¯ä»»ä½•ç±»å‹ã€‚æˆ‘ä»¬æƒ³å°†å…¶é™åˆ¶ä¸ºintæˆ–stringç±»å‹ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å®šä¹‰è‡ªå®šä¹‰çº¦æŸï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> customConstraint <span class="keyword">interface</span> &#123;</span><br><span class="line">    ~<span class="keyword">int</span> | ~<span class="keyword">string</span>                   â¶ å®šä¹‰äº†ä¸€ä¸ªè‡ªå®šä¹‰ç±»å‹ï¼Œé™åˆ¶ç±»å‹ä¸º <span class="keyword">int</span> å’Œ <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">â· å°†ç±»å‹å‚æ•°Kæ›´æ”¹ä¸ºcustomConstraintç±»å‹</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getKeys</span>[<span class="title">K</span> <span class="title">customConstraint</span>, <span class="title">V</span> <span class="title">any</span>]<span class="params">(m <span class="keyword">map</span>[K]V)</span> []<span class="title">K</span></span> &#123; </span><br><span class="line">    <span class="comment">// Same implementation</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç±»å‹å‚æ•°çš„æœ€åä¸€é¡¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®ƒä»¬ä¸èƒ½ç”¨äºæ–¹æ³•å‚æ•°ï¼Œä»…èƒ½ç”¨äºå‡½æ•°å‚æ•°æˆ–æ–¹æ³•æ¥æ”¶å™¨ï¼Œä¾‹å¦‚ä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Foo <span class="keyword">struct</span> &#123;&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(Foo)</span> <span class="title">bar</span>[<span class="title">T</span> <span class="title">any</span>]<span class="params">(t T)</span></span> &#123;&#125;</span><br><span class="line">./main.<span class="keyword">go</span>:<span class="number">29</span>:<span class="number">15</span>: methods cannot have <span class="keyword">type</span> parameters</span><br></pre></td></tr></table></figure>
<p>åœ¨ä»¥ä¸‹åœºæ™¯ä¸­ï¼Œæ³›å‹æ¯”è¾ƒç”¨å¾—å¤šï¼š</p>
<ol>
<li><p>æ•°æ®ç»“æ„-ä¾‹å¦‚å®ç°äºŒå‰æ ‘ã€é“¾è¡¨æˆ–å †æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ³›å‹æ¥åˆ†ç¦»å…ƒç´ ç±»å‹ã€‚</p>
</li>
<li><p>ä¸ slicesï¼ˆåˆ‡ç‰‡ï¼‰ã€ mapsï¼ˆæ˜ å°„ï¼‰å’Œä»»ä½•ç±»å‹çš„ channelsï¼ˆé€šé“ï¼‰ä¸€èµ·ä½¿ç”¨çš„å‡½æ•°â€”â€”ä¾‹å¦‚ï¼Œåˆå¹¶ä¸¤ä¸ª channels çš„å‡½æ•°å°†é€‚ç”¨äºä»»ä½•ç±»å‹çš„ channelã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç±»å‹å‚æ•°æ¥åˆ†ç¦» channel ç±»å‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">merge</span>[<span class="title">T</span> <span class="title">any</span>]<span class="params">(ch1, ch2 &lt;-<span class="keyword">chan</span> T)</span> &lt;-<span class="title">chan</span> <span class="title">T</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å°†è¡Œä¸ºå’Œç±»å‹åˆ†ç¦»</p>
<p>ä¾‹å¦‚æœ‰ä¸€ä¸ªæ¥å£ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Interface <span class="keyword">interface</span> &#123;</span><br><span class="line">    Len() <span class="keyword">int</span></span><br><span class="line">    Less(i, j <span class="keyword">int</span>) <span class="keyword">bool</span></span><br><span class="line">    Swap(i, j <span class="keyword">int</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”¨æ³›å‹å®ç°ä¸Šé¢æ¥å£</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> SliceFn[T any] <span class="keyword">struct</span> &#123;    â¶ ä½¿ç”¨ç±»å‹å‚æ•°</span><br><span class="line">    S       []T</span><br><span class="line">    Compare <span class="function"><span class="keyword">func</span><span class="params">(T, T)</span> <span class="title">bool</span>     â· æ¯”è¾ƒä¸¤ä¸ª<span class="title">T</span>å…ƒç´ </span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s SliceFn[T])</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span>           &#123; <span class="keyword">return</span> <span class="built_in">len</span>(s.S) &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s SliceFn[T])</span> <span class="title">Less</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123; <span class="keyword">return</span> s.Compare(s.S[i], s.S[j]) &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s SliceFn[T])</span> <span class="title">Swap</span><span class="params">(i, j <span class="keyword">int</span>)</span></span>      &#123; s.S[i], s.S[j] = s.S[j], s.S[i] &#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºSliceFn ç»“æ„å®ç°äº† sort.Interfaceï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ sort.Sort(sort.Interface) å‡½æ•°å¯¹æä¾›çš„åˆ‡ç‰‡è¿›è¡Œæ’åºã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">s := SliceFn[<span class="keyword">int</span>]&#123;</span><br><span class="line">  S: []<span class="keyword">int</span>&#123;<span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>&#125;,</span><br><span class="line">    Compare: <span class="function"><span class="keyword">func</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a &lt; b</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line">sort.Sort(s)</span><br><span class="line">fmt.Println(s.S)</span><br><span class="line">[<span class="number">1</span> <span class="number">2</span> <span class="number">3</span>]</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="ç»“æ„ä½“å†…åµŒ"><a href="#ç»“æ„ä½“å†…åµŒ" class="headerlink" title="ç»“æ„ä½“å†…åµŒ"></a>ç»“æ„ä½“å†…åµŒ</h3><p>Goåœ¨ç»“æ„ä½“ä¸­æä¾›äº†å†…åµŒç±»å‹çš„æ–¹å¼ï¼Œä¼šå‡ºç°ä¸€äº›ä¸åœ¨é¢„æœŸå†…çš„æƒ…å†µã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Foo <span class="keyword">struct</span> &#123;</span><br><span class="line">    Bar</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> Bar <span class="keyword">struct</span> &#123;</span><br><span class="line">    Baz <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Foo.Barå°±æ˜¯ä¸€ç§å†…åµŒç±»å‹ï¼Œå…è®¸Fooç›´æ¥è°ƒç”¨Barçš„æ–¹æ³•ã€‚</p>
<p><strong>âŒé”™è¯¯ä»£ç </strong></p>
<p>æˆ‘ä»¬ä¸‹é¢çœ‹ä¸€ç§é”™è¯¯çš„å†…åµŒä½¿ç”¨æ–¹å¼,æˆ‘ä»¬æƒ³è¦åœ¨å†…å­˜ä¸­å¹¶å‘æ“ä½œmapï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> InMem <span class="keyword">struct</span> &#123;</span><br><span class="line">    sync.Mutex</span><br><span class="line">    m <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">()</span> *<span class="title">InMem</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;InMem&#123;m: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>)&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(i *InMem)</span> <span class="title">Get</span><span class="params">(key <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">int</span>, <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">    i.Lock()</span><br><span class="line">    v, contains := i.m[key]</span><br><span class="line">    i.Unlock()</span><br><span class="line">    <span class="keyword">return</span> v, contains</span><br></pre></td></tr></table></figure>
<p>å› ä¸º<code>sync.Mutex</code>æ˜¯å†…åµŒç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>Lock</code>å’Œ<code>Unlock</code>æ–¹æ³•ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªæ–¹æ³•ä¹ŸåŒæ ·æ˜¯å¯¼å‡ºæ–¹æ³•ï¼Œå¯ä»¥è¢«å¤–éƒ¨è°ƒç”¨ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">m := inmem.New()</span><br><span class="line">m.Lock() <span class="comment">// ??</span></span><br></pre></td></tr></table></figure>
<p>Mutex åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯æˆ‘ä»¬æƒ³è¦å°è£…åœ¨ç»“æ„ä½“ä¸­å¹¶å¯¹å¤–éƒ¨å®¢æˆ·ç«¯éšè—çš„å†…å®¹ã€‚å› æ­¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬ä¸åº”è¯¥å°†å…¶ä½œä¸ºåµŒå…¥å­—æ®µã€‚</p>
<p><strong>âœ…æ­£ç¡®ä»£ç </strong></p>
<p>æ‰€ä»¥æˆ‘ä»¬åº”è¯¥æ”¹ä¸ºï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> InMem <span class="keyword">struct</span> &#123;</span><br><span class="line">    mu sync.Mutex</span><br><span class="line">    m <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ğŸ¡æ€»ç»“</strong></p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä½¿ç”¨å†…åµŒæ¯”è¾ƒé€‚åˆçš„åœºæ™¯ï¼Œæˆ‘ä»¬æƒ³ç¼–å†™ä¸€ä¸ªè‡ªå®šä¹‰æ—¥å¿—è®°å½•å™¨ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªio.WriteCloserå¹¶å…¬å¼€ä¸¤ç§æ–¹æ³•ï¼šWriteå’ŒCloseã€‚å¦‚æœæœªåµŒå…¥io.WriteCloserï¼Œåˆ™éœ€è¦ç¼–å†™å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Logger <span class="keyword">struct</span> &#123;</span><br><span class="line">    writeCloser io.WriteCloser</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l Logger)</span> <span class="title">Write</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> l.writeCloser.Write(p)     â¶ è½¬å‘è°ƒç”¨ç»™ writeCloser</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l Logger)</span> <span class="title">Close</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> l.writeCloser.Close()      â¶ è½¬å‘è°ƒç”¨ç»™ writeCloser</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    l := Logger&#123;writeCloser: os.Stdout&#125;</span><br><span class="line">    _, _ = l.Write([]<span class="keyword">byte</span>(<span class="string">"foo"</span>))</span><br><span class="line">    _ = l.Close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨å†…åµŒçš„æ—¶å€™ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Logger <span class="keyword">struct</span> &#123; </span><br><span class="line">    io.WriteCloser       â¶ å†…åµŒ io.WriteCloserï¼Œè¿™æ ·å°±ä¸ç”¨å®ç° Write å’Œ Close æ–¹æ³•</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    l := Logger&#123;WriteCloser: os.Stdout&#125;</span><br><span class="line">    _, _ = l.Write([]<span class="keyword">byte</span>(<span class="string">"foo"</span>))</span><br><span class="line">    _ = l.Close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ç¤ºä¾‹é˜²æ­¢äº†ä»…ä»…ä¸ºäº†è½¬å‘è°ƒç”¨è€Œå®ç°çš„è¿™äº›é™„åŠ æ–¹æ³•ã€‚</p>
<p>é‚£å†…åµŒå’Œé›†æˆæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼š</p>
<p><img src="https://raw.githubusercontent.com/rexyan/warehouse/master/202308061018957.png" alt></p>
<p>é€šè¿‡åµŒå…¥ï¼ŒFoo çš„æ¥æ”¶è€…ä»ç„¶æ˜¯ Xã€‚ç„¶è€Œï¼Œé€šè¿‡ç»§æ‰¿ï¼ŒFoo çš„æ¥æ”¶è€…å˜æˆäº†å­ç±» Yã€‚åµŒå…¥æ˜¯å…³äºç»„åˆï¼Œè€Œéç»§æ‰¿ã€‚</p>
<h3 id="å‡½æ•°çš„é€‰é¡¹æ¨¡å¼"><a href="#å‡½æ•°çš„é€‰é¡¹æ¨¡å¼" class="headerlink" title="å‡½æ•°çš„é€‰é¡¹æ¨¡å¼"></a>å‡½æ•°çš„é€‰é¡¹æ¨¡å¼</h3><p>å½“æˆ‘ä»¬è®¾è®¡APIçš„æ—¶å€™ç»å¸¸ä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜:æ€ä¹ˆå»å¤„ç†ä¸€äº›å¯é€‰çš„é…ç½®é¡¹ï¼Ÿæ•ˆç‡çš„è§£å†³è¿™ä¸ªé—®é¢˜å°±å¯ä»¥è®©æˆ‘ä»¬çš„APIä½¿ç”¨èµ·æ¥æ›´èˆ’é€‚ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå½“æˆ‘ä»¬éœ€è¦è®¾è®¡ä¸€ä¸ªå‡½æ•°å»åˆ›å»ºä¸€ä¸ªHTTPæœåŠ¡æ—¶ï¼Œèµ·åˆéœ€è¦ä¸¤ä¸ªå…¥å‚ï¼šåœ°å€ä»¥åŠç«¯å£ï¼Œæˆ‘ä»¬æä¾›äº†ä»¥ä¸‹æ–¹å¼ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewServer</span><span class="params">(addr <span class="keyword">string</span>, port <span class="keyword">int</span>)</span> <span class="params">(*http.Server, error)</span></span> &#123; </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸€å¼€å§‹éƒ½å¾ˆæ–¹ä¾¿ï¼Œæ¸æ¸çš„ï¼Œå®¢æˆ·ç«¯å¼€å§‹æŠ±æ€¨è¯´æ€ä¹ˆæ— æ³•è®¾ç½®è¶…æ—¶æ—¶é—´ã€‚è¿™æ—¶å€™æˆ‘ä»¬å°±ä¼šå‘ç°ï¼šå½“æˆ‘ä»¬æƒ³è¦å¢åŠ ä¸€ä¸ªå‚æ•°æ—¶ï¼Œå®¢æˆ·ç«¯å°±æ— æ³•å…¼å®¹åŸæ¥çš„è°ƒç”¨<code>NewServer</code>æ–¹å¼äº†ã€‚é‚£æˆ‘ä»¬æ€ä¹ˆå»è®¾è®¡ä¸€ä¸ªAPIå‹å¥½å‹çš„å‡½æ•°å‘¢ï¼Ÿæ¯”è¾ƒé€šç”¨çš„æ–¹å¼å°±æ˜¯æŠŠæ‰€æœ‰çš„é…ç½®é¡¹è®¾ç½®æˆä¸€ä¸ªstructï¼Œç„¶ååªæ¥æ”¶ä¸€ä¸ªstructå‚æ•°ã€‚è€Œæˆ‘ä»¬è¿™ä¸€ç« è¦è®²çš„åˆ™æ˜¯å¦ä¸€ç§æ–¹å¼<code>functional options pattern</code>ï¼š</p>
<ul>
<li>ç§æœ‰ç»“æ„ä½“æ¶µç›–é…ç½®å‚æ•°ï¼š<code>options</code></li>
<li>æ¯ä¸ªå¯é€‰é¡¹éƒ½ä¼šè¿”å›åŒç±»å‹ï¼š<code>type Option func(options *options) error</code></li>
</ul>
<p><img src="https://raw.githubusercontent.com/rexyan/warehouse/master/202308061027915.png" alt></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> options <span class="keyword">struct</span> &#123;                          â¶ é…ç½®ç»“æ„ä½“</span><br><span class="line">    port *<span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">type</span> Option <span class="function"><span class="keyword">func</span><span class="params">(options *options)</span> <span class="title">error</span>       â· ä»£è¡¨ä¸€ä¸ªå‡½æ•°ç±»å‹ï¼Œå®ƒæ›´æ–°é…ç½®çš„ç»“æ„ä½“</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithPort</span><span class="params">(port <span class="keyword">int</span>)</span> <span class="title">Option</span></span> &#123;               â¸ æ›´æ–°ç«¯å£çš„å‡½æ•°</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(options *options)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> port &lt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> errors.New(<span class="string">"port should be positive"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        options.port = &amp;port</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>WithPort è¿”å›ä¸€ä¸ªé—­åŒ…ã€‚é—­åŒ…æ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œå®ƒå¼•ç”¨äº†å¤–éƒ¨å˜é‡ï¼Œè¿™é‡Œæ˜¯å¼•ç”¨äº† port å‚æ•°ã€‚</p>
<p>é—­åŒ…è€ƒè™‘äº†é€‰é¡¹ç±»å‹å¹¶å®ç°äº†ç«¯å£éªŒè¯é€»è¾‘ã€‚æ¯ä¸ªé…ç½®å­—æ®µéƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªå…¬å…±å‡½æ•°ï¼ˆæŒ‰æƒ¯ä¾‹ä»¥ With å‰ç¼€å¼€å¤´ï¼‰ï¼Œå…¶ä¸­åŒ…å«ç±»ä¼¼çš„é€»è¾‘ï¼šå¿…è¦æ—¶éªŒè¯è¾“å…¥å¹¶æ›´æ–°é…ç½®ç»“æ„ã€‚å†æ¥çœ‹çœ‹æ€ä¹ˆåº”ç”¨è¿™äº›é…ç½®ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewServer</span><span class="params">(addr <span class="keyword">string</span>, opts ...Option)</span> <span class="params">(     â¶ æ¥æ”¶ä¸å®šæ•°é‡çš„ Option å‚æ•°</span></span></span><br><span class="line"><span class="function"><span class="params">    *http.Server, error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> options options                           â· åˆ›å»ºä¸€ä¸ªç©ºçš„é€‰é¡¹ç»“æ„ä½“</span><br><span class="line">    <span class="keyword">for</span> _, opt := <span class="keyword">range</span> opts &#123;                    â¸ å¾ªç¯æ‰€æœ‰ä½¿ç”¨çš„é€‰é¡¹</span><br><span class="line">        err := opt(&amp;options)                      â¹ è°ƒç”¨æ¯ä¸ªé€‰é¡¹ï¼Œè¿™å°†å¯¼è‡´ä¿®æ”¹å…¬å…±é€‰é¡¹ç»“æ„ä½“ã€‚</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// å‚æ•°é€»è¾‘</span></span><br><span class="line">    <span class="keyword">var</span> port <span class="keyword">int</span></span><br><span class="line">    <span class="keyword">if</span> options.port == <span class="literal">nil</span> &#123;</span><br><span class="line">        port = defaultHTTPPort</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> *options.port == <span class="number">0</span> &#123;</span><br><span class="line">            port = randomPort()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            port = *options.port</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨çš„æ—¶å€™ï¼Œå¯ä»¥è¿™ä¹ˆå†™ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server, err := httplib.NewServer(<span class="string">"localhost"</span>,</span><br><span class="line">        httplib.WithPort(<span class="number">8080</span>),</span><br><span class="line">        httplib.WithTimeout(time.Second))</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæƒ³ä½¿ç”¨é»˜è®¤å‚æ•°ï¼Œåˆ™å¯ä»¥ä¸ä¼ é€’ Withxx å‡½æ•°</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server, err := httplib.NewServer(<span class="string">"localhost"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="é¡¹ç›®ç»“æ„"><a href="#é¡¹ç›®ç»“æ„" class="headerlink" title="é¡¹ç›®ç»“æ„"></a>é¡¹ç›®ç»“æ„</h3><p>Goè¯­è¨€çš„ç»´æŠ¤è€…æ²¡æœ‰å…³äºå¦‚ä½•åœ¨Goä¸­æ„å»ºé¡¹ç›®çš„å¼ºçƒˆæƒ¯ä¾‹ã€‚ç„¶è€Œï¼Œå¤šå¹´æ¥å·²ç»å‡ºç°äº†ä¸€ä¸ªå¸ƒå±€ï¼š<a href="https://github.com/golang-standards/project-layout" target="_blank" rel="noopener">project-layout</a></p>
<p>åœ¨ Go ä¸­ï¼Œæ²¡æœ‰å­åŒ…çš„æ¦‚å¿µã€‚ç„¶è€Œï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©åœ¨å­ç›®å½•ä¸­ç»„ç»‡è½¯ä»¶åŒ…ã€‚å¦‚æœæˆ‘ä»¬çœ‹ä¸€ä¸‹æ ‡å‡†åº“ï¼Œnet ç›®å½•å°±æ˜¯è¿™æ ·ç»„ç»‡çš„ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/net</span><br><span class="line">    /http</span><br><span class="line">        client.go</span><br><span class="line">        ...</span><br><span class="line">    /smtp</span><br><span class="line">        auth.go</span><br><span class="line">        ...</span><br><span class="line">    addrselect.go</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>net æ—¢æ˜¯ä¸€ä¸ªåŒ…åˆæ˜¯ä¸€ä¸ªåŒ…å«å…¶ä»–åŒ…çš„ç›®å½•ã€‚</p>
<p>ç²’åº¦æ˜¯å¦ä¸€ä¸ªéœ€è¦è€ƒè™‘çš„é‡è¦å› ç´ ã€‚æˆ‘ä»¬åº”è¯¥é¿å…æ‹¥æœ‰æ•°åä¸ªä»…åŒ…å«ä¸€ä¸ªæˆ–ä¸¤ä¸ªæ–‡ä»¶çš„çº³ç±³çº§åŒ…ã€‚ç›¸ååœ°ï¼Œæˆ‘ä»¬ä¹Ÿåº”è¯¥é¿å…è¿‡å¤§çš„åŒ…ï¼Œè¿™å°†æ·¡åŒ–åŒ…åç§°çš„æ„ä¹‰ã€‚</p>
<p>åŒ…ååº”è¯¥ç®€çŸ­ã€ç®€æ˜ã€å¯Œæœ‰è¡¨ç°åŠ›ï¼Œåœ¨çº¦å®šä¸­åº”è¯¥æ˜¯ä¸€ä¸ªå°å†™å•è¯ã€‚</p>
<h3 id="utility-åŒ…"><a href="#utility-åŒ…" class="headerlink" title="utility åŒ…"></a>utility åŒ…</h3><p>æœ¬èŠ‚è®¨è®ºä¸€ç§å¸¸è§çš„åä¹ æƒ¯ï¼šåˆ›å»ºå…±äº«åŒ…ï¼Œä¾‹å¦‚ utilsã€common å’Œ baseç­‰</p>
<p>ä¾‹å¦‚ï¼šæˆ‘ä»¬æœ‰ä»¥ä¸‹ä»£ç ï¼Œå¹¶å°†å…¶æ”¾åœ¨ util åŒ…ä¸­</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> util</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewStringSet</span><span class="params">(...<span class="keyword">string</span>)</span> <span class="title">map</span>[<span class="title">string</span>]<span class="title">struct</span></span>&#123;&#125; &#123;    â¶ åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸² set</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SortStringSet</span><span class="params">(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">struct</span>&#123;&#125;)</span> []<span class="title">string</span></span> &#123;    â· è¿”å›æŒ‰ç…§ <span class="keyword">map</span> çš„ key æ’åºçš„åˆ—è¡¨</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set := util.NewStringSet(<span class="string">"c"</span>, <span class="string">"a"</span>, <span class="string">"b"</span>)</span><br><span class="line">fmt.Println(util.SortStringSet(set))</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„é—®é¢˜åœ¨äº util æ²¡æœ‰æ„ä¹‰ã€‚æˆ‘ä»¬å¯ä»¥ç§°ä¹‹ä¸º commonã€shared æˆ– baseï¼Œä½†å®ƒä»ç„¶æ˜¯ä¸€ä¸ªæ¯«æ— æ„ä¹‰çš„åç§°ï¼Œæ— æ³•æä¾›ä»»ä½•å…³äºè¯¥è½¯ä»¶åŒ…å±æ€§çš„æŒ‡ç¤ºã€‚</p>
<p>æˆ‘ä»¬åº”è¯¥åˆ›å»ºä¸€ä¸ªæ›´æœ‰è¡¨ç°åŠ›çš„åŒ…åï¼Œæ¯”å¦‚stringsetï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå®ç”¨ç¨‹åºåŒ…ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> stringset</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(...<span class="keyword">string</span>)</span> <span class="title">map</span>[<span class="title">string</span>]<span class="title">struct</span></span>&#123;&#125; &#123; ... &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sort</span><span class="params">(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">struct</span>&#123;&#125;)</span> []<span class="title">string</span></span> &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set := stringset.New(<span class="string">"c"</span>, <span class="string">"a"</span>, <span class="string">"b"</span>)</span><br><span class="line">fmt.Println(stringset.Sort(set))</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ç”šè‡³å¯ä»¥å†è¿›ä¸€æ­¥ã€‚ä¸æ˜¯æš´éœ²å®ç”¨å‡½æ•°ï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ªç‰¹å®šç±»å‹ï¼Œå¹¶ä»¥æ­¤æ–¹å¼ä½œä¸ºæ–¹æ³•å…¬å¼€:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> stringset</span><br><span class="line"> </span><br><span class="line"><span class="keyword">type</span> Set <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(...<span class="keyword">string</span>)</span> <span class="title">Set</span></span> &#123; ... &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s Set)</span> <span class="title">Sort</span><span class="params">()</span> []<span class="title">string</span></span> &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set := stringset.New(<span class="string">"c"</span>, <span class="string">"a"</span>, <span class="string">"b"</span>)</span><br><span class="line">fmt.Println(set.Sort())</span><br></pre></td></tr></table></figure>
<h3 id="å˜é‡åå’ŒåŒ…åå†²çª"><a href="#å˜é‡åå’ŒåŒ…åå†²çª" class="headerlink" title="å˜é‡åå’ŒåŒ…åå†²çª"></a>å˜é‡åå’ŒåŒ…åå†²çª</h3><p>å½“å˜é‡åç§°ä¸ç°æœ‰åŒ…åç§°å†²çªæ—¶ï¼Œä¼šå‘ç”ŸåŒ…å†²çªã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªå…·ä½“çš„ç¤ºä¾‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> redis</span><br><span class="line"> </span><br><span class="line"><span class="keyword">type</span> Client <span class="keyword">struct</span> &#123; ... &#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewClient</span><span class="params">()</span> *<span class="title">Client</span></span> &#123; ... &#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Client)</span> <span class="title">Get</span><span class="params">(key <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨æ—¶ï¼Œå°½ç®¡åŒ…åç§°ä¸º redisï¼Œä½†åœ¨ Go ä¸­åˆ›å»ºä¸€ä¸ªåä¸º redis çš„å˜é‡ä¹Ÿå®Œå…¨æœ‰æ•ˆ</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis := redis.NewClient()     â¶ ä» redis åŒ…è°ƒç”¨ NewClient</span><br><span class="line">v, err := redis.Get(<span class="string">"foo"</span>)     â· ä½¿ç”¨ redis å˜é‡</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œ redis å˜é‡åä¸ redis åŒ…åå‘ç”Ÿäº†å†²çªã€‚å°½ç®¡è¿™æ˜¯è¢«å…è®¸çš„ï¼Œä½†åº”è¯¥é¿å…å‘ç”Ÿè¿™ç§æƒ…å†µã€‚å®é™…ä¸Šï¼Œåœ¨ redis å˜é‡çš„ä½œç”¨åŸŸèŒƒå›´å†…ï¼Œredis åŒ…å°†ä¸å¯è®¿é—®ã€‚</p>
<p>ç¬¬ä¸€ç§è§£å†³æ–¹å¼ï¼šä½¿ç”¨ä¸åŒçš„å˜é‡å</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redisClient := redis.NewClient()</span><br><span class="line">v, err := redisClient.Get(<span class="string">"foo"</span>)</span><br></pre></td></tr></table></figure>
<p>ç¬¬äºŒç§è§£å†³æ–¹å¼ï¼šä½¿ç”¨åˆ«å</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redisapi <span class="string">"mylib/redis"</span>    â¶ åˆ›å»º redis åŒ…çš„åˆ«å</span><br><span class="line"> </span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"> </span><br><span class="line">redis := redisapi.NewClient()    â· é€šè¿‡ redisapi åˆ«åè®¿é—® redis åŒ…</span><br><span class="line">v, err := redis.Get(<span class="string">"foo"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="ä»£ç æ–‡æ¡£"><a href="#ä»£ç æ–‡æ¡£" class="headerlink" title="ä»£ç æ–‡æ¡£"></a>ä»£ç æ–‡æ¡£</h3><p>æ¯ä¸ªå¯¼å‡ºçš„å…ƒç´ å¿…é¡»è¿›è¡Œæ–‡æ¡£åŒ–ã€‚æ— è®ºæ˜¯ç»“æ„ä½“ã€æ¥å£ã€å‡½æ•°è¿˜æ˜¯å…¶ä»–çš„ä¸œè¥¿ï¼Œåªè¦å®ƒè¢«å¯¼å‡ºï¼Œå°±å¿…é¡»è¿›è¡Œæ–‡æ¡£åŒ–ã€‚çº¦å®šä¿—æˆçš„åšæ³•æ˜¯æ·»åŠ æ³¨é‡Šï¼Œä»¥å¯¼å‡ºå…ƒç´ çš„åç§°å¼€å¤´</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Customer is a customer representation.</span></span><br><span class="line"><span class="keyword">type</span> Customer <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// ID returns the customer identifier.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c Customer)</span> <span class="title">ID</span><span class="params">()</span> <span class="title">string</span></span> &#123; <span class="keyword">return</span> <span class="string">""</span> &#125;</span><br></pre></td></tr></table></figure>
<p>æ¯ä¸ªæ³¨é‡Šåº”è¯¥æ˜¯ä¸€ä¸ªä»¥æ ‡ç‚¹ç¬¦å·ç»“å°¾çš„å®Œæ•´å¥å­ã€‚å¹¶ä¸”æ³¨é‡Šçš„å†…å®¹ï¼Œåº”è¯¥å¼ºè°ƒå‡½æ•°çš„æ„å›¾è€Œä¸æ˜¯å®ƒå¦‚ä½•å®ç°ã€‚</p>
<blockquote>
<p>å¯ä»¥ä½¿ç”¨ // Deprecated: æ³¨é‡Šçš„æ–¹å¼æ ‡è®°å¯¼å‡ºçš„å…ƒç´ ä¸ºè¿‡æ—¶å…ƒç´ ã€‚</p>
</blockquote>
<p>å½“ä¸ºå¸¸é‡æ—¶ï¼Œåº”è¯¥è¿™ä¹ˆä½¿ç”¨æ³¨é‡Š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DefaultPermission is the default permission used by the store engine.</span></span><br><span class="line"><span class="keyword">const</span> DefaultPermission = <span class="number">0</span>o644 <span class="comment">// Need read and write accesses.</span></span><br></pre></td></tr></table></figure>
<p>ç¬¬ä¸€è¡Œæ³¨é‡Šæ–‡æ¡£è¯´æ˜äº†ç›®çš„ï¼Œç¬¬äºŒè¡Œæ–‡æ¡£è¯´æ˜äº†å®é™…çš„å†…å®¹ã€‚</p>
<p>å½“ä¸ºåŒ…çš„æ—¶å€™ï¼Œåº”è¯¥å¯¹æ¯ä¸ªåŒ…è¿›è¡Œæ–‡æ¡£ç¼–å†™ã€‚æƒ¯ä¾‹æ˜¯ä»¥ <code>// Package</code> ä¸ºå¼€å¤´ï¼Œåè·ŸåŒ…åç§°çš„æ³¨é‡Š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Package math provides basic constants and mathematical functions.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This package does not guarantee bit-identical results</span></span><br><span class="line"><span class="comment">// across architectures.</span></span><br><span class="line"><span class="keyword">package</span> math</span><br></pre></td></tr></table></figure>
<p>ä¸€ä¸ªåŒ…çš„æ–‡æ¡£å¯ä»¥åœ¨ä»»ä½• Go æ–‡ä»¶ä¸­å®Œæˆï¼Œè¿™ä¸ªæ²¡æœ‰è§„å®šã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åº”è¯¥å°†åŒ…æ–‡æ¡£æ”¾åœ¨ä¸åŒ…åŒåçš„ç›¸å…³æ–‡ä»¶ä¸­ï¼Œæˆ–è€…æ”¾åœ¨ä¸€ä¸ªç‰¹å®šçš„æ–‡ä»¶ï¼Œæ¯”å¦‚doc.goä¸­ã€‚</p>
<p>ä¸å£°æ˜ä¸ç›¸é‚»çš„æ³¨é‡Šå°†ä¼šè¢«çœç•¥ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹ç‰ˆæƒæ³¨é‡Šå°†ä¸ä¼šåœ¨ç”Ÿæˆçš„æ–‡æ¡£ä¸­æ˜¾ç¤º</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright 2009 The Go Authors. All rights reserved.</span></span><br><span class="line"><span class="comment">// Use of this source code is governed by a BSD-style</span></span><br><span class="line"><span class="comment">// license that can be found in the LICENSE file.</span></span><br><span class="line"><span class="comment">// Package math provides basic constants and mathematical functions.</span></span><br><span class="line"><span class="comment">//                                                       â¶ ç©ºè¡Œï¼Œä¹‹å‰çš„æ³¨é‡Šä¸ä¼šåŒ…å«åœ¨æ–‡æ¡£ä¸­</span></span><br><span class="line"><span class="comment">// This package does not guarantee bit-identical results</span></span><br><span class="line"><span class="comment">// across architectures.</span></span><br><span class="line"><span class="keyword">package</span> math</span><br></pre></td></tr></table></figure>
<h3 id="ä»£ç æ£€æŸ¥å·¥å…·"><a href="#ä»£ç æ£€æŸ¥å·¥å…·" class="headerlink" title="ä»£ç æ£€æŸ¥å·¥å…·"></a>ä»£ç æ£€æŸ¥å·¥å…·</h3><p>åœ¨ â€œå˜é‡å±è”½â€ ä¸­ï¼Œæˆ‘ä»¬è®¨è®ºäº†å˜é‡é‡åæ½œåœ¨çš„é”™è¯¯ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ vet å’Œ shadow æ¥å‘ç°è¿™ç§æƒ…å†µ</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    i := <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> <span class="literal">true</span> &#123;</span><br><span class="line">        i := <span class="number">1</span>          â¶ å˜é‡å±è”½</span><br><span class="line">        fmt.Println(i)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>vet å·²ç»å†…ç½®äº†ï¼Œshadow éœ€è¦å…ˆå®‰è£…<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> go install golang.org/x/tools/go/analysis/passes/shadow/cmd/shadow     â¶ å®‰è£… shadow</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> go vet -vettool=$(<span class="built_in">which</span> shadow)                             â· ä½¿ç”¨</span></span><br><span class="line">./main.go:8:3:</span><br><span class="line">  declaration of "i" shadows declaration at line 6            â¸ æ£€æµ‹åˆ°å˜é‡å±è”½</span><br></pre></td></tr></table></figure></p>
<p>ä»£ç æ£€æŸ¥å¸¸ç”¨å·¥å…·ï¼š</p>
<p><a href="https://golang.org/cmd/vet/" target="_blank" rel="noopener">https://golang.org/cmd/vet/</a>  â€”A standard Go analyzer<br><a href="https://github.com/kisielk/errcheck" target="_blank" rel="noopener">https://github.com/kisielk/errcheck</a>  â€”An error checker<br><a href="https://github.com/fzipp/gocyclo" target="_blank" rel="noopener">https://github.com/fzipp/gocyclo</a>  â€”A cyclomatic complexity analyzer<br><a href="https://github.com/jgautheron/goconst" target="_blank" rel="noopener">https://github.com/jgautheron/goconst</a>  â€”A repeated string constants analyzer</p>
<p>ä»£ç æ ¼å¼åŒ–å·¥å…·ï¼š</p>
<p><a href="https://golang.org/cmd/gofmt/" target="_blank" rel="noopener">https://golang.org/cmd/gofmt/</a>   â€”A standard Go code formatter<br><a href="https://godoc.org/golang.org/x/tools/cmd/goimports" target="_blank" rel="noopener">https://godoc.org/golang.org/x/tools/cmd/goimports</a>   â€”A standard Go imports formatter<br><a href="https://github.com/golangci/golangci-lint" target="_blank" rel="noopener">https://github.com/golangci/golangci-lint</a></p>
<h3 id="å…«è¿›åˆ¶å­—é¢é‡çš„è¯¯è§£"><a href="#å…«è¿›åˆ¶å­—é¢é‡çš„è¯¯è§£" class="headerlink" title="å…«è¿›åˆ¶å­—é¢é‡çš„è¯¯è§£"></a>å…«è¿›åˆ¶å­—é¢é‡çš„è¯¯è§£</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sum := <span class="number">100</span> + <span class="number">010</span></span><br><span class="line">fmt.Println(sum)</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯èƒ½æœŸæœ›è¿™æ®µä»£ç ä¼šæ‰“å°å‡º 100 + 10 = 110 çš„ç»“æœã€‚ä½†å®é™…ä¸Šå®ƒæ‰“å°å‡ºäº† 108ã€‚</p>
<p>åœ¨Goè¯­è¨€ä¸­ï¼Œä»¥0å¼€å¤´çš„æ•´æ•°å­—é¢å€¼è¢«è®¤ä¸ºæ˜¯å…«è¿›åˆ¶æ•´æ•°ï¼Œå› æ­¤å…«è¿›åˆ¶æ•°10 ç­‰äºåè¿›åˆ¶æ•°8ã€‚å› æ­¤ï¼Œå‰é¢ä¾‹å­ä¸­çš„æ€»å’Œç­‰äº100 + 8 = 108ã€‚</p>
<p>å…«è¿›åˆ¶æ•´æ•°åœ¨ä¸åŒçš„åœºæ™¯ä¸­éå¸¸æœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æƒ³è¦ä½¿ç”¨ os.OpenFile æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ã€‚æ­¤å‡½æ•°éœ€è¦ä¼ é€’ä¸€ä¸ªuint32ä½œä¸ºæƒé™ã€‚å¦‚æœæˆ‘ä»¬æƒ³åŒ¹é… Linux æƒé™ï¼Œæˆ‘ä»¬å¯ä»¥ä¼ é€’ä¸€ä¸ªå…«è¿›åˆ¶æ•°ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªåè¿›åˆ¶æ•°ï¼Œä»¥æé«˜å¯è¯»æ€§ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file, err := os.OpenFile(<span class="string">"foo"</span>, os.O_RDONLY, <span class="number">0644</span>)</span><br></pre></td></tr></table></figure>
<p>è¿˜å¯ä»¥åœ¨é›¶åé¢æ·»åŠ ä¸€ä¸ªoå­—ç¬¦ï¼ˆå°å†™å­—æ¯oï¼‰ï¼Œä½¿ç”¨ 0o è€Œä¸ä»…ä»…æ˜¯ 0 ä½œä¸ºå‰ç¼€ï¼ŒäºŒè€…è¡¨è¾¾æ„æ€æ˜¯ç›¸åŒçš„ï¼Œä½†å®ƒå¯ä»¥å¸®åŠ©ä½¿ä»£ç æ›´æ¸…æ™°ã€‚ä¸ºäº†æé«˜å¯è¯»æ€§å¹¶é¿å…æœªæ¥ä»£ç è¯»è€…çš„æ½œåœ¨é”™è¯¯ï¼Œåº”æ˜ç¡®ä½¿ç”¨0oå‰ç¼€æ¥è¡¨ç¤ºå…«è¿›åˆ¶æ•°ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file, err := os.OpenFile(<span class="string">"foo"</span>, os.O_RDONLY, <span class="number">0</span>o644)</span><br></pre></td></tr></table></figure>
<p>å…¶ä»–å­—é¢é‡çš„è¡¨è¾¾æ–¹å¼ï¼š</p>
<ul>
<li>äºŒè¿›åˆ¶â€”â€”ä½¿ç”¨ 0b æˆ– 0B å‰ç¼€ï¼ˆä¾‹å¦‚ï¼Œ0b100 ç­‰äº 10 è¿›åˆ¶ä¸­çš„ 4ï¼‰</li>
<li>åå…­è¿›åˆ¶â€”â€”ä½¿ç”¨0xæˆ–0Xå‰ç¼€ï¼ˆä¾‹å¦‚ï¼Œ0xFç­‰äº10è¿›åˆ¶ä¸­çš„15ï¼‰</li>
<li>è™šæ•° - ä½¿ç”¨ i åç¼€ï¼ˆä¾‹å¦‚ï¼Œ3iï¼‰</li>
</ul>
<h3 id="æ•´æ•°æº¢å‡º"><a href="#æ•´æ•°æº¢å‡º" class="headerlink" title="æ•´æ•°æº¢å‡º"></a>æ•´æ•°æº¢å‡º</h3><p>Goè¯­è¨€æä¾›äº†10ç§æ•´å‹ç±»å‹ã€‚å…¶ä¸­åŒ…æ‹¬4ç§æœ‰ç¬¦å·æ•´å‹ç±»å‹å’Œ4ç§æ— ç¬¦å·æ•´å‹ç±»å‹ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤º</p>
<table>
<thead>
<tr>
<th>æœ‰ç¬¦å·æ•´æ•°</th>
<th>æ— ç¬¦å·æ•´æ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td>int8 (8 bits)</td>
<td>uint8 (8 bits)</td>
</tr>
<tr>
<td>int16 (16 bits)</td>
<td>uint16 (16 bits)</td>
</tr>
<tr>
<td>int32 (32 bits)</td>
<td>uint32 (32 bits)</td>
</tr>
<tr>
<td>int64 (64 bits)</td>
<td>uint64 (64 bits)</td>
</tr>
</tbody>
</table>
<p>å¦å¤–ä¸¤ç§æ•´æ•°ç±»å‹æ˜¯æœ€å¸¸ç”¨çš„ï¼šint å’Œ uintã€‚è¿™ä¸¤ç§ç±»å‹çš„å¤§å°å–å†³äºç³»ç»Ÿï¼šåœ¨ 32 ä½ç³»ç»Ÿä¸Šæ˜¯ 32 ä½ï¼Œåœ¨ 64 ä½ç³»ç»Ÿä¸Šæ˜¯ 64 ä½ã€‚</p>
<p>æº¢å‡ºçš„ä¾‹å­ï¼š</p>
<p>å‡è®¾æˆ‘ä»¬æƒ³è¦å°† int32 åˆå§‹åŒ–ä¸ºæœ€å¤§å€¼ï¼Œç„¶åé€’å¢å®ƒã€‚è¿™æ®µä»£ç çš„è¡Œä¸ºåº”è¯¥æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> counter <span class="keyword">int32</span> = math.MaxInt32</span><br><span class="line">counter++</span><br><span class="line">fmt.Printf(<span class="string">"counter=%d\n"</span>, counter)</span><br></pre></td></tr></table></figure>
<p>è¯¥ä»£ç å¯ä»¥ç¼–è¯‘ï¼Œå¹¶ä¸”åœ¨è¿è¡Œæ—¶ä¸ä¼šå‘ç”Ÿ panicã€‚ä½†æ˜¯ï¼Œcounter++ è¯­å¥ä¼šç”Ÿæˆæ•´æ•°æº¢å‡ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">counter=-2147483648</span><br></pre></td></tr></table></figure>
<p>æ•´å‹æº¢å‡ºæ˜¯æŒ‡ç®—æœ¯è¿ç®—äº§ç”Ÿä¸€ä¸ªå€¼ï¼Œè¶…å‡ºä¸€ä¸ªç»™å®šå­—èŠ‚æ•°é‡æ‰€èƒ½è¡¨ç¤ºçš„èŒƒå›´ã€‚ä¸€ä¸ª int32 ç±»å‹ä½¿ç”¨ 32 ä¸ªæ¯”ç‰¹ä½è¡¨ç¤ºã€‚ä»¥ä¸‹æ˜¯æœ€å¤§ int32 å€¼ï¼ˆmath.MaxInt32ï¼‰çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">01111111111111111111111111111111</span><br><span class="line"> |------31 bits set to 1-------|</span><br></pre></td></tr></table></figure>
<p>ç”±äº int32 æ˜¯æœ‰ç¬¦å·æ•´æ•°ï¼Œå·¦ä¾§çš„ä½è¡¨ç¤ºæ•´æ•°çš„ç¬¦å·ï¼š0 è¡¨ç¤ºæ­£æ•°ï¼Œ1 è¡¨ç¤ºè´Ÿæ•°ã€‚å¦‚æœæˆ‘ä»¬å°†è¿™ä¸ªæ•´æ•°é€’å¢ï¼Œå°±æ²¡æœ‰ç©ºé—´æ¥è¡¨ç¤ºæ–°å€¼ã€‚å› æ­¤ï¼Œè¿™å¯¼è‡´æ•´æ•°æº¢å‡º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">10000000000000000000000000000000</span><br><span class="line"> |------31 bits set to 0-------|</span><br></pre></td></tr></table></figure>
<p>æ­£å¦‚æˆ‘ä»¬æ‰€çœ‹åˆ°çš„ï¼Œç¬¦å·ä½ç°åœ¨ç­‰äº1ï¼Œè¡¨ç¤ºä¸ºè´Ÿæ•°ã€‚è¿™ä¸ªå€¼æ˜¯ç”¨32ä½è¡¨ç¤ºçš„æœ‰ç¬¦å·æ•´æ•°çš„æœ€å°å¯èƒ½å€¼ã€‚</p>
<p><strong>åœ¨ Go ä¸­ï¼Œç¼–è¯‘æ—¶èƒ½æ£€æµ‹åˆ°çš„æ•´æ•°æº¢å‡ºä¼šç”Ÿæˆç¼–è¯‘é”™è¯¯</strong>ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> counter <span class="keyword">int32</span> = math.MaxInt32 + <span class="number">1</span></span><br><span class="line">constant <span class="number">2147483648</span> overflows <span class="keyword">int32</span></span><br></pre></td></tr></table></figure>
<p>ç„¶è€Œï¼Œåœ¨è¿è¡Œæ—¶ï¼Œæ•´æ•°æº¢å‡ºæˆ–ä¸‹æº¢æ˜¯é™é»˜çš„ï¼›è¿™ä¸ä¼šå¯¼è‡´åº”ç”¨ç¨‹åºå´©æºƒã€‚å¿…é¡»è®°ä½è¿™ç§è¡Œä¸ºï¼Œå› ä¸ºå®ƒå¯èƒ½ä¼šå¯¼è‡´è®¨åŒçš„é”™è¯¯ï¼ˆä¾‹å¦‚ï¼Œæ•´æ•°çš„å¢é‡æˆ–æ­£æ•´æ•°çš„åŠ æ³•å¯¼è‡´è´Ÿç»“æœï¼‰</p>
<p><strong>é€’å¢æ—¶æ£€æµ‹æ•´æ•°æº¢å‡º</strong></p>
<p>å¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨åŸºäºå®šä¹‰å¤§å°çš„ç±»å‹ï¼ˆint8ï¼Œint16ï¼Œint32ï¼Œint64ï¼Œuint8ï¼Œuint16ï¼Œuint32æˆ–uint64ï¼‰ä¸Šè¿›è¡Œå¢é‡æ“ä½œæ—¶æ£€æµ‹æ•´æ•°æº¢å‡ºï¼Œæˆ‘ä»¬å¯ä»¥å°†è¯¥å€¼ä¸mathå¸¸æ•°è¿›è¡Œæ¯”è¾ƒã€‚ä¾‹å¦‚ï¼Œå¯¹äºint32ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Inc32</span><span class="params">(counter <span class="keyword">int32</span>)</span> <span class="title">int32</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> counter == math.MaxInt32 &#123;    â¶ ä¸ math.MaxInt32 æ¯”è¾ƒ</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">"int32 overflow"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> counter + <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­¤å‡½æ•°æ£€æŸ¥è¾“å…¥å€¼æ˜¯å¦å·²ç­‰äº math.MaxInt32ã€‚å¦‚æœæ˜¯é‚£æ ·ï¼Œæˆ‘ä»¬å°±çŸ¥é“ Inc32 å¢é‡æ“ä½œæ˜¯å¦ä¼šå¯¼è‡´æº¢å‡ºäº†ã€‚</p>
<p>å¯¹äºintï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">IncInt</span><span class="params">(counter <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> counter == math.MaxInt &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">"int overflow"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> counter + <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹äº uintï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">IncUint</span><span class="params">(counter <span class="keyword">uint</span>)</span> <span class="title">uint</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> counter == math.MaxUint &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">"uint overflow"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> counter + <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>åœ¨åŠ æ³•ä¸­æ£€æµ‹æ•´æ•°æº¢å‡º</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">AddInt</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> a &gt; math.MaxInt-b &#123;       â¶ æ£€æµ‹æ˜¯å¦æº¢å‡º</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">"int overflow"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>åœ¨ä¹˜æ³•ä¸­æ£€æµ‹æ•´æ•°æº¢å‡º</strong></p>
<p>ä¹˜æ³•è¿ç®—å¤„ç†èµ·æ¥ç¨å¾®æœ‰ç‚¹å¤æ‚ã€‚æˆ‘ä»¬éœ€è¦å¯¹æœ€å°æ•´æ•°math.MinIntè¿›è¡Œæ£€æŸ¥ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MultiplyInt</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> a == <span class="number">0</span> || b == <span class="number">0</span> &#123;                       â¶ å…¶ä¸­ä¸€ä¸ªä¸º<span class="number">0</span>ï¼Œç›´æ¥è¿”å› <span class="number">0</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    result := a * b</span><br><span class="line">    <span class="keyword">if</span> a == <span class="number">1</span> || b == <span class="number">1</span> &#123;                       â· æ£€æŸ¥æ“ä½œæ•°ä¹‹ä¸€æ˜¯å¦ç­‰äº<span class="number">1</span>ï¼Œç­‰äº<span class="number">1</span>åˆ™ç›´æ¥è¿”å› result</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">if</span> a == math.MinInt || b == math.MinInt &#123;   â¸ æ£€æŸ¥æ“ä½œæ•°ä¹‹ä¸€æ˜¯å¦ç­‰äº math.MinInt</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">"integer overflow"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> result/b != a &#123;                          â¹ æ£€æŸ¥ä¹˜æ³•æ˜¯å¦å¯¼è‡´æ•´æ•°æº¢å‡º</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">"integer overflow"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æµ‹è¯•å…¶ä¸­ä¸€ä¸ªè¿ç®—æ•°æ˜¯å¦ç­‰äº0ã€1æˆ–math.MinIntã€‚ç„¶åï¼Œæˆ‘ä»¬å°†ä¹˜æ³•ç»“æœé™¤ä»¥bã€‚å¦‚æœç»“æœä¸åŸå› æ•°ï¼ˆaï¼‰ä¸ç›¸ç­‰ï¼Œåˆ™è¡¨ç¤ºå‘ç”Ÿäº†æ•´æ•°æº¢å‡ºã€‚</p>
<p>ç®€è€Œè¨€ä¹‹ï¼Œåœ¨Goè¯­è¨€ä¸­ï¼Œæ•´æ•°æº¢å‡ºï¼ˆå’Œä¸‹æº¢ï¼‰æ˜¯ä¸å¸¦æç¤ºçš„æ“ä½œã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦æ£€æŸ¥æº¢å‡ºä»¥é¿å…ä¸æ˜é”™è¯¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æœ¬èŠ‚ä¸­æè¿°çš„å®ç”¨ç¨‹åºå‡½æ•°ã€‚æ­¤å¤–ï¼Œè¯·è®°ä½ï¼ŒGoè¯­è¨€æä¾›äº†ä¸€ä¸ªç”¨äºå¤„ç†å¤§å‹æ•°å­—çš„åŒ…ï¼šmath/bigã€‚å¦‚æœintç±»å‹ä¸å¤Ÿç”¨ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªé€‰æ‹©ã€‚</p>
<h3 id="æµ®ç‚¹"><a href="#æµ®ç‚¹" class="headerlink" title="æµ®ç‚¹"></a>æµ®ç‚¹</h3><p>åœ¨Goè¯­è¨€ä¸­ï¼Œé™¤äº†è™šæ•°ä¹‹å¤–ï¼Œæœ‰ä¸¤ç§æµ®ç‚¹æ•°ç±»å‹ï¼šfloat32å’Œfloat64ã€‚æµ®ç‚¹æ•°çš„æ¦‚å¿µæ˜¯ä¸ºäº†è§£å†³æ•´æ•°çš„ä¸»è¦é—®é¢˜ï¼šæ— æ³•è¡¨ç¤ºåˆ†æ•°å€¼ã€‚ä¸ºäº†é¿å…å‡ºç°æ„å¤–æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“æµ®ç‚¹æ•°è¿ç®—æ˜¯å®æ•°è¿ç®—çš„è¿‘ä¼¼å€¼ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> n <span class="keyword">float32</span> = <span class="number">1.0001</span></span><br><span class="line">fmt.Println(n * n)</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯èƒ½æœŸæœ›è¿™æ®µä»£ç æ‰“å°å‡º 1.0001 * 1.0001 çš„ç»“æœä¸º 1.00020001ï¼Œæ˜¯ä¸æ˜¯å¯¹çš„å‘¢ï¼Ÿç„¶è€Œï¼Œåœ¨å¤§å¤šæ•° x86 å¤„ç†å™¨ä¸Šè¿è¡Œå®ƒä¼šæ‰“å°å‡º 1.0002ã€‚é‚£æˆ‘ä»¬è¯¥å¦‚ä½•è§£é‡Šå‘¢ï¼Ÿ</p>
<p><code>math.SmallestNonzeroFloat64</code>ï¼ˆfloat64æœ€å°å€¼ï¼‰å’Œ <code>math.MaxFloat64</code>ï¼ˆfloat64æœ€å¤§å€¼ï¼‰ä¹‹é—´æœ‰æ— é™æ•°é‡çš„å®æ•°å€¼ã€‚ç›¸åï¼Œfloat64ç±»å‹å…·æœ‰æœ‰é™æ•°é‡çš„ä½æ•°ï¼š64ã€‚å› ä¸ºå°†æ— é™å€¼è£…å…¥æœ‰é™ç©ºé—´æ˜¯ä¸å¯èƒ½çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»ä½¿ç”¨è¿‘ä¼¼å€¼ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå¤±å»ç²¾åº¦ã€‚åŒæ ·çš„é€»è¾‘ä¹Ÿé€‚ç”¨äºfloat32ç±»å‹ã€‚</p>
<p>åœ¨Goä¸­ï¼Œæµ®ç‚¹æ•°éµå¾ªIEEE-754æ ‡å‡†ï¼Œå…¶ä¸­ä¸€äº›ä½è¡¨ç¤ºä½™æ•°ï¼Œå¦ä¸€äº›ä½è¡¨ç¤ºæŒ‡æ•°ã€‚ä½™æ•°æ˜¯ä¸€ä¸ªåŸºç¡€å€¼ï¼Œè€ŒæŒ‡æ•°æ˜¯åº”ç”¨äºä½™æ•°çš„ä¹˜æ•°ã€‚åœ¨å•ç²¾åº¦æµ®ç‚¹ç±»å‹ï¼ˆfloat32ï¼‰ä¸­ï¼Œ8ä¸ªä½è¡¨ç¤ºæŒ‡æ•°ï¼Œ23ä¸ªä½è¡¨ç¤ºä½™æ•°ã€‚åœ¨åŒç²¾åº¦æµ®ç‚¹ç±»å‹ï¼ˆfloat64ï¼‰ä¸­ï¼Œåˆ†åˆ«ä¸º11ä¸ªä½å’Œ52ä¸ªä½çš„æŒ‡æ•°å’Œä½™æ•°ã€‚å‰©ä½™ä¸€ä¸ªä½ç”¨äºè¡¨ç¤ºç¬¦å·ã€‚</p>
<ul>
<li><p>æ ‡è®°(sign)  â€”â€” è¡¨ç¤ºæ­£è´Ÿ</p>
</li>
<li><p>æŒ‡æ•°(exponent) â€”â€” float32(8ä½) ã€float64(11ä½)</p>
</li>
<li><p>å°¾æ•°(mantissa) â€”â€” float32(23ä½) ã€float64(52ä½)</p>
</li>
</ul>
<p>å…¬å¼ä¸ºï¼š<code>sign * 2^exponent * mantissa</code>ï¼Œä¾‹å¦‚ï¼šåœ¨float32ä¸­è¡¨ç¤º1.0001</p>
<p><img src="https://raw.githubusercontent.com/rexyan/warehouse/master/202308082155084.png" alt></p>
<p>ä¸€æ—¦æˆ‘ä»¬æ„è¯†åˆ° float32 å’Œ float64 æ˜¯è¿‘ä¼¼å€¼ã€‚åœ¨ä½¿ç”¨ == è¿ç®—ç¬¦æ¯”è¾ƒä¸¤ä¸ªæµ®ç‚¹æ•°å¯èƒ½ä¼šå¯¼è‡´ä¸å‡†ç¡®ã€‚ç›¸åï¼Œæˆ‘ä»¬åº”è¯¥æ¯”è¾ƒå®ƒä»¬çš„å·®å¼‚ï¼Œä»¥æŸ¥çœ‹å®ƒæ˜¯å¦å°äºæŸä¸ªå°é”™è¯¯å€¼ã€‚ä¾‹å¦‚ï¼Œ<a href="https://github.com/stretchr/testify" target="_blank" rel="noopener">testifyåº“</a> å…·æœ‰InDeltaå‡½æ•°ï¼Œä»¥æ–­è¨€ä¸¤ä¸ªå€¼æ˜¯å¦å½¼æ­¤ä¹‹é—´å·®å€¼åœ¨ç»™å®šçš„deltaå†…ã€‚</p>
<p>æµ®ç‚¹è¿ç®—çš„ç»“æœå–å†³äºå®é™…å¤„ç†å™¨ã€‚å¤§å¤šæ•°å¤„ç†å™¨éƒ½æœ‰æµ®ç‚¹å•å…ƒï¼ˆFPUï¼‰æ¥å¤„ç†è¿™ç§è®¡ç®—ã€‚ä¸èƒ½ä¿è¯åœ¨ä¸€å°æœºå™¨ä¸Šæ‰§è¡Œçš„ç»“æœä¸å…·æœ‰ä¸åŒFPUçš„å¦ä¸€å°æœºå™¨ä¸Šæ‰§è¡Œçš„ç»“æœç›¸åŒã€‚</p>
<p>Go è¿˜æ‹¥æœ‰ä¸‰ç§ç‰¹æ®Šçš„æµ®ç‚¹æ•°ï¼š</p>
<ul>
<li>æ­£æ— ç©·</li>
<li>è´Ÿæ— ç©·</li>
<li>NaN</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a <span class="keyword">float64</span></span><br><span class="line">positiveInf := <span class="number">1</span> / a</span><br><span class="line">negativeInf := <span class="number">-1</span> / a</span><br><span class="line">nan := a / a</span><br><span class="line">fmt.Println(positiveInf, negativeInf, nan)</span><br><span class="line"><span class="comment">// +Inf -Inf NaN</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨math.IsInf æ¥æ£€æŸ¥ä¸€ä¸ªæµ®ç‚¹æ•°æ˜¯å¦ä¸ºæ— ç©·å¤§ï¼Œä½¿ç”¨math.IsNaNæ¥æ£€æŸ¥å®ƒæ˜¯å¦ä¸ºNaNã€‚</p>
<p>è¯¯å·®è¿˜å¯ä»¥åœ¨æµ®ç‚¹æ•°çš„è®¡ç®—ä¸­ç§¯ç´¯ï¼Œæœ‰ä¸¤ä¸ªå‡½æ•°ä»¥ä¸åŒçš„é¡ºåºæ‰§è¡Œç›¸åŒçš„æ“ä½œåºåˆ—ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œf1é¦–å…ˆå°†float64åˆå§‹åŒ–ä¸º10,000ï¼Œç„¶åé‡å¤å°†1.0001åŠ åˆ°ç»“æœä¸­ï¼ˆnæ¬¡ï¼‰ã€‚ç›¸åï¼Œf2æŒ‰ç›¸åçš„é¡ºåºæ‰§è¡Œç›¸åŒçš„æ“ä½œï¼ˆåœ¨æœ«å°¾åŠ ä¸Š10,000ï¼‰</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f1</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="title">float64</span></span> &#123;</span><br><span class="line">    result := <span class="number">10</span>_000.</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</span><br><span class="line">        result += <span class="number">1.0001</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f2</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="title">float64</span></span> &#123;</span><br><span class="line">    result := <span class="number">0.</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</span><br><span class="line">        result += <span class="number">1.0001</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result + <span class="number">10</span>_000.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»“æœè¯¯å·®å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center">n</th>
<th style="text-align:left">Exact result</th>
<th style="text-align:left">f1</th>
<th style="text-align:left">f2</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">10</td>
<td style="text-align:left">10010.001</td>
<td style="text-align:left">10010.099999999993</td>
<td style="text-align:left">10010.001</td>
</tr>
<tr>
<td style="text-align:center">1k</td>
<td style="text-align:left">11000.1</td>
<td style="text-align:left">11000.099999999293</td>
<td style="text-align:left">11000.099999999982</td>
</tr>
<tr>
<td style="text-align:center">1m</td>
<td style="text-align:left">1.0101e+06</td>
<td style="text-align:left">1.0100999999761417e+06</td>
<td style="text-align:left">1.0100999999766762e+06</td>
</tr>
</tbody>
</table>
<p>nè¶Šå¤§ï¼Œè¯¯å·®è¶Šå¤§ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œf2çš„ç²¾åº¦æ¯”f1æ›´å¥½ã€‚ç»“è®ºæ˜¯ï¼Œå½“è¿›è¡Œä¸€ç³»åˆ—åŠ å‡æ“ä½œæ—¶ï¼Œæˆ‘ä»¬åº”è¯¥å°†å…·æœ‰ç›¸ä¼¼æ•°é‡çº§çš„å€¼è¿›è¡Œåˆ†ç»„ï¼Œç„¶åå†è¿›è¡ŒåŠ å‡è¿ç®—ï¼Œä»¥ä¾¿å…ˆè¿›è¡Œç›¸åŒæ•°é‡çº§çš„åŠ å‡è¿ç®—ï¼Œæœ€åå†è¿›è¡Œæ•°é‡çº§ä¸åŒçš„åŠ å‡æ“ä½œã€‚å› ä¸ºf2åŠ äº†ä¸€ä¸‡ï¼Œæ‰€ä»¥å®ƒæœ€ç»ˆä¼šå¾—åˆ°æ¯”f1æ›´å‡†ç¡®çš„ç»“æœã€‚</p>
<p>å¦ä¸€ä¸ªä¾‹å­æ˜¯ä¹˜æ³•çš„åˆ†é…å¾‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">a := <span class="number">100000.001</span></span><br><span class="line">b := <span class="number">1.0001</span></span><br><span class="line">c := <span class="number">1.0002</span></span><br><span class="line"> </span><br><span class="line">fmt.Println(a * (b + c))</span><br><span class="line">fmt.Println(a*b + a*c)</span><br><span class="line"><span class="comment">// 200030.00200030004</span></span><br><span class="line"><span class="comment">// 200030.0020003</span></span><br></pre></td></tr></table></figure>
<p>å‡†ç¡®çš„ç»“æœæ˜¯200,030.002ã€‚å› æ­¤ï¼Œç¬¬ä¸€æ¬¡è®¡ç®—å…·æœ‰æœ€å·®çš„å‡†ç¡®æ€§ã€‚å®é™…ä¸Šï¼Œå½“è¿›è¡Œæµ®ç‚¹æ•°åŠ æ³•ã€å‡æ³•ã€ä¹˜æ³•æˆ–é™¤æ³•çš„è®¡ç®—æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»å…ˆå®Œæˆä¹˜æ³•å’Œé™¤æ³•è¿ç®—ä»¥è·å¾—æ›´å¥½çš„å‡†ç¡®æ€§ã€‚æœ‰æ—¶ï¼Œè¿™å¯èƒ½ä¼šå½±å“æ‰§è¡Œæ—¶é—´ï¼ˆåœ¨å‰é¢çš„ä¾‹å­ä¸­ï¼Œéœ€è¦ä¸‰ä¸ªæ“ä½œè€Œä¸æ˜¯ä¸¤ä¸ªï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œéœ€è¦åœ¨å‡†ç¡®æ€§å’Œæ‰§è¡Œæ—¶é—´ä¹‹é—´åšå‡ºé€‰æ‹©ã€‚</p>
<p>æ€»ç»“ï¼š</p>
<ol>
<li>åœ¨æ¯”è¾ƒä¸¤ä¸ªæµ®ç‚¹æ•°æ—¶ï¼Œæ£€æŸ¥å®ƒä»¬çš„å·®å¼‚æ˜¯å¦åœ¨å¯æ¥å—çš„èŒƒå›´å†…ã€‚</li>
<li>åœ¨è¿›è¡ŒåŠ æ³•æˆ–å‡æ³•è¿ç®—æ—¶ï¼Œå°†å…·æœ‰ç›¸ä¼¼æ•°é‡çº§çš„è¿ç®—è¿›è¡Œåˆ†ç»„ï¼Œä»¥æé«˜ç²¾åº¦ã€‚</li>
<li>ä¸ºäº†ä¿è¯å‡†ç¡®æ€§ï¼Œå¦‚æœä¸€ç³»åˆ—æ“ä½œéœ€è¦è¿›è¡ŒåŠ å‡ä¹˜é™¤ï¼Œåº”å…ˆæ‰§è¡Œä¹˜æ³•å’Œé™¤æ³•è¿ç®—ã€‚</li>
</ol>
<h3 id="åˆ‡ç‰‡é•¿åº¦å’Œå®¹é‡"><a href="#åˆ‡ç‰‡é•¿åº¦å’Œå®¹é‡" class="headerlink" title="åˆ‡ç‰‡é•¿åº¦å’Œå®¹é‡"></a>åˆ‡ç‰‡é•¿åº¦å’Œå®¹é‡</h3><p><code>length</code>è¡¨ç¤ºå½“å‰çš„é•¿åº¦ï¼Œ<code>capacity</code>è¡¨ç¤ºå®¹é‡ã€‚å¦‚æœä¸¤è€…ç›¸ç­‰ï¼Œå†<code>append</code>å°±ä¼šè§¦å‘æ‰©å®¹ã€‚å¦‚æœåˆ‡ç‰‡çš„å®¹é‡å°äº 1,024 ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆåˆ‡ç‰‡ä¼šå…ˆæŒ‰ç…§ä¸¤å€æ‰©å……ï¼Œä¹‹åå†æŒ‰ç…§ 25% çš„é€Ÿåº¦æ‰©å……ã€‚</p>
<h3 id="åˆ‡ç‰‡åˆå§‹åŒ–"><a href="#åˆ‡ç‰‡åˆå§‹åŒ–" class="headerlink" title="åˆ‡ç‰‡åˆå§‹åŒ–"></a>åˆ‡ç‰‡åˆå§‹åŒ–</h3><p>åœ¨ä½¿ç”¨makeåˆå§‹åŒ–ä¸€ä¸ªåˆ‡ç‰‡æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»æä¾›é•¿åº¦å’Œå¯é€‰å®¹é‡ã€‚å¿˜è®°ä¼ é€’è¿™ä¸¤ä¸ªå‚æ•°ä¸­çš„ä»»ä¸€ä¸ªé€‚å½“çš„å€¼éƒ½æ˜¯ä¸€ä¸ªæ™®éçš„é”™è¯¯ã€‚</p>
<p>å‡è®¾æˆ‘ä»¬æƒ³è¦å®ç°ä¸€ä¸ªè½¬æ¢å‡½æ•°ï¼Œå°†ä¸€ä¸ª Foo åˆ‡ç‰‡æ˜ å°„ä¸ºä¸€ä¸ª Bar åˆ‡ç‰‡ï¼Œå¹¶ä¸”ä¸¤ä¸ªåˆ‡ç‰‡å…·æœ‰ç›¸åŒæ•°é‡çš„å…ƒç´ ã€‚è¿™æ˜¯ç¬¬ä¸€ç§å®ç°ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">convert</span><span class="params">(foos []Foo)</span> []<span class="title">Bar</span></span> &#123;</span><br><span class="line">    bars := <span class="built_in">make</span>([]Bar, <span class="number">0</span>)                   â¶ åˆ›å»ºä¿å­˜çš„åˆ‡ç‰‡</span><br><span class="line">    <span class="keyword">for</span> _, foo := <span class="keyword">range</span> foos &#123;</span><br><span class="line">        bars = <span class="built_in">append</span>(bars, fooToBar(foo))   â· å°† Foo è½¬ä¸º Bar å¹¶å°†å…¶æ·»åŠ åˆ°åˆ‡ç‰‡ä¸­</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bars</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸€å¼€å§‹ï¼Œbars æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥æ·»åŠ ç¬¬ä¸€ä¸ªå…ƒç´ ä¼šåˆ†é…ä¸€ä¸ªå¤§å°ä¸º1çš„æ•°ç»„ã€‚æ¯æ¬¡æ”¯æŒæ•°ç»„æ»¡äº†ï¼ŒGoä¼šåˆ›å»ºå¦ä¸€ä¸ªæ•°ç»„ï¼Œå°†å®¹é‡åŠ å€ã€‚å½“æˆ‘ä»¬æ·»åŠ ç¬¬ä¸‰ä¸ªå…ƒç´ ã€ç¬¬äº”ä¸ªå…ƒç´ ã€ç¬¬ä¹ä¸ªå…ƒç´ æ—¶ï¼Œå› ä¸ºå½“å‰æ•°ç»„å·²æ»¡ï¼Œæ‰€ä»¥ä¼šå†æ¬¡åˆ›å»ºå¦ä¸€ä¸ªæ•°ç»„çš„é€»è¾‘ä¼šé‡å¤å‡ºç°å¤šæ¬¡ã€‚</p>
<p>å‡è®¾è¾“å…¥çš„ foos è¶…è¿‡ 1,000ä¸ªå…ƒç´ ï¼Œè¿™ä¸ªç®—æ³•å°†åˆ†é…10ä¸ªæ•°ç»„ï¼ˆæ¯æ¬¡æŒ‰ç…§ä¸¤å€æ‰©å®¹ï¼‰ï¼Œå¹¶åœ¨æ€»å…±ä»ä¸€ä¸ªæ•°ç»„å¤åˆ¶è¶…è¿‡1,000ä¸ªå…ƒç´ ã€‚è¿™å¯¼è‡´ GC éœ€è¦é¢å¤–çš„å·¥ä½œæ¥æ¸…ç†æ‰€æœ‰è¿™äº›ä¸´æ—¶æ•°ç»„ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹ç¬¬äºŒç§å†™æ³•ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">convert</span><span class="params">(foos []Foo)</span> []<span class="title">Bar</span></span> &#123;</span><br><span class="line">    n := <span class="built_in">len</span>(foos)</span><br><span class="line">    bars := <span class="built_in">make</span>([]Bar, <span class="number">0</span>, n)                â¶ é•¿åº¦è®¾ç½®ä¸º<span class="number">0</span>ï¼Œå®¹é‡ä¸º foos çš„é•¿åº¦</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> _, foo := <span class="keyword">range</span> foos &#123;</span><br><span class="line">        bars = <span class="built_in">append</span>(bars, fooToBar(foo))   â· å°† Foo è½¬ä¸º Bar å¹¶å°†å…¶æ·»åŠ åˆ°åˆ‡ç‰‡ä¸­</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bars</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ–è€…ç›´æ¥åˆ†é…é•¿åº¦ï¼Œè€Œä¸æ˜¯å®¹é‡</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">convert</span><span class="params">(foos []Foo)</span> []<span class="title">Bar</span></span> &#123;</span><br><span class="line">    n := <span class="built_in">len</span>(foos)</span><br><span class="line">    bars := <span class="built_in">make</span>([]Bar, n)         â¶ æ ¹æ®ç»™å®šçš„é•¿åº¦åˆå§‹åŒ–</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> i, foo := <span class="keyword">range</span> foos &#123;</span><br><span class="line">        bars[i] = fooToBar(foo)    â· è®¾ç½®åˆ‡ç‰‡çš„ç¬¬ i ä¸ªå…ƒç´ ã€‚æ³¨æ„è¿™é‡Œä¸æ˜¯ <span class="built_in">append</span> äº†</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bars</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºæˆ‘ä»¬ä½¿ç”¨é•¿åº¦åˆå§‹åŒ–äº†åˆ‡ç‰‡ï¼Œnä¸ªå…ƒç´ å·²ç»è¢«åˆ†é…å¹¶åˆå§‹åŒ–ä¸ºBarçš„é›¶å€¼ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä¸æ˜¯ä½¿ç”¨appendï¼Œè€Œæ˜¯ä½¿ç”¨bars[i]ã€‚</p>
<p>æ¯”è¾ƒä¸‰ä¸ªæ–¹æ¡ˆï¼Œå½“æˆ‘ä»¬ä¸æ–­åˆ†é…æ•°ç»„å’Œå¤åˆ¶å…ƒç´ æ—¶ï¼Œç¬¬ä¸€ä¸ªåŸºå‡†æµ‹è¯•æ¯”å¦å¤–ä¸¤ä¸ªæ…¢äº†è¿‘400%ã€‚æ¯”è¾ƒç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªè§£å†³æ–¹æ¡ˆï¼Œç¬¬ä¸‰ä¸ªæ–¹æ¡ˆå¿«äº†çº¦4ï¼…ï¼Œå› ä¸ºæˆ‘ä»¬é¿å…äº†å¯¹å†…ç½®çš„appendå‡½æ•°çš„é‡å¤è°ƒç”¨ï¼Œè¿™ä¸ç›´æ¥èµ‹å€¼ç›¸æ¯”æœ‰ä¸€äº›å¼€é”€ã€‚ä½¿ç”¨åˆ‡ç‰‡çš„ä¸‹æ ‡æ¥æ“ä½œåˆ‡ç‰‡è™½ç„¶æ¯” append è¦å¿«ï¼Œä½†æ˜¯åœ¨å¯è¯»æ€§ä¸Šæœ‰æ‰€ç¼ºå¤±ï¼Œç‰¹åˆ«æ˜¯ä»£ç é€»è¾‘æ¯”è¾ƒå¤æ‚çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶ä¸­è¿›è¡Œå–èˆï¼Œæ‰¾åˆ°åˆé€‚è‡ªå·±çš„ã€‚</p>
<h3 id="nil-åˆ‡ç‰‡å’Œ-empty-åˆ‡ç‰‡"><a href="#nil-åˆ‡ç‰‡å’Œ-empty-åˆ‡ç‰‡" class="headerlink" title="nil åˆ‡ç‰‡å’Œ empty åˆ‡ç‰‡"></a>nil åˆ‡ç‰‡å’Œ empty åˆ‡ç‰‡</h3><p>å®šä¹‰ï¼š</p>
<ol>
<li>å¦‚æœä¸€ä¸ª slice çš„é•¿åº¦ä¸º 0ï¼Œå®ƒå°±æ˜¯ç©ºçš„ã€‚</li>
<li>å¦‚æœä¸€ä¸ªåˆ‡ç‰‡ç­‰äºnilï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯nilã€‚</li>
</ol>
<p>çŒœçŒœä»¥ä¸‹ä»£ç çš„è¾“å‡ºæ˜¯ä»€ä¹ˆï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> s []<span class="keyword">string</span>         â¶ empty=<span class="literal">true</span>   <span class="literal">nil</span>=<span class="literal">true</span></span><br><span class="line">    log(<span class="number">1</span>, s)</span><br><span class="line"> </span><br><span class="line">    s = []<span class="keyword">string</span>(<span class="literal">nil</span>)      â· empty=<span class="literal">true</span>   <span class="literal">nil</span>=<span class="literal">true</span></span><br><span class="line">    log(<span class="number">2</span>, s)</span><br><span class="line"> </span><br><span class="line">    s = []<span class="keyword">string</span>&#123;&#125;         â¸ empty=<span class="literal">true</span>   <span class="literal">nil</span>=<span class="literal">false</span></span><br><span class="line">    log(<span class="number">3</span>, s)</span><br><span class="line"> </span><br><span class="line">    s = <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="number">0</span>)  â¹ empty=<span class="literal">true</span>   <span class="literal">nil</span>=<span class="literal">false</span></span><br><span class="line">    log(<span class="number">4</span>, s)</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">log</span><span class="params">(i <span class="keyword">int</span>, s []<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    fmt.Printf(<span class="string">"%d: empty=%t\tnil=%t\n"</span>, i, <span class="built_in">len</span>(s) == <span class="number">0</span>, s == <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">1: empty=true   nil=true</span></span><br><span class="line"><span class="string">2: empty=true   nil=true</span></span><br><span class="line"><span class="string">3: empty=true   nil=false</span></span><br><span class="line"><span class="string">4: empty=true   nil=false</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šå››ç§åˆ›å»ºåˆ‡ç‰‡çš„æ–¹å¼ï¼Œåˆ†åˆ«é€‚åˆåœ¨ä»€ä¹ˆåœºæ™¯ä¸‹ä½¿ç”¨å‘¢:</p>
<ol>
<li><code>var s []string</code>ä¸ç¡®å®šæœ€ç»ˆé•¿åº¦å¹¶ä¸” slice å¯ä»¥ä¸ºç©ºæ—¶</li>
<li><code>s = []string(nil)</code>ä½œä¸ºè¯­æ³•ç³–åˆ›å»ºä¸€ä¸ª nil slice</li>
<li><code>s = []string{}</code>åœ¨æœ‰åˆå§‹åŒ–å…ƒç´ çš„æ—¶å€™ä½¿ç”¨</li>
<li><code>s = make([]string, 0)</code>é•¿åº¦å·²çŸ¥</li>
</ol>
<p>ç»“è®ºï¼š</p>
<ol>
<li><p>ä¸€ä¸ª nil slice å’Œä¸€ä¸ªç©ºçš„ slice çš„ä¸»è¦åŒºåˆ«ä¹‹ä¸€åœ¨äºåˆ†é…ã€‚åˆå§‹åŒ–ä¸€ä¸ª nil slice ä¸éœ€è¦åˆ†é…ä»»ä½•å†…å­˜ç©ºé—´ï¼Œè€Œç©ºçš„ slice åˆ™ä¸æ˜¯è¿™ç§æƒ…å†µã€‚</p>
</li>
<li><p>æ— è®ºåˆ‡ç‰‡æ˜¯å¦ä¸º nilï¼Œè°ƒç”¨ append å†…ç½®å‡½æ•°éƒ½èƒ½æ­£å¸¸å·¥ä½œã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s1 []<span class="keyword">string</span></span><br><span class="line">fmt.Println(<span class="built_in">append</span>(s1, <span class="string">"foo"</span>)) <span class="comment">// [foo]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>å½“æ–¹æ³•è¿”å›åˆ‡ç‰‡çš„æ—¶å€™ï¼Œå¦‚æœå¯èƒ½ï¼Œåº”è¯¥è¿”å›ä¸€ä¸ª nil sliceï¼Œè€Œä¸æ˜¯ä¸€ä¸ªç©ºåˆ‡ç‰‡ã€‚ä¾‹å¦‚ä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">()</span> []<span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> s []<span class="keyword">string</span>  				<span class="comment">// nil åˆ‡ç‰‡</span></span><br><span class="line">    <span class="keyword">if</span> foo() &#123;</span><br><span class="line">        s = <span class="built_in">append</span>(s, <span class="string">"foo"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> bar() &#123;</span><br><span class="line">        s = <span class="built_in">append</span>(s, <span class="string">"bar"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s  							<span class="comment">// å¦‚æœä¸Šè¿° if éƒ½ä¸æˆç«‹ï¼Œé‚£ä¹ˆè¿”å›ä¸€ä¸ª nil åˆ‡ç‰‡ã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¸€äº›åŒ…åˆ‡åˆ† nil åˆ‡ç‰‡å’Œ ç©ºåˆ‡ç‰‡ï¼Œæ¯”å¦‚åœ¨ encoding/json åŒ…ä¸­å°±æ˜¯å¦‚æ­¤ã€‚ä¸€ä¸ªç©ºçš„åˆ‡ç‰‡ä¼šè¢«åºåˆ—åŒ–æˆä¸€ä¸ª null å…ƒç´ ï¼Œè€Œä¸€ä¸ªéç©ºçš„ç©ºåˆ‡ç‰‡ä¼šè¢«åºåˆ—åŒ–æˆä¸€ä¸ªç©ºæ•°ç»„ã€‚è¿˜æœ‰åœ¨ä½¿ç”¨ <code>reflect.DeepEqual</code> æ¯”è¾ƒä¸€ä¸ª nil å’Œä¸€ä¸ªé nil çš„ç©ºåˆ‡ç‰‡æ—¶ï¼Œå°†ä¼šè¿”å› falseã€‚</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s1 []<span class="keyword">float32</span>                 â¶ <span class="literal">nil</span> åˆ‡ç‰‡</span><br><span class="line">customer1 := customer&#123;</span><br><span class="line">    ID:         <span class="string">"foo"</span>,</span><br><span class="line">    Operations: s1,</span><br><span class="line">&#125;</span><br><span class="line">b, _ := json.Marshal(customer1)</span><br><span class="line">fmt.Println(<span class="keyword">string</span>(b))</span><br><span class="line"> </span><br><span class="line">s2 := <span class="built_in">make</span>([]<span class="keyword">float32</span>, <span class="number">0</span>)         â· ç©ºåˆ‡ç‰‡</span><br><span class="line">customer2 := customer&#123;</span><br><span class="line">    ID:         <span class="string">"bar"</span>,</span><br><span class="line">    Operations: s2,</span><br><span class="line">&#125;</span><br><span class="line">b, _ = json.Marshal(customer2)</span><br><span class="line">fmt.Println(<span class="keyword">string</span>(b))</span><br><span class="line"></span><br><span class="line"><span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">&#123;"</span>ID<span class="string">":"</span>foo<span class="string">","</span>Operations<span class="string">":null&#125;</span></span><br><span class="line"><span class="string">&#123;"</span>ID<span class="string">":"</span>bar<span class="string">","</span>Operations<span class="string">":[]&#125;</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="æ£€æŸ¥åˆ‡ç‰‡æ˜¯å¦ä¸ºç©º"><a href="#æ£€æŸ¥åˆ‡ç‰‡æ˜¯å¦ä¸ºç©º" class="headerlink" title="æ£€æŸ¥åˆ‡ç‰‡æ˜¯å¦ä¸ºç©º"></a>æ£€æŸ¥åˆ‡ç‰‡æ˜¯å¦ä¸ºç©º</h3><p>åˆ¤æ–­ä¸€ä¸ªåˆ‡ç‰‡æ˜¯å¦åŒ…å«å…ƒç´ çš„æƒ¯ç”¨æ–¹æ³•æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>ä»¥ä¸‹ä»£ç æ˜¯ä¸ªé”™è¯¯ç¤ºä¾‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleOperations</span><span class="params">(id <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    operations := getOperations(id)</span><br><span class="line">    <span class="keyword">if</span> operations != <span class="literal">nil</span> &#123;                  â¶ æ£€æŸ¥åˆ‡ç‰‡æ˜¯å¦ä¸º <span class="literal">nil</span></span><br><span class="line">        handle(operations)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getOperations</span><span class="params">(id <span class="keyword">string</span>)</span> []<span class="title">float32</span></span> &#123;</span><br><span class="line">    operations := <span class="built_in">make</span>([]<span class="keyword">float32</span>, <span class="number">0</span>)        â· åˆ›å»ºä¸€ä¸ª ç©ºåˆ‡ç‰‡</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> id == <span class="string">""</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> operations                   â¸ è¿”å›ç©ºåˆ‡ç‰‡</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Add elements to operations</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> operations</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä»£ç ä¸­ï¼Œ operationsï¼= nil å°†å§‹ç»ˆä¸º trueã€‚å› ä¸ºæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç©ºåˆ‡ç‰‡ã€‚</p>
<p>æˆ‘ä»¬æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š</p>
<p>æ–¹æ¡ˆ1: å½“ <code>id == &quot;&quot;</code> æ—¶ï¼Œè¿”å› nil è€Œä¸æ˜¯åˆ›å»ºçš„ ç©ºåˆ‡ç‰‡</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getOperations</span><span class="params">(id <span class="keyword">string</span>)</span> []<span class="title">float32</span></span> &#123;</span><br><span class="line">    operations := <span class="built_in">make</span>([]<span class="keyword">float32</span>, <span class="number">0</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> id == <span class="string">""</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>      â¶ è¿”å› <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Add elements to operations</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> operations</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ–¹æ¡ˆ2: æ£€æŸ¥åˆ‡ç‰‡çš„é•¿åº¦</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleOperations</span><span class="params">(id <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    operations := getOperations(id)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(operations) != <span class="number">0</span> &#123;          â¶ æ£€æŸ¥é•¿åº¦è€Œä¸æ˜¯åˆ¤æ–­æ˜¯å¦ä¸º <span class="literal">nil</span></span><br><span class="line">        handle(operations)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› æ­¤ï¼Œä¸ç®¡åˆ‡ç‰‡æ˜¯ nil è¿˜æ˜¯ç©ºï¼Œé•¿åº¦æ€»æ˜¯ä¸º 0ã€‚æ‰€ä»¥æ£€æŸ¥é•¿åº¦æ˜¯åˆ¤æ–­ä¸€ä¸ªåˆ‡ç‰‡æ˜¯å¦åŒ…å«å…ƒç´ çš„æƒ¯ç”¨æ–¹æ³•ã€‚è¿™ä¸ªè§„åˆ™åŒæ ·é€‚ç”¨äº mapï¼Œè¦æ£€æŸ¥ map æ˜¯å¦ä¸ºç©ºï¼Œåº”è¯¥æ£€æŸ¥å…¶é•¿åº¦ï¼Œè€Œä¸æ˜¯åˆ¤æ–­å®ƒæ˜¯å¦ä¸º nilã€‚</p>
<h3 id="copy-åˆ‡ç‰‡"><a href="#copy-åˆ‡ç‰‡" class="headerlink" title="copy åˆ‡ç‰‡"></a>copy åˆ‡ç‰‡</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">src := []<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>&#125;</span><br><span class="line"><span class="keyword">var</span> dst []<span class="keyword">int</span></span><br><span class="line"><span class="built_in">copy</span>(dst, src)</span><br><span class="line">fmt.Println(dst)</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä»£ç ä¸­ï¼Œæ‰“å°çš„ dst å€¼ä¸º []ã€‚src æ˜¯ä¸€ä¸ªé•¿åº¦ä¸º 3 çš„åˆ‡ç‰‡ï¼Œè€Œ dst æ˜¯ä¸€ä¸ªé•¿åº¦ä¸º 0 çš„åˆ‡ç‰‡ï¼Œå› ä¸ºå®ƒè¢«åˆå§‹åŒ–ä¸ºå®ƒçš„é›¶å€¼ã€‚å› æ­¤ï¼Œcopy å‡½æ•°åªä¼šå¤åˆ¶æœ€å°‘æ•°é‡çš„å…ƒç´ ï¼ˆåœ¨ 0 å’Œ 3 ä¹‹é—´ï¼‰ï¼šåœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯ 0ã€‚æœ€ç»ˆå¾—åˆ°ä¸€ä¸ªç©ºçš„åˆ‡ç‰‡ã€‚æ‰€ä»¥ï¼Œå¤åˆ¶åˆ°ç›®æ ‡åˆ‡ç‰‡çš„å…ƒç´ æ•°é‡å–å†³äºä»¥ä¸‹ä¸¤è€…ä¸­çš„æœ€å°å€¼</p>
<ul>
<li>æºåˆ‡ç‰‡çš„é•¿åº¦</li>
<li>ç›®æ ‡åˆ‡ç‰‡çš„é•¿åº¦</li>
</ul>
<p>æ­£ç¡®ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">src := []<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>&#125;</span><br><span class="line">dst := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="built_in">len</span>(src))     â¶ åˆ›å»ºä¸€ä¸ªç»™å®šé•¿åº¦çš„ dst åˆ‡ç‰‡</span><br><span class="line"><span class="built_in">copy</span>(dst, src)  <span class="comment">// ç›®æ ‡æ˜¯å‰ä¸€ä¸ªå‚æ•°ï¼Œè€Œæºæ˜¯åä¸€ä¸ªå‚æ•°</span></span><br><span class="line">fmt.Println(dst)</span><br></pre></td></tr></table></figure>
<p>è¿˜æœ‰ä¸€ç§æ–¹æ¡ˆæ˜¯ä½¿ç”¨ append</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">src := []<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>&#125;</span><br><span class="line">dst := <span class="built_in">append</span>([]<span class="keyword">int</span>(<span class="literal">nil</span>), src...)</span><br></pre></td></tr></table></figure>
<h3 id="slice-å…±äº«åº•å±‚æ•°ç»„å¸¦æ¥çš„é—®é¢˜"><a href="#slice-å…±äº«åº•å±‚æ•°ç»„å¸¦æ¥çš„é—®é¢˜" class="headerlink" title="slice å…±äº«åº•å±‚æ•°ç»„å¸¦æ¥çš„é—®é¢˜"></a>slice å…±äº«åº•å±‚æ•°ç»„å¸¦æ¥çš„é—®é¢˜</h3><p>ç”±äº slice åº•å±‚çš„ data æŒ‡å‘çš„åŒä¸€å—è¿ç»­å†…å­˜ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬åœ¨åˆ‡ç‰‡ç„¶åå†è¿›è¡Œ append çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šä¿®æ”¹åˆ°åº•å±‚çš„æ•°ç»„ï¼Œä»è€Œå½±å“æ•´ä¸ª sliceã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s1 := []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line">s2 := s1[<span class="number">1</span>:<span class="number">2</span>]</span><br><span class="line">s3 := <span class="built_in">append</span>(s2, <span class="number">10</span>)</span><br><span class="line"><span class="comment">// ä¸Šè¿°ä»£ç ä¸­ï¼Œs1=[1 2 10], s2=[2], s3=[2 10]</span></span><br></pre></td></tr></table></figure>
<p>ä¾‹å¦‚ï¼šä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸‰ä¸ªå…ƒç´ åˆå§‹åŒ–ä¸€ä¸ªåˆ‡ç‰‡ï¼Œå¹¶ä»…å°†å‰ä¸¤ä¸ªå…ƒç´ ä¼ é€’ç»™ä¸€ä¸ªå‡½æ•°ã€‚ç„¶ååœ¨ f ä¸­è°ƒç”¨ appendï¼Œå®ƒå°†ä¼šæ›´æ–°åˆ‡ç‰‡çš„ç¬¬ä¸‰ä¸ªå…ƒç´ ï¼Œå³ä½¿æˆ‘ä»¬åªä¼ é€’äº†ä¸¤ä¸ªå…ƒç´ ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    s := []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line"> </span><br><span class="line">    f(s[:<span class="number">2</span>])</span><br><span class="line">    fmt.Println(s) <span class="comment">// [1 2 10]</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">(s []<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    _ = <span class="built_in">append</span>(s, <span class="number">10</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¬¬ä¸€ç§è§£å†³æ–¹æ³•ï¼šå¤åˆ¶åˆ‡ç‰‡ï¼Œä¼ é€’åˆ‡ç‰‡çš„å‰¯æœ¬</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    s := []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line">    sCopy := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">2</span>)</span><br><span class="line">    <span class="built_in">copy</span>(sCopy, s)                    â¶ å°†sçš„å‰ä¸¤ä¸ªå…ƒç´ å¤åˆ¶åˆ° sCopy ä¸­</span><br><span class="line"> </span><br><span class="line">    f(sCopy)</span><br><span class="line">    result := <span class="built_in">append</span>(sCopy, s[<span class="number">2</span>])     â· å°†s[<span class="number">2</span>] æ·»åŠ åˆ° sCopy ä¸­</span><br><span class="line">    <span class="comment">// Use result</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">(s []<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// Update s</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¬¬äºŒç§æ–¹æ³•ï¼šä½¿ç”¨å®Œæ•´åˆ‡ç‰‡è¡¨è¾¾å¼ s [low:high:max]ã€‚ æ­¤è¯­å¥åˆ›å»ºä¸€ä¸ªç±»ä¼¼äºä½¿ç”¨s [lowï¼šhigh]åˆ›å»ºçš„åˆ‡ç‰‡ï¼Œåªæ˜¯æ‰€å¾—åˆ°çš„åˆ‡ç‰‡å®¹é‡ç­‰äºmax-lowã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    s := []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line">    f(s[:<span class="number">2</span>:<span class="number">2</span>])            â¶ å®Œæ•´çš„åˆ‡ç‰‡è¡¨è¾¾å¼ä¼ é€’å­åˆ‡ç‰‡ï¼Œå­åˆ‡ç‰‡çš„å®¹é‡ä¸º <span class="number">2</span></span><br><span class="line">    <span class="comment">// Use s</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">(s []<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// Update s</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ğŸ¡æ€»ç»“</strong></p>
<p>å¦‚æœä»ä¸€ä¸ªåˆ‡ç‰‡ç”Ÿæˆä¸€ä¸ªå­åˆ‡ç‰‡ï¼Œä½†æ˜¯å¦‚æœç”Ÿæˆçš„å­åˆ‡ç‰‡é•¿åº¦å°äºå…¶å®¹é‡ï¼Œåˆ™ append åˆ°å­åˆ‡ç‰‡çš„æ•°æ®å¯èƒ½ä¼šä¿®æ”¹åŸå§‹åˆ‡ç‰‡ã€‚ä¸ºäº†é™åˆ¶å¯èƒ½å‰¯ä½œç”¨çš„èŒƒå›´ï¼Œæˆ‘ä»¬å¯ä»¥ copy å‡ºä¸€ä¸ªåˆ‡ç‰‡å‰¯æœ¬ï¼Œæˆ–ä½¿ç”¨å®Œæ•´çš„åˆ‡ç‰‡è¡¨è¾¾å¼æ¥è§£å†³è¿™ç§é—®é¢˜ã€‚</p>
<h3 id="åˆ‡ç‰‡å†…å­˜æ³„æ¼"><a href="#åˆ‡ç‰‡å†…å­˜æ³„æ¼" class="headerlink" title="åˆ‡ç‰‡å†…å­˜æ³„æ¼"></a>åˆ‡ç‰‡å†…å­˜æ³„æ¼</h3><p><strong>åˆ‡ç‰‡å®¹é‡å¯¼è‡´çš„å†…å­˜æ³„æ¼</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">consumeMessages</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        msg := receiveMessage()      â¶ å‡è®¾ä¸€ä¸ªæ¶ˆæ¯åŒ…å«ä¸€ç™¾ä¸‡ä¸ªå­—èŠ‚ï¼Œå‰äº”ä¸ªå­—èŠ‚è¡¨ç¤ºæ¶ˆæ¯çš„ç±»å‹</span><br><span class="line">        <span class="comment">// Do something with msg</span></span><br><span class="line">        storeMessageType(getMessageType(msg))    â· åœ¨å†…å­˜ä¸­å­˜å‚¨æœ€æ–°çš„<span class="number">1000</span>ä¸ªæ¶ˆæ¯ç±»å‹</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getMessageType</span><span class="params">(msg []<span class="keyword">byte</span>)</span> []<span class="title">byte</span></span> &#123;         â¸ é€šè¿‡åˆ‡ç‰‡è·å–æ¶ˆæ¯ç±»å‹</span><br><span class="line">    <span class="keyword">return</span> msg[:<span class="number">5</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä»£ç è¿è¡Œä¼šéå¸¸æ¶ˆè€—å†…å­˜ï¼Œå› ä¸ºä½¿ç”¨ msg[:5] è¿›è¡Œåˆ‡ç‰‡æ“ä½œå¯ä»¥åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º 5 çš„åˆ‡ç‰‡ã€‚ç„¶è€Œï¼Œå®ƒçš„å®¹é‡ä»ä¸åˆå§‹åˆ‡ç‰‡ç›¸åŒã€‚å³ä½¿æœ€ç»ˆ msg æœªè¢«å¼•ç”¨ï¼Œå…¶ä½™å…ƒç´ ä»ä¼šè¢«åˆ†é…åœ¨å†…å­˜ä¸­ã€‚</p>
<p><img src="https://raw.githubusercontent.com/rexyan/warehouse/master/202308142134038.png" alt></p>
<p>æ–°çš„å¾ªç¯ä¹‹åï¼Œmsgä¸å†ä½¿ç”¨ã€‚ç„¶è€Œï¼Œmsg[:5]ä»ç„¶ä¼šä½¿ç”¨å®ƒçš„åº•å±‚æ•°ç»„ã€‚åˆ‡ç‰‡çš„åº•å±‚æ•°ç»„ä»åŒ…å« 100ä¸‡å­—èŠ‚ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬å°†1,000æ¡æ¶ˆæ¯ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œæˆ‘ä»¬å°†æŒæœ‰å¤§çº¦1 GBè€Œä¸æ˜¯å¤§çº¦5 KBçš„ç©ºé—´ã€‚</p>
<p>è§£å†³æ–¹æ³•ï¼š</p>
<p>æˆ‘ä»¬å¯ä»¥å¤åˆ¶ä¸€ä¸ªåˆ‡ç‰‡ï¼Œè€Œä¸æ˜¯å¯¹ msg è¿›è¡Œåˆ‡ç‰‡æ“ä½œæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å› ä¸ºæˆ‘ä»¬æ‰§è¡Œ copyï¼Œæ‰€ä»¥æ— è®ºæ¥æ”¶åˆ°çš„æ¶ˆæ¯å¤§å°å¦‚ä½•ï¼ŒmsgType éƒ½æ˜¯ä¸€ä¸ªé•¿åº¦ä¸º5ã€å®¹é‡ä¸º5çš„åˆ‡ç‰‡ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä»…å­˜å‚¨æ¯ä¸ªæ¶ˆæ¯ç±»å‹çš„5ä¸ªå­—èŠ‚ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getMessageType</span><span class="params">(msg []<span class="keyword">byte</span>)</span> []<span class="title">byte</span></span> &#123;</span><br><span class="line">    msgType := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">5</span>)</span><br><span class="line">    <span class="built_in">copy</span>(msgType, msg)</span><br><span class="line">    <span class="keyword">return</span> msgType</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨å®Œæ•´çš„åˆ‡ç‰‡è¡¨è¾¾å¼ï¼Œåˆ™è¿˜æ˜¯ä¼šå­˜åœ¨å†…å­˜æ³„æ¼çš„æƒ…å†µï¼Œå³ä¸ä¼šé‡Šæ”¾åº•å±‚æ•°ç»„ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getMessageType</span><span class="params">(msg []<span class="keyword">byte</span>)</span> []<span class="title">byte</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> msg[:<span class="number">5</span>:<span class="number">5</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>åˆ‡ç‰‡ä¸æŒ‡é’ˆå¯¼è‡´çš„å†…å­˜æ³„æ¼</strong></p>
<p>å®šä¸€ä¸ªç»“æ„ä½“ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Foo <span class="keyword">struct</span> &#123;</span><br><span class="line">    v []<span class="keyword">byte</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    foos := <span class="built_in">make</span>([]Foo, <span class="number">1</span>_000)              â¶ åˆ†é…ä¸€ä¸ª <span class="number">1000</span> ä¸ªå…ƒç´ çš„åˆ‡ç‰‡</span><br><span class="line">    printAlloc()  <span class="comment">// æ‰“å°å†…å­˜ä½¿ç”¨</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(foos); i++ &#123;        â· å¾ªç¯ <span class="number">1000</span> ä¸ªå…ƒç´ ï¼Œå°†æ¯ä¸ªå…ƒç´ åˆ†é… <span class="number">1</span>M çš„åˆ‡ç‰‡</span><br><span class="line">        foos[i] = Foo&#123;</span><br><span class="line">            v: <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">1024</span>*<span class="number">1024</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    printAlloc()  <span class="comment">// æ‰“å°å†…å­˜ä½¿ç”¨</span></span><br><span class="line"> </span><br><span class="line">    two := keepFirstTwoElementsOnly(foos)   â¸ ä¿ç•™å‰ä¸¤ä¸ªå…ƒç´ </span><br><span class="line">    runtime.GC()                            â¹ åƒåœ¾å›æ”¶</span><br><span class="line">    printAlloc()  <span class="comment">// æ‰“å°å†…å­˜ä½¿ç”¨</span></span><br><span class="line">    runtime.KeepAlive(two)                  âº ä¿ç•™å¯¹ä¸¤ä¸ªå˜é‡çš„å¼•ç”¨</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">keepFirstTwoElementsOnly</span><span class="params">(foos []Foo)</span> []<span class="title">Foo</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> foos[:<span class="number">2</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">83 KB</span><br><span class="line">1024072 KB</span><br><span class="line">1024072 KB     â¶ åˆ‡ç‰‡æ“ä½œåå†…å­˜ä»æ²¡æœ‰ç¼©å°</span><br></pre></td></tr></table></figure>
<p>åŸå› æ˜¯ï¼Œåœ¨ä½¿ç”¨åˆ‡ç‰‡æ—¶ï¼Œå¦‚æœå…ƒç´ æ˜¯æŒ‡é’ˆæˆ–å¸¦æœ‰æŒ‡é’ˆå­—æ®µçš„ç»“æ„ä½“ï¼Œåˆ™å…ƒç´ ä¸ä¼šè¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ã€‚åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œå› ä¸ºFooåŒ…å«ä¸€ä¸ªåˆ‡ç‰‡ï¼ˆåˆ‡ç‰‡æ˜¯åŸºäºä¸€ä¸ªåº•å±‚æ•°ç»„çš„æŒ‡é’ˆï¼‰ï¼Œæ‰€ä»¥å³ä½¿è¿™äº› 998 ä¸ªå…ƒç´ æ— æ³•è®¿é—®ï¼Œåªè¦keepFirstTwoElementsOnly è¿”å›çš„å˜é‡è¢«å¼•ç”¨ï¼Œå®ƒä»¬ä»ç„¶ä¼šç•™åœ¨å†…å­˜ä¸­ã€‚</p>
<p>ç¬¬ä¸€ç§è§£å†³æ–¹æ³•æ˜¯ï¼Œå†æ¬¡åˆ›å»ºä¸€ä¸ªåˆ‡ç‰‡å‰¯æœ¬ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">keepFirstTwoElementsOnly</span><span class="params">(foos []Foo)</span> []<span class="title">Foo</span></span> &#123;</span><br><span class="line">    res := <span class="built_in">make</span>([]Foo, <span class="number">2</span>)</span><br><span class="line">    <span class="built_in">copy</span>(res, foos)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±äºæˆ‘ä»¬å¤åˆ¶äº†åˆ‡ç‰‡çš„å‰ä¸¤ä¸ªå…ƒç´ ï¼Œåƒåœ¾å›æ”¶å™¨çŸ¥é“å‰©ä¸‹çš„998ä¸ªå…ƒç´ å°†ä¸å†è¢«å¼•ç”¨ï¼Œå› æ­¤ç°åœ¨å¯ä»¥è¿›è¡Œå›æ”¶ã€‚</p>
<p>ç¬¬äºŒç§è§£å†³æ–¹æ³•æ˜¯ï¼Œå°†å‰©ä½™çš„åˆ‡ç‰‡å…ƒç´ æ˜ç¡®çš„æ ‡è®°ä¸º nilã€‚å› æ­¤ï¼ŒGC å¯ä»¥å›æ”¶åº•å±‚ 998ä¸ªä¸ä½¿ç”¨çš„æ•°ç»„ç©ºé—´ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">keepFirstTwoElementsOnly</span><span class="params">(foos []Foo)</span> []<span class="title">Foo</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">2</span>; i &lt; <span class="built_in">len</span>(foos); i++ &#123;</span><br><span class="line">        foos[i].v = <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> foos[:<span class="number">2</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ğŸ¡æ€»ç»“</strong></p>
<ol>
<li>åœ¨å¯¹å¤§çš„ slice æˆ–è€…æ•°ç»„è¿›è¡Œåˆ‡ç‰‡æ“ä½œæ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´é«˜å†…å­˜æ¶ˆè€—ã€‚å‰©ä½™çš„ç©ºé—´ä¸ä¼šè¢«åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶ï¼Œå› æ­¤å³ä½¿æˆ‘ä»¬åªä½¿ç”¨äº†å…¶ä¸­çš„å‡ ä¸ªå…ƒç´ ï¼Œæˆ‘ä»¬ä»ç„¶å¯èƒ½ä¼šå ç”¨å¾ˆå¤§çš„åº•å±‚æ•°ç»„ã€‚ä½¿ç”¨ copy slice çš„æ–¹å¼æ˜¯é¿å…è¿™ç§æƒ…å†µçš„è§£å†³æ–¹æ¡ˆã€‚</li>
<li>å½“æˆ‘ä»¬ä½¿ç”¨åˆ‡ç‰‡æ“ä½œä¸æŒ‡é’ˆæˆ–å…·æœ‰æŒ‡é’ˆå­—æ®µçš„ç»“æ„ä½“æ—¶ï¼ŒGCä¸ä¼šå›æ”¶åˆ‡ç‰‡å‰©ä¸‹çš„è¿™äº›å…ƒç´ ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥æ‰§è¡Œ copy æˆ–æ˜ç¡®æ ‡è®°å‰©ä½™å…ƒç´ å­—æ®µä¸ºç©ºå€¼æ¥è§£å†³é—®é¢˜ã€‚</li>
</ol>
<h3 id="ä½æ•ˆçš„-map-åˆå§‹åŒ–"><a href="#ä½æ•ˆçš„-map-åˆå§‹åŒ–" class="headerlink" title="ä½æ•ˆçš„ map åˆå§‹åŒ–"></a>ä½æ•ˆçš„ map åˆå§‹åŒ–</h3><h4 id="map-åŸç†"><a href="#map-åŸç†" class="headerlink" title="map åŸç†"></a>map åŸç†</h4><p>map æ˜¯åŸºäºå“ˆå¸Œè¡¨æ•°æ®ç»“æ„çš„ã€‚å“ˆå¸Œè¡¨æ˜¯ä¸€ä¸ªæ¡¶çš„æ•°ç»„ï¼Œæ¯ä¸ªæ¡¶æ˜¯ä¸€ä¸ªæŒ‡å‘é”®å€¼å¯¹æ•°ç»„çš„æŒ‡é’ˆã€‚æ¯ä¸ªæ¡¶çš„å¤§å°å›ºå®šä¸º8ä¸ªå…ƒç´ ã€‚</p>
<p><img src="https://raw.githubusercontent.com/rexyan/warehouse/master/202308152148145.png" alt></p>
<p>æ¯ä¸ªæ“ä½œï¼ˆè¯»å–ã€æ›´æ–°ã€æ’å…¥ã€åˆ é™¤ï¼‰éƒ½æ˜¯é€šè¿‡å°†é”®ä¸æ•°ç»„ç´¢å¼•å…³è”æ¥å®Œæˆçš„ã€‚è¿™ä¸€æ­¥ä¾èµ–äºå“ˆå¸Œå‡½æ•°ã€‚ç”±äºæˆ‘ä»¬å¸Œæœ›è¯¥å‡½æ•°å§‹ç»ˆè¿”å›ç›¸åŒçš„æ¡¶ï¼Œå› æ­¤è¯¥å‡½æ•°æ˜¯ç¨³å®šçš„ã€‚ä¾‹å¦‚ï¼Œå“ˆå¸Œå‡½æ•°ä½œç”¨åœ¨ two ä¸Šè¿”å› 0ï¼›å› æ­¤ï¼Œè¯¥å…ƒç´ å­˜å‚¨åœ¨ç”±æ•°ç»„ç´¢å¼• 0 å¼•ç”¨çš„æ¡¶ä¸­ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬æ’å…¥å¦ä¸€ä¸ªå…ƒç´ ï¼Œå“ˆå¸Œå‡½æ•°è¿”å›ç›¸åŒçš„ç´¢å¼•ï¼Œåˆ™Goå°†å¦ä¸€ä¸ªå…ƒç´ æ·»åŠ åˆ°åŒä¸€ä¸ªæ¡¶ä¸­ã€‚</p>
<p><img src="https://raw.githubusercontent.com/rexyan/warehouse/master/202308152147814.png" alt></p>
<p>å¦‚æœæ’å…¥å·²ç»æ»¡çš„æ¡¶ï¼ˆæ¡¶æº¢å‡ºï¼‰ï¼ŒGo ä¼šåˆ›å»ºå¦ä¸€ä¸ª8å…ƒç´ çš„æ¡¶å¹¶å°†å‰ä¸€ä¸ªæ¡¶è¿æ¥åˆ°å®ƒã€‚</p>
<p><img src="https://raw.githubusercontent.com/rexyan/warehouse/master/202308152153139.png" alt></p>
<h4 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h4><p>ä»€ä¹ˆæ—¶å€™ map ä¼šè¿›è¡Œæ‰©å®¹å‘¢ï¼Ÿ</p>
<ol>
<li>æ¡¶ä¸­çš„å¹³å‡é¡¹æ•°ï¼ˆç§°ä¸ºè´Ÿè½½å› å­ï¼‰å¤§äºä¸€ä¸ªå›ºå®šå€¼ã€‚è¯¥å¸¸æ•°ç­‰äº6.5ï¼ˆä½†å®ƒå¯èƒ½ä¼šåœ¨å°†æ¥çš„ç‰ˆæœ¬ä¸­æ”¹å˜ï¼Œå› ä¸ºå®ƒæ˜¯ Go çš„å†…éƒ¨å¸¸æ•°ï¼‰</li>
<li>å¤ªå¤šçš„æ¡¶å·²ç»æº¢å‡ºï¼ˆå«æœ‰è¶…è¿‡å…«ä¸ªå…ƒç´ ï¼‰</li>
</ol>
<p>å½“ map æ‰©å®¹æ—¶ï¼Œæ‰€æœ‰çš„é”®éƒ½ä¼šå†æ¬¡åˆ†é…åˆ°æ‰€æœ‰çš„æ¡¶ä¸­ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨æœ€åæƒ…å†µä¸‹ï¼Œæ’å…¥ä¸€ä¸ªé”®å¯èƒ½æ˜¯ä¸€ä¸ªO(n)æ“ä½œï¼Œå…¶ä¸­næ˜¯ map ä¸­å…ƒç´ çš„æ€»æ•°ã€‚</p>
<p>ä¹Ÿå¯ä»¥åƒä½¿ç”¨ slice ä¸€æ ·ï¼Œåœ¨åˆå§‹åŒ–çš„æ—¶å€™å°±æŒ‡å®š map çš„å¤§å°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œè¯¥ map æ˜¯ä½¿ç”¨è¶³å¤Ÿæ•°é‡çš„æ¡¶åˆ›å»ºçš„ï¼Œä»¥å­˜å‚¨100ä¸‡ä¸ªå…ƒç´ ã€‚è¿™æ ·åšå¯ä»¥èŠ‚çœå¤§é‡çš„è®¡ç®—æ—¶é—´ï¼Œå› ä¸º map ä¸å¿…åŠ¨æ€åˆ›å»ºæ¡¶å¹¶é‡æ–°å¹³è¡¡ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">m := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>, <span class="number">1</span>_000_000)</span><br></pre></td></tr></table></figure>
<p>åŒæ—¶ï¼ŒæŒ‡å®šå¤§å° n å¹¶ä¸æ„å‘³ç€åˆ›å»ºæœ€å¤šæœ‰ n ä¸ªå…ƒç´ çš„æ˜ å°„ã€‚æˆ‘ä»¬ä»ç„¶å¯ä»¥æ·»åŠ è¶…è¿‡ n ä¸ªå…ƒç´ ã€‚</p>
<p><strong>ğŸ¡æ€»ç»“</strong></p>
<p>å°±åƒåˆ‡ç‰‡ä¸€æ ·ï¼Œå¦‚æœæˆ‘ä»¬äº‹å…ˆçŸ¥é“ map åŒ…å«çš„å…ƒç´ æ•°é‡ï¼Œæˆ‘ä»¬åº”è¯¥é€šè¿‡æä¾›åˆå§‹å¤§å°æ¥åˆ›å»ºå®ƒã€‚è¿™æ ·åšå¯ä»¥é¿å…æ½œåœ¨çš„ map æ‰©å®¹ï¼Œè¿™å¯¹è®¡ç®—æœºè€Œè¨€æ˜¯ç›¸å½“æ²‰é‡çš„è®¡ç®—ï¼Œå› ä¸ºå®ƒéœ€è¦é‡æ–°åˆ†é…è¶³å¤Ÿçš„ç©ºé—´å¹¶é‡æ–°å¹³è¡¡æ‰€æœ‰å…ƒç´ ã€‚</p>
<h3 id="map-å†…å­˜æ³„æ¼"><a href="#map-å†…å­˜æ³„æ¼" class="headerlink" title="map å†…å­˜æ³„æ¼"></a>map å†…å­˜æ³„æ¼</h3><p>æˆ‘ä»¬åˆ†é…äº†ä¸€ä¸ªç©ºçš„mapï¼Œæ·»åŠ äº†100ä¸‡ä¸ªå…ƒç´ ï¼Œå†åˆ é™¤100ä¸‡ä¸ªå…ƒç´ ï¼Œç„¶åè¿è¡Œäº†ä¸€æ¬¡åƒåœ¾å›æ”¶ã€‚æˆ‘ä»¬è¿˜ä½¿ç”¨runtime.KeepAlive ç¡®ä¿ä¿ç•™å¯¹è¯¥ map çš„å¼•ç”¨ï¼Œä»¥é˜²æ­¢å…¶è¢«å›æ”¶ã€‚è®©æˆ‘ä»¬è¿è¡Œæ­¤ç¤ºä¾‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">n := <span class="number">1</span>_000_000</span><br><span class="line">m := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>][<span class="number">128</span>]<span class="keyword">byte</span>)</span><br><span class="line">printAlloc()</span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;      â¶ å¢åŠ ä¸€ç™¾ä¸‡ä¸ªå…ƒç´ </span><br><span class="line">    m[i] = randBytes()</span><br><span class="line">&#125;</span><br><span class="line">printAlloc()</span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;      â· åˆ é™¤ä¸€ç™¾ä¸‡ä¸ªå…ƒç´ </span><br><span class="line">    <span class="built_in">delete</span>(m, i)</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">runtime.GC()                  â¸ æ‰‹åŠ¨è§¦å‘ GC</span><br><span class="line">printAlloc()</span><br><span class="line">runtime.KeepAlive(m)          â¹ ä¿ç•™å¯¹ m çš„å¼•ç”¨ï¼Œé˜²æ­¢ <span class="keyword">map</span> è¢«å›æ”¶</span><br></pre></td></tr></table></figure>
<p>ç»“æœå¦‚ä¸‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span> MB       â¶ </span><br><span class="line"><span class="number">461</span> MB     â· æ·»åŠ ä¸€ç™¾ä¸‡å…ƒç´ ä¹‹å</span><br><span class="line"><span class="number">293</span> MB     â¸ åˆ é™¤ä¸€ç™¾ä¸‡å…ƒç´ ä¹‹å</span><br></pre></td></tr></table></figure>
<p>æœ€ç»ˆï¼Œå°½ç®¡ GC æ”¶é›†äº†æ‰€æœ‰å…ƒç´ ï¼Œä½†å †å¤§å°ä»ä¸º293 MBã€‚å› æ­¤ï¼Œå†…å­˜å·²ç»ç¼©å°ï¼Œä½†ä¸æˆ‘ä»¬çš„é¢„æœŸä¸åŒï¼ˆè¿˜å­˜åœ¨å†…å­˜å ç”¨ï¼‰ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ</p>
<p>åŸå› åœ¨äº map ä¸­æ¡¶çš„æ•°é‡ä¸å¯æ”¶ç¼©ã€‚å› æ­¤ï¼Œä» map ä¸­åˆ é™¤å…ƒç´ ä¸ä¼šå½±å“ç°æœ‰æ¡¶çš„æ•°é‡ï¼›å®ƒåªä¼šå°†æ¡¶ä¸­çš„æ’æ§½æ¸…é›¶ã€‚ å³ map åªèƒ½å¢é•¿å¹¶æ‹¥æœ‰æ›´å¤šçš„æ¡¶ï¼Œè€Œä¸ä¼šç¼©å°æ¡¶çš„æ•°é‡ã€‚</p>
<p>æœ‰ä»€ä¹ˆè§£å†³æ–¹æ³•å‘¢ï¼Ÿ</p>
<ol>
<li>ä½¿ç”¨å¤åˆ¶çš„æ–¹æ³•ï¼Œå®šæœŸé‡æ–°åˆ›å»ºå½“å‰ map çš„å‰¯æœ¬ã€‚ä¾‹å¦‚ï¼Œæ¯ä¸ªå°æ—¶æˆ‘ä»¬å¯ä»¥å»ºç«‹ä¸€ä¸ªæ–° mapï¼Œå¤åˆ¶æ‰€æœ‰å…ƒç´ å¹¶é‡Šæ”¾ä¹‹å‰çš„ mapï¼Œè¿™ç§æ–¹æ³•çš„ä¸»è¦ç¼ºç‚¹æ˜¯åœ¨å¤åˆ¶ä¹‹åç›´åˆ°ä¸‹ä¸€æ¬¡åƒåœ¾å›æ”¶ä¹‹å‰ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šåœ¨çŸ­æ—¶é—´å†…æ¶ˆè€—ä¸¤å€äºå½“å‰å†…å­˜ã€‚</li>
<li>å°† map ç±»å‹æ›´æ”¹ä¸ºå­˜å‚¨æ•°ç»„æŒ‡é’ˆï¼šmap[int]*[128]byteã€‚è¿™å¹¶ä¸èƒ½è§£å†³æˆ‘ä»¬å°†æ‹¥æœ‰å¤§é‡æ¡¶çš„äº‹å®; ä½†æ˜¯ï¼Œæ¯ä¸ªæ¡¶æ¡ç›®å°†ä¿ç•™å€¼çš„æŒ‡é’ˆå¤§å°ï¼ˆ64ä½ç³»ç»Ÿä¸Šä¸º8å­—èŠ‚ï¼Œ32ä½ç³»ç»Ÿä¸Šä¸º4å­—èŠ‚ï¼‰ï¼Œè€Œä¸æ˜¯128å­—èŠ‚ã€‚</li>
</ol>
<h3 id="é”™è¯¯çš„å€¼æ¯”è¾ƒ"><a href="#é”™è¯¯çš„å€¼æ¯”è¾ƒ" class="headerlink" title="é”™è¯¯çš„å€¼æ¯”è¾ƒ"></a>é”™è¯¯çš„å€¼æ¯”è¾ƒ</h3><p>ä½•æ—¶é€‚åˆä½¿ç”¨ ==ï¼Œè¿˜æœ‰ä»€ä¹ˆå…¶ä»–æ–¹æ¡ˆå‘¢ï¼Ÿçœ‹ä¸€ä¸ªä¾‹å­:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> customer <span class="keyword">struct</span> &#123;</span><br><span class="line">    id <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    cust1 := customer&#123;id: <span class="string">"x"</span>&#125;</span><br><span class="line">    cust2 := customer&#123;id: <span class="string">"x"</span>&#125;</span><br><span class="line">    fmt.Println(cust1 == cust2)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¯”è¾ƒè¿™ä¸¤ä¸ªç»“æ„ä½“å®ƒä¼šæ‰“å° trueã€‚é‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬å¯¹ç»“æ„ä½“è¿›è¡Œè½»å¾®ä¿®æ”¹ä»¥æ·»åŠ ä¸€ä¸ªåˆ‡ç‰‡å­—æ®µï¼Œä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> customer <span class="keyword">struct</span> &#123;</span><br><span class="line">    id         <span class="keyword">string</span></span><br><span class="line">    operations []<span class="keyword">float64</span>      â¶ æ·»åŠ ä¸€ä¸ªåˆ‡ç‰‡å­—æ®µ</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    cust1 := customer&#123;id: <span class="string">"x"</span>, operations: []<span class="keyword">float64</span>&#123;<span class="number">1.</span>&#125;&#125;</span><br><span class="line">    cust2 := customer&#123;id: <span class="string">"x"</span>, operations: []<span class="keyword">float64</span>&#123;<span class="number">1.</span>&#125;&#125;</span><br><span class="line">    fmt.Println(cust1 == cust2)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œä¸Šè¿°ä»£ç ï¼Œä¼šå‡ºç°æ— æ³•ç¼–è¯‘çš„æƒ…å†µã€‚å› ä¸ºè¿™æ¶‰åŠåˆ° == å’Œ != è¿ç®—ç¬¦çš„å·¥ä½œåŸç†ã€‚è¿™äº›è¿ç®—ç¬¦æ— æ³•ä¸åˆ‡ç‰‡æˆ– map ä¸€èµ·ä½¿ç”¨ã€‚å› æ­¤ï¼Œç”±äºä¸Šè¿°ç»“æ„åŒ…å«ä¸€ä¸ªåˆ‡ç‰‡ï¼Œæ‰€ä»¥å®ƒæ— æ³•ç¼–è¯‘ã€‚</p>
<p>slices &amp; maps æ˜¯æ— æ³•é€šè¿‡<code>==</code>æ¯”è¾ƒçš„ã€‚æˆ‘ä»¬å¯ä»¥çœ‹ä¸‹å“ªäº›æ˜¯å¯æ¯”è¾ƒçš„ï¼š</p>
<ol>
<li>Booleans æ¯”è¾ƒå€¼æ˜¯å¦ç›¸ç­‰</li>
<li>Numerics (int, float, and complex types) æ¯”è¾ƒå€¼æ˜¯å¦ç›¸ç­‰</li>
<li>Strings æ¯”è¾ƒå†…å®¹</li>
<li>Channels æ¯”è¾ƒæ˜¯å¦æ˜¯åŒä¸€ä¸ªmakeåˆ›å»ºçš„ï¼Œæˆ–è€…æ˜¯å¦éƒ½æ˜¯nil</li>
<li>Interfaces æ¯”è¾ƒæ˜¯å¦æœ‰ç›¸åŒçš„ç±»å‹å’Œå€¼ æˆ–è€…æ˜¯å¦éƒ½æ˜¯nil</li>
<li>Pointers æŒ‡é’ˆæ¯”è¾ƒæ˜¯å¦éƒ½æŒ‡å‘åŒä¸€ä¸ªå€¼ æˆ–è€…æ˜¯å¦éƒ½æ˜¯nil</li>
<li>Structs and arrays æ¯”è¾ƒç»„æˆçš„ç®€å•ç±»å‹</li>
</ol>
<p>æˆ‘ä»¬æ›´æ–°ä¸€ä¸‹ä¸Šè¿°çš„ä¾‹å­ï¼Œä½†æ˜¯å°†ä½¿ç”¨ any æ¥æ¥æ”¶å€¼ï¼Œç„¶ååœ¨ç”¨äºæ¯”è¾ƒï¼Œä¼šæœ‰ä»€ä¹ˆç°è±¡å‘¢ï¼Ÿ</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> cust1 any = customer&#123;id: <span class="string">"x"</span>, operations: []<span class="keyword">float64</span>&#123;<span class="number">1.</span>&#125;&#125;</span><br><span class="line"><span class="keyword">var</span> cust2 any = customer&#123;id: <span class="string">"x"</span>, operations: []<span class="keyword">float64</span>&#123;<span class="number">1.</span>&#125;&#125;</span><br><span class="line">fmt.Println(cust1 == cust2)</span><br></pre></td></tr></table></figure>
<p>ç°è±¡æ˜¯å¯ä»¥ç¼–è¯‘é€šè¿‡ï¼Œä½†æ˜¯æ— æ³•è¿›è¡Œæ¯”è¾ƒï¼Œä¼šäº§ç”Ÿä¸€ä¸ªé”™è¯¯ã€‚</p>
<p>é‚£ä¹ˆæœ‰ä»€ä¹ˆè§£å†³æ–¹æ³•å‘¢ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ reflect.DeepEqualã€‚è¯¥å‡½æ•°é€šè¿‡é€’å½’éå†ä¸¤ä¸ªå€¼æ¥æ£€æŸ¥ä¸¤ä¸ªå…ƒç´ æ˜¯å¦æ·±åº¦ç›¸ç­‰ã€‚å®ƒæ¥å—çš„å…ƒç´ åŒ…æ‹¬åŸºæœ¬ç±»å‹ä»¥åŠæ•°ç»„ã€ç»“æ„ä½“ã€åˆ‡ç‰‡ã€mapã€æŒ‡é’ˆã€æ¥å£å’Œå‡½æ•°ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cust1 := customer&#123;id: <span class="string">"x"</span>, operations: []<span class="keyword">float64</span>&#123;<span class="number">1.</span>&#125;&#125;</span><br><span class="line">cust2 := customer&#123;id: <span class="string">"x"</span>, operations: []<span class="keyword">float64</span>&#123;<span class="number">1.</span>&#125;&#125;</span><br><span class="line">fmt.Println(reflect.DeepEqual(cust1, cust2))</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯ï¼Œå¹³å‡è€Œè¨€ï¼Œreflect.DeepEqualæ¯”==æ…¢å¤§çº¦100å€ã€‚å¦‚æœæ€§èƒ½æ˜¯è‡³å…³é‡è¦çš„å› ç´ ï¼Œå¦ä¸€ä¸ªé€‰æ‹©æ˜¯æˆ‘ä»¬è‡ªå·±å®ç°æ¯”è¾ƒçš„æ–¹æ³•ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a customer)</span> <span class="title">equal</span><span class="params">(b customer)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> a.id != b.id &#123;                             â¶ æ¯”è¾ƒ id å­—æ®µ</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(a.operations) != <span class="built_in">len</span>(b.operations) &#123;   â· æ£€æŸ¥ä¸¤ä¸ªåˆ‡ç‰‡çš„é•¿åº¦</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(a.operations); i++ &#123;      â¸ æ¯”è¾ƒä¸¤ä¸ªåˆ‡ç‰‡ä¸­çš„æ¯ä¸ªå…ƒç´ </span><br><span class="line">        <span class="keyword">if</span> a.operations[i] != b.operations[i] &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çš„è‡ªå®šä¹‰ç›¸ç­‰æ–¹æ³•å¤§çº¦æ¯” reflect.DeepEqual å¿«96å€</p>
<p><strong>ğŸ¡æ€»ç»“</strong></p>
<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åº”è¯¥è®°ä½ â€œ==â€ è¿ç®—ç¬¦çš„å±€é™æ€§ã€‚ä¾‹å¦‚ï¼Œå®ƒä¸èƒ½ç”¨äºåˆ‡ç‰‡å’Œ mapã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½¿ç”¨reflect.DeepEqual æ˜¯ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œä½†ä¸»è¦é—®é¢˜æ˜¯æ€§èƒ½ä¸å¥½ã€‚</p>
<h3 id="range-å¾ªç¯æ˜¯å€¼æ‹·è´"><a href="#range-å¾ªç¯æ˜¯å€¼æ‹·è´" class="headerlink" title="range å¾ªç¯æ˜¯å€¼æ‹·è´"></a>range å¾ªç¯æ˜¯å€¼æ‹·è´</h3><p><code>range</code>æ˜¯ä¸€ä¸ªæ¯”è¾ƒæ–¹ä¾¿çš„æ§åˆ¶å¾ªç¯çš„æ–¹å¼ï¼Œå¯ç”¨äºï¼š</p>
<ol>
<li>å­—ç¬¦ä¸²</li>
<li>æ•°ç»„</li>
<li>æŒ‡é’ˆæ•°ç»„</li>
<li>åˆ‡ç‰‡</li>
<li>Map</li>
<li>æ¥æ”¶çš„channel</li>
</ol>
<p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª account ç»“æ„ä½“ï¼ŒåŒ…å«ä¸€ä¸ªå•ä¸€çš„ä½™é¢å­—æ®µ</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> account <span class="keyword">struct</span> &#123;</span><br><span class="line">    balance <span class="keyword">float32</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè´¦æˆ·ç»“æ„çš„åˆ‡ç‰‡ï¼Œå¹¶ä½¿ç”¨èŒƒå›´å¾ªç¯è¿­ä»£æ¯ä¸ªå…ƒç´ ã€‚åœ¨æ¯æ¬¡è¿­ä»£æœŸé—´ï¼Œæˆ‘ä»¬ä¼šå¢åŠ æ¯ä¸ªè´¦æˆ·çš„ä½™é¢ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">accounts := []account&#123;</span><br><span class="line">    &#123;balance: <span class="number">100.</span>&#125;,</span><br><span class="line">    &#123;balance: <span class="number">200.</span>&#125;,</span><br><span class="line">    &#123;balance: <span class="number">300.</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> _, a := <span class="keyword">range</span> accounts &#123;</span><br><span class="line">    a.balance += <span class="number">1000</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç­”æ¡ˆæ˜¯ï¼š<code>[{100} {200} {300}]</code>ã€‚åŸå› æ˜¯ï¼Œå› ä¸ºæˆ‘ä»¬ä¿®æ”¹çš„æ˜¯ä¸€ä»½å€¼æ‹·è´ï¼Œå½“å¾ªç¯è¿­ä»£æ•°æ®ç»“æ„æ—¶ï¼Œå®ƒå°†æ¯ä¸ªå…ƒç´ å¤åˆ¶åˆ°å€¼å˜é‡ï¼ˆç¬¬äºŒé¡¹ï¼‰ä¸­ã€‚</p>
<p>åœ¨ Go è¯­è¨€ä¸­ï¼Œéƒ½æ˜¯å€¼çš„å¤åˆ¶ã€‚ä¾‹å¦‚ä¸€ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ªç»“æ„ä½“ï¼Œåœ¨ä½¿ç”¨ä¸€ä¸ªå˜é‡æ¥æ”¶ï¼Œé‚£ä¹ˆå˜é‡æ¥æ”¶åˆ°çš„å°†æ˜¯è¯¥ç»“æ„ä½“çš„å¤åˆ¶ã€‚å¦‚æœæˆ‘ä»¬å°†è¿”å›æŒ‡é’ˆçš„å‡½æ•°çš„ç»“æœåˆ†é…ç»™å˜é‡ï¼Œå®ƒå°†æ‰§è¡Œå†…å­˜åœ°å€çš„å¤åˆ¶ã€‚</p>
<p>é‚£ä¹ˆä¸Šé¢é—®é¢˜æœ‰ä»€ä¹ˆè§£å†³æ–¹æ¡ˆå‘¢ï¼Ÿ</p>
<p>ç¬¬ä¸€ç§æ–¹æ¡ˆæ˜¯ä½¿ç”¨ç´¢å¼•ä¸‹æ ‡æ¥è§£å†³ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> accounts &#123;                â¶ ä½¿ç”¨ç´¢å¼•å˜é‡è®¿é—®åˆ‡ç‰‡çš„å…ƒç´ </span><br><span class="line">    accounts[i].balance += <span class="number">1000</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(accounts); i++ &#123;     â· ä½¿ç”¨ä¼ ç»Ÿçš„ <span class="keyword">for</span> å¾ªç¯ï¼Œä½¿ç”¨ä¸‹æ ‡æ¥è®¿é—®åˆ‡ç‰‡å…ƒç´ </span><br><span class="line">    accounts[i].balance += <span class="number">1000</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦ä¸€ç§é€‰æ‹©æ˜¯ç»§ç»­ä½¿ç”¨ range å¾ªç¯è®¿é—®å€¼ï¼Œä½†å°†åˆ‡ç‰‡ç±»å‹ä¿®æ”¹ä¸ºå¸æˆ·æŒ‡é’ˆçš„åˆ‡ç‰‡ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">accounts := []*account&#123;       â¶ å°†åˆ‡ç‰‡ç±»å‹æ›´æ–°ä¸º []*account</span><br><span class="line">    &#123;balance: <span class="number">100.</span>&#125;,</span><br><span class="line">    &#123;balance: <span class="number">200.</span>&#125;,</span><br><span class="line">    &#123;balance: <span class="number">300.</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> _, a := <span class="keyword">range</span> accounts &#123;</span><br><span class="line">    a.balance += <span class="number">1000</span>         â· ç›´æ¥æ›´æ–°åˆ‡ç‰‡çš„å…ƒç´ </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å˜é‡ a æ˜¯å­˜å‚¨åœ¨åˆ‡ç‰‡ä¸­çš„ account æŒ‡é’ˆçš„å‰¯æœ¬ã€‚ç”±äºæŒ‡é’ˆå¼•ç”¨åŒä¸€ç»“æ„ä½“ï¼Œæ‰€ä»¥ a.balance += 1000 è¯­å¥ä¼šæ›´æ–°åˆ‡ç‰‡å…ƒç´ ã€‚</p>
<p>ç„¶è€Œï¼Œè¿™ç§é€‰æ‹©æœ‰ä¸¤ä¸ªä¸»è¦ç¼ºç‚¹ã€‚é¦–å…ˆï¼Œå®ƒéœ€è¦æ›´æ–°åˆ‡ç‰‡ç±»å‹ï¼ˆæ›´æ”¹ä¸ºæŒ‡é’ˆï¼‰ã€‚å…¶æ¬¡ï¼Œå¦‚æœæ€§èƒ½å¾ˆé‡è¦ï¼Œè¿­ä»£æŒ‡é’ˆåˆ‡ç‰‡å¯èƒ½å¯¹CPUæ¥è¯´æ•ˆç‡è¾ƒä½ã€‚</p>
<p><strong>ğŸ¡æ€»ç»“</strong></p>
<p>è¾ƒä¸ºæ¨èçš„æ–¹æ¡ˆæ˜¯ï¼Œé€šè¿‡ä½¿ç”¨ range å¾ªç¯æˆ–ç»å…¸çš„ for å¾ªç¯ï¼Œæ¥é€šè¿‡ç´¢å¼•è®¿é—®è¯¥å…ƒç´ ã€‚</p>
<h3 id="range-å¯¹è±¡ä½•æ—¶è¢«è®¡ç®—"><a href="#range-å¯¹è±¡ä½•æ—¶è¢«è®¡ç®—" class="headerlink" title="range å¯¹è±¡ä½•æ—¶è¢«è®¡ç®—"></a>range å¯¹è±¡ä½•æ—¶è¢«è®¡ç®—</h3><p>ä¸‹é¢ä»£ç ä¼šé™·å…¥æ­»å¾ªç¯å—ï¼Ÿ</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s := []<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>&#125;</span><br><span class="line"><span class="keyword">for</span> <span class="keyword">range</span> s &#123;</span><br><span class="line">    s = <span class="built_in">append</span>(s, <span class="number">10</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç­”æ¡ˆæ˜¯ä¸ä¼šï¼Œåœ¨ä½¿ç”¨ range å¾ªç¯æ—¶ï¼Œæä¾›çš„è¡¨è¾¾å¼ä»…åœ¨å¾ªç¯å¼€å§‹ä¹‹å‰è¢«è¯„ä¼°ä¸€æ¬¡ã€‚åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­ï¼Œâ€œè¯„ä¼°â€æ„å‘³ç€æä¾›çš„è¡¨è¾¾å¼è¢«å¤åˆ¶åˆ°ä¸€ä¸ªä¸´æ—¶å˜é‡ä¸­ï¼Œç„¶ååœ¨éå†è¿™ä¸ªå˜é‡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸Šè¿°è¢«éå†çš„ s å˜é‡ä¼šè¢«æ‹·è´åˆ°ä¸€ä¸ªä¸´æ—¶å˜é‡ä¸­åœ¨è¿›è¡Œéå†ã€‚</p>
<p>é‚£å¦‚æœå˜æˆä¸‹é¢è¿™æ ·çš„è¯ï¼Œ ä»£ç å°±ä¼šé™·å…¥å¾ªç¯ï¼Œæ°¸è¿œä¸ä¼šç»“æŸã€‚len(s) è¡¨è¾¾å¼åœ¨æ¯æ¬¡è¿­ä»£æœŸé—´éƒ½ä¼šè¢«è¯„ä¼°ï¼Œå› ä¸ºæˆ‘ä»¬ä¸æ–­åœ°æ·»åŠ å…ƒç´ ï¼Œæ‰€ä»¥æˆ‘ä»¬æ°¸è¿œä¸ä¼šè¾¾åˆ°ç»ˆæ­¢çŠ¶æ€ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s := []<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>&#125;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(s); i++ &#123;</span><br><span class="line">    s = <span class="built_in">append</span>(s, <span class="number">10</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ch1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">3</span>)     â¶ åˆ›å»ºä¸€ä¸ªé€šé“ï¼Œå¹¶åœ¨ä¸‹é¢çš„åç¨‹ä¸­å¡å…¥å…ƒç´  <span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ch1 &lt;- <span class="number">0</span></span><br><span class="line">    ch1 &lt;- <span class="number">1</span></span><br><span class="line">    ch1 &lt;- <span class="number">2</span></span><br><span class="line">    <span class="built_in">close</span>(ch1)</span><br><span class="line">&#125;()</span><br><span class="line"> </span><br><span class="line">ch2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">3</span>)     â· åˆ›å»ºå¦ä¸€ä¸ªé€šé“ï¼Œå¹¶åœ¨ä¸‹é¢çš„åç¨‹ä¸­å¡å…¥å…ƒç´  <span class="number">10</span>,<span class="number">11</span>,<span class="number">12</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ch2 &lt;- <span class="number">10</span></span><br><span class="line">    ch2 &lt;- <span class="number">11</span></span><br><span class="line">    ch2 &lt;- <span class="number">12</span></span><br><span class="line">    <span class="built_in">close</span>(ch2)</span><br><span class="line">&#125;()</span><br><span class="line"> </span><br><span class="line">ch := ch1                    â¸ å°†ç¬¬ä¸€ä¸ªé€šé“èµ‹å€¼ç»™ ch</span><br><span class="line"><span class="keyword">for</span> v := <span class="keyword">range</span> ch &#123;          â¹ å¾ªç¯ ch</span><br><span class="line">    fmt.Println(v)</span><br><span class="line">    ch = ch2                 âº å†å°† ch2 èµ‹å€¼ç»™ ch</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œè¿˜æ˜¯ä¼šæ‰“å° 0,1,2ã€‚åŸå› åœ¨äº range ä¼šè¯„ä¼° chï¼Œå°†å…¶å¤åˆ¶åˆ°ä¸€ä¸ªä¸´æ—¶å˜é‡ä¸­ã€‚å°½ç®¡æœ‰ ch = ch2 è¯­å¥ï¼Œrange ä»ä¼šç»§ç»­è¿­ä»£ ch1 è€Œé ch2ã€‚</p>
<p>åŒç†ï¼Œåœ¨çœ‹å¦ä¸€ä¸ªä¾‹å­ï¼šæˆ‘ä»¬å¾ªç¯æ•°ç»„ aï¼Œå¹¶å°† a çš„ç¬¬ä¸‰ä¸ªå…ƒç´ ä¿®æ”¹ä¸º 10ï¼Œç„¶åæˆ‘ä»¬æ‰“å°ç¬¬ä¸‰ä¸ªå…ƒç´ ã€‚æ­¤æ—¶è¾“å‡ºç»“æœè¿˜æ˜¯2ï¼Œè€Œä¸æ˜¯ 10ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a := [<span class="number">3</span>]<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>&#125;      â¶ åˆ›å»ºåŒ…å«ä¸‰ä¸ªå…ƒç´ çš„æ•°ç»„</span><br><span class="line"><span class="keyword">for</span> i, v := <span class="keyword">range</span> a &#123;     â· éå†æ•°ç»„</span><br><span class="line">    a[<span class="number">2</span>] = <span class="number">10</span>             â¸ æ›´æ–°æœ€åä¸€ä¸ªå…ƒç´ çš„ç´¢å¼•</span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">2</span> &#123;           â¹ æ‰“å°æœ€åä¸€ä¸ªå…ƒç´ ç´¢å¼•çš„å†…å®¹</span><br><span class="line">        fmt.Println(v)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŸå› è¿˜æ˜¯åœ¨äºåœ¨ range å¾ªç¯ä¹‹å‰ a å˜é‡è¢«è¯„ä¼°äº†ä¸€æ¬¡ï¼ˆä¹Ÿå°±æ˜¯å¤åˆ¶åˆ°äº†ä¸´æ—¶å˜é‡ä¸­ï¼Œæ‰€æœ‰åç»­ä¸ç®¡åœ¨æ€ä¹ˆé€šè¿‡ä¸‹æ ‡æ›´æ”¹ï¼Œå…¶è¿­ä»£æ—¶å€™çš„å€¼ä¹Ÿä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼‰ã€‚</p>
<p>é‚£å¦‚æœæˆ‘ä»¬å°±æ˜¯æƒ³åœ¨è¿­ä»£çš„æ—¶å€™è¿›è¡Œå€¼çš„ä¿®æ”¹ï¼Œè¯¥æ€ä¹ˆå®ç°å‘¢ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§æ–¹æ³•:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–¹æ³•1</span></span><br><span class="line">a := [<span class="number">3</span>]<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>&#125;</span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> a &#123;</span><br><span class="line">    a[<span class="number">2</span>] = <span class="number">10</span></span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">2</span> &#123;</span><br><span class="line">        fmt.Println(a[<span class="number">2</span>])     â¶ é€šè¿‡ä¸‹æ ‡æ¥è®¿é—®å€¼ï¼Œè€Œä¸æ˜¯ <span class="keyword">range</span> çš„å˜é‡</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–¹æ³•2</span></span><br><span class="line">a := [<span class="number">3</span>]<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>&#125;</span><br><span class="line"><span class="keyword">for</span> i, v := <span class="keyword">range</span> &amp;a &#123;     â¶ ä½¿ç”¨æ•°ç»„æŒ‡é’ˆ</span><br><span class="line">    a[<span class="number">2</span>] = <span class="number">10</span></span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">2</span> &#123;</span><br><span class="line">        fmt.Println(v)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="range-ä¸­ä½¿ç”¨æŒ‡é’ˆ"><a href="#range-ä¸­ä½¿ç”¨æŒ‡é’ˆ" class="headerlink" title="range ä¸­ä½¿ç”¨æŒ‡é’ˆ"></a>range ä¸­ä½¿ç”¨æŒ‡é’ˆ</h3><p>åœ¨ä½¿ç”¨ for å¾ªç¯éå†æ•°æ®æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»è®°ä½æ‰€æœ‰çš„å€¼éƒ½è¢«åˆ†é…ç»™ä¸€ä¸ªå”¯ä¸€çš„å˜é‡ï¼Œè¯¥å˜é‡æœ‰ä¸€ä¸ªå•ä¸€çš„å”¯ä¸€åœ°å€ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬åœ¨æ¯æ¬¡è¿­ä»£ä¸­å­˜å‚¨å¼•ç”¨æ­¤å˜é‡çš„æŒ‡é’ˆï¼Œé‚£æˆ‘ä»¬ä¼šå¾—åˆ°æŒ‡å‘åŒä¸€å…ƒç´ çš„ç›¸åŒæŒ‡é’ˆï¼Œå³æœ€æ–°çš„æŒ‡é’ˆã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Customer <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID      <span class="keyword">string</span></span><br><span class="line">    Balance <span class="keyword">float64</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">type</span> Store <span class="keyword">struct</span> &#123;</span><br><span class="line">    m <span class="keyword">map</span>[<span class="keyword">string</span>]*Customer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Store)</span> <span class="title">storeCustomers</span><span class="params">(customers []Customer)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> _, customer := <span class="keyword">range</span> customers &#123;</span><br><span class="line">        s.m[customer.ID] = &amp;customer         â¶ åœ¨ <span class="keyword">map</span> ä¸­å­˜å‚¨æŒ‡é’ˆ</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨æ—¶ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">s.storeCustomers([]Customer&#123;</span><br><span class="line">    &#123;ID: <span class="string">"1"</span>, Balance: <span class="number">10</span>&#125;,</span><br><span class="line">    &#123;ID: <span class="string">"2"</span>, Balance: <span class="number">-10</span>&#125;,</span><br><span class="line">    &#123;ID: <span class="string">"3"</span>, Balance: <span class="number">0</span>&#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»“æœ</span></span><br><span class="line"><span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">key=1, value=&amp;main.Customer&#123;ID:"</span><span class="number">3</span><span class="string">", Balance:0&#125;</span></span><br><span class="line"><span class="string">key=2, value=&amp;main.Customer&#123;ID:"</span><span class="number">3</span><span class="string">", Balance:0&#125;</span></span><br><span class="line"><span class="string">key=3, value=&amp;main.Customer&#123;ID:"</span><span class="number">3</span><span class="string">", Balance:0&#125;</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä»£ç çš„è¾“å‡ºä¼šæ˜¯ä¸‰ä¸ªç›¸åŒçš„é¢å€¼ï¼Œå³ <code>{ID: &quot;3&quot;, Balance: 0}</code> ã€‚å‡ºç°è¿™ä¸ªé—®é¢˜çš„åŸå› åœ¨äº for å¾ªç¯éå†æ•°æ®æ—¶ï¼Œæ‰€æœ‰çš„å€¼éƒ½è¢«åˆ†é…ç»™ä¸€ä¸ªå”¯ä¸€çš„å˜é‡ï¼Œè¯¥å˜é‡æœ‰ä¸€ä¸ªå•ä¸€çš„å”¯ä¸€åœ°å€ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Store)</span> <span class="title">storeCustomers</span><span class="params">(customers []Customer)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> _, customer := <span class="keyword">range</span> customers &#123;</span><br><span class="line">        fmt.Printf(<span class="string">"%p\n"</span>, &amp;customer)      â¶ æ‰“å° customer åœ°å€ï¼Œä¼šå‘ç°æ˜¯ä¸€æ ·çš„</span><br><span class="line">        s.m[customer.ID] = &amp;customer</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">0xc000096020</span></span><br><span class="line"><span class="number">0xc000096020</span></span><br><span class="line"><span class="number">0xc000096020</span></span><br></pre></td></tr></table></figure>
<p>è¯¥æŒ‡é’ˆçš„æœ€åä¸€æ¬¡åˆ†é…æ˜¯åˆ‡ç‰‡çš„æœ€åä¸€ä¸ªå…ƒç´  Customer3 çš„å¼•ç”¨ã€‚æ‰€ä»¥æ‰ä¼šå‡ºç°ä¸Šè¿°ä»£ç ä¸­çš„ç°è±¡ï¼ˆæ‰“å°äº†ä¸‰ä¸ªç›¸åŒçš„å€¼ï¼‰</p>
<p><img src="https://raw.githubusercontent.com/rexyan/warehouse/master/202308191015329.png" alt></p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å¼ºåˆ¶åœ¨å¾ªç¯å†…åˆ›å»ºä¸€ä¸ªå±€éƒ¨å˜é‡æˆ–é€šè¿‡ç´¢å¼•åˆ›å»ºä¸€ä¸ªå¼•ç”¨åˆ‡ç‰‡å…ƒç´ çš„æŒ‡é’ˆæ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Store)</span> <span class="title">storeCustomers</span><span class="params">(customers []Customer)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> _, customer := <span class="keyword">range</span> customers &#123;</span><br><span class="line">        current := customer                 â¶ åˆ›å»ºä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œä»¥è§£å†³è¿™ä¸ªé—®é¢˜</span><br><span class="line">        s.m[current.ID] = &amp;current       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Store)</span> <span class="title">storeCustomers</span><span class="params">(customers []Customer)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> customers &#123;</span><br><span class="line">        customer := &amp;customers[i]        â¶ ä½¿ç”¨åˆ‡ç‰‡çš„ç´¢å¼•åˆ›å»ºä¸€ä¸ªå¼•ç”¨åˆ‡ç‰‡å…ƒç´ çš„æŒ‡é’ˆæ¥è§£å†³</span><br><span class="line">        s.m[customer.ID] = customer    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="map-è¿­ä»£ä¸­çš„å¸¸è§é—®é¢˜"><a href="#map-è¿­ä»£ä¸­çš„å¸¸è§é—®é¢˜" class="headerlink" title="map è¿­ä»£ä¸­çš„å¸¸è§é—®é¢˜"></a>map è¿­ä»£ä¸­çš„å¸¸è§é—®é¢˜</h3><ol>
<li>map çš„è¿­ä»£é¡ºåºæ˜¯æ²¡æœ‰è§„å®šçš„ã€‚æ¯æ¬¡è¿­ä»£çš„é¡ºåºéƒ½æ˜¯ä¸åŒçš„ã€‚</li>
<li>åœ¨è¿­ä»£è¿‡ç¨‹ä¸­æ›´æ–°åœ°å›¾ï¼ˆæ’å…¥æˆ–åˆ é™¤å…ƒç´ ï¼‰æ˜¯å…è®¸çš„ï¼›å®ƒä¸ä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯æˆ–è¿è¡Œæ—¶é”™è¯¯ã€‚ï¼ˆä½†æ˜¯åœ¨è¿­ä»£è¿‡ç¨‹ä¸­å‘ map æ·»åŠ å…ƒç´ æ—¶ï¼Œåœ¨åç»­è¿­ä»£ä¸­å¯èƒ½ä¼šé‡åˆ°è¯¥å…ƒç´ ï¼Œä¹Ÿå¯èƒ½ä¸ä¼šï¼‰</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">m := <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">bool</span>&#123;</span><br><span class="line">    <span class="number">0</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="number">1</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="number">2</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> k, v := <span class="keyword">range</span> m &#123;</span><br><span class="line">    <span class="keyword">if</span> v &#123;</span><br><span class="line">        m[<span class="number">10</span>+k] = <span class="literal">true</span>  <span class="comment">// åœ¨éå†æœŸé—´æ’å…¥å…ƒç´ </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">fmt.Println(m)</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯è¿è¡Œä¸Šè¿°ä»£ç å¯èƒ½å¾—åˆ°çš„ç»“æœï¼Œå› ä¸ºä¸€è¾¹éå†ï¼Œä¸€éæ’å…¥å…ƒç´ ï¼Œæ‰€ä»¥ä¼šå‡ºç°æ–°æ’å…¥çš„å…ƒç´ å¯èƒ½ä¼šåœ¨åé¢å¯è§æˆ–è€…ä¸å¯è§ã€‚æ‰€ä»¥å½±å“äº†æœ€ç»ˆçš„ç»“æœã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">map[0:true 1:false 2:true 10:true 12:true 20:true 22:true 30:true]</span><br><span class="line">map[0:true 1:false 2:true 10:true 12:true 20:true 22:true 30:true 32:true]</span><br><span class="line">map[0:true 1:false 2:true 10:true 12:true 20:true]</span><br></pre></td></tr></table></figure></p>
<p><strong>ğŸ¡æ€»ç»“</strong></p>
<p>å½“æˆ‘ä»¬ä½¿ç”¨ map æ—¶ï¼Œä¸åº”è¯¥ä¾é ä»¥ä¸‹å†…å®¹ï¼š</p>
<ol>
<li>æ•°æ®æŒ‰é”®æ’åº</li>
<li>ä¿ç•™æ’å…¥é¡ºåº</li>
<li>ä¸€ä¸ªç¡®å®šçš„è¿­ä»£é¡ºåº</li>
<li>åœ¨åŒä¸€è½®è¿­ä»£ä¸­æ·»åŠ å…ƒç´ ï¼Œå¹¶æœŸå¾…åç»­åœ¨è¿­ä»£ä¸­é‡åˆ°è¯¥å…ƒç´ </li>
</ol>
<h3 id="break-çš„ä½¿ç”¨"><a href="#break-çš„ä½¿ç”¨" class="headerlink" title="break çš„ä½¿ç”¨"></a>break çš„ä½¿ç”¨</h3><p>è®°ä½ä¸€ä¸ª break çš„åŸåˆ™ï¼šbreak è¯­å¥åªä¼šç»ˆæ­¢æœ€æ·±å±‚çš„ forã€switch æˆ– select è¯­å¥çš„æ‰§è¡Œã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">    fmt.Printf(<span class="string">"%d "</span>, i)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">switch</span> i &#123;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">break</span>      â¶ è¿™ä¸ª <span class="keyword">break</span> ä¸æ˜¯ç»ˆæ­¢ <span class="keyword">for</span>ï¼Œè€Œæ˜¯ç»ˆæ­¢ <span class="keyword">switch</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœè¦ç»ˆæ­¢ for ï¼Œæœ€ç¬¦åˆçš„æ–¹å¼æ˜¯ä½¿ç”¨æ ‡ç­¾</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">loop:                           â¶ å®šä¸€ä¸ªå¾ªç¯æ ‡ç­¾</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">        fmt.Printf(<span class="string">"%d "</span>, i)</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">switch</span> i &#123;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">break</span> loop          â· <span class="keyword">break</span> loopæ ‡ç­¾ã€‚è¿™æ ·å°±èƒ½ç»ˆæ­¢æ•´ä¸ª <span class="keyword">for</span> å¾ªç¯</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// è¾“å‡º 0ï¼Œ1ï¼Œ2</span></span><br></pre></td></tr></table></figure>
<p>ä¾‹å¦‚ï¼Œåœ¨ä¸‹é¢ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æƒ³è¦åœ¨ä¸Šä¸‹æ–‡è¢«å–æ¶ˆçš„æ—¶å€™ä¸­æ–­å¾ªç¯:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">loop:                          â¶ å®šä¸€ä¸ªå¾ªç¯æ ‡ç­¾</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-ch:</span><br><span class="line">            <span class="comment">// Do something</span></span><br><span class="line">        <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">            <span class="keyword">break</span> loop         â· ä¸Šä¸‹æ–‡è¢«å–æ¶ˆæ—¶ï¼Œç»ˆæ­¢æ•´ä¸ª <span class="keyword">for</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="åœ¨å¾ªç¯ä¸­ä½¿ç”¨-defer"><a href="#åœ¨å¾ªç¯ä¸­ä½¿ç”¨-defer" class="headerlink" title="åœ¨å¾ªç¯ä¸­ä½¿ç”¨ defer"></a>åœ¨å¾ªç¯ä¸­ä½¿ç”¨ defer</h3><p>defer è¯­å¥ä¼šè¢«å»¶è¿Ÿè°ƒç”¨ â€”â€” ç›´åˆ°åŒ…å«å®ƒ defer çš„å‡½æ•°è¿”å›æ—¶æ‰ä¼šè°ƒç”¨ã€‚è¿™å°±ä¼šå¯¼è‡´ä¸€äº›ä½¿ç”¨ä¸Šçš„é—®é¢˜ã€‚</p>
<p>å¸¸è§çš„é”™è¯¯å°±æ˜¯ä¸äº†è§£åœ¨å¾ªç¯ä¸­ä½¿ç”¨ defer çš„åæœï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readFiles</span><span class="params">(ch &lt;-<span class="keyword">chan</span> <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> path := <span class="keyword">range</span> ch &#123;                    â¶ éå†é€šé“ä¸­çš„æ–‡ä»¶è·¯å¾„</span><br><span class="line">        file, err := os.Open(path)            â· æ‰“å¼€æ–‡ä»¶</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">defer</span> file.Close()                    â¸ å…³é—­æ–‡ä»¶</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Do something with file</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>defer æ˜¯åœ¨åŒ…å«å‡½æ•°è¿”å›æ—¶è°ƒåº¦å‡½æ•°è°ƒç”¨ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œdefer è°ƒç”¨å¹¶ä¸æ˜¯åœ¨æ¯ä¸ªå¾ªç¯æœŸé—´æ‰§è¡Œçš„ï¼Œè€Œæ˜¯åœ¨ readFiles å‡½æ•°è¿”å›æ—¶æ‰æ‰§è¡Œã€‚å¦‚æœ readFiles ä¸è¿”å›ï¼Œæ–‡ä»¶æè¿°ç¬¦å°†æ°¸è¿œä¿æŒæ‰“å¼€çŠ¶æ€ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p>
<p>ä¸€ç§è§£å†³çš„æ–¹æ³•æ˜¯æ”¾å¼ƒä½¿ç”¨ deferï¼Œæ”¹ä¸ºæ‰‹åŠ¨å…³é—­æ–‡ä»¶ã€‚</p>
<p>å¦ä¸€ç§è§£å†³æ–¹æ³•æ˜¯ï¼Œå°†æ–‡ä»¶çš„è¯»å–æ“ä½œæŠ½å–å‡ºæ¥å•ç‹¬å°è£…åœ¨ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œåœ¨å…¶ä¸­å®ç° defer çš„é€»è¾‘ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readFiles</span><span class="params">(ch &lt;-<span class="keyword">chan</span> <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> path := <span class="keyword">range</span> ch &#123;</span><br><span class="line">        <span class="keyword">if</span> err := readFile(path); err != <span class="literal">nil</span> &#123;    â¶ æ¯è¯»å–ä¸€ä¸ªæ–‡ä»¶å°±å…³é—­ä¸€ä¸ªæ–‡ä»¶</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readFile</span><span class="params">(path <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;  <span class="comment">// å°†è¯»å–æ–‡ä»¶å•ç‹¬å°è£…ï¼Œç¡®ä¿ defer èƒ½è¢«æ‰§è¡Œ</span></span><br><span class="line">    file, err := os.Open(path)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">defer</span> file.Close()                            â·</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Do something with file</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿˜æœ‰ä¸€ç§è§£å†³æ€è·¯æ˜¯å°† readFile å‡½æ•°è®¾è®¡ä¸ºä¸€ä¸ªé—­åŒ…</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readFiles</span><span class="params">(ch &lt;-<span class="keyword">chan</span> <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> path := <span class="keyword">range</span> ch &#123;</span><br><span class="line">        err := <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            <span class="keyword">defer</span> file.Close()</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;()                  â¶ è¿è¡Œé—­åŒ…ï¼Œç¡®ä¿è°ƒç”¨ <span class="keyword">defer</span> å…³é—­æ–‡ä»¶</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ç§è§£å†³æ–¹æ³•æœ¬è´¨ä¸Šå’Œç¬¬äºŒç§æ˜¯ä¸€è‡´çš„ã€‚</p>
<h3 id="ä¸ç†è§£-rune"><a href="#ä¸ç†è§£-rune" class="headerlink" title="ä¸ç†è§£ rune"></a>ä¸ç†è§£ rune</h3><p>æˆ‘ä»¬éœ€è¦å…ˆç†è§£ä¸¤ä¸ªåŸºç¡€æ¦‚å¿µï¼š</p>
<ol>
<li>å­—ç¬¦é›† ä»åå­—ç†è§£å°±æ˜¯å­—ç¬¦çš„é›†åˆï¼Œæ¯”å¦‚ <code>Unicode</code>å­—ç¬¦é›†åŒ…å«äº†2^21å­—ç¬¦ã€‚</li>
<li>ç¼–ç  æ˜¯ä¸€ä¸ªå­—ç¬¦åˆ—è¡¨åœ¨äºŒè¿›åˆ¶ç§çš„ç¿»è¯‘ã€‚æ¯”å¦‚UTF-8å°±æ˜¯ä¸€ç§æ ‡å‡†çš„ç¼–ç æ ¼å¼ï¼Œæ‰€æœ‰çš„å­—ç¬¦éƒ½ç”¨1-4ä¸ªå­—èŠ‚è¡¨ç¤ºã€‚</li>
</ol>
<blockquote>
<p>ä»£ç ç‚¹ï¼ˆCode Pointï¼‰æ˜¯æŒ‡åœ¨å­—ç¬¦ç¼–ç æ ‡å‡†ä¸­ï¼Œæ¯ä¸ªå­—ç¬¦æ‰€å¯¹åº”çš„å”¯ä¸€æ•°å€¼ã€‚å­—ç¬¦ç¼–ç æ˜¯ä¸€ç§å°†å­—ç¬¦æ˜ å°„åˆ°æ•°å­—çš„æ–¹å¼ï¼Œä»¥ä¾¿è®¡ç®—æœºèƒ½å¤Ÿå¤„ç†å’Œå­˜å‚¨æ–‡æœ¬æ•°æ®ã€‚ä¸åŒçš„å­—ç¬¦ç¼–ç æ ‡å‡†ä½¿ç”¨ä¸åŒçš„æ–¹æ³•æ¥åˆ†é…ä»£ç ç‚¹ã€‚</p>
<p>æœ€å¸¸è§çš„å­—ç¬¦ç¼–ç ä¹‹ä¸€æ˜¯ Unicodeï¼Œå®ƒä¸ºä¸–ç•Œä¸Šå‡ ä¹æ‰€æœ‰çš„å­—ç¬¦éƒ½å®šä¹‰äº†å”¯ä¸€çš„ä»£ç ç‚¹ã€‚Unicodeä½¿ç”¨åå…­è¿›åˆ¶è¡¨ç¤ºä»£ç ç‚¹ï¼Œä¾‹å¦‚å¤§å†™å­—æ¯â€Aâ€åœ¨Unicodeä¸­çš„ä»£ç ç‚¹ä¸ºU+0041ï¼Œå…¶ä¸­â€U+â€è¡¨ç¤ºUnicodeä»£ç ç‚¹çš„å‰ç¼€ï¼Œåé¢è·Ÿç€å››ä½åå…­è¿›åˆ¶æ•°ã€‚â€” chatgpt</p>
</blockquote>
<p>åœ¨<code>Unicode</code>ä¸­ï¼Œä½¿ç”¨ä¸€ä¸ªæ¦‚å¿µ<code>ä»£ç ç‚¹</code>å»è¡¨ç¤ºä¸€ä¸ªå•å€¼ã€‚æ¯”å¦‚<code>æ±‰</code>è¿™ä¸ªå­—ç¬¦çš„ä»£ç ç‚¹å°±æ˜¯<code>U+6C49</code>.ä½¿ç”¨UTF-8ï¼Œ<code>æ±‰</code>è¢«ç¼–ç æˆ3ä¸ªå­—èŠ‚ï¼š<code>0xE6, 0xB1, 0x89</code>ã€‚åœ¨Goä¸­ï¼Œ<code>rune</code>å°±æ˜¯ä¸€ä¸ªä»£ç ç‚¹ã€‚æ‰€ä»¥åœ¨Goä¸­ï¼Œä¸€ä¸ª<code>rune</code>å°±æ˜¯<code>int32</code>çš„åˆ«åã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="keyword">rune</span> = <span class="keyword">int32</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>åœ¨Goè¯­è¨€ä¸­ï¼Œ<code>rune</code>ç±»å‹å®é™…ä¸Šæ˜¯ä¸€ä¸ª<code>int32</code>ç±»å‹çš„åˆ«åï¼Œç”¨äºè¡¨ç¤ºä¸€ä¸ªUnicodeä»£ç ç‚¹ã€‚è¿™ä½¿å¾—åœ¨å¤„ç†å’Œæ“ä½œUnicodeå­—ç¬¦æ—¶æ›´åŠ æ–¹ä¾¿ï¼Œå› ä¸ºå®ƒå¯ä»¥å®¹çº³æ‰€æœ‰å¯èƒ½çš„Unicodeä»£ç ç‚¹ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;str := &quot;ä½ å¥½ï¼Œä¸–ç•Œï¼&quot;</span><br><span class="line">&gt;    </span><br><span class="line">&gt;for _, r := range str &#123;</span><br><span class="line">&gt;    fmt.Printf(&quot;Unicode code point: %U\n&quot;, r)</span><br><span class="line">&gt;&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>å­—ç¬¦ä¸² â€œä½ å¥½ï¼Œä¸–ç•Œï¼â€ ä¸­çš„æ¯ä¸ªå­—ç¬¦éƒ½è¢«è½¬æ¢ä¸ºå¯¹åº”çš„Unicodeä»£ç ç‚¹ï¼Œå¹¶ä½¿ç”¨<code>%U</code>æ ¼å¼åŒ–è¾“å‡ºã€‚</p>
</blockquote>
<h3 id="å­—ç¬¦ä¸²è¿­ä»£å’Œé•¿åº¦"><a href="#å­—ç¬¦ä¸²è¿­ä»£å’Œé•¿åº¦" class="headerlink" title="å­—ç¬¦ä¸²è¿­ä»£å’Œé•¿åº¦"></a>å­—ç¬¦ä¸²è¿­ä»£å’Œé•¿åº¦</h3><p>lenå†…ç½®å‡½æ•°å¹¶ä¸è¿”å›å­—ç¬¦æ•°ï¼Œè€Œæ˜¯å­—èŠ‚æ•°ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">s := <span class="string">"æ±‰"</span></span><br><span class="line">fmt.Println(<span class="built_in">len</span>(s)) <span class="comment">// 3 ä¸ªå­—èŠ‚</span></span><br><span class="line"></span><br><span class="line">s := <span class="keyword">string</span>([]<span class="keyword">byte</span>&#123;<span class="number">0xE6</span>, <span class="number">0xB1</span>, <span class="number">0x89</span>&#125;)</span><br><span class="line">fmt.Printf(<span class="string">"%s\n"</span>, s)  <span class="comment">// æ±‰</span></span><br></pre></td></tr></table></figure>
<p>è¿­ä»£å­—ç¬¦ä¸²ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">s := <span class="string">"hÃªllo"</span>            â¶ åŒ…å«ä¸€ä¸ªç‰¹æ®Šçš„ç¬¦æ–‡ï¼šÃª</span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> s &#123;</span><br><span class="line">    fmt.Printf(<span class="string">"position %d: %c\n"</span>, i, s[i])</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">"len=%d\n"</span>, <span class="built_in">len</span>(s))</span><br><span class="line"><span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">position 0: h</span></span><br><span class="line"><span class="string">position 1: Ãƒ  // é”™è¯¯çš„æ‰“å°äº†å­—ç¬¦</span></span><br><span class="line"><span class="string">position 3: l</span></span><br><span class="line"><span class="string">position 4: l</span></span><br><span class="line"><span class="string">position 5: o</span></span><br><span class="line"><span class="string">len=6  // é•¿åº¦ä¸º6ï¼Œä½†æ˜¯åªæœ‰5ä¸ªå­—ç¬¦ï¼Œå¹¶ä¸”å­—ç¬¦æ‰“å°å‡ºé”™</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯å› ä¸ºï¼Œæˆ‘ä»¬å¹¶ä¸æ˜¯è¿­ä»£æ¯ä¸€ä¸ªç¬¦æ–‡ï¼›ç›¸åï¼Œæˆ‘ä»¬æ˜¯è¿­ä»£æ¯ä¸€ä¸ªç¬¦æ–‡çš„èµ·å§‹ç´¢å¼•</p>
<p><img src="https://raw.githubusercontent.com/rexyan/warehouse/master/202308191252346.png" alt></p>
<p>æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥åœ¨è¿­ä»£çš„æ—¶å€™æ­£å¸¸æ˜¾ç¤ºå‘¢ï¼Ÿ</p>
<p>æ–¹æ³•ä¸€å°±æ˜¯åœ¨è¿­ä»£çš„æ—¶å€™ä¸ä½¿ç”¨ä¸‹æ ‡ï¼Œè€Œæ˜¯ä½¿ç”¨å˜é‡æœ¬èº«</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">s := <span class="string">"hÃªllo"</span></span><br><span class="line"><span class="keyword">for</span> i, r := <span class="keyword">range</span> s &#123;</span><br><span class="line">    fmt.Printf(<span class="string">"position %d: %c\n"</span>, i, r)</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">position 0: h</span></span><br><span class="line"><span class="string">position 1: Ãª</span></span><br><span class="line"><span class="string">position 3: l</span></span><br><span class="line"><span class="string">position 4: l</span></span><br><span class="line"><span class="string">position 5: o</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br></pre></td></tr></table></figure>
<p>æ–¹æ³•äºŒæ˜¯å°†å­—ç¬¦ä¸²è½¬æ¢ä¸º rune åˆ‡ç‰‡</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">s := <span class="string">"hÃªllo"</span></span><br><span class="line">runes := []<span class="keyword">rune</span>(s)</span><br><span class="line"><span class="keyword">for</span> i, r := <span class="keyword">range</span> runes &#123;</span><br><span class="line">    fmt.Printf(<span class="string">"position %d: %c\n"</span>, i, r)</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">position 0: h</span></span><br><span class="line"><span class="string">position 1: Ãª</span></span><br><span class="line"><span class="string">position 2: l</span></span><br><span class="line"><span class="string">position 3: l</span></span><br><span class="line"><span class="string">position 4: o</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br></pre></td></tr></table></figure>
<p>æ–¹æ³•äºŒå¼€é”€æ¯”æ–¹æ³•ä¸€å¤§ï¼Œå› ä¸ºå¤šäº†ä¸€å±‚ç±»å‹è½¬æ¢ã€‚</p>
<p><strong>ğŸ¡æ€»ç»“</strong></p>
<p>å¦‚æœæˆ‘ä»¬æƒ³è¦è¿­ä»£ä¸€ä¸ªå­—ç¬¦ä¸²çš„ç¬¦æ–‡ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨å­—ç¬¦ä¸²ä¸Šä½¿ç”¨ range å¾ªç¯ã€‚ä½†æ˜¯æˆ‘ä»¬å¿…é¡»è®°ä½ï¼Œç´¢å¼•ä¸å¯¹åº”äºç¬¦æ–‡ç´¢å¼•ï¼Œè€Œæ˜¯å¯¹åº”äºç¬¦æ–‡å­—èŠ‚åºåˆ—çš„èµ·å§‹ç´¢å¼•ã€‚å› ä¸ºä¸€ä¸ªç¬¦æ–‡å¯ä»¥ç”±å¤šä¸ªå­—èŠ‚ç»„æˆï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦è®¿é—®ç¬¦æ–‡æœ¬èº«ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ range çš„å€¼å˜é‡ï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸²ä¸­çš„ç´¢å¼•ã€‚åŒæ—¶ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦è·å–å­—ç¬¦ä¸²çš„ç¬¬iä¸ªç¬¦æ–‡ï¼Œæˆ‘ä»¬åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹åº”è¯¥å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºä¸€ä¸ª rune åˆ‡ç‰‡ã€‚</p>
<h3 id="trim-å‡½æ•°"><a href="#trim-å‡½æ•°" class="headerlink" title="trim å‡½æ•°"></a>trim å‡½æ•°</h3><p>Goå¼€å‘è€…åœ¨ä½¿ç”¨å­—ç¬¦ä¸²åŒ…æ—¶å¸¸è§çš„ä¸€ä¸ªé”™è¯¯æ˜¯æ··æ·† TrimRight å’Œ TrimSuffix å‡½æ•°ã€‚</p>
<p><strong>TrimRight</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fmt.Println(strings.TrimRight(<span class="string">"123oxo"</span>, <span class="string">"xo"</span>))</span><br><span class="line"><span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">123</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br></pre></td></tr></table></figure>
<p>TrimRight æ–¹æ³•å€’åºè¿­ä»£æ¯ä¸ªå­—ç¬¦ã€‚å¦‚æœæŸä¸ªå­—ç¬¦åœ¨æä¾›çš„å­—ç¬¦é›†ä¸­ï¼Œåˆ™è¯¥å‡½æ•°ä¼šå°†å…¶åˆ é™¤ã€‚å¦‚æœä¸åœ¨ï¼Œåˆ™å‡½æ•°åœæ­¢è¿­ä»£å¹¶è¿”å›å‰©ä½™å­—ç¬¦ä¸²</p>
<p><img src="https://raw.githubusercontent.com/rexyan/warehouse/master/202308192143378.png" alt></p>
<p><strong>TrimSuffix</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fmt.Println(strings.TrimSuffix(<span class="string">"123oxo"</span>, <span class="string">"xo"</span>))</span><br><span class="line"><span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">123o</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br></pre></td></tr></table></figure>
<p>ç”±äº123oxo ä»¥xo ç»“å°¾ï¼Œæ‰€ä»¥æ­¤ä»£ç å°†æ‰“å°å‡º123oã€‚æ­¤å¤–ï¼Œåˆ é™¤æœ«å°¾åç¼€å¹¶ä¸æ˜¯ä¸€ä¸ªé‡å¤çš„æ“ä½œï¼Œæ‰€ä»¥ TrimSuffix(â€œ123xoxoâ€, â€œxoâ€) è¿”å› 123xoã€‚</p>
<p>ä½¿ç”¨ TrimLeft å’Œ TrimPrefix å‡½æ•°å¤„ç†å­—ç¬¦ä¸²å·¦ä¾§çš„ç©ºæ ¼ï¼Œä¸ä¸Šè¿°åŸåˆ™æ˜¯ç›¸åŒçš„ã€‚</p>
<p>Trim=TrimLeft + TrimRightã€‚ å› æ­¤ï¼Œå®ƒä¼šåˆ é™¤é›†åˆä¸­åŒ…å«çš„æ‰€æœ‰å‰ç½®å’Œå°¾éƒ¨çš„å­—ç¬¦ã€‚</p>
<h3 id="å­—ç¬¦ä¸²æ‹¼æ¥"><a href="#å­—ç¬¦ä¸²æ‹¼æ¥" class="headerlink" title="å­—ç¬¦ä¸²æ‹¼æ¥"></a>å­—ç¬¦ä¸²æ‹¼æ¥</h3><p>å†™ä¸€ä¸ª concat å‡½æ•°ï¼Œä½¿ç”¨ += æ“ä½œç¬¦æ¥è¿æ¥åˆ‡ç‰‡çš„æ‰€æœ‰å­—ç¬¦ä¸²å…ƒç´ </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">concat</span><span class="params">(values []<span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    s := <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> _, value := <span class="keyword">range</span> values &#123;</span><br><span class="line">        s += value</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°å‡½æ•°çš„é—®é¢˜åœ¨äºï¼Œå­—ç¬¦ä¸²æ˜¯ä¸å¯å˜çš„ã€‚å› æ­¤ï¼Œæ¯æ¬¡è¿­ä»£éƒ½ä¸ä¼šæ›´æ–° sï¼Œè€Œæ˜¯åœ¨å†…å­˜ä¸­é‡æ–°åˆ†é…ä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²ï¼Œè¿™æ˜¾è‘—å½±å“äº†è¯¥å‡½æ•°çš„æ€§èƒ½ã€‚</p>
<p>è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•æ˜¯ä½¿ç”¨ strings åŒ…å’Œ Builder ç»“æ„ä½“:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">concat</span><span class="params">(values []<span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    sb := strings.Builder&#123;&#125;               â¶ åˆ›å»ºä¸€ä¸ª strings.Builder</span><br><span class="line">    <span class="keyword">for</span> _, value := <span class="keyword">range</span> values &#123;</span><br><span class="line">        _, _ = sb.WriteString(value)      â· è¿½åŠ å­—ç¬¦ä¸²</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sb.String()                    â¸ è¿”å›æ‹¼æ¥çš„å­—ç¬¦ä¸²</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>WriteStringè¿”å›ä¸€ä¸ªé”™è¯¯ä½œä¸ºç¬¬äºŒä¸ªè¾“å‡ºï¼Œä½†æˆ‘ä»¬æœ‰æ„å¿½ç•¥å®ƒã€‚å®é™…ä¸Šï¼Œè¿™ä¸ªæ–¹æ³•æ°¸è¿œä¸ä¼šè¿”å›énilé”™è¯¯ã€‚é‚£ä¹ˆè¿™ä¸ªæ–¹æ³•è¿”å›ç­¾åä¸­çš„é”™è¯¯çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿ strings.Builder å®ç°äº†io.StringWriteræ¥å£ï¼Œå®ƒåŒ…å«ä¸€ä¸ªæ–¹æ³•ï¼šWriteStringï¼ˆs stringï¼‰ï¼ˆn intï¼Œerr errorï¼‰ã€‚å› æ­¤ï¼Œä¸ºäº†éµå®ˆæ­¤æ¥å£ï¼ŒWriteStringå¿…é¡»è¿”å›ä¸€ä¸ªé”™è¯¯ã€‚</p>
<p>é™¤äº†ä¸Šè¿°çš„ WriteString å¤–ï¼Œstrings.Builder è¿˜æ”¯æŒå…¶ä»–çš„è¿½åŠ æ–¹æ³•ï¼š</p>
<ol>
<li>Write â€”â€” è¿½åŠ å­—èŠ‚åˆ‡ç‰‡</li>
<li>WriteByte â€”â€” è¿½åŠ å•ä¸ªå­—èŠ‚</li>
<li>WriteRune â€”â€” è¿½åŠ  rune</li>
</ol>
<p>æ³¨æ„äº‹é¡¹ï¼š</p>
<p>strings.Builder å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡ï¼Œæ¯æ¬¡è°ƒç”¨ WriteString éƒ½ä¼šå¯¼è‡´åœ¨è¿™ä¸ªåˆ‡ç‰‡ä¸Šè°ƒç”¨ appendï¼Œæ‰€ä»¥ï¼Œè¿™ä¸ªç»“æ„ä½“ä¸åº”è¯¥åŒæ—¶è¢«ä½¿ç”¨ï¼Œå› ä¸ºå¯¹ append çš„è°ƒç”¨ä¼šå¯¼è‡´ç«äº‰æ¡ä»¶ã€‚å…¶æ¬¡ï¼Œå¦‚æœå­—ç¬¦ä¸²çš„æœªæ¥é•¿åº¦æ˜¯çŸ¥é“çš„ï¼Œæˆ‘ä»¬åº”è¯¥é¢„å…ˆåˆ†é…ç©ºé—´ï¼Œstrings.Builder å…¬å¼€äº†ä¸€ä¸ªæ–¹æ³•Grow(n int)ï¼Œä»¥ä¿è¯æœ‰ n ä¸ªå­—èŠ‚çš„ç©ºé—´ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">concat</span><span class="params">(values []<span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    total := <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(values); i++ &#123;     â¶ è®¡ç®—æ€»é•¿åº¦ã€‚æ³¨æ„è¿™é‡Œä½¿ç”¨ <span class="built_in">len</span>ã€‚Grow å…³å¿ƒçš„æ˜¯å­—èŠ‚æ•°é‡ã€‚</span><br><span class="line">        total += <span class="built_in">len</span>(values[i])</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    sb := strings.Builder&#123;&#125;</span><br><span class="line">    sb.Grow(total)                         â· é¢„å…ˆåˆ†é…ç©ºé—´</span><br><span class="line">    <span class="keyword">for</span> _, value := <span class="keyword">range</span> values &#123;</span><br><span class="line">        _, _ = sb.WriteString(value)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sb.String()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ğŸ¡æ€»ç»“</strong></p>
<p>strings.Builder æ˜¯è¿æ¥å­—ç¬¦ä¸²åˆ—è¡¨çš„æ¨èè§£å†³æ–¹æ¡ˆã€‚é€šå¸¸ï¼Œåº”è¯¥åœ¨å¾ªç¯å†…ä½¿ç”¨æ­¤è§£å†³æ–¹æ¡ˆã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬åªéœ€è¦è¿æ¥å‡ ä¸ªå­—ç¬¦ä¸²ï¼ˆå¦‚åå­—å’Œå§“æ°ï¼‰ï¼Œä½¿ç”¨ strings.Builder ä¸å¦‚ä½¿ç”¨ += è¿ç®—ç¬¦æˆ– fmt.Sprintf æ–¹æ¡ˆå¯è¯»æ€§é«˜ã€‚</p>
<p>ä¸€èˆ¬åŸåˆ™ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥è®°ä½ï¼Œæ€§èƒ½æ–¹é¢ï¼Œå½“æˆ‘ä»¬éœ€è¦è¿æ¥è¶…è¿‡äº”ä¸ªå­—ç¬¦ä¸²æ—¶ï¼Œstrings.Builderè§£å†³æ–¹æ¡ˆæ›´å¿«ã€‚å³ä½¿è¿™ä¸ªç¡®åˆ‡çš„æ•°å­—å–å†³äºè®¸å¤šå› ç´ ï¼Œä¾‹å¦‚è¿æ¥çš„å­—ç¬¦ä¸²çš„å¤§å°å’Œæœºå™¨ï¼Œè¿™ä¹Ÿå¯ä»¥æˆä¸ºä¸€ä¸ªç»éªŒæ³•åˆ™ï¼Œå¸®åŠ©æˆ‘ä»¬å†³å®šä½•æ—¶é€‰æ‹©ä¸€ä¸ªè§£å†³æ–¹æ¡ˆè€Œä¸æ˜¯å¦ä¸€ä¸ªã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬ä¸åº”å¿˜è®°ï¼Œå¦‚æœå°†æ¥å­—ç¬¦ä¸²çš„å­—èŠ‚æ•°é‡äº‹å…ˆå·²çŸ¥ï¼Œåº”ä½¿ç”¨Growæ–¹æ³•æ¥é¢„åˆ†é…å†…éƒ¨å­—èŠ‚ç‰‡ã€‚</p>
<h3 id="æ— æ•ˆçš„å­—ç¬¦ä¸²è½¬æ¢"><a href="#æ— æ•ˆçš„å­—ç¬¦ä¸²è½¬æ¢" class="headerlink" title="æ— æ•ˆçš„å­—ç¬¦ä¸²è½¬æ¢"></a>æ— æ•ˆçš„å­—ç¬¦ä¸²è½¬æ¢</h3><p>å¤§éƒ¨åˆ†çš„ I/O æ“ä½œæ˜¯ä½¿ç”¨ []byte å®Œæˆçš„ã€‚ä¾‹å¦‚ï¼Œio.Readerã€io.Writer å’Œ io.ReadAll ä¸ []byte ä¸€èµ·å·¥ä½œï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸²ã€‚å› æ­¤ï¼Œä½¿ç”¨å­—ç¬¦ä¸²æ„å‘³ç€é¢å¤–çš„è½¬æ¢ï¼Œå°½ç®¡ bytes åŒ…ä¸­åŒ…å«äº†ä¸ strings åŒ…ç›¸åŒçš„è®¸å¤šæ“ä½œã€‚</p>
<p>æˆ‘ä»¬å°†å®ç°ä¸€ä¸ª getBytes å‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ª io.Reader ä½œä¸ºè¾“å…¥ï¼Œä»ä¸­è¯»å–æ•°æ®ï¼Œå¹¶è°ƒç”¨ä¸€ä¸ª sanitize å‡½æ•°ã€‚åˆ é™¤æ‰€æœ‰å‰å¯¼å’Œå°¾éƒ¨ç©ºæ ¼</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getBytes</span><span class="params">(reader io.Reader)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line">    b, err := io.ReadAll(reader)                    â¶ b æ˜¯ä¸€ä¸ª <span class="keyword">byte</span> åˆ‡ç‰‡</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Call sanitize</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆï¼Œæˆ‘ä»¬çš„ sanitize å‡½æ•°è¯¥æ€ä¹ˆå®ç°å‘¢ï¼Ÿæ¥æ”¶ä¸€ä¸ª å­—ç¬¦ä¸²ï¼Œç„¶åå»é™¤ç©ºæ ¼ï¼Ÿç„¶åå†å°†å­—ç¬¦ä¸²è¿”å›ï¼Ÿæœ€ç»ˆå†åœ¨ getBytes ä¸­è½¬æ¢ä¸º []byteï¼Ÿ</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sanitize</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> strings.TrimSpace(s)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¹ˆåšæ˜¯æœ‰ä»£ä»·çš„ï¼Œéœ€è¦å°†ä¸€ä¸ª[]byteè½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œå»é™¤ç©ºæ ¼åï¼Œå†å°†å­—ç¬¦ä¸²è½¬æ¢ä¸º[]byteã€‚</p>
<p>äº‹å®ä¸Šï¼Œåœ¨ strings åŒ…ä¸­çš„æ‰€æœ‰å…¬å¼€å‡½æ•°åœ¨ bytes åŒ…ä¸­éƒ½æœ‰ç›¸åº”çš„æ›¿ä»£å‡½æ•°ï¼šTrimSpaceã€Splitã€Countã€Containsã€Index ç­‰ç­‰ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸å¿…æ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç„¶åå†è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç„¶åå†å°†ç»“æœè½¬æ¢ä¸º []byteã€‚</p>
<h3 id="å­å­—ç¬¦ä¸²å†…å­˜æ³„éœ²"><a href="#å­å­—ç¬¦ä¸²å†…å­˜æ³„éœ²" class="headerlink" title="å­å­—ç¬¦ä¸²å†…å­˜æ³„éœ²"></a>å­å­—ç¬¦ä¸²å†…å­˜æ³„éœ²</h3><p>è¦æå–å­—ç¬¦ä¸²çš„å­é›†ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è¯­æ³•ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s1 := <span class="string">"Hello, World!"</span></span><br><span class="line">s2 := s1[:<span class="number">5</span>] <span class="comment">// Hello</span></span><br></pre></td></tr></table></figure>
<p>ä½†ä¸Šè¿°å‡½æ•°å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œè¿™ä¸ªç¤ºä¾‹ä»å‰äº”ä¸ªå­—èŠ‚åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè€Œä¸æ˜¯å‰äº”ä¸ªç¬¦æ–‡ã€‚å› æ­¤ï¼Œåœ¨å¤šå­—èŠ‚ç¼–ç ç¬¦æ–‡çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸åº”è¯¥ä½¿ç”¨è¿™ä¸ªè¯­æ³•ã€‚ç›¸åï¼Œæˆ‘ä»¬åº”è¯¥å…ˆå°†è¾“å…¥å­—ç¬¦ä¸²è½¬æ¢ä¸º []rune ç±»å‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s1 := <span class="string">"HÃªllo, World!"</span></span><br><span class="line">s2 := <span class="keyword">string</span>([]<span class="keyword">rune</span>(s1)[:<span class="number">5</span>]) <span class="comment">// HÃªllo</span></span><br></pre></td></tr></table></figure>
<p>å¦å¤–ä¸€ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬æ¥å—æ—¥å¿—æ¶ˆæ¯ï¼Œå‡è®¾æ—¥å¿—æœ€å¼€å¤´æ˜¯é•¿åº¦ä¸º 36 çš„UUIDï¼Œç„¶ååœ¨æ˜¯æ—¥å¿—å†…å®¹ã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦ä¿ç•™æœ€æ–°çš„ nä¸ªUUID çš„ç¼“å­˜ã€‚å‡è®¾è¿™äº›æ—¥å¿—æ¶ˆæ¯å¯èƒ½éå¸¸åºå¤§ï¼ˆé«˜è¾¾æ•°åƒå­—èŠ‚ï¼‰ã€‚ä»¥ä¸‹æ˜¯ä¸€ç§å®ç°æ–¹å¼ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s store)</span> <span class="title">handleLog</span><span class="params">(log <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(log) &lt; <span class="number">36</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">"log is not correctly formatted"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    uuid := log[:<span class="number">36</span>]  <span class="comment">// å–å‡ºæ—¥å¿—å‰é¢ uuid</span></span><br><span class="line">    s.store(uuid)</span><br><span class="line">    <span class="comment">// Do something</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä»£ç å­˜åœ¨å†…å­˜æ³„æ¼å—ï¼Ÿæ˜¯çš„ï¼log[:36] å°†åˆ›å»ºä¸€ä¸ªæ–°å­—ç¬¦ä¸²ï¼ŒåŒæ—¶ä¹Ÿä¼šå¼•ç”¨åŒä¸€åå¤‡æ•°ç»„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åœ¨å†…å­˜ä¸­å­˜å‚¨çš„æ¯ä¸ª uuid å­—ç¬¦ä¸²å°†åŒ…å«ä¸åªæ˜¯36ä¸ªå­—èŠ‚ï¼Œè€Œæ˜¯åˆå§‹æ—¥å¿—å­—ç¬¦ä¸²ä¸­çš„å­—èŠ‚ï¼ˆæ•°åƒå­—èŠ‚ï¼‰</p>
<p>é‚£ä¹ˆæ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ</p>
<p>æ–¹æ³•ä¸€ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s store)</span> <span class="title">handleLog</span><span class="params">(log <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(log) &lt; <span class="number">36</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">"log is not correctly formatted"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    uuid := <span class="keyword">string</span>([]<span class="keyword">byte</span>(log[:<span class="number">36</span>]))     â¶ å…ˆè½¬æ¢ä¸º []<span class="keyword">byte</span> ç±»å‹ï¼Œç„¶åè½¬æ¢ä¸ºå­—ç¬¦ä¸²</span><br><span class="line">    s.store(uuid)</span><br><span class="line">    <span class="comment">// Do something</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡é¦–å…ˆå°†å­ä¸²è½¬æ¢ä¸º[]byteï¼Œç„¶åå†è½¬æ¢å›å­—ç¬¦ä¸²æ¥ï¼Œé€šè¿‡è¿™æ ·åšï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”å¯ä»¥é˜²æ­¢å‘ç”Ÿå†…å­˜æ³„æ¼ã€‚ä¸” UUID å­—ç¬¦ä¸²ç”±ä»…ç”±36ä¸ªå­—èŠ‚ç»„æˆçš„æ•°ç»„æ”¯æŒã€‚</p>
<p>æ–¹æ³•äºŒï¼š</p>
<p>Go 1.18 ä¸­ï¼Œæ ‡å‡†åº“è¿˜åŒ…æ‹¬äº†ä¸€ä¸ªä½¿ç”¨ strings.Clone æ–¹æ³•è¿”å›å­—ç¬¦ä¸²çš„æ–°å‰¯æœ¬çš„è§£å†³æ–¹æ¡ˆï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uuid := strings.Clone(log[:<span class="number">36</span>])</span><br></pre></td></tr></table></figure>
<p><strong>ğŸ¡æ€»ç»“</strong></p>
<p>åœ¨ä½¿ç”¨Goä¸­çš„å­å­—ç¬¦ä¸²æ“ä½œæ—¶ï¼Œæˆ‘ä»¬éœ€è¦è®°ä½ä¸¤ä»¶äº‹æƒ…ã€‚é¦–å…ˆï¼Œæä¾›çš„åŒºé—´æ˜¯åŸºäºå­—èŠ‚è€Œä¸æ˜¯åŸºäºç¬¦æ–‡æ•°é‡ã€‚å…¶æ¬¡ï¼Œå­å­—ç¬¦ä¸²æ“ä½œå¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œå› ä¸ºç”Ÿæˆçš„å­å­—ç¬¦ä¸²å°†ä¸åˆå§‹å­—ç¬¦ä¸²å…±äº«ç›¸åŒçš„åå¤‡æ•°ç»„ã€‚é˜²æ­¢å‘ç”Ÿè¿™ç§æƒ…å†µçš„è§£å†³æ–¹æ¡ˆæ˜¯æ‰‹åŠ¨æ‰§è¡Œå­—ç¬¦ä¸²å¤åˆ¶æˆ–ä½¿ç”¨Go 1.18ä¸­çš„strings.Cloneã€‚</p>
<h3 id="ä¸çŸ¥è¯¥ç”¨å“ªç§ç±»å‹çš„æ–¹æ³•æ¥æ”¶å™¨"><a href="#ä¸çŸ¥è¯¥ç”¨å“ªç§ç±»å‹çš„æ–¹æ³•æ¥æ”¶å™¨" class="headerlink" title="ä¸çŸ¥è¯¥ç”¨å“ªç§ç±»å‹çš„æ–¹æ³•æ¥æ”¶å™¨"></a>ä¸çŸ¥è¯¥ç”¨å“ªç§ç±»å‹çš„æ–¹æ³•æ¥æ”¶å™¨</h3><p>åœ¨ Go è¯­è¨€ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°†å€¼æˆ–æŒ‡é’ˆæ¥æ”¶å™¨é™„åŠ åˆ°æ–¹æ³•ä¸Šã€‚ä½¿ç”¨å€¼æ¥æ”¶å™¨æ—¶ï¼ŒGo ä¼šå¤åˆ¶è¯¥å€¼å¹¶å°†å…¶ä¼ é€’ç»™æ–¹æ³•ã€‚å¯¹å¯¹è±¡æ‰€ä½œçš„ä»»ä½•æ›´æ”¹éƒ½ä»…é™äºè¯¥æ–¹æ³•èŒƒå›´å†…ï¼ŒåŸå§‹å¯¹è±¡ä»ä¿æŒä¸å˜ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> customer <span class="keyword">struct</span> &#123;</span><br><span class="line">    balance <span class="keyword">float64</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c customer)</span> <span class="title">add</span><span class="params">(v <span class="keyword">float64</span>)</span></span> &#123;              â¶ å€¼æ¥æ”¶å™¨</span><br><span class="line">    c.balance += v</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    c := customer&#123;balance: <span class="number">100.</span>&#125;</span><br><span class="line">    c.add(<span class="number">50.</span>)</span><br><span class="line">    fmt.Printf(<span class="string">"balance: %.2f\n"</span>, c.balance)    â· balance ä¾ç„¶æ˜¯ <span class="number">100</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦ä¸€æ–¹é¢ï¼Œä½¿ç”¨æŒ‡é’ˆæ¥æ”¶å™¨æ—¶ï¼ŒGoå°†å¯¹è±¡çš„åœ°å€ä¼ é€’ç»™æ–¹æ³•ã€‚ä»æœ¬è´¨ä¸Šè®²ï¼Œå®ƒä»ç„¶æ˜¯ä¸€ä¸ªå‰¯æœ¬ï¼Œä½†æˆ‘ä»¬åªå¤åˆ¶æŒ‡é’ˆï¼Œè€Œä¸æ˜¯å¯¹è±¡æœ¬èº«ï¼ˆåœ¨Goä¸­ä¸å­˜åœ¨æŒ‰å¼•ç”¨ä¼ é€’ï¼‰ã€‚å¯¹æ¥æ”¶å™¨çš„ä»»ä½•ä¿®æ”¹éƒ½æ˜¯åœ¨åŸå§‹å¯¹è±¡ä¸Šå®Œæˆçš„</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> customer <span class="keyword">struct</span> &#123;</span><br><span class="line">    balance <span class="keyword">float64</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *customer)</span> <span class="title">add</span><span class="params">(operation <span class="keyword">float64</span>)</span></span> &#123;    â¶ æŒ‡é’ˆæ¥æ”¶å™¨</span><br><span class="line">    c.balance += operation</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    c := customer&#123;balance: <span class="number">100.0</span>&#125;</span><br><span class="line">    c.add(<span class="number">50.0</span>)</span><br><span class="line">    fmt.Printf(<span class="string">"balance: %.2f\n"</span>, c.balance)   â· balance ä¸º <span class="number">150</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ğŸ¡æ€»ç»“</strong></p>
<p>receiver å¿…é¡»æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼š</p>
<ol>
<li><p>å¦‚æœè¯¥æ–¹æ³•éœ€è¦æ”¹å˜æ¥æ”¶è€…ã€‚ä¾‹å¦‚å¦‚æœæ¥æ”¶è€…æ˜¯ä¸€ä¸ªåˆ‡ç‰‡ï¼Œå¹¶ä¸”æ–¹æ³•éœ€è¦è¿½åŠ å…ƒç´ </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> slice []<span class="keyword">int</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *slice)</span> <span class="title">add</span><span class="params">(element <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    *s = <span class="built_in">append</span>(*s, element)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¦‚æœæ–¹æ³•æ¥æ”¶å™¨åŒ…å«æ— æ³•å¤åˆ¶çš„å­—æ®µï¼šä¾‹å¦‚ï¼ŒsyncåŒ…çš„ç±»å‹éƒ¨åˆ†</p>
</li>
</ol>
<p>receiver åº”è¯¥æ˜¯æŒ‡é’ˆï¼š</p>
<ol>
<li>å¦‚æœæ¥æ”¶å™¨æ˜¯ä¸€ä¸ªå¤§å¯¹è±¡ï¼Œä½¿ç”¨æŒ‡é’ˆå¯ä»¥ä½¿è°ƒç”¨æ›´æœ‰æ•ˆï¼Œå› ä¸ºè¿™æ ·å¯ä»¥é˜²æ­¢è¿›è¡Œå¹¿æ³›çš„å¤åˆ¶ã€‚</li>
</ol>
<p>receiver å¿…é¡»æ˜¯ä¸€ä¸ªå€¼ï¼š</p>
<ol>
<li>å¦‚æœæˆ‘ä»¬å¿…é¡»å¼ºåˆ¶æ¥æ”¶å™¨çš„ä¸å¯å˜æ€§</li>
<li>æ¥æ”¶è€…æ˜¯ä¸€ä¸ªmapã€å‡½æ•°æˆ–ç®¡é“</li>
<li>å¦‚æœæ¥æ”¶å™¨æ˜¯ä¸€ä¸ªä¸å¿…è¢«æ”¹å˜çš„åˆ‡ç‰‡</li>
<li>å¦‚æœæ¥æ”¶è€…æ˜¯ä¸€ä¸ªå°çš„æ•°ç»„æˆ–ç»“æ„ä½“ï¼Œè‡ªç„¶åº”è¯¥æ˜¯æ²¡æœ‰å¯å˜å­—æ®µçš„å€¼ç±»å‹ï¼Œä¾‹å¦‚ time.Time</li>
<li>å¦‚æœæ¥æ”¶å™¨æ˜¯ intã€float64 æˆ– string ç­‰åŸºæœ¬ç±»å‹</li>
</ol>
<h3 id="å‘½åè¿”å›å‚æ•°"><a href="#å‘½åè¿”å›å‚æ•°" class="headerlink" title="å‘½åè¿”å›å‚æ•°"></a>å‘½åè¿”å›å‚æ•°</h3><p>å‘½åè¿”å›å‚æ•°ç®€å•ç¤ºä¾‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">(a <span class="keyword">int</span>)</span> <span class="params">(b <span class="keyword">int</span>)</span></span> &#123;    â¶ å‘½åç»“æœå‚æ•° <span class="keyword">int</span> b</span><br><span class="line">    b = a</span><br><span class="line">    <span class="keyword">return</span>                 â· è¿”å›å˜é‡ b çš„å½“å‰å€¼</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»€ä¹ˆæ—¶å€™å»ºè®®æˆ‘ä»¬ä½¿ç”¨å‘½åç»“æœå‚æ•°ï¼Ÿ</p>
<p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªä»ç»™å®šåœ°å€ä¸­è·å–åæ ‡çš„æ¥å£ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸ºäº†è®©ä»£ç æ›´æ˜“äºé˜…è¯»ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨å‘½åç»“æœå‚æ•°</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> locator <span class="keyword">interface</span> &#123;</span><br><span class="line">    getCoordinates(address <span class="keyword">string</span>) (lat, lng <span class="keyword">float32</span>, err error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»€ä¹ˆæ—¶å€™å»ºè®®ä¸ä½¿ç”¨å‘½åçš„ç»“æœå‚æ•°ï¼Ÿ</p>
<p>å‡è®¾æˆ‘æˆ‘ä»¬éœ€è¦å°†ä¸€ä¸ª Customer ç±»å‹å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ï¼Œè¿™é‡Œçš„å°†é”™è¯¯å‚æ•°å‘½åä¸º err æ˜¯æ²¡æœ‰å¸®åŠ©çš„ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">StoreCustomer</span><span class="params">(customer Customer)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› æ­¤ï¼Œä½•æ—¶ä½¿ç”¨å‘½åç»“æœå‚æ•°å–å†³äºä¸Šä¸‹æ–‡ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¦‚æœä¸æ¸…æ¥šä½¿ç”¨å®ƒä»¬æ˜¯å¦ä½¿æˆ‘ä»¬çš„ä»£ç æ›´å¯è¯»ï¼Œæˆ‘ä»¬å°±ä¸åº”è¯¥ä½¿ç”¨å‘½åç»“æœå‚æ•°ã€‚</p>
<p>è¿˜æœ‰ä¸€ç§åœºæ™¯æ˜¯å‘½åç»“æœå‚æ•°å¹¶ä¸ä¼šä½¿æˆ‘ä»¬çš„ä»£ç æ›´æ˜“äºé˜…è¯»ï¼Œè€Œæ˜¯åˆå§‹åŒ–äº†çš„å‘½åç»“æœå‚æ•°å¯èƒ½ä¼šéå¸¸æ–¹ä¾¿</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadFull</span><span class="params">(r io.Reader, buf []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">len</span>(buf) &gt; <span class="number">0</span> &amp;&amp; err == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> nr <span class="keyword">int</span></span><br><span class="line">        nr, err = r.Read(buf)</span><br><span class="line">        n += nr</span><br><span class="line">        buf = buf[nr:]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå‘½åç»“æœå‚æ•°å¹¶ä¸ä¼šçœŸæ­£å¢åŠ å¯è¯»æ€§ã€‚ä½†æ˜¯ï¼Œç”±äºnå’Œerréƒ½è¢«åˆå§‹åŒ–ä¸ºå®ƒä»¬çš„é›¶å€¼ï¼Œä½¿å¾—å®ç°å˜å¾—æ›´çŸ­äº†ã€‚ä½†å¦ä¸€æ–¹é¢ï¼Œå¯¹äºè¯»è€…æ¥è¯´ï¼Œè¿™ä¸ªå‡½æ•°å¯èƒ½æœ‰ç‚¹ä»¤äººå›°æƒ‘ã€‚</p>
<h3 id="å‘½åè¿”å›å‚æ•°æ„å¤–è¾¹ç•Œæƒ…å†µ"><a href="#å‘½åè¿”å›å‚æ•°æ„å¤–è¾¹ç•Œæƒ…å†µ" class="headerlink" title="å‘½åè¿”å›å‚æ•°æ„å¤–è¾¹ç•Œæƒ…å†µ"></a>å‘½åè¿”å›å‚æ•°æ„å¤–è¾¹ç•Œæƒ…å†µ</h3><p>åœ¨ä¸€äº›æƒ…å†µä¸‹å‘½åçš„ç»“æœå‚æ•°å¾ˆæœ‰ç”¨ã€‚ä½†æ˜¯ç”±äºè¿™äº›ç»“æœå‚æ•°è¢«åˆå§‹åŒ–ä¸ºå®ƒä»¬çš„é›¶å€¼ï¼Œå¦‚æœæˆ‘ä»¬ä¸å¤Ÿå°å¿ƒï¼Œä½¿ç”¨å®ƒä»¬æœ‰æ—¶ä¼šå¯¼è‡´å¾®å¦™çš„é”™è¯¯ã€‚</p>
<p>æˆ‘ä»¬å°†ä¹‹å‰çš„ getCoordinates æ–¹æ³•ä¿®æ”¹ä¸€ä¸‹ï¼Œä¼ å…¥ä¸€ä¸ª ctxï¼Œå¹¶åœ¨å‡½æ•°å†…éƒ¨æ·»åŠ ä¸€ä¸ªéªŒè¯åœ°å€æ˜¯å¦æœ‰æ•ˆçš„é€»è¾‘ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l loc)</span> <span class="title">getCoordinates</span><span class="params">(ctx context.Context, address <span class="keyword">string</span>)</span> <span class="params">(lat, lng <span class="keyword">float32</span>, err error)</span></span> &#123;</span><br><span class="line">    isValid := l.validateAddress(address)          â¶ éªŒè¯åœ°å€</span><br><span class="line">    <span class="keyword">if</span> !isValid &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, <span class="number">0</span>, errors.New(<span class="string">"invalid address"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> ctx.Err() != <span class="literal">nil</span> &#123;                          â· æ£€æŸ¥ä¸Šä¸‹æ–‡æ˜¯å¦å·²å–æ¶ˆ</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, <span class="number">0</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Get and return coordinates</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œif ctx.Err() != nil çš„ä½œç”¨åŸŸä¸­è¿”å›çš„é”™è¯¯æ˜¯errã€‚ä½†æˆ‘ä»¬æ²¡æœ‰ä¸ºerrå˜é‡åˆ†é…ä»»ä½•å€¼ã€‚ä½†å®ƒæ˜¯ä¸€ä¸ªå‘½åå‚æ•°ï¼Œæ‰€ä»¥å®ƒä»ç„¶è¢«åˆ†é…ä¸ºé”™è¯¯ç±»å‹çš„é›¶å€¼ï¼šnilã€‚å› æ­¤ï¼Œè¿™æ®µä»£ç æ€»æ˜¯ä¼šè¿”å›ä¸€ä¸ªnilé”™è¯¯ã€‚ä½†å…¶å® ctx å‘ç”Ÿäº†é”™è¯¯ã€‚</p>
<p>ä¸€ç§è§£å†³æ–¹æ³•æ˜¯å°† ctx.Err() åˆ†é…ç»™ err</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> err := ctx.Err(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>, <span class="number">0</span>, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ–è€…</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> err = ctx.Err(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½†ä¸å»ºè®®ç¬¬äºŒç§æ–¹å¼ï¼Œå› ä¸ºå’Œä¸Šé¢ <code>if !isValid</code> çš„è¿”å›é£æ ¼ä¸ä¸€è‡´ï¼Œåœ¨ä¸€ä¸ªæ–¹æ³•ä¸­ï¼Œæœ€å¥½ä¸è¦å‡ºç°ä¸ä¸€è‡´çš„å†™æ³•ã€‚</p>
<h3 id="nil-receiver"><a href="#nil-receiver" class="headerlink" title="nil receiver"></a>nil receiver</h3><p>æˆ‘ä»¬å°†ä¼šåˆ›å»ºä¸€ä¸ªåä¸º Customer çš„ç»“æ„ä½“ï¼Œå¹¶å®ç°ä¸€ä¸ª Validate æ–¹æ³•æ¥è¿›è¡Œåˆç†æ€§æ£€æŸ¥ã€‚ä½†æˆ‘ä»¬ä¸æƒ³åªè¿”å›ç¬¬ä¸€ä¸ªé”™è¯¯ä¿¡æ¯ï¼Œæˆ‘ä»¬å¸Œæœ›è¿”å›æ•´ä¸ªé”™è¯¯åˆ—è¡¨ã€‚ä¸ºäº†å®ç°è¿™ä¸ªç›®æ ‡ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰é”™è¯¯ç±»å‹ä»¥ä¾¿ä¼ é€’å¤šä¸ªé”™è¯¯ä¿¡æ¯ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MultiError <span class="keyword">struct</span> &#123;</span><br><span class="line">    errs []<span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *MultiError)</span> <span class="title">Add</span><span class="params">(err error)</span></span> &#123;      â¶ æ·»åŠ ä¸€ä¸ªé”™è¯¯</span><br><span class="line">    m.errs = <span class="built_in">append</span>(m.errs, err.Error())</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *MultiError)</span> <span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span> &#123;      â· å®ç°äº†erroræ¥å£</span><br><span class="line">    <span class="keyword">return</span> strings.Join(m.errs, <span class="string">";"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c Customer)</span> <span class="title">Validate</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> m *MultiError                           â¶ å®ä¾‹åŒ–ä¸€ä¸ªç©ºçš„ *MultiError</span><br><span class="line">    <span class="keyword">if</span> c.Age &lt; <span class="number">0</span> &#123;</span><br><span class="line">        m = &amp;MultiError&#123;&#125;</span><br><span class="line">        m.Add(errors.New(<span class="string">"age is negative"</span>))    â· å¦‚æœå¹´é¾„ä¸ºè´Ÿæ•°ï¼Œåˆ™æ·»åŠ ä¸€ä¸ªé”™è¯¯</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> c.Name == <span class="string">""</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> m == <span class="literal">nil</span> &#123;</span><br><span class="line">            m = &amp;MultiError&#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        m.Add(errors.New(<span class="string">"name is nil"</span>))        â¸ å¦‚æœåå­—ä¸ºè´Ÿæ•°ï¼Œåˆ™æ·»åŠ ä¸€ä¸ªé”™è¯¯</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> m</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•å¦‚ä¸‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">customer := Customer&#123;Age: <span class="number">33</span>, Name: <span class="string">"John"</span>&#125;</span><br><span class="line"><span class="keyword">if</span> err := customer.Validate(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatalf(<span class="string">"customer is invalid: %v"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">2021/05/08 13:47:28 customer is invalid: &lt;nil&gt;</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªç»“æœå¯èƒ½ä¼šç›¸å½“ä»¤äººæƒŠè®¶ã€‚Customer æ˜¯æœ‰æ•ˆçš„ï¼Œä½† errï¼= nil çš„æ¡ä»¶ä¸ºçœŸï¼Œæ‰“å°äº† <code>&lt;nil&gt;</code></p>
<p>æˆ‘ä»¬å†æ¥çœ‹å¦ä¸€ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Foo <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(foo *Foo)</span> <span class="title">Bar</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"bar"</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> foo *Foo</span><br><span class="line">    fmt.Println(foo.Bar())   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>foo è¢«åˆå§‹åŒ–ä¸ºæŒ‡é’ˆçš„é›¶å€¼ï¼šnilã€‚ä½†æ˜¯ç¼–è¯‘è¿™æ®µä»£ç æ˜¯å¯ä»¥é€šè¿‡çš„ï¼Œè€Œä¸”å¦‚æœæˆ‘ä»¬è¿è¡Œå®ƒï¼Œå®ƒä¼šæ‰“å° barã€‚æ‰€ä»¥ç©ºæŒ‡é’ˆæ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æ¥æ”¶å™¨ã€‚</p>
<p>å›åˆ°ä¸Šä¸Šä¸ªä¾‹å­ä¸­ï¼Œmä¼šè¢«åˆå§‹åŒ–ä¸ºæŒ‡é’ˆçš„é›¶å€¼ï¼šnilã€‚ç„¶åï¼Œå¦‚æœæ‰€æœ‰çš„æ£€æŸ¥éƒ½æœ‰æ•ˆï¼Œæä¾›ç»™ return è¯­å¥çš„å‚æ•°ä¸æ˜¯ç›´æ¥çš„ nil è€Œæ˜¯ä¸€ä¸ª nilæŒ‡é’ˆã€‚å› ä¸ºnilæŒ‡é’ˆæ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æ¥æ”¶å™¨ï¼Œå°†ç»“æœè½¬æ¢ä¸ºæ¥å£ä¸ä¼šäº§ç”Ÿnilå€¼ã€‚æ¢å¥è¯è¯´ï¼Œè°ƒç”¨Validateçš„è°ƒç”¨è€…å°†å§‹ç»ˆè·å¾—ä¸€ä¸ªénilçš„é”™è¯¯ã€‚</p>
<p>å¦‚ä½•è§£å†³è¿™ä¸ªä¾‹å­å‘¢ï¼Ÿæœ€ç®€å•çš„è§£å†³æ–¹æ³•å°±æ˜¯ï¼šå¦‚æœ m ä¸æ˜¯ nilï¼Œé‚£å°±è¿”å›å®ƒã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c Customer)</span> <span class="title">Validate</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> m *MultiError</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> c.Age &lt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> c.Name == <span class="string">""</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> m != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> m     â¶ ä»…åœ¨è‡³å°‘æœ‰ä¸€ä¸ªé”™è¯¯æ—¶è¿”å› m</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>       â· è¿”å› <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ä½¿ç”¨æ–‡ä»¶åä½œä¸ºå…¥å‚"><a href="#ä½¿ç”¨æ–‡ä»¶åä½œä¸ºå…¥å‚" class="headerlink" title="ä½¿ç”¨æ–‡ä»¶åä½œä¸ºå…¥å‚"></a>ä½¿ç”¨æ–‡ä»¶åä½œä¸ºå…¥å‚</h3><p>å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªéœ€è¦è¯»æ–‡ä»¶çš„å‡½æ•°æ—¶ï¼Œä¼ é€’ä¸€ä¸ªæ–‡ä»¶åä½œä¸ºå…¥å‚å¹¶ä¸åˆé€‚ï¼Œæ¯”å¦‚å•å…ƒæµ‹è¯•çš„æ—¶å€™å°±å¾ˆéš¾å†™ã€‚</p>
<p>æ¯”å¦‚æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªè¯»å–è¡Œæ•°çš„å‡½æ•°ï¼Œæˆ‘ä»¬éœ€è¦è¦†ç›–3ç§case:æ­£å¸¸case/ç©ºæ–‡ä»¶/åªæœ‰ç©ºè¡Œçš„æ–‡ä»¶ã€‚é‚£æˆ‘ä»¬å°±éœ€è¦åˆ›å»º3ä¸ªæ–‡ä»¶åœ¨å•å…ƒæµ‹è¯•ä¸­ã€‚</p>
<p>æ‰€ä»¥æ¯”è¾ƒå¥½çš„æ–¹å¼æ˜¯ä½¿ç”¨<code>io.Reader</code>ä½œä¸ºå‚æ•°ã€‚</p>
<h3 id="defer-å‚æ•°å’Œä¸åŒ-receiver"><a href="#defer-å‚æ•°å’Œä¸åŒ-receiver" class="headerlink" title="defer å‚æ•°å’Œä¸åŒ receiver"></a>defer å‚æ•°å’Œä¸åŒ receiver</h3><p>æˆ‘ä»¬çš„ä¸€ä¸ªå‡½æ•°éœ€è¦è°ƒç”¨ä¸¤ä¸ªå‡½æ•°fooå’Œbarã€‚åŒæ—¶ï¼Œå®ƒå¿…é¡»å¤„ç†å…³äºæ‰§è¡Œçš„çŠ¶æ€ï¼š</p>
<ul>
<li>å¦‚æœfooå’Œbaréƒ½æ²¡æœ‰è¿”å›é”™è¯¯ï¼Œåˆ™çŠ¶æ€ä¸ºStatusSuccess</li>
<li>å¦‚æœfooè¿”å›é”™è¯¯ï¼Œåˆ™ä¸ºStatusErrorFoo</li>
<li>å¦‚æœbarå‡½æ•°è¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œåˆ™ä¸ºStatusErrorBar </li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    StatusSuccess  = <span class="string">"success"</span></span><br><span class="line">    StatusErrorFoo = <span class="string">"error_foo"</span></span><br><span class="line">    StatusErrorBar = <span class="string">"error_bar"</span></span><br><span class="line">)</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> status <span class="keyword">string</span>  <span class="comment">// å®šä¹‰çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">defer</span> notify(status)               â¶ å»¶è¿Ÿè°ƒç”¨ notifyï¼Œå¹¶ä¼ å…¥ status</span><br><span class="line">    <span class="keyword">defer</span> incrementCounter(status)     â· å»¶è¿Ÿè°ƒç”¨ incrementCounterï¼Œå¹¶ä¼ å…¥ status</span><br><span class="line">    <span class="keyword">if</span> err := foo(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        status = StatusErrorFoo        â¸ å°†çŠ¶æ€è®¾ç½®ä¸º StatusErrorFoo</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> err := bar(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        status = StatusErrorBar        â¹ å°†çŠ¶æ€è®¾ç½®ä¸º StatusErrorBar</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    status = StatusSuccess             âº å°†çŠ¶æ€è®¾ç½®ä¸º StatusSuccess</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆæˆ‘ä»¬å£°æ˜ä¸€ä¸ªçŠ¶æ€å˜é‡ã€‚ç„¶åä½¿ç”¨ defer å»¶è¿Ÿè°ƒç”¨ notify å’Œ incrementCounter å‡½æ•°ã€‚ç„¶è€Œï¼Œå¦‚æœæˆ‘ä»¬å°è¯•ä½¿ç”¨è¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬ä¼šå‘ç°æ— è®ºæ‰§è¡Œè·¯å¾„å¦‚ä½•ï¼Œnotify å’Œ incrementCounter æ€»æ˜¯è¢«è°ƒç”¨å¹¶ä½¿ç”¨ç›¸åŒçš„çŠ¶æ€ï¼šä¸€ä¸ªç©ºå­—ç¬¦ä¸²ï¼</p>
<p>å‡ºç°è¿™ä¸ªé—®é¢˜çš„åŸå› æ˜¯ï¼Œå‚æ•°ä¼šç«‹å³è¢«è¯„ä¼°ï¼Œè€Œä¸æ˜¯åœ¨åŒ…å›´å‡½æ•°è¿”å›æ—¶ã€‚åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°† notifyï¼ˆstatusï¼‰å’Œ incrementCounterï¼ˆstatusï¼‰ä½œä¸ºå»¶è¿Ÿå‡½æ•°è°ƒç”¨ã€‚ä½†æ˜¯ä¼ å…¥çš„å‚æ•° status å°†æ˜¯å½“å‰çš„å€¼ï¼Œè€Œä¸æ˜¯æœ€ç»ˆçš„å€¼ã€‚</p>
<p>è§£å†³æ–¹æ³•ä¸€ï¼Œå°†ä¸€ä¸ªå­—ç¬¦ä¸²æŒ‡é’ˆä¼ é€’ç»™å»¶è¿Ÿå‡½æ•°</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> status <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">defer</span> notify(&amp;status)                â¶ ä¼ é€’ä¸€ä¸ªå­—ç¬¦ä¸²æŒ‡é’ˆ</span><br><span class="line">    <span class="keyword">defer</span> incrementCounter(&amp;status)      â· ä¼ é€’ä¸€ä¸ªå­—ç¬¦ä¸²æŒ‡é’ˆ</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// The rest of the function is unchanged</span></span><br><span class="line">    <span class="keyword">if</span> err := foo(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        status = StatusErrorFoo</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> err := bar(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        status = StatusErrorBar</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    status = StatusSuccess</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨ defer ä¼šç«‹å³è¯„ä¼°å‚æ•°ï¼šåœ¨è¿™é‡Œï¼Œæ˜¯ status çš„åœ°å€ã€‚status æœ¬èº«åœ¨å‡½æ•°ä¸­é€æ¸æ›´æ–°ï¼Œä½†æ˜¯å…¶åœ°å€ä¿æŒä¸å˜ã€‚å› æ­¤ï¼Œå¦‚æœ notify æˆ– incrementCounterä½¿ç”¨stringæŒ‡é’ˆå¼•ç”¨çš„å€¼ï¼Œå®ƒå°†æŒ‰é¢„æœŸå·¥ä½œã€‚</p>
<p>è§£å†³æ–¹æ³•äºŒï¼Œå¦ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯åœ¨ defer è¯­å¥ä¸­è°ƒç”¨é—­åŒ…</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> status <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;                   â¶ å°†ä¸€ä¸ªé—­åŒ…å‡½æ•°ä½œä¸ºå»¶è¿Ÿå‡½æ•°è°ƒç”¨</span><br><span class="line">        notify(status)               â· åœ¨é—­åŒ…å†…è°ƒç”¨ notify å¹¶å¼•ç”¨ status</span><br><span class="line">        incrementCounter(status)     â¸ </span><br><span class="line">    &#125;()</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// The rest of the function is unchanged</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› æ­¤ï¼Œåœ¨æ‰§è¡Œé—­åŒ…æ—¶ status ä¼šè¢«è®¡ç®—ï¼Œè€Œä¸æ˜¯åœ¨æˆ‘ä»¬è°ƒç”¨ defer æ—¶ã€‚è¿™ç§è§£å†³æ–¹æ¡ˆä¹Ÿæ˜¯å¯è¡Œçš„ï¼Œå¹¶ä¸”ä¸éœ€è¦æ›´æ”¹notify å’Œ incrementCounterçš„ç­¾åã€‚</p>
<p>å¦ä¸€ç§æ¯”è¾ƒå®¹æ˜“æ··æ·†çš„å°±æ˜¯ç»“æ„ä½“å‡½æ•°çš„<code>defer</code>è°ƒç”¨ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">    s := Struct&#123;id: &quot;foo&quot;&#125;</span><br><span class="line">    defer s.print()</span><br><span class="line">    s.id = &quot;bar&quot;</span><br><span class="line">&#125;</span><br><span class="line">type Struct struct &#123;</span><br><span class="line">    id string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (s Struct) print() &#123; </span><br><span class="line">    fmt.Println(s.id)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å€¼ä¼ é€’è¾“å‡ºçš„ç»“æœæ˜¯<code>foo</code>ï¼ŒæŒ‡é’ˆä¼ é€’è¾“å‡ºçš„ç»“æœæ˜¯<code>bar</code>.</p>
<h3 id="ä½¿ç”¨-panic"><a href="#ä½¿ç”¨-panic" class="headerlink" title="ä½¿ç”¨ panic"></a>ä½¿ç”¨ panic</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;                       â¶ åœ¨ <span class="keyword">defer</span> å‡½æ•°ä¸­è¿›è¡Œ <span class="built_in">recover</span> è°ƒç”¨</span><br><span class="line">        <span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Println(<span class="string">"recover"</span>, r)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"> </span><br><span class="line">    f()                                  â· è°ƒç”¨ fï¼Œä¼šå¯¼è‡´ç¨‹åºå´©æºƒ</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"a"</span>)</span><br><span class="line">    <span class="built_in">panic</span>(<span class="string">"foo"</span>)</span><br><span class="line">    fmt.Println(<span class="string">"b"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»…åœ¨ defer å‡½æ•°å†…è°ƒç”¨ recover() ä»¥æ•è· goroutine panic æ˜¯æœ‰ç”¨çš„ã€‚</p>
<p>ä»€ä¹ˆæƒ…å†µä¸‹æ‰é€‚åˆä½¿ç”¨ panicï¼Ÿ</p>
<p>åœ¨ go è¯­è¨€ä¸­ï¼Œpanic ç”¨äºè¡¨ç¤ºçœŸæ­£çš„å¼‚å¸¸æƒ…å†µï¼Œä¾‹å¦‚ï¼Œnet/http åŒ…ä¸­çš„ WriteHeader æ–¹æ³•ï¼Œæˆ‘ä»¬ä¼šæ³¨æ„åˆ°æœ‰ä¸€ä¸ªè°ƒç”¨ checkWriteHeaderCode å‡½æ•°çš„è¯­å¥ï¼Œæ¥æ£€æŸ¥çŠ¶æ€ç æ˜¯å¦æœ‰æ•ˆ</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">checkWriteHeaderCode</span><span class="params">(code <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> code &lt; <span class="number">100</span> || code &gt; <span class="number">999</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(fmt.Sprintf(<span class="string">"invalid WriteHeader code %v"</span>, code))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ go è¯­è¨€ä¸­ï¼Œæˆ‘ä»¬åº”è¯¥è°¨æ…ä½¿ç”¨ panicï¼Œåªæœ‰åœ¨ç‰¹æ®Šæƒ…å†µä¸‹æ‰ä¼šä½¿ç”¨ panic å¯¼è‡´åº”ç”¨ç¨‹åºåœæ­¢ã€‚åœ¨å¤§å¤šæ•°å…¶ä»–æƒ…å†µä¸‹ï¼Œåº”è¯¥ä½¿ç”¨ä¸€ä¸ªå‡½æ•°æ¥å¤„ç†é”™è¯¯ï¼Œå°†é”™è¯¯ç±»å‹ä½œä¸ºæœ€åä¸€ä¸ªè¿”å›å‚æ•°ã€‚</p>
<h3 id="åŒ…è£…-error"><a href="#åŒ…è£…-error" class="headerlink" title="åŒ…è£… error"></a>åŒ…è£… error</h3><p>è‡ªGo 1.13èµ·ï¼Œ<code>%w</code> å¯ä»¥ä½¿æˆ‘ä»¬èƒ½å¤Ÿæ–¹ä¾¿åœ°åŒ…è£…é”™è¯¯ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œé”™è¯¯åŒ…è£…çš„ä¸¤ä¸ªä¸»è¦ç”¨é€”å¦‚ä¸‹</p>
<ol>
<li>ç»™é”™è¯¯æ·»åŠ é¢å¤–çš„ä¸Šä¸‹æ–‡ä¿¡æ¯</li>
<li>å°†é”™è¯¯æ ‡è®°ä¸ºç‰¹å®šçš„é”™è¯¯</li>
</ol>
<p><img src="https://raw.githubusercontent.com/rexyan/warehouse/master/202308212055921.png" alt></p>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬æ”¶åˆ°æ¥è‡ªç‰¹å®šç”¨æˆ·çš„è¯·æ±‚ï¼Œè®¿é—®æ•°æ®åº“èµ„æºï¼Œä½†åœ¨æŸ¥è¯¢è¿‡ç¨‹ä¸­å‡ºç°â€œæƒé™è¢«æ‹’ç»â€é”™è¯¯ã€‚ä¸ºäº†è°ƒè¯•ç›®çš„ï¼Œè™½ç„¶æœ€ç»ˆè®°å½•äº†é”™è¯¯ï¼Œä½†å¸Œæœ›æ·»åŠ é¢å¤–çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p>
<p><code>%v</code> å’Œ<code>%w</code> çš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œä½¿ç”¨ <code>%v</code>  æ—¶é”™è¯¯æœ¬èº«æœªè¢«åŒ…è£…ã€‚è€Œæ˜¯å°†å…¶è½¬åŒ–ä¸ºå¦ä¸€ä¸ªé”™è¯¯ä»¥æ·»åŠ åˆ°ä¸Šä¸‹æ–‡ä¸­ï¼Œæºé”™è¯¯ä¸å†å¯ç”¨ã€‚</p>
<h3 id="æ£€æŸ¥-error-ç±»å‹"><a href="#æ£€æŸ¥-error-ç±»å‹" class="headerlink" title="æ£€æŸ¥ error ç±»å‹"></a>æ£€æŸ¥ error ç±»å‹</h3><p>ä½¿ç”¨%wæŒ‡ä»¤æ¥åŒ…è£…é”™è¯¯æ—¶ï¼Œæˆ‘ä»¬åŒæ ·éœ€è¦æ”¹å˜æ£€æŸ¥ç‰¹å®šé”™è¯¯ç±»å‹çš„æ–¹å¼ï¼›å¦åˆ™ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šä¸å‡†ç¡®åœ°å¤„ç†é”™è¯¯ã€‚</p>
<p>è®©æˆ‘ä»¬è®¨è®ºä¸€ä¸ªå…·ä½“çš„ä¾‹å­ã€‚æˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ªHTTPå¤„ç†ç¨‹åºï¼Œä»¥è¿”å›IDå¯¹åº”çš„äº¤æ˜“é‡‘é¢ã€‚æˆ‘ä»¬çš„å¤„ç†ç¨‹åºå°†è§£æè¯·æ±‚ä»¥è·å–IDï¼Œå¹¶ä»æ•°æ®åº“ï¼ˆDBï¼‰ä¸­æ£€ç´¢é‡‘é¢ã€‚æˆ‘ä»¬çš„å®ç°å¯èƒ½ä¼šæœ‰ä¸¤ç§å¤±è´¥æƒ…å†µï¼š</p>
<ul>
<li>ID æ— æ•ˆï¼ˆå­—ç¬¦ä¸²é•¿åº¦ä¸ç­‰äºäº”ä¸ªå­—ç¬¦ï¼‰</li>
<li>æŸ¥è¯¢æ•°æ®åº“å¤±è´¥</li>
</ul>
<p>åœ¨å‰ä¸€ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æƒ³è¦è¿”å› StatusBadRequestï¼ˆ400ï¼‰ï¼Œè€Œåœ¨åä¸€ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æƒ³è¦è¿”å›ServiceUnavailableï¼ˆ503ï¼‰ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getTransactionAmount</span><span class="params">(transactionID <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">float32</span>, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// Check transaction ID validity</span></span><br><span class="line"> </span><br><span class="line">    amount, err := getTransactionAmountFromDB(transactionID)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        â¶ å°†é”™è¯¯åŒ…è£…èµ·æ¥ï¼Œè€Œä¸æ˜¯ç›´æ¥è¿”å› transientError</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, fmt.Errorf(<span class="string">"failed to get transaction %s: %w"</span>, transactionID, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> amount, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getTransactionAmountFromDB</span><span class="params">(transactionID <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">float32</span>, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, transientError&#123;err: err&#125;     â· è¿”å› transientError </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ¤æ–­é”™è¯¯ç±»å‹æ—¶ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">    transactionID := r.URL.Query().Get(<span class="string">"transaction"</span>)      â¶ è·å– transaction id</span><br><span class="line"> </span><br><span class="line">    amount, err := getTransactionAmount(transactionID)     â· è°ƒç”¨ getTransactionAmount æ–¹æ³•</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> err := err.(<span class="keyword">type</span>) &#123;     â¸ å¦‚æœæ˜¯ transientError è¿”å› <span class="number">503</span>ï¼Œå¦åˆ™è¿”å› <span class="number">400</span></span><br><span class="line">        <span class="keyword">case</span> transientError:</span><br><span class="line">            http.Error(w, err.Error(), http.StatusServiceUnavailable)</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            http.Error(w, err.Error(), http.StatusBadRequest)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Write response</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“æˆ‘ä»¬è¿è¡Œä»£ç ï¼Œå¹¶ä¸” getTransactionAmountFromDB å‘ç”Ÿå¼‚å¸¸æ—¶ï¼ŒHTTP çŠ¶æ€ç æ€»æ˜¯è¿”å› 400ï¼Ÿè¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿ</p>
<p>è¿™äº‹å› ä¸º getTransactionAmount è¿”å›çš„ä¸æ˜¯ transientErrorï¼Œè€Œæ˜¯å°è£… transientError çš„ä¸€ä¸ªé”™è¯¯ã€‚å› æ­¤ switch case åŒ¹é…æ—¶ï¼Œ ä¸èƒ½åŒ¹é…åˆ° transientErrorã€‚</p>
<p>è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ errors.Asï¼Œerrors.As æ˜¯ä¸€ç§æ£€æŸ¥åŒ…è£…é”™è¯¯æ˜¯å¦æ˜¯æŸç§ç±»å‹çš„æ–¹æ³•ã€‚è¯¥å‡½æ•°é€’å½’åœ°å–æ¶ˆåŒ…è£…é”™è¯¯ï¼Œå¹¶åœ¨é”™è¯¯é“¾ä¸­åŒ¹é…ç›¸å¯¹åº”çš„é”™è¯¯ï¼Œå½“åŒ¹é…åˆ°æ—¶åˆ™è¿”å› trueã€‚ä¸Šè¿°ä»£ç æ”¹ä¸ºå¦‚ä¸‹æ‰€ç¤ºå³å¯ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">    <span class="comment">// Get transaction ID</span></span><br><span class="line"> </span><br><span class="line">    amount, err := getTransactionAmount(transactionID)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> errors.As(err, &amp;transientError&#123;&#125;) &#123;      â¶ åˆ¤æ–­ err é“¾ä¸­æ˜¯å¦å­˜åœ¨ transientError</span><br><span class="line">            http.Error(w, err.Error(),</span><br><span class="line">                http.StatusServiceUnavailable)      â· å¦‚æœæ˜¯ transientError è¿”å› <span class="number">503</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            http.Error(w, err.Error(),</span><br><span class="line">                http.StatusBadRequest)              â¸ å¦åˆ™è¿”å› <span class="number">400</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Write response</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>errors.As å‡½æ•°è¦æ±‚ç¬¬äºŒä¸ªå‚æ•°ï¼ˆç›®æ ‡é”™è¯¯ï¼‰ä¸ºæŒ‡é’ˆã€‚å¦åˆ™ï¼Œè¯¥å‡½æ•°ä¼šç¼–è¯‘ä½†åœ¨è¿è¡Œæ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p>
<h3 id="æ£€æŸ¥-error-å€¼"><a href="#æ£€æŸ¥-error-å€¼" class="headerlink" title="æ£€æŸ¥ error å€¼"></a>æ£€æŸ¥ error å€¼</h3><p>é¡¹ç›®ä¸­æœ‰å¾ˆå¤šå·²çŸ¥çš„errorï¼Œå±äºæ˜¯é¢„æœŸä¹‹å†…çš„ã€‚æ¯”å¦‚ï¼š</p>
<ul>
<li><code>sql.ErrNoRows</code></li>
<li><code>io.EOF</code></li>
</ul>
<p>æˆ‘ä»¬å¸¸å¸¸ä½¿ç”¨ <code>==</code>å»æ£€æŸ¥errorçš„å€¼ï¼Œä½†å½“errorè¢«<code>%w</code>åŒ…è£…ä¹‹åï¼Œè¿™æ ·åˆ¤æ–­å°±ä¼šæœ‰é—®é¢˜ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨<code>errors.Is</code>.ä»–ä¼šé€’å½’unwrap,ç„¶åä¾æ¬¡æ¯”å¯¹é”™è¯¯é“¾ä¸Šçš„å€¼ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">err := query()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> errors.Is(err, sql.ErrNoRows) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="error-è¢«å¤„ç†å¤šæ¬¡"><a href="#error-è¢«å¤„ç†å¤šæ¬¡" class="headerlink" title="error è¢«å¤„ç†å¤šæ¬¡"></a>error è¢«å¤„ç†å¤šæ¬¡</h3><p>ä¸€ä¸ªerrorå¤„ç†å¤šæ¬¡åœ¨é¡¹ç›®ä¸­å¾ˆå¸¸è§ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä¾‹å­ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetRoute</span><span class="params">(srcLat, srcLng, dstLat, dstLng <span class="keyword">float32</span>)</span> <span class="params">(Route, error)</span></span> &#123;</span><br><span class="line">    err := validateCoordinates(srcLat, srcLng)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Println(<span class="string">"failed to validate source coordinates"</span>)   </span><br><span class="line">        <span class="keyword">return</span> Route&#123;&#125;, err</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    err = validateCoordinates(dstLat, dstLng)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Println(<span class="string">"failed to validate target coordinates"</span>)  </span><br><span class="line">        <span class="keyword">return</span> Route&#123;&#125;, err</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> getRoute(srcLat, srcLng, dstLat, dstLng)</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">validateCoordinates</span><span class="params">(lat, lng <span class="keyword">float32</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> lat &gt; <span class="number">90.0</span> || lat &lt; <span class="number">-90.0</span> &#123;</span><br><span class="line">        log.Printf(<span class="string">"invalid latitude: %f"</span>, lat)                </span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">"invalid latitude: %f"</span>, lat)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> lng &gt; <span class="number">180.0</span> || lng &lt; <span class="number">-180.0</span> &#123;</span><br><span class="line">        log.Printf(<span class="string">"invalid longitude: %f"</span>, lng)              </span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">"invalid longitude: %f"</span>, lng)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ä¼ å…¥ 200 æ—¶ï¼Œä¼šå‘ç°é”™è¯¯è¢«å¤„ç†çš„ä¸¤éã€‚åˆ†åˆ«åœ¨ validateCoordinates ä¸­å’Œ GetRoute ä¸­ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2021/06/01 20:35:12 invalid latitude: 200.000000</span><br><span class="line">2021/06/01 20:35:12 failed to validate source coordinates</span><br></pre></td></tr></table></figure></p>
<p>è‰¯å¥½çš„ä¹ æƒ¯æ˜¯ï¼Œé”™è¯¯åº”è¯¥åªè¢«å¤„ç†ä¸€æ¬¡ã€‚è®°å½•é”™è¯¯æ˜¯å¤„ç†é”™è¯¯çš„ä¸€ç§æ–¹å¼ï¼Œè¿”å›é”™è¯¯ä¹Ÿæ˜¯å¦‚æ­¤ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åº”è¯¥è®°å½•æˆ–è¿”å›é”™è¯¯ï¼Œè€Œä¸æ˜¯ä¸¤è€…åŒæ—¶è¿›è¡Œã€‚</p>
<p>æ›´æ–°åçš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetRoute</span><span class="params">(srcLat, srcLng, dstLat, dstLng <span class="keyword">float32</span>)</span> <span class="params">(Route, error)</span></span> &#123;</span><br><span class="line">    err := validateCoordinates(srcLat, srcLng)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨ %w å°†é”™è¯¯è¿›è¡ŒåŒ…è£…</span></span><br><span class="line">        <span class="keyword">return</span> Route&#123;&#125;, fmt.Errorf(<span class="string">"failed to validate source coordinates: %w"</span>, err)  </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    err = validateCoordinates(dstLat, dstLng)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Route&#123;&#125;, fmt.Errorf(<span class="string">"failed to validate target coordinates: %w"</span>, err) </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> getRoute(srcLat, srcLng, dstLat, dstLng)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>validateCoordinates è¿”å›çš„æ¯ä¸ªé”™è¯¯ç°åœ¨éƒ½è¢«åŒ…è£…èµ·æ¥ï¼Œä»¥æä¾›é”™è¯¯çš„é™„åŠ ä¸Šä¸‹æ–‡ã€‚ä»¥æºå¸¦ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2021/06/01 20:35:12 failed to validate source coordinates:</span><br><span class="line">    invalid latitude: 200.000000</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·ï¼Œä¸ä¼šä¸¢å¤±ä»»ä½•æœ‰ä»·å€¼çš„ä¿¡æ¯ã€‚æ­¤å¤–ï¼Œæ¯ä¸ªé”™è¯¯åªå¤„ç†ä¸€æ¬¡ï¼Œè¿™ç®€åŒ–äº†æˆ‘ä»¬çš„ä»£ç ï¼Œé¿å…é‡å¤çš„é”™è¯¯ä¿¡æ¯ã€‚</p>
<h3 id="ä¸éœ€è¦å¤„ç†çš„-error"><a href="#ä¸éœ€è¦å¤„ç†çš„-error" class="headerlink" title="ä¸éœ€è¦å¤„ç†çš„ error"></a>ä¸éœ€è¦å¤„ç†çš„ error</h3><p>å½“æˆ‘ä»¬ä¸éœ€è¦å¤„ç†errorçš„æ—¶å€™ï¼Œç»å¸¸ä¼šé‚£ä¹ˆå†™ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">func f() &#123;</span><br><span class="line">    // ...</span><br><span class="line">    notify() </span><br><span class="line">&#125;</span><br><span class="line">func notify() error &#123;</span><br><span class="line">    // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å…¶å®ä¼šè®©è¯»è€…äº§ç”Ÿè¯¯åŒºï¼Œç©¶ç«Ÿæ˜¯ä¸éœ€è¦å¤„ç†errorè¿˜æ˜¯å¿˜è®°å¤„ç†äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ”¹ä¸ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_ = notify()</span><br></pre></td></tr></table></figure>
<h3 id="å¤„ç†-defer-ä¸­çš„-error"><a href="#å¤„ç†-defer-ä¸­çš„-error" class="headerlink" title="å¤„ç† defer ä¸­çš„ error"></a>å¤„ç† defer ä¸­çš„ error</h3><p>å½“æˆ‘ä»¬åœ¨æ‰§è¡Œ sql æŸ¥è¯¢çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ close rowsã€‚ä½†æ˜¯ close rows æ—¶å¯èƒ½å‡ºé”™ï¼Œæˆ‘ä»¬æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> query = <span class="string">"..."</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getBalance</span><span class="params">(db *sql.DB, clientID <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">float32</span>, error)</span></span> &#123;</span><br><span class="line">    rows, err := db.Query(query, clientID)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> rows.Close()     â¶ å»¶è¿Ÿè°ƒç”¨ <span class="built_in">close</span></span><br><span class="line">    <span class="comment">// Use rows</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æœ‰ä¸€ç§é€‰æ‹©æ˜¯è®°å½• close çš„ errorã€‚å°† <code>rows.Close()</code> æ”¾åœ¨ defer ä¸­ï¼Œå¦‚æœ close å‘ç”Ÿé”™è¯¯å°±è®°å½•ä¸€æ¡æ—¥å¿—ä¿¡æ¯ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    err := rows.Close()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Printf(<span class="string">"failed to close rows: %v"</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>
<p>é‚£æˆ‘ä»¬å¦‚æœéœ€è¦å°† close çš„é”™è¯¯ä¿¡æ¯ä¼ æ’­ç»™ getBalanceï¼Œè¿™æ—¶è¯¥æ€ä¹ˆå®ç°å‘¢ï¼Ÿ</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    closeErr := rows.Close()     â¶ æ‰§è¡Œ <span class="built_in">close</span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;              â· å¦‚æœ getBalance å‘ç”Ÿäº†å…¶ä»–é”™è¯¯</span><br><span class="line">        <span class="keyword">if</span> closeErr != <span class="literal">nil</span> &#123;</span><br><span class="line">            log.Printf(<span class="string">"failed to close rows: %v"</span>, err)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœ getBalance æ²¡æœ‰å‘ç”Ÿå…¶ä»–é”™è¯¯ï¼Œè¿™æ—¶å¦‚æœ closeErr æœ‰å€¼çš„è¯ä¼šç»™åˆ° err è¿”å›ã€‚å¦‚æœ closeErr æ— çŸ¥åˆ™ err ä¸ºç©º</span></span><br><span class="line">    err = closeErr â¸ </span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>
<h3 id="å¹¶å‘å’Œå¹¶è¡Œ"><a href="#å¹¶å‘å’Œå¹¶è¡Œ" class="headerlink" title="å¹¶å‘å’Œå¹¶è¡Œ"></a>å¹¶å‘å’Œå¹¶è¡Œ</h3><p>å¹¶è¡Œæ˜¯åŒæ—¶åšå¾ˆå¤šäº‹æƒ…ï¼Œè€Œå¹¶å‘æ˜¯æŒ‡åŒæ—¶ç®¡ç†å¾ˆå¤šäº‹æƒ…ï¼Œè¿™äº›äº‹æƒ…å¯èƒ½åªåšäº†ä¸€åŠå°±è¢«æš‚åœå»åšåˆ«çš„äº‹æƒ…äº†ã€‚</p>
<h3 id="è®¤ä¸ºå¹¶å‘ä¸€å®šæ›´å¿«"><a href="#è®¤ä¸ºå¹¶å‘ä¸€å®šæ›´å¿«" class="headerlink" title="è®¤ä¸ºå¹¶å‘ä¸€å®šæ›´å¿«"></a>è®¤ä¸ºå¹¶å‘ä¸€å®šæ›´å¿«</h3><p>ä½œä¸ºGoå¼€å‘äººå‘˜ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥åˆ›å»ºçº¿ç¨‹ï¼Œä½†æˆ‘ä»¬å¯ä»¥åˆ›å»º goroutineï¼Œå¯ä»¥æŠŠå®ƒä»¬çœ‹ä½œåº”ç”¨ç¨‹åºçº§åˆ«çš„çº¿ç¨‹ã€‚ç„¶è€Œï¼Œæ“ä½œç³»ç»Ÿçº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æ˜¯ç”±æ“ä½œç³»ç»Ÿåœ¨CPUå†…æ ¸ä¸Šè¿›è¡Œçš„ï¼Œè€Œ goroutine çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æ˜¯ç”±Goè¿è¡Œæ—¶åœ¨æ“ä½œç³»ç»Ÿçº¿ç¨‹ä¸Šè¿›è¡Œã€‚</p>
<ul>
<li><p>G - Goroutineï¼ˆåç¨‹ï¼‰</p>
</li>
<li><p>M - OSçº¿ç¨‹ï¼ˆä»£è¡¨æœºå™¨ï¼‰</p>
</li>
<li><p>P - CPU æ ¸å¿ƒï¼ˆè¡¨ç¤ºå¤„ç†å™¨ï¼‰</p>
</li>
</ul>
<p>æ¯ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼ˆMï¼‰ç”±æ“ä½œç³»ç»Ÿè°ƒåº¦ç¨‹åºåˆ†é…ç»™ CPU æ ¸å¿ƒï¼ˆPï¼‰ã€‚ç„¶åï¼Œæ¯ä¸ª goroutineï¼ˆGï¼‰åœ¨Mä¸Šè¿è¡Œã€‚ GOMAXPROCS å˜é‡å®šä¹‰äº†åŒæ—¶æ‰§è¡Œç”¨æˆ·çº§ä»£ç çš„ M çš„æ•°é‡é™åˆ¶ã€‚ä½†æ˜¯ï¼Œå¦‚æœçº¿ç¨‹åœ¨ç³»ç»Ÿè°ƒç”¨ä¸­è¢«é˜»å¡ï¼ˆä¾‹å¦‚I/Oï¼‰ï¼Œåˆ™è°ƒåº¦ç¨‹åºå¯ä»¥å¯åŠ¨æ›´å¤šMã€‚è‡ªGo 1.5ä»¥æ¥ï¼Œé»˜è®¤æƒ…å†µä¸‹GOMAXPROCSç­‰äºå¯ç”¨CPUæ ¸å¿ƒæ•°ã€‚</p>
<p>å½“ä¸€ä¸ª goroutine è¢«åˆ›å»ºä½†è¿˜ä¸èƒ½è¢«æ‰§è¡Œæ—¶ï¼›ä¾‹å¦‚ï¼Œæ‰€æœ‰å…¶ä»–çš„ M å·²ç»åœ¨æ‰§è¡Œ Gã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒGo è¿è¡Œæ—¶ä¼šæ€ä¹ˆå¤„ç†å‘¢ï¼Ÿç­”æ¡ˆæ˜¯æ’é˜Ÿã€‚Go è¿è¡Œæ—¶å¤„ç†ä¸¤ç§ç±»å‹çš„é˜Ÿåˆ—ï¼šæ¯ä¸ª P ä¸€ä¸ªæœ¬åœ°é˜Ÿåˆ—å’Œæ‰€æœ‰ P å…±äº«çš„å…¨å±€é˜Ÿåˆ—ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä¸‹å›¾æ˜¾ç¤ºäº†åœ¨ GOMAXPROCS ç­‰äº4çš„å››æ ¸è®¡ç®—æœºä¸Šç»™å®šè°ƒåº¦æƒ…å†µï¼š</p>
<p><img src="https://raw.githubusercontent.com/rexyan/warehouse/master/202308232117401.png" alt></p>
<p>P0ã€P1å’ŒP3æ­£å¤„ç†å¿™ç¢ŒçŠ¶æ€ã€‚P2 å¤„äºç©ºé—²çŠ¶æ€ã€‚</p>
<p>æ¯æ‰§è¡Œ 61 æ¬¡ï¼ŒGolang è°ƒåº¦å™¨å°±ä¼šæ£€æŸ¥å…¨å±€é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å¯ç”¨çš„ goroutineã€‚å¦‚æœæ²¡æœ‰ï¼Œå°±ä¼šæ£€æŸ¥å…¶æœ¬åœ°é˜Ÿåˆ—ã€‚ä¸æ­¤åŒæ—¶ï¼Œå¦‚æœå…¨å±€å’Œæœ¬åœ°é˜Ÿåˆ—éƒ½ä¸ºç©ºï¼ŒGolang è°ƒåº¦å™¨å¯ä»¥ä»å…¶ä»–æœ¬åœ°é˜Ÿåˆ—ä¸­æŒ‘é€‰ goroutineã€‚è¿™ç§è°ƒåº¦åŸåˆ™ç§°ä¸ºå·¥ä½œçªƒå–ï¼Œå®ƒå…è®¸æœªè¢«å……åˆ†åˆ©ç”¨çš„å¤„ç†å™¨ç§¯æå¯»æ‰¾å¦ä¸€ä¸ªå¤„ç†å™¨çš„ goroutine å¹¶çªƒå–ä¸€äº›ã€‚</p>
<p>åœ¨ Go 1.14 ä¹‹å‰ï¼Œè°ƒåº¦å™¨æ˜¯åä½œå¼çš„ï¼Œè¿™æ„å‘³ç€ä»…åœ¨ç‰¹å®šçš„é˜»å¡æƒ…å†µä¸‹ï¼ˆä¾‹å¦‚é€šé“å‘é€æˆ–æ¥æ”¶ã€I/Oã€ç­‰å¾…è·å–äº’æ–¥é”ï¼‰æ‰èƒ½è¿›è¡Œ goroutine åˆ‡æ¢ã€‚ä» Go 1.14 å¼€å§‹ï¼ŒGo è°ƒåº¦å™¨ç°åœ¨æ˜¯æŠ¢å å¼çš„ï¼šå½“ goroutine è¿è¡Œç‰¹å®šçš„æ—¶é—´ï¼ˆ10 æ¯«ç§’ï¼‰åï¼Œå®ƒå°†è¢«æ ‡è®°ä¸ºå¯æŠ¢å ï¼Œå¹¶å¯ä»¥è¢«åˆ‡æ¢ä¸Šä¸‹æ–‡ä»¥æ›¿æ¢ä¸ºå¦ä¸€ä¸ª goroutineã€‚è¿™ä½¿å¾—é•¿æ—¶é—´è¿è¡Œçš„ä½œä¸šå¯ä»¥è¢«å¼ºåˆ¶å…±äº« CPU æ—¶é—´ã€‚</p>
<blockquote>
<p><strong>åä½œå¼è°ƒåº¦</strong>ï¼š</p>
<p>åœ¨åä½œå¼è°ƒåº¦ä¸­ï¼Œgoroutinesä¸»åŠ¨è®©å‡ºCPUçš„æ‰§è¡Œæ—¶é—´ã€‚è¿™æ„å‘³ç€ä¸€ä¸ªgoroutineæ‰§è¡Œä»»åŠ¡æ—¶ï¼Œå®ƒå¯ä»¥é€‰æ‹©ä½•æ—¶é‡Šæ”¾CPUï¼Œå…è®¸å…¶ä»–goroutinesæ‰§è¡Œã€‚</p>
<p>è¿™ç§æ–¹å¼é€šå¸¸ç”¨äºç¼–å†™å¹¶å‘ç¨‹åºï¼Œå…¶ä¸­goroutinesä¹‹é—´éœ€è¦æ˜ç¡®åœ°åè°ƒå’Œå…±äº«èµ„æºã€‚</p>
<p>åä½œå¼è°ƒåº¦å™¨çš„ä¼˜ç‚¹æ˜¯å¯ä»¥é¿å…ç«æ€æ¡ä»¶å’Œé”çš„ä½¿ç”¨ï¼Œå› ä¸ºgoroutinesåªåœ¨æ˜ç¡®çš„æ—¶æœºè®©å‡ºCPUï¼Œè€Œä¸ä¼šåœ¨ä»»æ„æ—¶åˆ»è¢«å¼ºåˆ¶åœæ­¢ã€‚</p>
<p>ç¼–å†™åä½œå¼ä»£ç é€šå¸¸æ›´å®¹æ˜“ç†è§£å’Œè°ƒè¯•ï¼Œä½†ä¹Ÿéœ€è¦å¼€å‘äººå‘˜æ³¨æ„é¿å…é•¿æ—¶é—´çš„å ç”¨CPUï¼Œä»¥å…é˜»å¡å…¶ä»–goroutinesã€‚</p>
<p><strong>æŠ¢å å¼è°ƒåº¦</strong>ï¼š </p>
<p>åœ¨æŠ¢å å¼è°ƒåº¦ä¸­ï¼Œè°ƒåº¦å™¨å¯ä»¥åœ¨ä»»ä½•æ—¶é—´ä¸­æ–­æ­£åœ¨è¿è¡Œçš„goroutineï¼Œå¹¶åˆ‡æ¢åˆ°å¦ä¸€ä¸ªgoroutineï¼Œæ— éœ€ç­‰å¾…æ­£åœ¨è¿è¡Œçš„goroutineä¸»åŠ¨é‡Šæ”¾CPUã€‚</p>
<p>è¿™ç§æ–¹å¼é€šå¸¸ç”¨äºéœ€è¦æ›´å¥½çš„å“åº”æ—¶é—´å’Œæ›´å…¬å¹³çš„èµ„æºå…±äº«çš„åº”ç”¨ç¨‹åºï¼Œä¾‹å¦‚å®æ—¶ç³»ç»Ÿæˆ–éœ€è¦å¤„ç†å¤§é‡è®¡ç®—å¯†é›†å‹ä»»åŠ¡çš„åº”ç”¨ç¨‹åºã€‚</p>
<p>æŠ¢å å¼è°ƒåº¦å™¨å¯ä»¥ç¡®ä¿æ²¡æœ‰å•ä¸ªgoroutineä¼šé•¿æ—¶é—´å ç”¨CPUï¼Œä»è€Œæé«˜ç³»ç»Ÿçš„å“åº”æ€§ã€‚</p>
<p>ä½†æ˜¯ï¼Œä½¿ç”¨æŠ¢å å¼è°ƒåº¦å™¨å¯èƒ½éœ€è¦æ›´å¤šçš„å¼€é”€ï¼Œå› ä¸ºéœ€è¦æ›´é¢‘ç¹åœ°è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¯èƒ½ä¼šå¼•å…¥ä¸€äº›ç«æ€æ¡ä»¶å’Œé”ã€‚</p>
</blockquote>
<p>ä¸‹é¢ä½¿ç”¨å½’å¹¶æ’åºæ¥ä¸¾ä¾‹ï¼š</p>
<p><img src="https://raw.githubusercontent.com/rexyan/warehouse/master/202308232138776.png" alt></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sequentialMergesort</span><span class="params">(s []<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(s) &lt;= <span class="number">1</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    middle := <span class="built_in">len</span>(s) / <span class="number">2</span></span><br><span class="line">    sequentialMergesort(s[:middle])     â¶ é€’å½’å‰åŠéƒ¨åˆ†æ’åº</span><br><span class="line">    sequentialMergesort(s[middle:])     â· é€’å½’ååŠéƒ¨åˆ†æ’åº</span><br><span class="line">    merge(s, middle)                    â¸ åˆå¹¶</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">merge</span><span class="params">(s []<span class="keyword">int</span>, middle <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ç¼–å†™å¦ä¸€ä¸ªç‰ˆæœ¬çš„å½’å¹¶æ’åºï¼Œå¹¶ä¸”ä½¿ç”¨åç¨‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parallelMergesortV1</span><span class="params">(s []<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(s) &lt;= <span class="number">1</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    middle := <span class="built_in">len</span>(s) / <span class="number">2</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">    wg.Add(<span class="number">2</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;             â¶ åœ¨åç¨‹ä¸­è¿›è¡Œå‰åŠéƒ¨åˆ†çš„æ’åº</span><br><span class="line">        <span class="keyword">defer</span> wg.Done()</span><br><span class="line">        parallelMergesortV1(s[:middle])</span><br><span class="line">    &#125;()</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;             â· åœ¨åç¨‹ä¸­è¿›è¡ŒååŠéƒ¨åˆ†çš„æ’åº</span><br><span class="line">        <span class="keyword">defer</span> wg.Done()</span><br><span class="line">        parallelMergesortV1(s[middle:])</span><br><span class="line">    &#125;()</span><br><span class="line"> </span><br><span class="line">    wg.Wait()</span><br><span class="line">    merge(s, middle)        â¸ åˆå¹¶</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æŒ‰é“ç†æ¥è¯´ï¼Œä½¿ç”¨åç¨‹çš„ç‰ˆæœ¬ä¼šæ›´å¿«ï¼ä½†æ˜¯ç»“æœå´ç›¸åï¼Œç¬¬ä¸€ç§ä¼ ç»Ÿçš„æ–¹å¼æ›´å¿«ã€‚ä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Ÿ</p>
<p>è¿™æ˜¯å› ä¸ºï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªåŒ…å«1024ä¸ªå…ƒç´ çš„åˆ‡ç‰‡ï¼Œé‚£ä¹ˆçˆ¶åç¨‹å°†ä¼šå¯åŠ¨ä¸¤ä¸ªåç¨‹ï¼Œæ¯ä¸ªåç¨‹è´Ÿè´£å¤„ç†512ä¸ªå…ƒç´ çš„ä¸€åŠã€‚æ¯ä¸ªåç¨‹éƒ½ä¼šå¯åŠ¨ä¸¤ä¸ªæ–°åç¨‹æ¥å¤„ç†256ä¸ªå…ƒç´ ï¼Œç„¶åæ˜¯128ä¸ªï¼Œä¾æ­¤ç±»æ¨ã€‚è¿™æ˜¯å› ä¸ºåç¨‹éœ€è¦çš„å¼€é”€å¤ªå¤§äº†ï¼Œè¿˜ä¸å¦‚ä¼ ç»Ÿçš„æ–¹å¼æ¥è¿è¡Œã€‚</p>
<p>å¦å¤–ä¸€ç§è§£å†³æ–¹æ³•æ˜¯ï¼Œå®šä¹‰ä¸€ä¸ªé˜€å€¼ï¼Œå½“é«˜äºè¿™ä¸ªé˜€å€¼æ—¶æˆ‘ä»¬ä½¿ç”¨åç¨‹æ¥å¹¶è¡Œå¤„ç†ã€‚å½“ä½äºé˜€å€¼æ—¶æˆ‘ä»¬ä½¿ç”¨ä¼ ç»Ÿçš„æ–¹å¼æ¥å¤„ç†</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> max = <span class="number">2048</span>                      â¶ å®šä¹‰é˜€å€¼</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parallelMergesortV2</span><span class="params">(s []<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(s) &lt;= <span class="number">1</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(s) &lt;= max &#123;</span><br><span class="line">        sequentialMergesort(s)        â· ä½äºé˜€å€¼æ—¶æˆ‘ä»¬ä½¿ç”¨ä¼ ç»Ÿçš„æ–¹å¼æ¥å¤„ç†</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;                          â¸ é«˜äºé˜€å€¼æ—¶æˆ‘ä»¬ä½¿ç”¨åç¨‹æ¥å¹¶è¡Œå¤„ç†</span><br><span class="line">        middle := <span class="built_in">len</span>(s) / <span class="number">2</span></span><br><span class="line"> </span><br><span class="line">        <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">        wg.Add(<span class="number">2</span>)</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            <span class="keyword">defer</span> wg.Done()</span><br><span class="line">            parallelMergesortV2(s[:middle])</span><br><span class="line">        &#125;()</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            <span class="keyword">defer</span> wg.Done()</span><br><span class="line">            parallelMergesortV2(s[middle:])</span><br><span class="line">        &#125;()</span><br><span class="line"> </span><br><span class="line">        wg.Wait()</span><br><span class="line">        merge(s, middle)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Benchmark_sequentialMergesort-4       2278993555 ns/op  # ç¬¬ä¸€ç§æ–¹å¼</span><br><span class="line">Benchmark_parallelMergesortV1-4      17525998709 ns/op  # ç¬¬äºŒç§æ–¹å¼</span><br><span class="line">Benchmark_parallelMergesortV2-4       1313010260 ns/op  # ç¬¬ä¸‰ç§æ–¹å¼</span><br></pre></td></tr></table></figure>
<p>è¿™ç§æ–¹æ³•æ¯”ç¬¬ä¸€ç§è¦å¿« 40% å·¦å³ã€‚æ‰€ä»¥ä¹Ÿå¹¶ä¸æ˜¯æ‰€æœ‰åœºæ™¯ä¸‹éƒ½æ˜¯å¹¶å‘æ›´å¿«ï¼</p>
<h3 id="ä½•æ—¶ä½¿ç”¨é€šé“æˆ–äº’æ–¥é”æ¥è§£å†³å¹¶å‘é—®é¢˜"><a href="#ä½•æ—¶ä½¿ç”¨é€šé“æˆ–äº’æ–¥é”æ¥è§£å†³å¹¶å‘é—®é¢˜" class="headerlink" title="ä½•æ—¶ä½¿ç”¨é€šé“æˆ–äº’æ–¥é”æ¥è§£å†³å¹¶å‘é—®é¢˜"></a>ä½•æ—¶ä½¿ç”¨é€šé“æˆ–äº’æ–¥é”æ¥è§£å†³å¹¶å‘é—®é¢˜</h3><p>äº’æ–¥é”å’Œé€šé“å…·æœ‰ä¸åŒçš„è¯­ä¹‰ã€‚æ¯å½“æˆ‘ä»¬æƒ³å…±äº«çŠ¶æ€æˆ–è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œäº’æ–¥é”ç¡®ä¿å¯¹è¯¥èµ„æºçš„ç‹¬å è®¿é—®ã€‚ç›¸åï¼Œé€šé“æ˜¯ä¸€ç§è¿›è¡Œä¿¡å·ä¼ é€’çš„æœºåˆ¶ã€‚åè°ƒæˆ–æ‰€æœ‰æƒè½¬ç§»åº”é€šè¿‡é€šé“å®ç°</p>
<p>å³ä¸€èˆ¬æ¥è¯´ï¼Œå¹¶è¡Œ Goroutine éœ€è¦åŒæ­¥ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨äº’æ–¥é”ã€‚ç›¸åçš„ï¼ŒåŒæ—¶æ‰§è¡Œçš„ Goroutine é€šå¸¸éœ€è¦åè°ƒç®¡ç†ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨é€šé“ã€‚</p>
<h3 id="race-é—®é¢˜"><a href="#race-é—®é¢˜" class="headerlink" title="race é—®é¢˜"></a>race é—®é¢˜</h3><p><strong>æ•°æ®ç«äº‰</strong></p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªæ•°æ®ç«äº‰çš„é—®é¢˜ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">i := <span class="number">0</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    i++       â¶ å¢åŠ  i</span><br><span class="line">&#125;()</span><br><span class="line"> </span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    i++</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>
<p>å½“æˆ‘ä»¬ä½¿ç”¨ -race æ¥è¿è¡Œæ—¶ï¼Œä¼šæ£€æµ‹å‡º data race</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">==================</span><br><span class="line">WARNING: DATA RACE</span><br><span class="line">Write at 0x00c00008e000 by goroutine 7:</span><br><span class="line">  main.main.func2()</span><br><span class="line"> </span><br><span class="line">Previous write at 0x00c00008e000 by goroutine 6:</span><br><span class="line">  main.main.func1()</span><br><span class="line">==================</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬è¯¥å¦‚ä½•é¿å…æ•°æ®ç«äº‰å‘¢ï¼Ÿç¬¬ä¸€ç§é€‰æ‹©æ˜¯è®©å¢é‡æ“ä½œå˜ä¸ºåŸå­æ“ä½œï¼Œå³åœ¨å•ä¸ªæ“ä½œä¸­å®Œæˆï¼šå¯ä»¥ä½¿ç”¨sync/atomicåŒ…æ¥è¿›è¡ŒåŸå­æ“ä½œã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå¦‚ä½•åŸå­åœ°é€’å¢int64çš„ç¤ºä¾‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i <span class="keyword">int64</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    atomic.AddInt64(&amp;i, <span class="number">1</span>)    â¶ åŸå­æ€§çš„å¢åŠ  i</span><br><span class="line">&#125;()</span><br><span class="line"> </span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    atomic.AddInt64(&amp;i, <span class="number">1</span>)    â· åŸå­æ€§çš„å¢åŠ  i</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>
<p>sync/atomic åŒ…æä¾›äº† int32ã€int64ã€uint32å’Œuint64çš„åŸè¯­ï¼Œä½†ä¸æ”¯æŒintã€‚</p>
<p>å¦ä¸€ç§é€‰é¡¹æ˜¯ä½¿ç”¨åƒäº’æ–¥é”ï¼ˆmutexï¼‰è¿™æ ·çš„ç‰¹æ®Šæ•°æ®ç»“æ„æ¥åŒæ­¥ä¸¤ä¸ª goroutine</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">i := <span class="number">0</span></span><br><span class="line">mutex := sync.Mutex&#123;&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    mutex.Lock()        â¶ ä¸Šé”</span><br><span class="line">    i++                 â· i++</span><br><span class="line">    mutex.Unlock()      â¸ é‡Šæ”¾é”</span><br><span class="line">&#125;()</span><br><span class="line"> </span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    mutex.Lock()</span><br><span class="line">    i++</span><br><span class="line">    mutex.Unlock()</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>
<p>å¦ä¸€ä¸ªå¯èƒ½çš„é€‰é¡¹æ˜¯é¿å…å…±äº«ç›¸åŒçš„å†…å­˜ä½ç½®ï¼Œè€Œæ˜¯è·¨ Goroutine è¿›è¡Œé€šä¿¡</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">i := <span class="number">0</span></span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ch &lt;- <span class="number">1</span>     â¶ é€šçŸ¥ goroutine å°†è®¡æ•°å™¨åŠ  <span class="number">1</span></span><br><span class="line">&#125;()</span><br><span class="line"> </span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ch &lt;- <span class="number">1</span></span><br><span class="line">&#125;()</span><br><span class="line"> </span><br><span class="line">i += &lt;-ch       â· ä»é€šé“æ¥æ”¶å¢åŠ çš„å€¼</span><br><span class="line">i += &lt;-ch</span><br></pre></td></tr></table></figure>
<p>æ¯ä¸ª goroutine é€šè¿‡é€šé“å‘é€é€šçŸ¥ï¼Œå‘ŠçŸ¥æˆ‘ä»¬åº”å°† i å¢åŠ  1ã€‚çˆ¶åç¨‹æ”¶é›†é€šçŸ¥å¹¶å¢åŠ  iã€‚ç”±äºå®ƒæ˜¯å”¯ä¸€ä¸€ä¸ªå†™å…¥ i çš„åç¨‹ï¼Œå› æ­¤è¯¥è§£å†³æ–¹æ¡ˆä¹Ÿé¿å…äº†æ•°æ®ç«æ€ã€‚</p>
<p><strong>å†…å­˜æ¨¡å‹</strong></p>
<p>åˆ›å»º Goroutine æ˜¯åœ¨ Goroutine æ‰§è¡Œå¼€å§‹ä¹‹å‰å‘ç”Ÿçš„ã€‚å› æ­¤ï¼Œå…ˆè¯»å–ä¸€ä¸ªå˜é‡ï¼Œç„¶åå¯åŠ¨ä¸€ä¸ªæ–°çš„ Goroutine æ¥å†™å…¥è¿™ä¸ªå˜é‡ï¼Œä¸ä¼šå¯¼è‡´æ•°æ®ç«äº‰</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">i := <span class="number">0</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    i++</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>
<p>ç›¸åï¼Œä¸€ä¸ª goroutine çš„é€€å‡ºä¸èƒ½ä¿è¯åœ¨ä»»ä½•äº‹ä»¶ä¹‹å‰å‘ç”Ÿã€‚å› æ­¤ï¼Œä¸‹é¢çš„ç¤ºä¾‹å­˜åœ¨æ•°æ®ç«äº‰</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">i := <span class="number">0</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    i++</span><br><span class="line">&#125;()</span><br><span class="line">fmt.Println(i)</span><br></pre></td></tr></table></figure>
<p>ä¸€ä¸ªé€šé“ä¸Šçš„å‘é€æ“ä½œå‘ç”Ÿåœ¨ç›¸åº”çš„æ¥æ”¶æ“ä½œå®Œæˆä¹‹å‰ã€‚åœ¨ç¤ºä¾‹ä¸­ï¼Œçˆ¶ goroutine åœ¨å‘é€å‰é€’å¢äº†ä¸€ä¸ªå˜é‡ï¼Œè€Œå¦ä¸€ä¸ª goroutine åœ¨é€šé“è¯»å–åè¯»å–äº†è¯¥å˜é‡</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">i := <span class="number">0</span></span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    &lt;-ch</span><br><span class="line">    fmt.Println(i)</span><br><span class="line">&#125;()</span><br><span class="line">i++</span><br><span class="line">ch &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>å…³é—­ä¸€ä¸ªé€šé“æ˜¯åœ¨æ”¶åˆ°å®ƒè¢«å…³é—­ä¹‹å‰</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">i := <span class="number">0</span></span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    &lt;-ch</span><br><span class="line">    fmt.Println(i)</span><br><span class="line">&#125;()</span><br><span class="line">i++</span><br><span class="line"><span class="built_in">close</span>(ch)</span><br></pre></td></tr></table></figure>
<p>æ— ç¼“å†²é€šé“çš„æ¥æ”¶æ“ä½œå‘ç”Ÿåœ¨å‘é€æ“ä½œä¹‹å‰</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">i := <span class="number">0</span></span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;) </span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    i = <span class="number">1</span></span><br><span class="line">    &lt;-ch</span><br><span class="line">&#125;()</span><br><span class="line">ch &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">fmt.Println(i)</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºæ¥è‡ªæ— ç¼“å†²é€šé“çš„æ¥æ”¶æ“ä½œå‘ç”Ÿåœ¨å‘é€æ“ä½œä¹‹å‰ï¼Œå› æ­¤å¯¹ i çš„å†™æ“ä½œå°†å§‹ç»ˆåœ¨è¯»æ“ä½œä¹‹å‰å‘ç”Ÿã€‚</p>
<p><a href="https://colobu.com/2021/07/13/Updating-the-Go-Memory-Model/" target="_blank" rel="noopener">https://colobu.com/2021/07/13/Updating-the-Go-Memory-Model/</a></p>
<h3 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h3><p><strong>context.WithTimeout</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> publishHandler <span class="keyword">struct</span> &#123;</span><br><span class="line">    pub publisher</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h publishHandler)</span> <span class="title">publishPosition</span><span class="params">(position flight.Position)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    ctx, cancel := context.WithTimeout(context.Background(), <span class="number">4</span>*time.Second) â¶ <span class="number">4</span>såè¶…æ—¶çš„ä¸Šä¸‹æ–‡</span><br><span class="line">    <span class="keyword">defer</span> cancel()                                                          â· <span class="keyword">defer</span> cancel</span><br><span class="line">    <span class="keyword">return</span> h.pub.Publish(ctx, position)                                     â¸ ä¼ é€’è¶…æ—¶ä¸Šä¸‹æ–‡</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç ä½¿ç”¨ context.WithTimeout å‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡ã€‚è¿™ä¸ªå‡½æ•°æ¥å—ä¸€ä¸ªè¶…æ—¶æ—¶é—´å’Œä¸€ä¸ªä¸Šä¸‹æ–‡ä¸ºå‚æ•°ã€‚åœ¨è¿™é‡Œï¼Œç”±äº publishPosition æ²¡æœ‰æ”¶åˆ°ä¸€ä¸ªç°æœ‰çš„ä¸Šä¸‹æ–‡ï¼Œæˆ‘ä»¬é€šè¿‡ context.Background åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ä¸Šä¸‹æ–‡ã€‚åŒæ—¶ï¼Œcontext.WithTimeout è¿”å›ä¸¤ä¸ªå˜é‡ï¼šæ‰€åˆ›å»ºçš„ä¸Šä¸‹æ–‡å’Œä¸€ä¸ªè¢«è°ƒç”¨åä¼šå–æ¶ˆä¸Šä¸‹æ–‡çš„å–æ¶ˆå‡½æ•° cancel func()ã€‚å°†åˆ›å»ºçš„ä¸Šä¸‹æ–‡ä¼ é€’ç»™ Publish æ–¹æ³•åº”è¯¥èƒ½åœ¨æœ€å¤š4ç§’å†…ä½¿å…¶è¿”å›ã€‚</p>
<p><strong>context.WithCancel</strong></p>
<p>Goè¯­è¨€ä¸Šä¸‹æ–‡çš„å¦ä¸€ä¸ªç”¨ä¾‹æ˜¯ä¼ é€’ cancel ä¿¡å·ï¼Œæˆ‘ä»¬æƒ³åˆ›å»ºä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œåœ¨å¦ä¸€ä¸ªgoroutineä¸­è°ƒç”¨CreateFileWatcher(ctx context.Context, filename string)ã€‚è¿™ä¸ªå‡½æ•°åˆ›å»ºäº†ä¸€ä¸ªç‰¹å®šçš„æ–‡ä»¶ç›‘å¬å™¨ï¼Œå®ƒä¸€ç›´ä»æ–‡ä»¶ä¸­è¯»å–å¹¶æ•è·æ›´æ–°ã€‚å½“æä¾›çš„ä¸Šä¸‹æ–‡è¿‡æœŸæˆ–è¢«å–æ¶ˆæ—¶ï¼Œæ­¤å‡½æ•°ä¼šå¤„ç†å®ƒä»¥å…³é—­æ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ctx, cancel := context.WithCancel(context.Background())    â¶ åˆ›å»ºå¯å–æ¶ˆçš„ä¸Šä¸‹æ–‡</span><br><span class="line">    <span class="keyword">defer</span> cancel()                                             â· å»¶è¿Ÿè°ƒç”¨cancel</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        CreateFileWatcher(ctx, <span class="string">"foo.txt"</span>)                      â¸ ä¼ é€’ä¸Šä¸‹æ–‡</span><br><span class="line">    &#125;()</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ main å‡½æ•°è¿”å›æ—¶ï¼Œå®ƒè°ƒç”¨ cancel å‡½æ•°æ¥å–æ¶ˆä¼ é€’ç»™ CreateFileWatcher å‡½æ•°çš„ä¸Šä¸‹æ–‡ï¼Œä½¿æ–‡ä»¶æè¿°ç¬¦å¯ä»¥æ­£å¸¸å…³é—­ã€‚</p>
<p><strong>context.WithValue</strong></p>
<p>Goè¯­è¨€ä¸Šä¸‹æ–‡çš„å¦ä¸€ä¸ªç”¨ä¾‹æ˜¯æºå¸¦é”®å€¼åˆ—è¡¨ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼åˆ›å»ºä¼ è¾¾å€¼çš„ä¸Šä¸‹æ–‡</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctx := context.WithValue(parentCtx, <span class="string">"key"</span>, <span class="string">"value"</span>)</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Valueæ–¹æ³•æ¥è®¿é—®è¯¥å€¼:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ctx := context.WithValue(context.Background(), <span class="string">"key"</span>, <span class="string">"value"</span>)</span><br><span class="line">fmt.Println(ctx.Value(<span class="string">"key"</span>))</span><br></pre></td></tr></table></figure>
<p>æä¾›çš„é”®å’Œå€¼å¯ä»¥æ˜¯ä»»ä½•ç±»å‹ã€‚å®é™…ä¸Šï¼Œå¯¹äºå€¼ï¼Œæˆ‘ä»¬å¯ä»¥ä¼ é€’ä»»ä½•ç±»å‹ã€‚ä½†ä¸ºä»€ä¹ˆé”®ä¹Ÿè¦æ˜¯ä¸€ä¸ªç©ºæ¥å£è€Œä¸æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Ÿè¿™äº‹å› ä¸ºè¿™ä¹ˆåšï¼Œå¯èƒ½ä¼šå‘ç”Ÿç¢°æ’ï¼šæ¥è‡ªä¸åŒåŒ…çš„ä¸¤ä¸ªå‡½æ•°å¯èƒ½ä½¿ç”¨ç›¸åŒçš„å­—ç¬¦ä¸²å€¼ä½œä¸ºé”®ã€‚å› æ­¤ï¼Œåè€…ä¼šè¦†ç›–å‰è€…çš„å€¼ã€‚å› æ­¤ï¼Œåœ¨å¤„ç†ä¸Šä¸‹æ–‡é”®æ—¶çš„æœ€ä½³å®è·µæ˜¯åˆ›å»ºä¸€ä¸ªæœªå¯¼å‡ºçš„è‡ªå®šä¹‰ç±»å‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> provider</span><br><span class="line"> </span><br><span class="line"><span class="keyword">type</span> key <span class="keyword">string</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> myCustomKey key = <span class="string">"key"</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">    ctx = context.WithValue(ctx, myCustomKey, <span class="string">"foo"</span>)</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Done å’Œ Err</strong></p>
<p>context.Context ç±»å‹å¯¼å‡ºä¸€ä¸ªDoneæ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªåªè¯»é€šçŸ¥é€šé“ï¼š&lt;-chan struct{}ã€‚å½“ä¸ä¸Šä¸‹æ–‡ç›¸å…³çš„å·¥ä½œåº”è¢«å–æ¶ˆæ—¶ï¼ˆæˆªæ­¢æ—¶æœŸå…³é—­æˆ–è€…è°ƒç”¨ cancelå–æ¶ˆï¼‰ï¼Œæ­¤é€šé“å°†å…³é—­ã€‚</p>
<p>æ­¤å¤–ï¼Œcontext.Context å¯¼å‡ºäº†ä¸€ä¸ª Err æ–¹æ³•ï¼Œå¦‚æœ Done channel å°šæœªå…³é—­ï¼Œåˆ™è¿”å› nilã€‚å¦åˆ™ï¼Œå®ƒå°†è¿”å›ä¸€ä¸ªé nil çš„é”™è¯¯ï¼Œå¦‚æœé€šé“è¢«å–æ¶ˆï¼Œåˆ™è¿”å›context.Canceledé”™è¯¯ã€‚å¦‚æœä¸Šä¸‹æ–‡çš„æˆªæ­¢æ—¥æœŸå·²è¿‡ï¼Œåˆ™ä¼šå‡ºç° context.DeadlineExceeded é”™è¯¯ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handler</span><span class="params">(ctx context.Context, ch <span class="keyword">chan</span> Message)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> msg := &lt;-ch:               â¶ ä¸æ–­æ”¶åˆ°æ¥è‡ª ch çš„æ¶ˆæ¯</span><br><span class="line">            <span class="comment">// Do something with msg</span></span><br><span class="line">        <span class="keyword">case</span> &lt;-ctx.Done():              â· å¦‚æœä¸Šä¸‹æ–‡è¢«å–æ¶ˆæˆ–è€…å®Œæˆï¼Œåˆ™è¿”å›ä¸å…¶ç›¸å…³çš„é”™è¯¯</span><br><span class="line">            <span class="keyword">return</span> ctx.Err()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ğŸ¡æ€»ç»“</strong></p>
<p>æ­£å¦‚æˆ‘ä»¬æ‰€æåˆ°çš„ï¼Œ context å…è®¸æˆ‘ä»¬æºå¸¦æˆªæ­¢æ—¶é—´ã€å–æ¶ˆä¿¡å·å’Œ/æˆ–é”®å€¼åˆ—è¡¨ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œç”¨æˆ·ç­‰å¾…çš„å‡½æ•°åº”è¯¥æ¥å— context ä½œä¸ºå‚æ•°ï¼Œè¿™æ ·å¯ä»¥ä¸Šæ¸¸è°ƒç”¨è€…å¯ä»¥å†³å®šåœ¨ä½•æ—¶å–æ¶ˆè°ƒç”¨æ­¤å‡½æ•°ã€‚</p>
<p>å¦‚æœå¯¹äºåº”è¯¥ä½¿ç”¨å“ªç§ä¸Šä¸‹æ–‡æ„Ÿåˆ°ç–‘æƒ‘ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨context.TODO()ä»£æ›¿ä¼ é€’ç©ºçš„context.Backgroundä¸Šä¸‹æ–‡ã€‚</p>
<h3 id="é”™è¯¯çš„ä¼ é€’-context"><a href="#é”™è¯¯çš„ä¼ é€’-context" class="headerlink" title="é”™è¯¯çš„ä¼ é€’ context"></a>é”™è¯¯çš„ä¼ é€’ context</h3><p>æœ‰ä¸€ä¸ªå‡½æ•°ï¼Œæ¥æ”¶ HTTP è¯·æ±‚ï¼Œå¹¶åœ¨ doSomeTask ä¸­æ„å»º response å“åº”ã€‚ç„¶ååœ¨å“åº”å†™å…¥ kafka ä¸­ï¼Œå¹¶ä¸”å°†å“åº”è¿”å›ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">    response, err := doSomeTask(r.Context(), r)         â¶ æ„å»º HTTP Response</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        http.Error(w, err.Error(), http.StatusInternalServerError)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;                                         â· åˆ›å»ºä¸€ä¸ªåç¨‹å°† response ä¼ é€’åˆ° kafka</span><br><span class="line">        err := publish(r.Context(), response)</span><br><span class="line">        <span class="comment">// Do something with err</span></span><br><span class="line">    &#125;()</span><br><span class="line"> </span><br><span class="line">    writeResponse(response)                             â¸ HTTP å“åº”</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é™„åŠ åˆ° HTTP è¯·æ±‚çš„ä¸Šä¸‹æ–‡å¯èƒ½ä¼šåœ¨ä»¥ä¸‹åœºæ™¯è¢«å–æ¶ˆï¼š</p>
<ol>
<li>å½“å®¢æˆ·ç«¯çš„è¿æ¥è¢«å…³é—­æ—¶</li>
<li>åœ¨ HTTP/2 è¯·æ±‚çš„æƒ…å†µä¸‹ï¼Œå½“è¯·æ±‚è¢«å–æ¶ˆçš„æ—¶å€™</li>
<li>å½“å“åº”å·²ç»è¢«å†™å›å®¢æˆ·ç«¯çš„æ—¶å€™</li>
</ol>
<p>å½“æ˜¯ç¬¬ä¸‰ç§æƒ…å†µçš„æ—¶å€™ï¼Œå¦‚æœå“åº”æ˜¯åœ¨ kafak publish ä¹‹åå†™çš„ï¼Œè¿™ç§æƒ…å†µä¸‹æ²¡æœ‰é—®é¢˜ã€‚ä½†æ˜¯å¦‚æœå“åº”æ˜¯åœ¨ kafka å‘å¸ƒä¹‹å‰æˆ–è€… publish æœŸé—´å†™çš„ï¼Œé‚£ä¹ˆ kafka å‘å¸ƒæ¶ˆæ¯å°±ä¼šå¤±è´¥ã€‚</p>
<p>é‚£ä¹ˆå¦‚ä½•è§£å†³è¿™ç§é—®é¢˜å‘¢ï¼Ÿ</p>
<p>ç¬¬ä¸€ç§è§£å†³æ–¹æ³•æ˜¯ä¸ä¼ æ’­çˆ¶çº§çš„ context ä¸Šä¸‹æ–‡ï¼Œåè€Œæˆ‘ä»¬ä¼šä½¿ç”¨ç©ºä¸Šä¸‹æ–‡ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">err := publish(context.Background(), response)    â¶ ä½¿ç”¨ç©ºçš„ä¸Šä¸‹æ–‡è€Œä¸æ˜¯ HTTP è¯·æ±‚ä¸Šä¸‹æ–‡</span><br></pre></td></tr></table></figure>
<p>ç¬¬äºŒç§è§£å†³æ–¹æ³•æ˜¯æˆ‘ä»¬å®ç°è‡ªå·±çš„ä¸Šä¸‹æ–‡ï¼Œä½†æ˜¯ä¸æºå¸¦ cancel çš„ä¿¡å·ï¼Œå¹¶ä¸”èƒ½è§£å†³ç¬¬ä¸€ç§è§£å†³æ–¹æ¡ˆä¸­çš„ä½¿ç”¨ç©ºçš„ä¸Šä¸‹æ–‡ä¸èƒ½åœ¨å…¶ä¸­ä¼ é€’å€¼çš„é—®é¢˜ã€‚</p>
<p>context.Context æ˜¯ä¸€ä¸ªåŒ…å«å››ä¸ªæ–¹æ³•çš„æ¥å£</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Context <span class="keyword">interface</span> &#123;</span><br><span class="line">    Deadline() (deadline time.Time, ok <span class="keyword">bool</span>) <span class="comment">// ä¸Šä¸‹æ–‡çš„æˆªæ­¢æ—¶é—´</span></span><br><span class="line">    Done() &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125; <span class="comment">// å–æ¶ˆä¿¡å·æˆ–è€…ä¿¡å·åˆ°æœŸæ—¶ï¼Œè¿”å›ä¸€ä¸ªå…³é—­çš„é€šé“</span></span><br><span class="line">    Err() error <span class="comment">// å–æ¶ˆä¿¡å·æˆ–è€…ä¿¡å·åˆ°æœŸæ—¶ï¼ŒErr è¿”å›ä¸€ä¸ªé”™è¯¯</span></span><br><span class="line">    Value(key any) any  <span class="comment">// ä¼ é€’å€¼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬è‡ªå·±å®ç°çš„ context å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> detach <span class="keyword">struct</span> &#123;                  â¶ è‡ªå®šä¹‰ç»“æ„ä½“ï¼Œå°è£… context</span><br><span class="line">    ctx context.Context</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d detach)</span> <span class="title">Deadline</span><span class="params">()</span> <span class="params">(time.Time, <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> time.Time&#123;&#125;, <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d detach)</span> <span class="title">Done</span><span class="params">()</span> &lt;-<span class="title">chan</span> <span class="title">struct</span></span>&#123;&#125; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d detach)</span> <span class="title">Err</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d detach)</span> <span class="title">Value</span><span class="params">(key any)</span> <span class="title">any</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> d.ctx.Value(key)           â· å°†å€¼å¡å…¥ ctx ä¸­</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è‡ªå·±å®ç°çš„ context é™¤äº†è°ƒç”¨çˆ¶çº§ä¸Šä¸‹æ–‡æ£€ç´¢å€¼çš„ Value æ–¹æ³•ä¹‹å¤–ï¼Œå…¶ä»–æ–¹æ³•éƒ½è¿”å›é»˜è®¤å€¼ï¼Œå› æ­¤ä¸Šä¸‹æ–‡æ°¸è¿œä¸ä¼šè¢«è§†ä¸ºå·²è¿‡æœŸæˆ–å·²å–æ¶ˆã€‚</p>
<p>ä½¿ç”¨æ—¶ï¼Œæˆ‘ä»¬å°†è‡ªå·±å®ç°çš„ context ä¼ é€’å°±å»å³å¯ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">err := publish(detach&#123;ctx: r.Context()&#125;, response)    â¶ ä¼ å…¥è‡ªå·±å®ç°çš„ context</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨ä¼ é€’ç»™å‘å¸ƒå‡½æ•°çš„ä¸Šä¸‹æ–‡å°†æ°¸ä¸è¿‡æœŸæˆ–è¢«å–æ¶ˆï¼Œå¹¶ä¸”å®ƒå°†æºå¸¦çˆ¶çº§ä¸Šä¸‹æ–‡çš„å€¼ã€‚</p>
<h3 id="ä½•æ—¶åœæ­¢-Goroutine"><a href="#ä½•æ—¶åœæ­¢-Goroutine" class="headerlink" title="ä½•æ—¶åœæ­¢ Goroutine"></a>ä½•æ—¶åœæ­¢ Goroutine</h3><p>Goroutine çš„æœ€å°å †æ ˆå¤§å°ä¸º 2 KBï¼Œå¯ä»¥éšéœ€è¦å¢é•¿å’Œç¼©å°ï¼ˆ64 ä½ç³»ç»Ÿä¸Šçš„æœ€å¤§å †æ ˆå¤§å°ä¸º 1 GBï¼Œ32 ä½ç³»ç»Ÿä¸Šä¸º 250 MBï¼‰</p>
<p>è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼Œå…¶ä¸­ goroutine çš„åœæ­¢æ—¶é—´ç‚¹ä¸æ˜ç¡®ï¼Œåˆ›å»ºçš„ Goroutine ä¼šåœ¨ ch è¢«å…³é—­æ—¶é€€å‡ºã€‚ä½†æˆ‘ä»¬ç¡®åˆ‡çŸ¥é“è¿™ä¸ª channel ä½•æ—¶å…³é—­å—ï¼Ÿè¿™å¯èƒ½ä¸æ˜æ˜¾ï¼Œå› ä¸º ch æ˜¯ç”± foo å‡½æ•°åˆ›å»ºçš„ã€‚å¦‚æœè¿™ä¸ª channel ä»æœªè¢«å…³é—­ï¼Œå°±ä¼šé€ æˆèµ„æºæ³„æ¼ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ch := foo()</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> v := <span class="keyword">range</span> ch &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å†æ¥çœ‹å¦å¤–ä¸€ä¸ªä¾‹å­ï¼Œè¿™æ®µä»£ç çš„é—®é¢˜åœ¨äºå½“ä¸» goroutine é€€å‡ºæ—¶ï¼ˆå¯èƒ½æ˜¯ç”±äºæ“ä½œç³»ç»Ÿä¿¡å·æˆ–è€…å› ä¸ºå®ƒæœ‰æœ‰é™çš„å·¥ä½œè´Ÿè½½ï¼‰ï¼Œåº”ç”¨ä¹Ÿä¼šåœæ­¢ã€‚å› æ­¤ï¼Œç”±ç›‘å¬å™¨åˆ›å»ºçš„èµ„æºå¹¶æ²¡æœ‰è¢«ä¼˜é›…åœ°å…³é—­ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    newWatcher()</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Run the application</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">type</span> watcher <span class="keyword">struct</span> &#123; <span class="comment">/* Some resources */</span> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newWatcher</span><span class="params">()</span></span> &#123;</span><br><span class="line">    w := watcher&#123;&#125;</span><br><span class="line">    <span class="keyword">go</span> w.watch()      â¶ åˆ›å»º gorouting æ¥ç›‘å¬å¤–éƒ¨é…ç½®</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‚£æˆ‘ä»¬æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿä¸€ä¸ªé€‰é¡¹æ˜¯å°†ä¸€ä¸ªåœ¨ main è¿”å›æ—¶å°†è¢«å–æ¶ˆçš„ä¸Šä¸‹æ–‡ä¼ é€’ç»™ newWatcherã€‚ä¾‹å¦‚ä¸‹é¢è¿™æ ·ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ctx, cancel := context.WithCancel(context.Background())</span><br><span class="line">    <span class="keyword">defer</span> cancel()</span><br><span class="line"> </span><br><span class="line">    newWatcher(ctx)      â¶ å°†ä¸Šä¸‹æ–‡ä¼ é€’ç»™ newWatcher</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Run the application</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newWatcher</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">    w := watcher&#123;&#125;</span><br><span class="line">    <span class="keyword">go</span> w.watch(ctx)      â· ä¼ æ’­ä¸Šä¸‹æ–‡</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯è¿™æ ·æœ‰ä¸ªé—®é¢˜ï¼Œé—®é¢˜åœ¨äºæˆ‘ä»¬ä½¿ç”¨ä¿¡å·æ¥ä¼ è¾¾ goroutine éœ€è¦åœæ­¢è¿è¡Œçš„æ¶ˆæ¯ã€‚æˆ‘ä»¬æ²¡æœ‰åœ¨èµ„æºè¢«å…³é—­ä¹‹å‰é˜»å¡çˆ¶çº§ goroutineã€‚æˆ‘ä»¬éœ€è¦ç¡®ä¿é˜»å¡çˆ¶çº§ goroutine ç›´åˆ°èµ„æºè¢«å…³é—­ï¼Œä¸ç„¶å°±å¯èƒ½å‘ç”Ÿçˆ¶çº§ goroutine ç»“æŸäº†ï¼Œw.watch è¿˜æ²¡è¢«å…³é—­çš„æƒ…å†µã€‚</p>
<p>æ‰€ä»¥æ­£ç¡®çš„åšæ³•æ˜¯ï¼Œæˆ‘ä»¬åº”è¯¥è°ƒç”¨ w çš„ close æ–¹æ³•æ¥å…³é—­èµ„æº</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    w := newWatcher()</span><br><span class="line">    <span class="keyword">defer</span> w.<span class="built_in">close</span>()     â¶ å»¶è¿Ÿè°ƒç”¨ w çš„ <span class="built_in">close</span> æ–¹æ³•</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Run the application</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newWatcher</span><span class="params">()</span> <span class="title">watcher</span></span> &#123;</span><br><span class="line">    w := watcher&#123;&#125;</span><br><span class="line">    <span class="keyword">go</span> w.watch()</span><br><span class="line">    <span class="keyword">return</span> w</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w watcher)</span> <span class="title">close</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// Close the resources</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨ defer æ¥è°ƒç”¨è¿™ä¸ª close æ–¹æ³•ï¼Œä»¥ç¡®ä¿åœ¨åº”ç”¨ç¨‹åºé€€å‡ºä¹‹å‰å…³é—­èµ„æºï¼Œè€Œä¸æ˜¯é€šè¿‡å‘ watcher å‘é€ä¿¡å·æ¥å…³é—­å…¶èµ„æºã€‚</p>
<h3 id="range-ä¸­æ‰§è¡Œåç¨‹"><a href="#range-ä¸­æ‰§è¡Œåç¨‹" class="headerlink" title="range ä¸­æ‰§è¡Œåç¨‹"></a>range ä¸­æ‰§è¡Œåç¨‹</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">s := []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> _, i := <span class="keyword">range</span> s &#123;      â¶ è¿­ä»£æ¯ä¸ªå…ƒç´ </span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        fmt.Print(i)       â· è®¿é—®å˜é‡ i</span><br><span class="line">    &#125;()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç çš„è¾“å‡ºä¸æ˜¯ç¡®å®šæ€§çš„ã€‚ä¾‹å¦‚ï¼Œæœ‰æ—¶å®ƒä¼šæ‰“å°å‡º 233ï¼Œè€Œå…¶ä»–æ—¶å€™åˆ™ä¼šæ‰“å°å‡º 333ã€‚è¿™æ˜¯ä»€ä¹ˆåŸå› å‘¢ï¼Ÿ</p>
<p>è¿™æ˜¯å› ä¸ºåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡é—­åŒ…åˆ›å»ºæ–°çš„ goroutineã€‚å®ƒå¼•ç”¨äº†å¤–éƒ¨å˜é‡ï¼šè¿™é‡Œæ˜¯å˜é‡ iã€‚æˆ‘ä»¬å¿…é¡»çŸ¥é“å½“é—­åŒ… goroutine æ‰§è¡Œæ—¶ï¼Œå®ƒå¹¶ä¸æ•è·åˆ›å»º goroutine æ—¶çš„å€¼ã€‚ç›¸åï¼Œæ‰€æœ‰ goroutine éƒ½å¼•ç”¨ç›¸åŒçš„å˜é‡ã€‚</p>
<p>é‚£è¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ</p>
<p>ç¬¬ä¸€ä¸ªé€‰æ‹©ï¼Œå¦‚æœæˆ‘ä»¬ä»è¦ä½¿ç”¨é—­åŒ…ï¼Œæ¶‰åŠåˆ›å»ºä¸€ä¸ªæ–°å˜é‡ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> _, i := <span class="keyword">range</span> s &#123;</span><br><span class="line">    val := i            â¶ é’ˆå¯¹æ¯æ¬¡è¿­ä»£ï¼Œåˆ›å»ºä¸€ä¸ªæœ¬åœ°å˜é‡</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        fmt.Print(val)</span><br><span class="line">    &#125;()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨æ¯æ¬¡è¿­ä»£ä¸­ï¼Œæˆ‘ä»¬ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å±€éƒ¨å˜é‡ valã€‚è¿™ä¸ªå˜é‡æ•è·äº†å½“å‰è¿­ä»£ä¸­çš„ i å€¼ï¼Œåœ¨åç¨‹åˆ›å»ºå‰ã€‚å› æ­¤ï¼Œå½“æ¯ä¸ªé—­åŒ…åç¨‹æ‰§è¡Œæ‰“å°è¯­å¥æ—¶ï¼Œéƒ½ä¼šä½¿ç”¨é¢„æœŸçš„å€¼ã€‚è¿™æ®µä»£ç ä¼šæ‰“å°å‡º 123ã€‚</p>
<p>ç¬¬äºŒä¸ªé€‰é¡¹ä¸å†ä¾èµ–é—­åŒ…ï¼Œè€Œæ˜¯ä½¿ç”¨å®é™…çš„å‡½æ•°ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> _, i := <span class="keyword">range</span> s &#123;</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(val <span class="keyword">int</span>)</span></span> &#123;     â¶ æ¥å— val å‚æ•°</span><br><span class="line">        fmt.Print(val)</span><br><span class="line">    &#125;(i)                   â· å°† i ä¼ å…¥</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ç§æ–¹æ³•ä¸æ˜¯é—­åŒ…ï¼Œè¯¥å‡½æ•°ä¸å¼•ç”¨æ¥è‡ªå…¶ä¸»ä½“å¤–éƒ¨çš„å˜é‡ valï¼›val ç°åœ¨æ˜¯å‡½æ•°çš„ä¸€éƒ¨åˆ†è¾“å…¥ã€‚é€šè¿‡è¿™æ ·åšï¼Œæˆ‘ä»¬åœ¨æ¯æ¬¡è¿­ä»£ä¸­éƒ½å›ºå®šäº†iã€‚</p>
<h3 id="switch-channel-çš„éšæœºé€‰æ‹©"><a href="#switch-channel-çš„éšæœºé€‰æ‹©" class="headerlink" title="switch+channel  çš„éšæœºé€‰æ‹©"></a>switch+channel  çš„éšæœºé€‰æ‹©</h3><p>ä¸‹é¢ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›å…ˆå¤„ç† messageCh é€šé“ä¸­çš„å†…å®¹ï¼Œç„¶ååœ¨å¤„ç† disconnectCh ä¸­çš„å†…å®¹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">    <span class="keyword">select</span> &#123;                         â¶ ä½¿ç”¨ <span class="keyword">select</span> è¯­å¥ä»å¤šä¸ªchannelä¸­æ¥æ”¶æ•°æ®</span><br><span class="line">    <span class="keyword">case</span> v := &lt;-messageCh:           â· å¤„ç† messageCh </span><br><span class="line">        fmt.Println(v)</span><br><span class="line">    <span class="keyword">case</span> &lt;-disconnectCh:             â¸ å¤„ç† disconnectCh</span><br><span class="line">        fmt.Println(<span class="string">"disconnection, return"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ç”¨ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">    messageCh &lt;- i</span><br><span class="line">&#125;</span><br><span class="line">disconnectCh &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯å¾—åˆ°çš„ç»“æœå¦‚ä¸‹ï¼Œå¹¶æ²¡æœ‰æ‰“å°10æ¡æ¶ˆæ¯ï¼Œç„¶ååœ¨å¤„ç† disconnectChã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">disconnection, return</span><br></pre></td></tr></table></figure>
<p>å‡ºç°è¿™æ ·çš„åŸå› æ˜¯ï¼Œå½“æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªé€šé“å¯ä»¥å¤„ç†æ—¶ï¼Œé‚£ä¹ˆå°†é€šè¿‡ä¼ªéšæœºé€‰æ‹©é€‰ä¸€ä¸ªé€šé“è¿›è¡Œå¤„ç†ã€‚è¿™ä¹ˆåšçš„å¥½å¤„æ˜¯é˜²æ­¢é¥¥é¥¿ã€‚</p>
<p>é‚£ä¹ˆå‡å¦‚æˆ‘ä»¬è¦å®ç°ä¸Šè¿°çš„éœ€æ±‚ã€âš ï¸ä¸Šè¿°çš„éœ€æ±‚ä¸­æœ‰å¤šä¸ª goroutine ç”Ÿäº§è€…ã€‘ï¼Œé‚£ä¹ˆè¯¥æ€ä¹ˆå®ç°å‘¢ï¼Ÿä¸‹é¢æ˜¯ä¸€ç§è§£å†³æ–¹å¼ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> v := &lt;-messageCh:</span><br><span class="line">        fmt.Println(v)</span><br><span class="line">    <span class="keyword">case</span> &lt;-disconnectCh:</span><br><span class="line">        <span class="keyword">for</span> &#123;                          â¶ å†…éƒ¨ <span class="keyword">for</span> <span class="keyword">select</span></span><br><span class="line">            <span class="keyword">select</span> &#123;</span><br><span class="line">            <span class="keyword">case</span> v := &lt;-messageCh:     â· è¯»å–å‰©ä½™æ¶ˆæ¯</span><br><span class="line">                fmt.Println(v)</span><br><span class="line">            <span class="keyword">default</span>:                   â¸ <span class="keyword">default</span> æ‰§è¡Œ <span class="keyword">return</span> è¿”å›</span><br><span class="line">                fmt.Println(<span class="string">"disconnection, return"</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯¥è§£å†³æ–¹æ¡ˆä½¿ç”¨ä¸€ä¸ªå¸¦æœ‰ä¸¤ä¸ª case çš„ for/selectï¼šä¸€ä¸ªæ˜¯ messageChï¼Œå¦ä¸€ä¸ªæ˜¯é»˜è®¤æƒ…å†µã€‚åªæœ‰åœ¨æ²¡æœ‰å…¶ä»– case åŒ¹é…æ—¶ï¼Œæ‰ä¼šåœ¨ select è¯­å¥ä¸­ä½¿ç”¨ defaultã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬åªæœ‰åœ¨æ¥æ”¶åˆ° messageCh ä¸­æ‰€æœ‰å‰©ä½™çš„æ¶ˆæ¯åæ‰ä¼šè¿”å›ã€‚</p>
<p>âš ï¸è¿™ä¹ˆåšèƒ½ä¿è¯é¡ºåºçš„å‰ææ˜¯ messageCh çš„æ¶ˆæ¯æ˜¯ä¸€æ¬¡æ€§å‘é€å®Œæˆçš„ï¼Œè€Œä¸æ˜¯åˆ†å¼€å‘é€ï¼Œè¿™æ ·åœ¨æ‰§è¡Œç¬¬äºŒä¸ªä» messageCh ä¸­è¯»å–æ¶ˆæ¯æ—¶ï¼Œè‚¯å®šä¼šæœ‰æ•°æ®ï¼Œè€Œä¸æ˜¯å…ˆæ‰§è¡Œ defaultã€‚</p>
<p>å¦ä¸€ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæ˜¯å•ä¸ª goroutine ä½œä¸ºç”Ÿäº§è€…çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åˆ™å¯ä»¥ä½¿ç”¨ä¸å¸¦ç¼“å†²åŒºçš„ channel æ¥è¾¾åˆ°ç›®çš„ã€‚</p>
<h3 id="ä½¿ç”¨-channel-ä½œä¸ºé€šçŸ¥ä¿¡é“"><a href="#ä½¿ç”¨-channel-ä½œä¸ºé€šçŸ¥ä¿¡é“" class="headerlink" title="ä½¿ç”¨ channel ä½œä¸ºé€šçŸ¥ä¿¡é“"></a>ä½¿ç”¨ channel ä½œä¸ºé€šçŸ¥ä¿¡é“</h3><p>åœ¨Goè¯­è¨€ä¸­ï¼Œä¸€ä¸ªç©ºç»“æ„ä½“æ˜¯ä¸€ä¸ªæ²¡æœ‰ä»»ä½•å­—æ®µçš„ç»“æ„ä½“ã€‚æ— è®ºæ¶æ„å¦‚ä½•ï¼Œå®ƒå ç”¨é›¶å­—èŠ‚çš„å­˜å‚¨ç©ºé—´ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨unsafe.SizeoféªŒè¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var s struct&#123;&#125;</span><br><span class="line">fmt.Println(unsafe.Sizeof(s))</span><br><span class="line">0</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ä¸€ä¸ªç©ºæ¥å£ï¼ˆvar i interface{}ï¼‰ï¼Ÿå› ä¸ºä¸€ä¸ªç©ºæ¥å£æ˜¯æœ‰å¤§å°çš„ï¼›å®ƒåœ¨32ä½æ¶æ„ä¸Šå ç”¨8å­—èŠ‚ï¼Œåœ¨64ä½æ¶æ„ä¸Šå ç”¨16å­—èŠ‚ã€‚</p>
</blockquote>
<p>ä¸€ä¸ªæ²¡æœ‰æ•°æ®çš„ä¿¡é“åº”è¯¥ç”¨ chan struct{} ç±»å‹æ¥è¡¨ç¤ºã€‚è¿™æ ·ä¸€æ¥ï¼Œå°±å¯ä»¥ä¸ºæ¥æ”¶è€…æ˜ç¡®è¡¨ç¤ºï¼Œä»–ä»¬ä¸åº”è¯¥ä»æ¶ˆæ¯å†…å®¹ä¸­æœŸæœ›ä»»ä½•å«ä¹‰â€”â€”åªæ˜¯è¡¨ç¤ºä»–ä»¬å·²ç»æ¥æ”¶åˆ°äº†ä¸€æ¡æ¶ˆæ¯ã€‚åœ¨Goä¸­ï¼Œè¿™äº›ä¿¡é“è¢«ç§°ä¸ºé€šçŸ¥ä¿¡é“ã€‚</p>
<h3 id="nil-channel"><a href="#nil-channel" class="headerlink" title="nil channel"></a>nil channel</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ch <span class="keyword">chan</span> <span class="keyword">int</span>     â¶ <span class="literal">nil</span> chanel</span><br><span class="line">&lt;-ch</span><br></pre></td></tr></table></figure>
<p>ch æ˜¯ chan int ç±»å‹ã€‚channel çš„é›¶å€¼ä¸º nilï¼Œå› æ­¤ ch ä¸º nilã€‚åç¨‹ä¸ä¼šè§¦å‘ panicï¼›ä½†æ˜¯ï¼Œå®ƒå°†ä¸€ç›´é˜»å¡ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬å‘ä¸€ä¸ª nil çš„é€šé“å‘é€æ¶ˆæ¯ï¼ŒåŸç†æ˜¯ä¸€æ ·çš„ã€‚è¿™ä¸ª goroutine ä¼šæ°¸è¿œé˜»å¡ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ch <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">ch &lt;- <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>nil channel æœ‰æ—¶å€™å¾ˆæœ‰ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ nil é€šé“æ¥å®ç°ä¸€ç§ä¼˜é›…çš„çŠ¶æ€æœºï¼Œä»è€Œå°†ä¸€ä¸ª case ä» select è¯­å¥ä¸­å»é™¤ã€‚ä¾‹å¦‚ä¸€ä¸‹ç¤ºä¾‹ï¼šä»ä¸¤ä¸ªé€šé“æ¥æ”¶ã€‚å¦‚æœå…¶ä¸­ä¸€ä¸ªå…³é—­ï¼Œæˆ‘ä»¬å°†å…¶èµ‹å€¼ä¸ºnilï¼Œå› æ­¤æˆ‘ä»¬åªä»ä¸€ä¸ªé€šé“æ¥æ”¶ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">merge</span><span class="params">(ch1, ch2 &lt;-<span class="keyword">chan</span> <span class="keyword">int</span>)</span> &lt;-<span class="title">chan</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> ch1 != <span class="literal">nil</span> || ch2 != <span class="literal">nil</span> &#123;    â¶ ä¿è¯è‡³å°‘ä¸€ä¸ªé€šé“ä¸ä¸º <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">            <span class="keyword">case</span> v, open := &lt;-ch1:</span><br><span class="line">                <span class="keyword">if</span> !open &#123;</span><br><span class="line">                    ch1 = <span class="literal">nil</span>             â· ä¸€æ—¦ ch1 å…³é—­ï¼Œå°±å°† ch1 è®¾ç½®ä¸º <span class="literal">nil</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                &#125;</span><br><span class="line">                ch &lt;- v</span><br><span class="line">            <span class="keyword">case</span> v, open := &lt;-ch2:</span><br><span class="line">                <span class="keyword">if</span> !open &#123;</span><br><span class="line">                    ch2 = <span class="literal">nil</span>             â¸ ä¸€æ—¦ ch2 å…³é—­ï¼Œå°±å°† ch2 è®¾ç½®ä¸º <span class="literal">nil</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                &#125;</span><br><span class="line">                ch &lt;- v</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">close</span>(ch)</span><br><span class="line">    &#125;()</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> ch</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>åœ¨ Go çš„ <code>select</code> è¯­å¥ä¸­ï¼Œå¦‚æœå¤šä¸ª <code>case</code> ä¸­çš„é€šé“éƒ½æ˜¯å¯è¯»çš„ï¼ˆæˆ–è€…éƒ½æ˜¯å¯å†™çš„ï¼‰ï¼Œé€‰æ‹©å“ªä¸ª <code>case</code> æ˜¯éç¡®å®šæ€§çš„ã€‚å½“å…¶ä¸­ä¸€ä¸ªé€šé“ä¸º <code>nil</code> æ—¶ï¼Œå®ƒè¢«è§†ä¸ºä¸å¯è¯»ï¼ˆæˆ–ä¸å¯å†™ï¼‰ï¼Œè€Œ <code>select</code> è¯­å¥ä¼šè‡ªåŠ¨é€‰æ‹©å…¶ä»–å¯è¯»ï¼ˆæˆ–å¯å†™ï¼‰çš„é€šé“æ¥æ‰§è¡Œã€‚</p>
</blockquote>
<h3 id="æœ‰-æ— ç¼“å†²çš„-channel"><a href="#æœ‰-æ— ç¼“å†²çš„-channel" class="headerlink" title="æœ‰/æ— ç¼“å†²çš„ channel"></a>æœ‰/æ— ç¼“å†²çš„ channel</h3><p>ä¸€ä¸ªéç¼“å­˜ä¿¡é“æ˜¯æ²¡æœ‰å®¹é‡çš„ä¿¡é“ã€‚å®ƒå¯ä»¥é€šè¿‡çœç•¥å¤§å°æˆ–æä¾›é›¶å¤§å°æ¥åˆ›å»º</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ch1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">ch2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨æ— ç¼“å†²ä¿¡é“ï¼ˆæœ‰æ—¶ç§°ä¸ºåŒæ­¥ä¿¡é“ï¼‰ï¼Œå‘é€è€…å°†ä¸€ç›´é˜»å¡ï¼Œç›´åˆ°æ¥æ”¶è€…ä»ä¿¡é“æ¥æ”¶åˆ°æ•°æ®</p>
<p>ç›¸ååœ°ï¼Œå¸¦ç¼“å†²çš„é€šé“å…·æœ‰å®¹é‡ï¼Œå¿…é¡»åˆ›å»ºä¸€ä¸ªå¤§å°å¤§äºæˆ–ç­‰äº1çš„é€šé“ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch3 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>æœ‰äº†ç¼“å†²é€šé“ï¼Œå‘é€è€…å¯ä»¥åœ¨é€šé“æœªæ»¡çš„æƒ…å†µä¸‹å‘é€æ¶ˆæ¯ã€‚ä¸€æ—¦é€šé“æ»¡äº†ï¼Œå®ƒå°†é˜»å¡ç›´åˆ°æ¥æ”¶è€…åç¨‹æ”¶åˆ°äº†ä¸€æ¡æ¶ˆæ¯ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ch3 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line">ch3 &lt;<span class="number">-1</span>               <span class="comment">// æœªé˜»å¡</span></span><br><span class="line">ch3 &lt;<span class="number">-2</span>               <span class="comment">// é˜»å¡</span></span><br></pre></td></tr></table></figure>
<h3 id="appendçš„æ—¶å€™-data-races"><a href="#appendçš„æ—¶å€™-data-races" class="headerlink" title="appendçš„æ—¶å€™ data races"></a>appendçš„æ—¶å€™ data races</h3><p>å¯¹åˆ‡ç‰‡ä½¿ç”¨ append æ·»åŠ å…ƒç´ ä¸€å®šä¼šäº§ç”Ÿæ•°æ®ç«äº‰å—ï¼Ÿå¹¶ä¸ä¸€å®šï¼éœ€è¦åˆ†åœºæ™¯ã€‚</p>
<p>åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­, æˆ‘ä»¬å°†åˆå§‹åŒ–ä¸€ä¸ªsliceå¹¶åˆ›å»ºä¸¤ä¸ªgoroutinesï¼Œè¿™äº›goroutineså°†ä½¿ç”¨appendåˆ›å»ºä¸€ä¸ªå…·æœ‰é¢å¤–å…ƒç´ çš„æ–° slice:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">s := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;                â¶ åœ¨åç¨‹<span class="number">1</span>ä¸­ <span class="built_in">append</span> ä¸€ä¸ªå…ƒç´ </span><br><span class="line">    s1 := <span class="built_in">append</span>(s, <span class="number">1</span>)</span><br><span class="line">    fmt.Println(s1)</span><br><span class="line">&#125;()</span><br><span class="line"> </span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;                â· åœ¨åç¨‹<span class="number">2</span>ä¸­ <span class="built_in">append</span> å¦ä¸€ä¸ªå…ƒç´ </span><br><span class="line">    s2 := <span class="built_in">append</span>(s, <span class="number">1</span>)</span><br><span class="line">    fmt.Println(s2)</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªä¾‹å­ä¼šé€ æˆæ•°æ®ç«äº‰å—ï¼Ÿç­”æ¡ˆæ˜¯ä¸ä¼šã€‚å› ä¸º slice æœ‰ä¸¤ä¸ªå±æ€§ï¼Œé•¿åº¦å’Œå®¹é‡ã€‚é•¿åº¦æ˜¯ Slice ä¸­å¯ç”¨å…ƒç´ çš„æ•°é‡ï¼Œè€Œå®¹é‡æ˜¯æ”¯æŒæ•°ç»„ä¸­å…ƒç´ çš„æ€»æ•°ã€‚å½“æˆ‘ä»¬ä½¿ç”¨ append æ—¶ï¼Œè¡Œä¸ºå–å†³äº Slice æ˜¯å¦å·²æ»¡ï¼ˆé•¿åº¦ == å®¹é‡ï¼‰ã€‚å¦‚æœæ˜¯ï¼ŒGo è¿è¡Œæ—¶ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ•°ç»„ä»¥æ·»åŠ æ–°å…ƒç´ ï¼›å¦åˆ™ï¼Œè¿è¡Œæ—¶å°†å…¶æ·»åŠ åˆ°ç°æœ‰çš„æ”¯æŒæ•°ç»„ä¸­ã€‚</p>
<p>åœ¨ä¸Šè¿°ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªé•¿åº¦å’Œå®¹é‡éƒ½ä¸º1çš„åˆ‡ç‰‡ã€‚å› æ­¤ï¼Œç”±äºåˆ‡ç‰‡å·²ç»æ»¡äº†ï¼Œæ‰€ä»¥åœ¨æ¯ä¸ª goroutine ä¸­ä½¿ç”¨ append éƒ½å°†è¿”å›ä¸€ä¸ªåº•å±‚ä¸ºæ–°æ•°ç»„çš„åˆ‡ç‰‡ã€‚å®ƒä¸ä¼šæ”¹å˜ç°æœ‰çš„æ•°ç»„ï¼Œæ‰€ä»¥ä¸ä¼šäº§ç”Ÿæ•°æ®ç«äº‰ã€‚</p>
<p>å‡å¦‚æˆ‘ä»¬æ›´æ¢ä¸€ä¸‹åˆå§‹åŒ–æ–¹æ³•ï¼Œä¸åœ¨åˆ›å»ºé•¿åº¦ä¸º1çš„åˆ‡ç‰‡ï¼Œè€Œæ˜¯åˆ›å»ºé•¿åº¦ä¸º0çš„ä½†å®¹é‡ä¸º1çš„åˆ‡ç‰‡</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="number">1</span>)  <span class="comment">// é•¿åº¦ä¸º0ï¼Œä½†å®¹é‡ä¸º1çš„åˆ‡ç‰‡</span></span><br></pre></td></tr></table></figure>
<p>è¿™æ ·æ˜¯å¦ä¸ºé€ æˆæ•°æ®ç«äº‰å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä¼šã€‚æˆ‘ä»¬ä½¿ç”¨ make([]int, 0, 1) åˆ›å»ºä¸€ä¸ªåˆ‡ç‰‡ï¼Œå› æ­¤æ•°ç»„å¹¶æ²¡æœ‰è¢«å¡«æ»¡ã€‚ä¸¤ä¸ª goroutines éƒ½è¯•å›¾æ›´æ–°æ”¯æ’‘æ•°ç»„çš„åŒä¸€ä¸ªç´¢å¼•ï¼ˆç´¢å¼• 1ï¼‰ï¼Œè¿™å°±ä¼šå¯¼è‡´æ•°æ®ç«äº‰ã€‚è¿™æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥åˆ›å»º s çš„å‰¯æœ¬æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">s := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    sCopy := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="built_in">len</span>(s), <span class="built_in">cap</span>(s))</span><br><span class="line">    <span class="built_in">copy</span>(sCopy, s)                          â¶ å¤åˆ¶åˆ‡ç‰‡ï¼Œå¹¶åœ¨å¤åˆ¶åä½¿ç”¨ <span class="built_in">append</span> </span><br><span class="line"> </span><br><span class="line">    s1 := <span class="built_in">append</span>(sCopy, <span class="number">1</span>)</span><br><span class="line">    fmt.Println(s1)</span><br><span class="line">&#125;()</span><br><span class="line"> </span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    sCopy := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="built_in">len</span>(s), <span class="built_in">cap</span>(s))</span><br><span class="line">    <span class="built_in">copy</span>(sCopy, s)                          â· å¤åˆ¶åˆ‡ç‰‡ï¼Œå¹¶åœ¨å¤åˆ¶åä½¿ç”¨ <span class="built_in">append</span> </span><br><span class="line"> </span><br><span class="line">    s2 := <span class="built_in">append</span>(sCopy, <span class="number">1</span>)</span><br><span class="line">    fmt.Println(s2)</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>
<p>ä¸¤ä¸ª goroutine éƒ½ä¼šå¤åˆ¶åˆ‡ç‰‡ï¼Œç„¶åå®ƒä»¬åœ¨å„è‡ªçš„åˆ‡ç‰‡å‰¯æœ¬ä¸Šä½¿ç”¨ appendï¼Œè€Œä¸æ˜¯åŸå§‹åˆ‡ç‰‡ï¼Œè¿™æ ·å°±å¯ä»¥é˜²æ­¢æ•°æ®ç«äº‰ã€‚</p>
<p><strong>ğŸ¡æ€»ç»“</strong></p>
<ol>
<li>è®¿é—®ç›¸åŒçš„åˆ‡ç‰‡ä¸ªç´¢å¼•ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ª goroutine åœ¨æ›´æ–°å€¼æ—¶ï¼Œè¿™å°†ä¼šå¼•èµ·æ•°æ®ç«äº‰ã€‚</li>
<li>è®¿é—®ä¸åŒçš„åˆ‡ç‰‡ç´¢å¼•ä¸ä¼šå¯¼è‡´æ•°æ®ç«äº‰ï¼Œä¸åŒçš„ç´¢å¼•æ„å‘³ç€ä¸åŒçš„å†…å­˜ä½ç½®ã€‚</li>
<li>è®¿é—®åŒä¸€ä¸ª mapï¼ˆæ— è®ºæ˜¯ç›¸åŒçš„é”®è¿˜æ˜¯ä¸åŒçš„é”®ï¼‰ä¸”è‡³å°‘æœ‰ä¸€ä¸ª goroutine æ›´æ–°å®ƒï¼Œå°±ä¼šäº§ç”Ÿæ•°æ®ç«äº‰ã€‚è¿™æ˜¯å› ä¸º map çš„åº•å±‚å®ç°æ˜¯ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼ˆhash tableï¼‰ï¼Œå®ƒåŒ…å«äº†æ¡¶ï¼ˆbucketsï¼‰å’Œå“ˆå¸Œå‡½æ•°ã€‚å½“ä½ å‘ map ä¸­æ’å…¥æˆ–æ£€ç´¢æ•°æ®æ—¶ï¼ŒGo ä¼šä½¿ç”¨é”®çš„å“ˆå¸Œå€¼æ¥ç¡®å®šæ•°æ®åœ¨å“ªä¸ªæ¡¶ä¸­ã€‚å³ï¼Œåœ¨å¹¶å‘æƒ…å†µä¸‹ï¼Œå¤šä¸ªgoroutineåŒæ—¶å¯¹mapè¿›è¡Œæ“ä½œæ—¶ï¼Œå¯èƒ½ä¼šé€ æˆå¤šä¸ªgoroutineåŒæ—¶è¯»å†™åŒä¸€ä¸ªå“ˆå¸Œæ¡¶ï¼Œå¯¼è‡´æ•°æ®ç«äº‰çš„é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œå¤šä¸ªgoroutineåŒæ—¶å‘åŒä¸€ä¸ªæ¡¶ä¸­æ’å…¥æ•°æ®ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ’å…¥çš„æ•°æ®è¢«è¦†ç›–æˆ–è€…ä¸¢å¤±ï¼Œä»è€Œç ´åäº†mapçš„æ­£ç¡®æ€§ã€‚</li>
<li>é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸åº”æ ¹æ®åˆ‡ç‰‡æ˜¯å¦å·²æ»¡æ¥é‡‡ç”¨ä¸åŒçš„å®ç°ã€‚æˆ‘ä»¬åº”è¯¥è€ƒè™‘åˆ°ï¼Œåœ¨å¹¶å‘åº”ç”¨ç¨‹åºä¸­å¯¹å…±äº«åˆ‡ç‰‡ä½¿ç”¨ append å¯èƒ½ä¼šå¯¼è‡´æ•°æ®ç«äº‰ã€‚å› æ­¤ï¼Œåº”é¿å…è¿™ç§æƒ…å†µã€‚</li>
</ol>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><ol>
<li><a href="https://yflee.in/go100mistakes.html" target="_blank" rel="noopener">https://yflee.in/go100mistakes.html</a></li>
<li><a href="https://www.luozhiyun.com/archives/797" target="_blank" rel="noopener">https://www.luozhiyun.com/archives/797</a></li>
<li><a href="https://qcrao.com/post/100-go-mistakes-reading-notes/" target="_blank" rel="noopener">https://qcrao.com/post/100-go-mistakes-reading-notes/</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/611451902" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/611451902</a></li>
</ol>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/07/28/Python æ—¥å¿—åº“å¯¹æ¯”/" rel="prev" title="Python æ—¥å¿—åº“å¯¹æ¯”">
      <i class="fa fa-chevron-left"></i> Python æ—¥å¿—åº“å¯¹æ¯”
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/10/24/Go Cookbook/" rel="next" title="Go CookBook">
      Go CookBook <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#æ‘˜è¦"><span class="nav-number">1.</span> <span class="nav-text">æ‘˜è¦</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å˜é‡å±è”½"><span class="nav-number">2.</span> <span class="nav-text">å˜é‡å±è”½</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¸å¿…è¦çš„åµŒå¥—"><span class="nav-number">3.</span> <span class="nav-text">ä¸å¿…è¦çš„åµŒå¥—</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ»¥ç”¨-init"><span class="nav-number">4.</span> <span class="nav-text">æ»¥ç”¨ init</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#è¿‡åº¦ä½¿ç”¨-getter-å’Œ-setter"><span class="nav-number">5.</span> <span class="nav-text">è¿‡åº¦ä½¿ç”¨ getter å’Œ setter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ¥å£æ±¡æŸ“"><span class="nav-number">6.</span> <span class="nav-text">æ¥å£æ±¡æŸ“</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#æ¥å£æ¦‚å¿µ"><span class="nav-number">6.1.</span> <span class="nav-text">æ¥å£æ¦‚å¿µ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ä»€ä¹ˆæ—¶å€™ä½¿ç”¨æ¥å£"><span class="nav-number">6.2.</span> <span class="nav-text">ä»€ä¹ˆæ—¶å€™ä½¿ç”¨æ¥å£</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#æ¥å£æ±¡æŸ“-1"><span class="nav-number">6.3.</span> <span class="nav-text">æ¥å£æ±¡æŸ“</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ¥å£åº”è¯¥åœ¨å“ªé‡Œ"><span class="nav-number">7.</span> <span class="nav-text">æ¥å£åº”è¯¥åœ¨å“ªé‡Œ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#è¿”å›æ¥å£"><span class="nav-number">8.</span> <span class="nav-text">è¿”å›æ¥å£</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#any"><span class="nav-number">9.</span> <span class="nav-text">any</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä»€ä¹ˆæ—¶å€™ç”¨æ³›å‹"><span class="nav-number">10.</span> <span class="nav-text">ä»€ä¹ˆæ—¶å€™ç”¨æ³›å‹</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ä»€ä¹ˆæ˜¯æ³›å‹"><span class="nav-number">10.1.</span> <span class="nav-text">ä»€ä¹ˆæ˜¯æ³›å‹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ä½¿ç”¨åœºæ™¯"><span class="nav-number">10.2.</span> <span class="nav-text">ä½¿ç”¨åœºæ™¯</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ç»“æ„ä½“å†…åµŒ"><span class="nav-number">11.</span> <span class="nav-text">ç»“æ„ä½“å†…åµŒ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å‡½æ•°çš„é€‰é¡¹æ¨¡å¼"><span class="nav-number">12.</span> <span class="nav-text">å‡½æ•°çš„é€‰é¡¹æ¨¡å¼</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#é¡¹ç›®ç»“æ„"><span class="nav-number">13.</span> <span class="nav-text">é¡¹ç›®ç»“æ„</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#utility-åŒ…"><span class="nav-number">14.</span> <span class="nav-text">utility åŒ…</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å˜é‡åå’ŒåŒ…åå†²çª"><span class="nav-number">15.</span> <span class="nav-text">å˜é‡åå’ŒåŒ…åå†²çª</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä»£ç æ–‡æ¡£"><span class="nav-number">16.</span> <span class="nav-text">ä»£ç æ–‡æ¡£</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä»£ç æ£€æŸ¥å·¥å…·"><span class="nav-number">17.</span> <span class="nav-text">ä»£ç æ£€æŸ¥å·¥å…·</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å…«è¿›åˆ¶å­—é¢é‡çš„è¯¯è§£"><span class="nav-number">18.</span> <span class="nav-text">å…«è¿›åˆ¶å­—é¢é‡çš„è¯¯è§£</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ•´æ•°æº¢å‡º"><span class="nav-number">19.</span> <span class="nav-text">æ•´æ•°æº¢å‡º</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æµ®ç‚¹"><span class="nav-number">20.</span> <span class="nav-text">æµ®ç‚¹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#åˆ‡ç‰‡é•¿åº¦å’Œå®¹é‡"><span class="nav-number">21.</span> <span class="nav-text">åˆ‡ç‰‡é•¿åº¦å’Œå®¹é‡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#åˆ‡ç‰‡åˆå§‹åŒ–"><span class="nav-number">22.</span> <span class="nav-text">åˆ‡ç‰‡åˆå§‹åŒ–</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nil-åˆ‡ç‰‡å’Œ-empty-åˆ‡ç‰‡"><span class="nav-number">23.</span> <span class="nav-text">nil åˆ‡ç‰‡å’Œ empty åˆ‡ç‰‡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ£€æŸ¥åˆ‡ç‰‡æ˜¯å¦ä¸ºç©º"><span class="nav-number">24.</span> <span class="nav-text">æ£€æŸ¥åˆ‡ç‰‡æ˜¯å¦ä¸ºç©º</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#copy-åˆ‡ç‰‡"><span class="nav-number">25.</span> <span class="nav-text">copy åˆ‡ç‰‡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#slice-å…±äº«åº•å±‚æ•°ç»„å¸¦æ¥çš„é—®é¢˜"><span class="nav-number">26.</span> <span class="nav-text">slice å…±äº«åº•å±‚æ•°ç»„å¸¦æ¥çš„é—®é¢˜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#åˆ‡ç‰‡å†…å­˜æ³„æ¼"><span class="nav-number">27.</span> <span class="nav-text">åˆ‡ç‰‡å†…å­˜æ³„æ¼</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä½æ•ˆçš„-map-åˆå§‹åŒ–"><span class="nav-number">28.</span> <span class="nav-text">ä½æ•ˆçš„ map åˆå§‹åŒ–</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#map-åŸç†"><span class="nav-number">28.1.</span> <span class="nav-text">map åŸç†</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#åˆå§‹åŒ–"><span class="nav-number">28.2.</span> <span class="nav-text">åˆå§‹åŒ–</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#map-å†…å­˜æ³„æ¼"><span class="nav-number">29.</span> <span class="nav-text">map å†…å­˜æ³„æ¼</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#é”™è¯¯çš„å€¼æ¯”è¾ƒ"><span class="nav-number">30.</span> <span class="nav-text">é”™è¯¯çš„å€¼æ¯”è¾ƒ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#range-å¾ªç¯æ˜¯å€¼æ‹·è´"><span class="nav-number">31.</span> <span class="nav-text">range å¾ªç¯æ˜¯å€¼æ‹·è´</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#range-å¯¹è±¡ä½•æ—¶è¢«è®¡ç®—"><span class="nav-number">32.</span> <span class="nav-text">range å¯¹è±¡ä½•æ—¶è¢«è®¡ç®—</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#range-ä¸­ä½¿ç”¨æŒ‡é’ˆ"><span class="nav-number">33.</span> <span class="nav-text">range ä¸­ä½¿ç”¨æŒ‡é’ˆ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#map-è¿­ä»£ä¸­çš„å¸¸è§é—®é¢˜"><span class="nav-number">34.</span> <span class="nav-text">map è¿­ä»£ä¸­çš„å¸¸è§é—®é¢˜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#break-çš„ä½¿ç”¨"><span class="nav-number">35.</span> <span class="nav-text">break çš„ä½¿ç”¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#åœ¨å¾ªç¯ä¸­ä½¿ç”¨-defer"><span class="nav-number">36.</span> <span class="nav-text">åœ¨å¾ªç¯ä¸­ä½¿ç”¨ defer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¸ç†è§£-rune"><span class="nav-number">37.</span> <span class="nav-text">ä¸ç†è§£ rune</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å­—ç¬¦ä¸²è¿­ä»£å’Œé•¿åº¦"><span class="nav-number">38.</span> <span class="nav-text">å­—ç¬¦ä¸²è¿­ä»£å’Œé•¿åº¦</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#trim-å‡½æ•°"><span class="nav-number">39.</span> <span class="nav-text">trim å‡½æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å­—ç¬¦ä¸²æ‹¼æ¥"><span class="nav-number">40.</span> <span class="nav-text">å­—ç¬¦ä¸²æ‹¼æ¥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ— æ•ˆçš„å­—ç¬¦ä¸²è½¬æ¢"><span class="nav-number">41.</span> <span class="nav-text">æ— æ•ˆçš„å­—ç¬¦ä¸²è½¬æ¢</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å­å­—ç¬¦ä¸²å†…å­˜æ³„éœ²"><span class="nav-number">42.</span> <span class="nav-text">å­å­—ç¬¦ä¸²å†…å­˜æ³„éœ²</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¸çŸ¥è¯¥ç”¨å“ªç§ç±»å‹çš„æ–¹æ³•æ¥æ”¶å™¨"><span class="nav-number">43.</span> <span class="nav-text">ä¸çŸ¥è¯¥ç”¨å“ªç§ç±»å‹çš„æ–¹æ³•æ¥æ”¶å™¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å‘½åè¿”å›å‚æ•°"><span class="nav-number">44.</span> <span class="nav-text">å‘½åè¿”å›å‚æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å‘½åè¿”å›å‚æ•°æ„å¤–è¾¹ç•Œæƒ…å†µ"><span class="nav-number">45.</span> <span class="nav-text">å‘½åè¿”å›å‚æ•°æ„å¤–è¾¹ç•Œæƒ…å†µ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nil-receiver"><span class="nav-number">46.</span> <span class="nav-text">nil receiver</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä½¿ç”¨æ–‡ä»¶åä½œä¸ºå…¥å‚"><span class="nav-number">47.</span> <span class="nav-text">ä½¿ç”¨æ–‡ä»¶åä½œä¸ºå…¥å‚</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#defer-å‚æ•°å’Œä¸åŒ-receiver"><span class="nav-number">48.</span> <span class="nav-text">defer å‚æ•°å’Œä¸åŒ receiver</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä½¿ç”¨-panic"><span class="nav-number">49.</span> <span class="nav-text">ä½¿ç”¨ panic</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#åŒ…è£…-error"><span class="nav-number">50.</span> <span class="nav-text">åŒ…è£… error</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ£€æŸ¥-error-ç±»å‹"><span class="nav-number">51.</span> <span class="nav-text">æ£€æŸ¥ error ç±»å‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ£€æŸ¥-error-å€¼"><span class="nav-number">52.</span> <span class="nav-text">æ£€æŸ¥ error å€¼</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#error-è¢«å¤„ç†å¤šæ¬¡"><span class="nav-number">53.</span> <span class="nav-text">error è¢«å¤„ç†å¤šæ¬¡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¸éœ€è¦å¤„ç†çš„-error"><span class="nav-number">54.</span> <span class="nav-text">ä¸éœ€è¦å¤„ç†çš„ error</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å¤„ç†-defer-ä¸­çš„-error"><span class="nav-number">55.</span> <span class="nav-text">å¤„ç† defer ä¸­çš„ error</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å¹¶å‘å’Œå¹¶è¡Œ"><span class="nav-number">56.</span> <span class="nav-text">å¹¶å‘å’Œå¹¶è¡Œ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#è®¤ä¸ºå¹¶å‘ä¸€å®šæ›´å¿«"><span class="nav-number">57.</span> <span class="nav-text">è®¤ä¸ºå¹¶å‘ä¸€å®šæ›´å¿«</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä½•æ—¶ä½¿ç”¨é€šé“æˆ–äº’æ–¥é”æ¥è§£å†³å¹¶å‘é—®é¢˜"><span class="nav-number">58.</span> <span class="nav-text">ä½•æ—¶ä½¿ç”¨é€šé“æˆ–äº’æ–¥é”æ¥è§£å†³å¹¶å‘é—®é¢˜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#race-é—®é¢˜"><span class="nav-number">59.</span> <span class="nav-text">race é—®é¢˜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Context"><span class="nav-number">60.</span> <span class="nav-text">Context</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#é”™è¯¯çš„ä¼ é€’-context"><span class="nav-number">61.</span> <span class="nav-text">é”™è¯¯çš„ä¼ é€’ context</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä½•æ—¶åœæ­¢-Goroutine"><span class="nav-number">62.</span> <span class="nav-text">ä½•æ—¶åœæ­¢ Goroutine</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#range-ä¸­æ‰§è¡Œåç¨‹"><span class="nav-number">63.</span> <span class="nav-text">range ä¸­æ‰§è¡Œåç¨‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#switch-channel-çš„éšæœºé€‰æ‹©"><span class="nav-number">64.</span> <span class="nav-text">switch+channel  çš„éšæœºé€‰æ‹©</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä½¿ç”¨-channel-ä½œä¸ºé€šçŸ¥ä¿¡é“"><span class="nav-number">65.</span> <span class="nav-text">ä½¿ç”¨ channel ä½œä¸ºé€šçŸ¥ä¿¡é“</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nil-channel"><span class="nav-number">66.</span> <span class="nav-text">nil channel</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æœ‰-æ— ç¼“å†²çš„-channel"><span class="nav-number">67.</span> <span class="nav-text">æœ‰/æ— ç¼“å†²çš„ channel</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#appendçš„æ—¶å€™-data-races"><span class="nav-number">68.</span> <span class="nav-text">appendçš„æ—¶å€™ data races</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å‚è€ƒ"><span class="nav-number">69.</span> <span class="nav-text">å‚è€ƒ</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Rex"
      src="https://raw.githubusercontent.com/rexyan/warehouse/master/20230809141242.jpg">
  <p class="site-author-name" itemprop="name">Rex</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">446</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">183</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2017 â€“ 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa-hand-o-right"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Rex</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
<script src="/js/utils.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  

</body>
</html>
